<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"/>

<link rel="stylesheet" href="/css/main.css?v=7.2.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Record and Think!">
<meta property="og:type" content="website">
<meta property="og:title" content="Schwimmer&#39;s Blog">
<meta property="og:url" content="https://schwimmer.github.io/page/30/index.html">
<meta property="og:site_name" content="Schwimmer&#39;s Blog">
<meta property="og:description" content="Record and Think!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Schwimmer&#39;s Blog">
<meta name="twitter:description" content="Record and Think!">





  
  
  <link rel="canonical" href="https://schwimmer.github.io/page/30/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Schwimmer's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Schwimmer's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br/>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br/>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br/>Sitemap</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br/>Commonweal 404</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/工具和环境/scp免密码登录/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/工具和环境/scp免密码登录/" class="post-title-link" itemprop="url">scp免密码登录</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-01-30 16:38:16" itemprop="dateModified" datetime="2018-01-30T16:38:16+08:00">2018-01-30</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/工具和环境/" itemprop="url" rel="index"><span itemprop="name">工具和环境</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设A要免密码传输文件到B</p>
<p>在A上创建秘钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa</div></pre></td></tr></table></figure>
<p>拷贝id_rsa.pub到B的.ssh，并改名为authorized_keys</p>
<p>注意要修改权限</p>
<p>A机器</p>
<p>.ssh目录，以及/home/当前用户 需要700权限，参考以下操作调整</p>
<p>sudo chmod 700 ~/.ssh</p>
<p>sudo chmod 700 /home/当前用户</p>
<p>B机器</p>
<p>.ssh目录下的authorized_keys文件需要600或644权限，参考以下操作调整</p>
<p>sudo chmod 600 ~/.ssh/authorized_keys</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/工具和环境/Hexo + Github 搭建博客入门/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/工具和环境/Hexo + Github 搭建博客入门/" class="post-title-link" itemprop="url">Hexo + Github 搭建博客入门</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-03 09:49:30" itemprop="dateModified" datetime="2019-06-03T09:49:30+08:00">2019-06-03</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/工具和环境/" itemprop="url" rel="index"><span itemprop="name">工具和环境</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1、安装node-js"><a href="#1、安装node-js" class="headerlink" title="1、安装node.js"></a>1、安装node.js</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> sudo add-apt-repository ppa:chris-lea/node.js</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install nodejs</span></div><div class="line"><span class="meta">#</span><span class="bash">原方法没有这一步，但是后面的操作会提示npm <span class="built_in">command</span> not found</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install npm</span></div></pre></td></tr></table></figure>
<h1 id="2、安装hexo"><a href="#2、安装hexo" class="headerlink" title="2、安装hexo"></a>2、安装hexo</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> sudo npm install hexo -g</span></div></pre></td></tr></table></figure>
<p>如果是mac，要用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo npm install hexo --no-optional</div></pre></td></tr></table></figure>
<p>不然会报错<strong>Error: Cannot find module ‘./build/Release/DTraceProviderBindings’] code: ‘MODULE_NOT_FOUND’</strong>这个错误。</p>
<p>如果报权限错误，需要用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo npm install --unsafe-perm --verbose -g hexo</div></pre></td></tr></table></figure>
<h1 id="3、初始博客的根目录"><a href="#3、初始博客的根目录" class="headerlink" title="3、初始博客的根目录"></a>3、初始博客的根目录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/myblog</span></div><div class="line"><span class="meta">$</span><span class="bash"> hexo init</span></div></pre></td></tr></table></figure>
<p>mac的根目录在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/Users/david/david/myblog</div></pre></td></tr></table></figure>
<h1 id="4、在github上新建仓库"><a href="#4、在github上新建仓库" class="headerlink" title="4、在github上新建仓库"></a>4、在github上新建仓库</h1><p>名称必须是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gitusername.github.io</div></pre></td></tr></table></figure>
<p>我的就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Schwimmer.github.io</div></pre></td></tr></table></figure>
<p>并将本地的SSH KEY添加到git上（略）</p>
<h1 id="5、让博客可以发布到git"><a href="#5、让博客可以发布到git" class="headerlink" title="5、让博客可以发布到git"></a>5、让博客可以发布到git</h1><p>1）安装hexo-deployer-Git（不然会出现ERROR Deployer not found: git）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-deployer-git --save</div></pre></td></tr></table></figure>
<p>2） 配置你hexo博客根目录下的_config.yml文件(应该是最下面一行，修改成你的github)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">  type: git</div><div class="line">  repo: git@github.com:Schwimmer/Schwimmer.github.io.git</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
<blockquote>
<p> tips</p>
<p> 冒号后面一定要跟空格</p>
</blockquote>
<h1 id="6、hexo常用命令"><a href="#6、hexo常用命令" class="headerlink" title="6、hexo常用命令"></a>6、hexo常用命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">hexo clean #清除缓存</div><div class="line">hexo new &quot;title&quot; #新建文章</div><div class="line">hexo g #生成html，或hexo generate</div><div class="line">hexo s #在本地启动服务，启动后访问localhost:4000就可以打开，或hexo server</div><div class="line">hexo d #发布到git，发布后访问https://schwimmer.github.io/就可以打开，或hexo deploy</div></pre></td></tr></table></figure>
<blockquote>
<p> tips</p>
<p> 我目前用的新建文章的方法，就是直接在source/_posts/下面新建md文件</p>
<p> 可以偷懒写成</p>
<p> cd ~/myblog</p>
<p> hexo clean;hexo g;hexo s</p>
<p> 或</p>
<p> hexo clean;hexo g;hexo d</p>
</blockquote>
<h1 id="7、支持数学公式"><a href="#7、支持数学公式" class="headerlink" title="7、支持数学公式"></a>7、支持数学公式</h1><p>更新：</p>
<p>现在用</p>
<p><a href="http://blog.csdn.net/u014630987/article/details/78670258" target="_blank" rel="noopener">如何在 hexo 中支持 Mathjax？</a></p>
<p><a href="http://blog.csdn.net/emptyset110/article/details/50123231" target="_blank" rel="noopener">搭建一个支持LaTEX的hexo博客</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-math --save</div></pre></td></tr></table></figure>
<p>这时如果你会发现出了一些问题，原因是hexo先用marked.<a href="http://lib.csdn.net/base/javascript" target="_blank" rel="noopener">js</a>渲染，然后再交给MathJax渲染。在marked.js渲染的时候下划线<code>_</code>是被escape掉并且换成了<code>&lt;em&gt;</code>标签，即斜体字，另外LaTeX中的<code>\\</code>也会被转义成一个<code>\</code>，这样会导致MathJax渲染时不认为它是一个换行符了。</p>
<p>为了使Marked.js与MathJax共存，打开node_modules/marked/lib/marked.js并做如下改动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Step 1:</div><div class="line">  escape: /^\\([\\`*&#123;&#125;\[\]()# +\-.!_&gt;])/,11替换成</div><div class="line">  escape: /^\\([`*\[\]()# +\-.!_&gt;])/,11这一步是在原基础上取消了对\\,\&#123;,\&#125;的转义(escape)</div><div class="line">Step 2:</div><div class="line">  em: /^\b_((?:[^_]|__)+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,11替换成</div><div class="line">  em:/^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML&quot;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<h1 id="8、安装主题"><a href="#8、安装主题" class="headerlink" title="8、安装主题"></a>8、安装主题</h1><p>转自：<a href="http://theme-next.iissnan.com/getting-started.html" target="_blank" rel="noopener">NexT主题安装教程</a></p>
<h1 id="9、文章阅读计数"><a href="#9、文章阅读计数" class="headerlink" title="9、文章阅读计数"></a>9、文章阅读计数</h1><p>转自：<a href="http://www.jianshu.com/p/702a7aec4d00" target="_blank" rel="noopener">Hexo添加不蒜子和LeanCloud统计无标题文章</a></p>
<p>找到站点的<code>themes/next/layout/_partials</code>目录下的<code>footer.swig</code>文件。插入代码如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;% if theme.copyright %&#125;</div><div class="line">&lt;div class=&quot;powered-by&quot;&gt;</div><div class="line">  &#123;&#123; __(&apos;footer.powered&apos;, &apos;&lt;a class=&quot;theme-link&quot; href=&quot;https://hexo.io&quot;&gt;Hexo&lt;/a&gt;&apos;) &#125;&#125;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&lt;div class=&quot;theme-info&quot;&gt;</div><div class="line">  &#123;&#123; __(&apos;footer.theme&apos;) &#125;&#125; -</div><div class="line">  &lt;a class=&quot;theme-link&quot; href=&quot;https://github.com/iissnan/hexo-theme-next&quot;&gt;</div><div class="line">    NexT.&#123;&#123; theme.scheme &#125;&#125;</div><div class="line">  &lt;/a&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line"># 此位置插入以下代码</div><div class="line">&lt;div&gt;</div><div class="line">&lt;script async src=&quot;https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</div><div class="line"></div><div class="line">本站总访问量 &lt;span id=&quot;busuanzi_value_site_pv&quot;&gt;&lt;/span&gt; 次&amp;nbsp&amp;nbsp&amp;nbsp</div><div class="line">本站访客数&lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt;人次</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<h1 id="10、增加图片"><a href="#10、增加图片" class="headerlink" title="10、增加图片"></a>10、增加图片</h1><p>1 把主页配置文件<code>_config.yml</code> 里的<code>post_asset_folder:</code>这个选项设置为<code>true</code></p>
<p>2 在你的hexo目录下执行这样一句话<code>npm install hexo-asset-image --save</code>，这是下载安装一个可以上传本地图片的插件，来自dalao：<a href="https://github.com/CodeFalling/hexo-asset-image" target="_blank" rel="noopener">dalao的git</a></p>
<p>3 等待一小段时间后，再运行<code>hexo n &quot;xxxx&quot;</code>来生成md博文时，<code>/source/_posts</code>文件夹内除了<code>xxxx.md</code>文件还有一个<strong>同名的文件夹</strong></p>
<p>4 最后在<code>xxxx.md</code>中想引入图片时，先把图片复制到xxxx这个文件夹中，然后只需要在xxxx.md中按照markdown的格式引入图片：</p>
<p><code>![你想输入的替代文字](xxxx/图片名.jpg)</code></p>
<p><strong>注意：</strong>xxxx是这个md文件的名字，也是同名文件夹的名字，你想引入的图片就只需要放入xxxx这个文件夹内就好了，很像引用相对路径。</p>
<p>5 最后检查一下，<code>hexo g</code>生成页面后，进入<code>public\2017\02\26\index.html</code>文件中查看相关字段，可以发现，html标签内的语句是<code>&lt;img src=&quot;2017/02/26/xxxx/图片名.jpg&quot;&gt;</code>，而不是<code>&lt;img src=&quot;xxxx/图片名.jpg&gt;</code>。这很重要，关乎你的网页是否可以真正加载你想插入的图片。</p>
<h1 id="11、sitemap-插件"><a href="#11、sitemap-插件" class="headerlink" title="11、sitemap 插件"></a>11、sitemap 插件</h1><p><a href="https://www.jianshu.com/p/86557c34b671" target="_blank" rel="noopener">Hexo Seo优化让你的博客在google搜索排名第一</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;meta name=&quot;google-site-verification&quot; content=&quot;Mx7Ikp0IpBtTbSpHDTBV0_CMJA-E8CLn8NRIrwyq5m4&quot; /&gt;</div><div class="line">&lt;meta name=&quot;baidu-site-verification&quot; content=&quot;ZBTsWx4NdC&quot; /&gt;</div></pre></td></tr></table></figure>
<h1 id="12、首页显示文章摘要"><a href="#12、首页显示文章摘要" class="headerlink" title="12、首页显示文章摘要"></a>12、首页显示文章摘要</h1><ul>
<li>进入hexo博客项目的themes/next目录</li>
<li>用文本编辑器打开_config.yml文件</li>
<li>搜索”auto_excerpt”,找到如下部分：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Automatically Excerpt. Not recommand.</div><div class="line"># Please use &lt;!-- more --&gt; in the post to control excerpt accurately.</div><div class="line">auto_excerpt:</div><div class="line">  enable: false</div><div class="line">  length: 150</div></pre></td></tr></table></figure>
<ul>
<li>把enable改为对应的false改为true，然后<code>hexo d -g</code>，再进主页，问题就解决了！</li>
</ul>
<h1 id="13、启用分类和标签"><a href="#13、启用分类和标签" class="headerlink" title="13、启用分类和标签"></a>13、启用分类和标签</h1><p>1、在博客的开头要加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">title: Hexo + Github 搭建博客入门</div><div class="line">date: 2017-07-12 11:49:53</div><div class="line">categories: &quot;工具和环境&quot;</div><div class="line">tags: </div><div class="line"> - hexo</div><div class="line">description:</div></pre></td></tr></table></figure>
<p>2、修改主题配置文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">menu:</div><div class="line">  home: /</div><div class="line">  categories: /categories</div><div class="line">  #about: /about</div><div class="line">  archives: /archives</div><div class="line">  tags: /tags</div></pre></td></tr></table></figure>
<p>3、hexo加上page</p>
<p>如分类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new page categories</div></pre></td></tr></table></figure>
<p>然后打开<code>source/categories/index.md</code>，增加一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">type: &quot;categories&quot;</div></pre></td></tr></table></figure>
<p>增加标签也是一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new page tags</div></pre></td></tr></table></figure>
<p>然后打开<code>source/tags/index.md</code>，增加一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">type: &quot;tags&quot;</div></pre></td></tr></table></figure>
<p>谷歌与百度的站点地图，前者适用于其他搜索引擎，用来手动提交以增加收录</p>
<p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-sitemap@1 --save</div><div class="line">npm install hexo-generator-baidu-sitemap@0.1.1 --save</div></pre></td></tr></table></figure>
<p><code>_config.yml</code>添加代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">baidusitemap:</div><div class="line">  path: baidusitemap.xml</div></pre></td></tr></table></figure>
<p>谷歌的<code>sitemap.xml</code>不需要写到配置文件中，自动生效。</p>
<p>在主页后面加<code>/baidusitemap.xml</code>可以看到baidusitemap（谷歌同理），将该网址它提交给百度搜索：<a href="http://zhanzhang.baidu.com/?castk=LTE%3D" target="_blank" rel="noopener">百度站长平台</a>，贴吧账号无法在这里使用。</p>
<p>不过由于Github禁止了百度爬虫，百度无法抓取其中的URL：</p>
<h1 id="绑定代码到Coding"><a href="#绑定代码到Coding" class="headerlink" title="绑定代码到Coding"></a>绑定代码到Coding</h1><p>创建coding仓库</p>
<p><img src="https://upload-images.jianshu.io/upload_images/4093388-383ab28e2c2b2e84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p>
<p>上传公钥</p>
<p><a href="https://coding.net/user/account/setting/keys" target="_blank" rel="noopener">https://coding.net/user/account/setting/keys</a></p>
<p>测试SSH Key 是否配置成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -T git@git.coding.net</div></pre></td></tr></table></figure>
<p>用来部署Hexo博客的Coding项目地址为：<code>git@git.coding.net:ddxy1986/DavidXu-Blog</code></p>
<p>deploy的配置改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">  type: git</div><div class="line">  repo: </div><div class="line">    github: git@github.com:Schwimmer/Schwimmer.github.io.git</div><div class="line">    coding: git@git.coding.net:ddxy1986/DavidXu-Blog</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
<h2 id="配置Coding项目的Pages服务"><a href="#配置Coding项目的Pages服务" class="headerlink" title="配置Coding项目的Pages服务"></a>配置Coding项目的Pages服务</h2><h3 id="开启Coding项目的Pages服务"><a href="#开启Coding项目的Pages服务" class="headerlink" title="开启Coding项目的Pages服务"></a>开启Coding项目的Pages服务</h3><p><img src="https://upload-images.jianshu.io/upload_images/4093388-1ab23c0ef7e753ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p>
<h1 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h1><p>1）若启动时报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> Error: Warning: Permanently added &apos;github.com,192.30.253.112&apos; (RSA) to the list of known hosts.</div><div class="line">sign_and_send_pubkey: signing failed: agent refused operation</div><div class="line">Permission denied (publickey).</div><div class="line">fatal: Could not read from remote repository.</div></pre></td></tr></table></figure>
<p>处理是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ eval &quot;$(ssh-agent -s)&quot;</div><div class="line">$ ssh-add</div></pre></td></tr></table></figure>
<p>2）生成html时报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">end of the stream or a document separator is expected</div></pre></td></tr></table></figure>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="http://blog.csdn.net/kesarchen/article/details/50579550" target="_blank" rel="noopener">ubuntu下使用hexo搭建博客</a> </p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/数学/利率计算/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/数学/利率计算/" class="post-title-link" itemprop="url">利率计算</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-01-29 21:42:24" itemprop="dateModified" datetime="2018-01-29T21:42:24+08:00">2018-01-29</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数学/" itemprop="url" rel="index"><span itemprop="name">数学</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>等额本息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">每月月供额=〔贷款本金×月利率×(1＋月利率)＾还款月数〕÷〔(1＋月利率)＾还款月数-1〕</div><div class="line">每月应还利息=贷款本金×月利率×〔(1+月利率)^还款月数-(1+月利率)^(还款月序号-1)〕÷〔(1+月利率)^还款月数-1〕</div><div class="line">每月应还本金=贷款本金×月利率×(1+月利率)^(还款月序号-1)÷〔(1+月利率)^还款月数-1〕</div><div class="line">总利息=还款月数×每月月供额-贷款本金</div></pre></td></tr></table></figure>
<p>等额本金</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">每月月供额=(贷款本金÷还款月数)+(贷款本金-已归还本金累计额)×月利率</div><div class="line">每月应还本金=贷款本金÷还款月数</div><div class="line">每月应还利息=剩余本金×月利率=(贷款本金-已归还本金累计额)×月利率</div><div class="line">每月月供递减额=每月应还本金×月利率=贷款本金÷还款月数×月利率</div><div class="line">总利息=还款月数×(总贷款额×月利率-月利率×(总贷款额÷还款月数)*(还款月数-1)÷2+总贷款额÷还款月数)</div></pre></td></tr></table></figure>
<p><a href="https://zhuanlan.zhihu.com/p/22920169" target="_blank" rel="noopener">信用卡账单分期真实年化利率</a></p>
<p><img src="https://pic4.zhimg.com/v2-177bf28088e8ef5462e3b5cc3d1ab2eb_b.png" alt=""></p>
<h1 id="年利率"><a href="#年利率" class="headerlink" title="年利率"></a>年利率</h1><p>利息率=利息量÷本金÷时间×100%</p>
<h1 id="IRR"><a href="#IRR" class="headerlink" title="IRR"></a>IRR</h1><p><strong>内部收益率 (IRR) 的定义是：净现值 (NPV) 为零时的折现率。</strong></p>
<p>综合考虑了每期的流入流出现金的量和时间，加权出来的结果。<br>IRR实质上是一个折现率，用IRR折现时会达到该项目的净现值NPV为0的状态。也可以理解为一个项目的预期收益率。<br>举例来说，如IRR为8%，可以简单解释为以8%的利率借钱投资于此项目，刚好可以不赚不赔。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/编程语言学习/JAVA/java笔记/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/编程语言学习/JAVA/java笔记/" class="post-title-link" itemprop="url">java笔记</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-06 11:42:13" itemprop="dateModified" datetime="2019-06-06T11:42:13+08:00">2019-06-06</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="list转array"><a href="#list转array" class="headerlink" title="list转array"></a>list转array</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">List&lt;Double&gt; scores = <span class="keyword">new</span> ArrayList&lt;Double&gt;();</div><div class="line"></div><div class="line">Double[] arrays = scores.toArray(<span class="keyword">new</span> Double[<span class="number">0</span>]);</div></pre></td></tr></table></figure>
<h1 id="log4j打印catch堆栈信息"><a href="#log4j打印catch堆栈信息" class="headerlink" title="log4j打印catch堆栈信息"></a>log4j打印catch堆栈信息</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">logger.error(e.getMessage(),e);</div></pre></td></tr></table></figure>
<h1 id="判断字符类型"><a href="#判断字符类型" class="headerlink" title="判断字符类型"></a>判断字符类型</h1><h2 id="判断中文字符"><a href="#判断中文字符" class="headerlink" title="判断中文字符"></a>判断中文字符</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Character.isLetter()</div></pre></td></tr></table></figure>
<h2 id="判断是否为英文或数字"><a href="#判断是否为英文或数字" class="headerlink" title="判断是否为英文或数字"></a>判断是否为英文或数字</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlphaOrDigit</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>)</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">if</span> (ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>)</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">if</span> (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>)</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a><strong>文件读写</strong></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">String encoding = &quot;GBK&quot;;</div><div class="line">		String lineText = null;</div><div class="line">		File file = new File(&quot;D:\\00projects\\20buzz-cookie-info\\chinaz.json&quot;);</div><div class="line">		if (file.isFile() &amp;&amp; file.exists()) &#123;</div><div class="line">			BufferedReader read = new BufferedReader(new InputStreamReader(</div><div class="line">					new FileInputStream(file), encoding));</div><div class="line">			while((lineText=read.readLine())!=null)&#123;</div><div class="line">				</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			read.close();</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<h1 id="读tar-gz"><a href="#读tar-gz" class="headerlink" title="读tar.gz"></a>读tar.gz</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; content = GzipUtil.readAllLines(Thread.currentThread().getContextClassLoader()</div><div class="line">                    .getResourceAsStream(filename));</div></pre></td></tr></table></figure>
<h1 id="读resource的文件"><a href="#读resource的文件" class="headerlink" title="读resource的文件"></a>读resource的文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">BufferedReader br = null;</div><div class="line">		try &#123;</div><div class="line">			br = new BufferedReader(new InputStreamReader(Thread.currentThread().getContextClassLoader()</div><div class="line">					.getResourceAsStream(modelFilePath), &quot;utf8&quot;));</div><div class="line">			</div><div class="line">	/*		 br = new BufferedReader(new InputStreamReader(new</div><div class="line">			 FileInputStream(modelFilePath),</div><div class="line">			 &quot;utf8&quot;));*/</div><div class="line">			String line = &quot;&quot;;</div><div class="line">			while ((line = br.readLine()) != null) &#123;</div><div class="line">				String[] dataArr = line.split(&quot;\t&quot;);</div><div class="line">				if(dataArr.length == 2)&#123;</div><div class="line">					enToCh.put(dataArr[0], dataArr[1]);</div><div class="line">					chToEn.put(dataArr[1], dataArr[0]);</div><div class="line">				&#125;				</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125; catch (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; finally &#123;</div><div class="line">			try &#123;</div><div class="line">				br.close();</div><div class="line">			&#125; catch (IOException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<h2 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">BufferedWriter bw = null;</div><div class="line">File f = new File(path);</div><div class="line">bw = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(f),&quot;gbk&quot;));</div><div class="line">bw.write(JSON.toJSONString(lookalikeNode));</div><div class="line">bw.write(&quot;\n&quot;);</div><div class="line">bw.close();</div></pre></td></tr></table></figure>
<h1 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h1><h2 id="日期和字符串互转"><a href="#日期和字符串互转" class="headerlink" title="日期和字符串互转"></a>日期和字符串互转</h2><p>字符串转日期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//2017-05-26-16-40-13</div><div class="line">SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);</div><div class="line">Date date = simpleDateFormat.parse(xmoEvent.getOpxdate());</div></pre></td></tr></table></figure>
<p>日期输出为字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">simpleDateFormat = new SimpleDateFormat(&quot;yyyyMMdd&quot;);</div><div class="line">System.out.println(simpleDateFormat.format(date));</div></pre></td></tr></table></figure>
<p>当前日期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">System.currentTimeMillis()</div><div class="line">或者</div><div class="line">Date date = new Date(System.currentTimeMillis());</div><div class="line"></div><div class="line">字符串表示</div><div class="line">SimpleDateFormat simpleDateFormat  = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</div><div class="line">Date date = new Date(System.currentTimeMillis());</div><div class="line">System.out.println(simpleDateFormat.format(date));</div></pre></td></tr></table></figure>
<h2 id="两个日期之间的天数和周数"><a href="#两个日期之间的天数和周数" class="headerlink" title="两个日期之间的天数和周数"></a>两个日期之间的天数和周数</h2><p><a href="http://www.jb51.net/article/100441.htm" target="_blank" rel="noopener">http://www.jb51.net/article/100441.htm</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Calendar end = Calendar.getInstance();</div><div class="line">//取日期是一年中第几天</div><div class="line">d1 = end.get(Calendar.DAY_OF_YEAR)</div><div class="line"></div><div class="line">//两个日期相隔几周</div><div class="line">(d2-d1)/7</div><div class="line">//星期中相隔几天</div><div class="line"></div><div class="line">Date转为Calendar</div></pre></td></tr></table></figure>
<h2 id="日期加减"><a href="#日期加减" class="headerlink" title="日期加减"></a>日期加减</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Calendar calendar = Calendar.getInstance();//此时打印它获取的是系统当前时间</div><div class="line">        calendar.add(Calendar.DATE, -1);    //得到前一天</div><div class="line"></div><div class="line">String  yestedayDate</div><div class="line"></div><div class="line">= new SimpleDateFormat("yyyy-MM-dd").format(cal.getTime());</div><div class="line"></div><div class="line"></div><div class="line">        calendar.add(Calendar.MONTH, -1);    //得到前一个月</div><div class="line">        int year = calendar.get(Calendar.YEAR);</div><div class="line"></div><div class="line"></div><div class="line">       int month = calendar.get(Calendar.MONTH)+1; //输出前一月的时候要记得加1</div></pre></td></tr></table></figure>
<h2 id="String-Date-Calendar之间的转换"><a href="#String-Date-Calendar之间的转换" class="headerlink" title="String Date Calendar之间的转换"></a>String Date Calendar之间的转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>.Calendar 转化 String</div><div class="line"></div><div class="line">Calendar calendat = Calendar.getInstance();</div><div class="line"></div><div class="line">SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line"></div><div class="line">String dateStr = sdf.format(calendar.getTime());</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">2</span>.String 转化Calendar</div><div class="line"></div><div class="line">String str=<span class="string">"2012-5-27"</span>;</div><div class="line"></div><div class="line">SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line"></div><div class="line">Date date =sdf.parse(str);</div><div class="line"></div><div class="line">Calendar calendar = Calendar.getInstance();</div><div class="line"></div><div class="line">calendar.setTime(date);</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">3</span>.Date 转化String</div><div class="line"></div><div class="line">SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line"></div><div class="line">String dateStr=sdf.format(<span class="keyword">new</span> Date());</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">4</span>.String 转化Date</div><div class="line"></div><div class="line">String str=<span class="string">"2012-5-27"</span>;</div><div class="line"></div><div class="line">SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</div><div class="line"></div><div class="line">Date date= sdf.parse(str);</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">5</span>.Date 转化Calendar</div><div class="line"></div><div class="line">Calendar calendar = Calendar.getInstance();</div><div class="line"></div><div class="line">calendar.setTime(<span class="keyword">new</span> java.util.Date());</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">6</span>.Calendar转化Date</div><div class="line"></div><div class="line">Calendar calendar = Calendar.getInstance();</div><div class="line"></div><div class="line">java.util.Date date =calendar.getTime();</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">7</span>.String 转成 Timestamp</div><div class="line"></div><div class="line">Timestamp ts = Timestamp.valueOf(<span class="string">"2012-1-14 08:11:00"</span>);</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line"><span class="number">8</span>.Date 转 TimeStamp</div><div class="line"></div><div class="line">SimpleDateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line"></div><div class="line">String time = df.format(<span class="keyword">new</span> Date());</div><div class="line"></div><div class="line">Timestamp ts = Timestamp.valueOf(time);</div></pre></td></tr></table></figure>
<h1 id="读写json"><a href="#读写json" class="headerlink" title="读写json"></a>读写json</h1><h2 id="常规解析"><a href="#常规解析" class="headerlink" title="常规解析"></a>常规解析</h2><p>对于某个json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"classic_payload"</span>:&#123;<span class="attr">"opxvrsn"</span>:<span class="string">"ut"</span>,<span class="attr">"opxuid"</span>:<span class="string">"0"</span>,<span class="attr">"opxclientid"</span>:<span class="string">"1127"</span>,<span class="attr">"opxcounter"</span>:<span class="string">"1"</span>,<span class="attr">"rnum"</span>:<span class="string">"4208937089424580.5"</span>,<span class="attr">"re"</span>:<span class="string">"http%3A%2F%2Fwww.liba.com%2Findex.shtml"</span>,<span class="attr">"opxpid"</span>:<span class="string">"201705221928320003451270013251741"</span>,<span class="attr">"opxsid"</span>:<span class="string">"2ebfa12ef6fe88985d2c1b04ea8d22df"</span>,<span class="attr">"opxdate"</span>:<span class="string">"2017-05-26-16-40-13"</span>,<span class="attr">"opxip"</span>:<span class="string">"120.92.161.27"</span>,<span class="attr">"opxleadsite"</span>:<span class="string">"http://www.liba.com/index.shtml"</span>,<span class="attr">"opxreferringsite"</span>:<span class="string">"http%3A%2F%2Fshuaxinfuwu.nipponpaint.com.cn%2Findex.aspx%3Futm_medium%3DVM%26utm_source%3DLB"</span>,<span class="attr">"useragent"</span>:<span class="string">"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"</span>,<span class="attr">"language"</span>:<span class="string">"zh-CN,zh;q=0.8,zh-TW;q=0.6,en-US;q=0.4,en;q=0.2"</span>,<span class="attr">"accept"</span>:<span class="string">"*/*"</span>,<span class="attr">"connection"</span>:<span class="string">"close"</span>,<span class="attr">"encoding"</span>:<span class="string">"gzip, deflate"</span>,<span class="attr">"hversion"</span>:<span class="string">"HTTP/1.0"</span>,<span class="attr">"frompaidsearch"</span>:<span class="number">0</span>,<span class="attr">"hascookie"</span>:<span class="number">0</span>,<span class="attr">"opxeventid"</span>:<span class="string">"13057"</span>&#125;,<span class="attr">"machine"</span>:<span class="string">"10.11.10.12"</span>,<span class="attr">"uuid"</span>:<span class="string">"318553958122302938064698429658924956664"</span>&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//取其中某个字段</div><div class="line">JSONObject jsonObj = JSONObject.parseObject(content);</div><div class="line">String uuid = jsonObj.getString(&quot;uuid&quot;);</div><div class="line"></div><div class="line">//如果是数组</div><div class="line">JSONArray array = json.getJSONArray(&quot;result&quot;);  </div><div class="line">List&lt;Keyword&gt; keywords = new ArrayList&lt;&gt;();  </div><div class="line">for (int i = 0; i &lt; array.size(); i++) &#123;  </div><div class="line">    JSONObject jo = array.getJSONObject(i);  </div><div class="line">    assertEquals(topic.getId(), jo.getInteger(&quot;topicId&quot;));  </div><div class="line">    keywords.add(new Keyword(topic, jo.getInteger(&quot;id&quot;), jo.getString(&quot;keyword&quot;), null,  </div><div class="line">            jo.getJSONArray(&quot;spiderTopics&quot;), jo.getString(&quot;updatedAt&quot;), jo.getString(&quot;createdAt&quot;)));  </div><div class="line">&#125;  </div><div class="line"></div><div class="line">//如果是某个类</div></pre></td></tr></table></figure>
<h2 id="解析JSONArray"><a href="#解析JSONArray" class="headerlink" title="解析JSONArray"></a>解析JSONArray</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">List&lt;IP&gt; iplist = <span class="keyword">new</span> ArrayList&lt;IP&gt;();</div><div class="line">iplist.add(<span class="keyword">new</span> IP(<span class="string">"1.4.255.255"</span>));</div><div class="line">iplist.add(<span class="keyword">new</span> IP(<span class="string">"1.0.255.255"</span>));</div><div class="line">iplist.add(<span class="keyword">new</span> IP(<span class="string">"1.2.255.255"</span>));</div><div class="line"></div><div class="line">String ipliststr = JSON.toJSONString(iplist);</div><div class="line"></div><div class="line">List&lt;IP&gt; ipl = <span class="keyword">new</span> ArrayList&lt;IP&gt;(JSONArray.parseArray(ipliststr,IP.class));</div><div class="line"></div><div class="line"><span class="keyword">for</span> (IP ip : ipl) &#123;</div><div class="line">  System.out.println(ip.getIp_address());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解析的类中有嵌套的ArrayList&lt;类&gt;，可以直接解析，但对ArrayList的命名有要求，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private ArrayList&lt;KeywordItem&gt; keywordItems;</div></pre></td></tr></table></figure>
<h2 id="解析为复杂集合"><a href="#解析为复杂集合" class="headerlink" title="解析为复杂集合"></a>解析为复杂集合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">TypeReference&lt;HashMap&lt;String, ArrayList&lt;WebPageInfo&gt;&gt;&gt; ty = new TypeReference&lt;HashMap&lt;String, ArrayList&lt;WebPageInfo&gt;&gt;&gt;()&#123;&#125;;</div><div class="line">	      </div><div class="line">			try &#123;</div><div class="line">				d2wps = JSON.parseObject(info,ty);</div><div class="line">			&#125; catch (Exception e) &#123;</div><div class="line">				continue;</div><div class="line">			&#125;</div></pre></td></tr></table></figure>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h2 id="比较两个double是否相等"><a href="#比较两个double是否相等" class="headerlink" title="比较两个double是否相等"></a>比较两个double是否相等</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">long thisBits    = Double.doubleToLongBits(d1);</div><div class="line">        long anotherBits = Double.doubleToLongBits(d2);</div><div class="line">        return (thisBits == anotherBits ?  0 : // Values are equal</div></pre></td></tr></table></figure>
<h1 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//匹配的是括号中的内容，匹配时，先matcher.find()，然后找group，group（0）是本身。group（1）是第一个括号内容</span></div><div class="line"><span class="comment">//这里匹配的是可能包括&amp;，然后有q=，括号是提取的内容，用懒惰模式。最后要么是结尾，要么是&amp;，</span></div><div class="line">Pattern pattern = Pattern.compile(<span class="string">"&amp;?(q|p|wd|word|query)=(.*?)(&amp;|$)"</span>);</div><div class="line">Matcher matcher = pattern.matcher(url.getQuery());</div><div class="line"><span class="keyword">while</span> (matcher.find()) &#123;</div><div class="line">	System.out.println(matcher.group(<span class="number">1</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="String转char"><a href="#String转char" class="headerlink" title="String转char"></a>String转char</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">char[] chars = word.toCharArray();</div></pre></td></tr></table></figure>
<h1 id="hdfs"><a href="#hdfs" class="headerlink" title="hdfs"></a>hdfs</h1><p>读数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FSDataInputStream dis = null;</div><div class="line">FileSystem fs = FileSystem.get(HDFSHandler.conf);</div><div class="line">dis = fs.open(new Path(modelFile));</div></pre></td></tr></table></figure>
<h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><h2 id="ArrayList拼接成String"><a href="#ArrayList拼接成String" class="headerlink" title="ArrayList拼接成String"></a>ArrayList拼接成String</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ArrayList&lt;String&gt; wordSet = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">StringUtils.join(wordSet, <span class="string">" "</span>);</div></pre></td></tr></table></figure>
<h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><h3 id="一句话初始化"><a href="#一句话初始化" class="headerlink" title="一句话初始化"></a>一句话初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;() &#123;&#123;</div><div class="line">    add(<span class="string">"A"</span>);</div><div class="line">    add(<span class="string">"B"</span>);</div><div class="line">    add(<span class="string">"C"</span>);</div><div class="line">&#125;&#125;</div><div class="line"></div><div class="line">List&lt;String&gt; places = Arrays.asList(<span class="string">"Buenos Aires"</span>, <span class="string">"Córdoba"</span>, <span class="string">"La Plata"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 初始化一个 List，而不是 ArrayList</span></div><div class="line">List&lt;String&gt; list = [<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>];</div><div class="line"></div><div class="line"><span class="comment">// 初始化的更好看些</span></div><div class="line">List&lt;Long&gt; cptIds = Lists.newArrayList();</div></pre></td></tr></table></figure>
<h2 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列"></a>优先级队列</h2><p><a href="http://blog.csdn.net/hiphopmattshi/article/details/7334487" target="_blank" rel="noopener">java中PriorityQueue优先级队列使用方法</a></p>
<p>优先级队列是不同于先进先出队列的另一种队列。每次从队列中取出的是具有最高优先权的元素。如果不提供Comparator的话，优先队列中元素默认按自然顺序排列，也就是数字默认是小的在队列头，字符串则按字典序排列。</p>
<p>如果想实现按照自己的意愿进行优先级排列的队列的话，需要实现Comparator接口。下面的方法，实现了根据某个变量，来进行优先级队列的建立。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Comparator&lt;test&gt; OrderIsdn =  <span class="keyword">new</span> Comparator&lt;test&gt;()&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(test o1, test o2)</span> </span>&#123;  </div><div class="line">        <span class="comment">// TODO Auto-generated method stub  </span></div><div class="line">        <span class="keyword">int</span> numbera = o1.getPopulation();  </div><div class="line">        <span class="keyword">int</span> numberb = o2.getPopulation();  </div><div class="line">        <span class="keyword">if</span>(numberb &gt; numbera)   <span class="keyword">return</span> <span class="number">1</span>;  </div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(numberb&lt;numbera)  <span class="keyword">return</span> -<span class="number">1</span>; </div><div class="line">        <span class="keyword">else</span>  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;  </div><div class="line">&#125;;  </div><div class="line">Queue&lt;test&gt; priorityQueue =  <span class="keyword">new</span> PriorityQueue&lt;test&gt;(<span class="number">11</span>,OrderIsdn);</div></pre></td></tr></table></figure>
<h1 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h1><p>TreeSet中的对象要实现comparable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class KeywordItem implements Comparable&lt;KeywordItem&gt; &#123;</div><div class="line">	public String name;</div><div class="line">	public Double score;</div><div class="line">	</div><div class="line">	public KeywordItem(String name, Double score) &#123;</div><div class="line">		this.name = name;</div><div class="line">		this.score = score;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">    public String toString() &#123;</div><div class="line">        return this.name + &quot;\t&quot; + score;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public int compareTo(KeywordItem o) &#123;</div><div class="line">		if (this.score &lt; o.score) &#123;</div><div class="line">            return 1;</div><div class="line">        &#125; else &#123;</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>插入的时候自动比较</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">TreeSet&lt;KeywordItem&gt; looklikeCodeTree = new TreeSet&lt;KeywordItem&gt;();</div><div class="line">if (entry.getValue() &gt; this.minLookLike) &#123;</div><div class="line">								looklikeCodeTree.add(new KeywordItem(entry.getKey().toString(), entry.getValue()));</div><div class="line">								if (looklikeCodeTree.size() &gt; maxLookLikeTagCnt) &#123;</div><div class="line">									looklikeCodeTree.pollLast();</div><div class="line">								&#125;</div><div class="line">							&#125;</div></pre></td></tr></table></figure>
<h1 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Random random = <span class="keyword">new</span> Random();</div><div class="line"></div><div class="line"><span class="comment">//随机打印一些日志</span></div><div class="line"><span class="keyword">if</span> (random.nextDouble() &lt; <span class="number">0.00001</span> ) &#123;</div><div class="line">	logger.info(JSON.toJSONString(obj));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="二维数组"><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int[][] arr = new int[3][5];</div></pre></td></tr></table></figure>
<h1 id="URLDecoder"><a href="#URLDecoder" class="headerlink" title="URLDecoder"></a>URLDecoder</h1><ul>
<li>Illegal hex characters in escape (%) pattern - For input string: “u0”</li>
</ul>
<ul>
<li>Incomplete trailing escape (%) pattern</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">searchString=URLDecoder.decode(searchString.replaceAll(&quot;%&quot;, &quot;%25&quot;),&quot;utf-8&quot;);</div></pre></td></tr></table></figure>
<h1 id="List对象的去重"><a href="#List对象的去重" class="headerlink" title="List对象的去重"></a>List对象的去重</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">def dedupBy[T](list: List[T])(f: T =&gt; String): List[T] = &#123;</div><div class="line">    val buf = new ListBuffer[T]</div><div class="line">    val set = new HashSet[String]</div><div class="line">    list foreach &#123; e =&gt;</div><div class="line">      val key = f(e)</div><div class="line">      if (!set.contains(key)) &#123;</div><div class="line">        buf += e</div><div class="line">        set += key</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    buf.result</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h1 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h1><h2 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h2><h2 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h2><p>两者的使用参考InterestTimerTask.java</p>
<p><a href="http://www.importnew.com/15731.html" target="_blank" rel="noopener">http://www.importnew.com/15731.html</a></p>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>setnx是「<strong>SET</strong> if <strong>N</strong>ot e<strong>X</strong>ists」的缩写，可以用来实现锁。如果setnx存在，则执行更新，更新后删除这个key。在锁的时候，其他对redis的访问要么等待，要么用过期的缓存</p>
<p>注意要加上锁的过期时间，防止请求意外退出而锁得不到释放。</p>
<h1 id="检测语言"><a href="#检测语言" class="headerlink" title="检测语言"></a>检测语言</h1><p>是否为繁体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String simpleText = TraditionalChineseDictionary.convertToSimplifiedChinese(text);</div><div class="line">if (!simpleText.equals(text)) &#123;</div><div class="line">    			lang =  &quot;zh-hk&quot;;</div><div class="line">			&#125;</div></pre></td></tr></table></figure>
<p>是否为英文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public static boolean isEnglish(String str) &#123;</div><div class="line">		String regEx = &quot;[a-zA-Z]+&quot;;</div><div class="line">		Pattern p = Pattern.compile(regEx);</div><div class="line">		Matcher m = p.matcher(str);</div><div class="line">		if (m.find()) &#123;</div><div class="line">			return true;</div><div class="line">		&#125;</div><div class="line">		return false;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>是否为中文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public static boolean isChinese(String str) &#123;</div><div class="line">		String regEx = &quot;[\\u4e00-\\u9fa5]+&quot;;</div><div class="line">		Pattern p = Pattern.compile(regEx);</div><div class="line">		Matcher m = p.matcher(str);</div><div class="line">		if (m.find()) &#123;</div><div class="line">			return true;</div><div class="line">		&#125;</div><div class="line">		return false;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h1 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1><p>定义一个枚举类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public enum TypeGroup &#123;</div><div class="line">	</div><div class="line">	CN(&quot;cn&quot;), EN(&quot;en&quot;), CN_EN(&quot;cn_en&quot;),BR(&quot;br&quot;),ALL(&quot;all&quot;);</div><div class="line">	private final String type; </div><div class="line">	</div><div class="line">	private TypeGroup(String type) &#123;  </div><div class="line">	     this.type = type;  </div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public String getType() &#123;</div><div class="line">		return type;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="jsoup"><a href="#jsoup" class="headerlink" title="jsoup"></a>jsoup</h1><h2 id="获取url的html"><a href="#获取url的html" class="headerlink" title="获取url的html"></a>获取url的html</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String url = &quot;http://www.jb51.net/softjc/414254.html&quot;;</div><div class="line">String html = Jsoup.connect(url).userAgent(&quot;Mozilla&quot;).get().toString();</div><div class="line">System.out.println(html);</div></pre></td></tr></table></figure>
<h1 id="get请求"><a href="#get请求" class="headerlink" title="get请求"></a>get请求</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">	 * 向指定URL发送GET方法的请求</div><div class="line">	 * </div><div class="line">	 */</div><div class="line">	public static String get(String url) &#123;</div><div class="line">		BufferedReader in = null;</div><div class="line">		try &#123;</div><div class="line">			URL realUrl = new URL(url);</div><div class="line">			// 打开和URL之间的连接</div><div class="line">			URLConnection connection = realUrl.openConnection();</div><div class="line">			// 设置通用的请求属性</div><div class="line">			connection.setRequestProperty(&quot;accept&quot;, &quot;*/*&quot;);</div><div class="line">			connection.setRequestProperty(&quot;connection&quot;, &quot;Keep-Alive&quot;);</div><div class="line">			connection.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;);</div><div class="line">			connection.setConnectTimeout(5000);</div><div class="line">			connection.setReadTimeout(5000);</div><div class="line">			// 建立实际的连接</div><div class="line">			connection.connect();</div><div class="line">			// 定义 BufferedReader输入流来读取URL的响应</div><div class="line">			in = new BufferedReader(new InputStreamReader(connection.getInputStream()));</div><div class="line">			StringBuffer sb = new StringBuffer();</div><div class="line">			String line;</div><div class="line">			while ((line = in.readLine()) != null) &#123;</div><div class="line">				sb.append(line);</div><div class="line">			&#125;</div><div class="line">			return sb.toString();</div><div class="line">		&#125; catch (Exception e) &#123;</div><div class="line">			LOG.error(&quot;Exception occur when send http get request!&quot;, e);</div><div class="line">		&#125;</div><div class="line">		// 使用finally块来关闭输入流</div><div class="line">		finally &#123;</div><div class="line">			try &#123;</div><div class="line">				if (in != null) &#123;</div><div class="line">					in.close();</div><div class="line">				&#125;</div><div class="line">			&#125; catch (Exception e2) &#123;</div><div class="line">				e2.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		return null;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h1 id="list排序"><a href="#list排序" class="headerlink" title="list排序"></a>list排序</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">static List&lt;Integer&gt; intList = Arrays.asList(2, 3, 1);</div><div class="line">Collections.sort(intList);</div></pre></td></tr></table></figure>
<p>结果默认是正序排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1,2,3</div></pre></td></tr></table></figure>
<p>如何实现逆序呢，这就要使用第二种方式了，即通过实现Comparator接口的compare方法来完成自定义排序，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Collections.sort(intList,<span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;</div><div class="line">                <span class="comment">// 返回值为int类型，大于0表示正序，小于0表示逆序</span></div><div class="line">                <span class="keyword">return</span> o2-o1;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<h2 id="随机打乱"><a href="#随机打乱" class="headerlink" title="随机打乱"></a>随机打乱</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Collections.shuffle</div></pre></td></tr></table></figure>
<h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><h2 id="最简单的多线程"><a href="#最简单的多线程" class="headerlink" title="最简单的多线程"></a>最简单的多线程</h2><p>如果要测试多线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">class MyThread extends Thread &#123;</div><div class="line">	public MyThread(String name) &#123;</div><div class="line">		super(name);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void run() &#123;</div><div class="line">		for (int i = 0; i &lt; 20; i++) &#123;</div><div class="line">			System.out.println(Thread.currentThread().getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(1000l);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static void main(String[] args) &#123;</div><div class="line">		MyThread myThread1 = new MyThread(&quot;myThread1&quot;);</div><div class="line">		MyThread myThread2 = new MyThread(&quot;myThread2&quot;);</div><div class="line">		myThread1.start();</div><div class="line">		myThread2.start();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>能看到两个线程交替打印</p>
<h2 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h2><p>保证在高并发的情况下只有一个线程能够访问这个属性值。</p>
<h2 id="AtomicBoolean"><a href="#AtomicBoolean" class="headerlink" title="AtomicBoolean"></a>AtomicBoolean</h2><p>使用 AtomicBoolean 高效并发处理 “只初始化一次” 的功能要求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private static AtomicBoolean initialized = new AtomicBoolean(false);</div><div class="line">public void init()</div><div class="line">&#123;</div><div class="line">   if( initialized.compareAndSet(false, true) )</div><div class="line">   &#123;</div><div class="line">       // 这里放置初始化代码....</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="多线程下的类"><a href="#多线程下的类" class="headerlink" title="多线程下的类"></a>多线程下的类</h2><p><code>/geo-poi/src/main/java/com/iclick/geo/search/GeoPois.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, GeoPois&gt; mRegistry = <span class="keyword">new</span> ConcurrentHashMap&lt;String, GeoPois&gt;();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> GeoPois <span class="title">getInstance</span><span class="params">(String cityname)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mRegistry.get(cityname) == <span class="keyword">null</span>) &#123;</div><div class="line">            mRegistry.put(cityname, <span class="keyword">new</span> GeoPois(cityname));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mRegistry.get(cityname);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h1 id="jar包替换文件"><a href="#jar包替换文件" class="headerlink" title="jar包替换文件"></a>jar包替换文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar -uvf pig-ext-lite-1.0-SNAPSHOT.jar sensitive_words.txt</div></pre></td></tr></table></figure>
<p>这里的sensitive_words.txt会放到jar包的根目录，若存在则会替换</p>
<p>执行java任务</p>
<h1 id="Double判断相等"><a href="#Double判断相等" class="headerlink" title="Double判断相等"></a>Double判断相等</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">if (new java.math.BigDecimal(distance).compareTo(new java.math.BigDecimal(-1.0)) == 0)</div></pre></td></tr></table></figure>
<h1 id="POJO命名规则"><a href="#POJO命名规则" class="headerlink" title="POJO命名规则"></a>POJO命名规则</h1><p><a href="https://www.cnblogs.com/yxnchinahlj/archive/2012/02/24/2366110.html" target="_blank" rel="noopener">https://www.cnblogs.com/yxnchinahlj/archive/2012/02/24/2366110.html</a></p>
<p>POJO是DO/DTO/BO/VO的统称。</p>
<p><strong>POJO：POJO（Plain Ordinary Java Object）简单的Java对象</strong>，实际就是普通JavaBeans，是为了避免和EJB混淆所创造的简称。通指没有使用Entity Beans的普通java对象，可以把POJO作为支持业务逻辑的协助类。</p>
<p>POJO实质上可以理解为简单的实体类，顾名思义POJO类的作用是方便程序员使用数据库中的数据表，对于广大的程序员，可以很方便的将POJO类当做对象来进行使用，当然也是可以方便的调用其get,set方法。POJO类也给我们在struts框架中的配置带来了很大的方便。</p>
<p><em>一个POJO持久化以后就是PO</em></p>
<p><em>直接用它传递、传递过程中就是DTO直接用来对应表示层就是VO</em></p>
<h1 id="java如何计算程序运行时间"><a href="#java如何计算程序运行时间" class="headerlink" title="java如何计算程序运行时间"></a>java如何计算程序运行时间</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">long startTime = System.currentTimeMillis();    //获取开始时间</div><div class="line"></div><div class="line">doSomething();    //测试的代码段</div><div class="line"></div><div class="line">long endTime = System.currentTimeMillis();    //获取结束时间</div><div class="line"></div><div class="line">System.out.println(&quot;程序运行时间：&quot; + (endTime - startTime) + &quot;ms&quot;);    //输出程序运行时间</div></pre></td></tr></table></figure>
<h1 id="用泛型来解析json"><a href="#用泛型来解析json" class="headerlink" title="用泛型来解析json"></a>用泛型来解析json</h1><p><a href="https://www.cnblogs.com/jpfss/p/9928747.html" target="_blank" rel="noopener">https://www.cnblogs.com/jpfss/p/9928747.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public static &lt;T&gt; T parseJson(String json, Class&lt;T&gt; object) &#123;</div><div class="line">        T t = null;</div><div class="line">        try &#123;</div><div class="line">            t = JacksonUtil.getObjectMapper().readValue(json, object);</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        return t;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h1 id="jackson解析json"><a href="#jackson解析json" class="headerlink" title="jackson解析json"></a>jackson解析json</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JacksonUtil</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</div><div class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line">        <span class="comment">//序列化的时候序列对象的所有属性</span></div><div class="line">        objectMapper.setSerializationInclusion(JsonInclude.Include.ALWAYS);</div><div class="line">        <span class="comment">//反序列化的时候如果多了其他属性,不抛出异常</span></div><div class="line">        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">//如果是空对象的时候,不抛异常</span></div><div class="line">        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">return</span> objectMapper;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">parseJson</span><span class="params">(String json, Class&lt;T&gt; object)</span> </span>&#123;</div><div class="line">        T t = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            t = getObjectMapper().readValue(json, object);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> t;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="反射和泛型"><a href="#反射和泛型" class="headerlink" title="反射和泛型"></a>反射和泛型</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 获取方法 scala语法</div><div class="line">gdav.app_code = clazz.getDeclaredMethod(&quot;getAppCode&quot;).invoke(x).asInstanceOf[String]</div><div class="line"></div><div class="line">// java语法</div><div class="line">// getDeclaredMethod，第一个参数是方法名，后面是形参；invoke第一个是类的实例，第二个实参</div><div class="line">ResponseResult ret = (ResponseResult)AnalysisController.class.getDeclaredMethod(methodName, SearchStopAreaVO.class).invoke(analysisController, searchStopAreaVO);</div></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/编程语言学习/JAVA/java出错汇总/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/编程语言学习/JAVA/java出错汇总/" class="post-title-link" itemprop="url">java出错汇总</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-05-25 15:43:50" itemprop="dateModified" datetime="2018-05-25T15:43:50+08:00">2018-05-25</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MD5线程不安全"><a href="#MD5线程不安全" class="headerlink" title="MD5线程不安全"></a>MD5线程不安全</h1><p>MessageDigest线程不安全，多线程下会报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">java.lang.ArrayIndexOutOfBoundsException</div><div class="line"></div><div class="line">	at java.lang.System.arraycopy(Native Method)</div><div class="line"></div><div class="line">	at sun.security.provider.DigestBase.engineUpdate(DigestBase.java:114)</div><div class="line"></div><div class="line">	at java.security.MessageDigest$Delegate.engineUpdate(MessageDigest.java:584)</div><div class="line"></div><div class="line">	at java.security.MessageDigest.update(MessageDigest.java:335)</div><div class="line"></div><div class="line">	at com.buzzinate.common.util.hash.MD5Util.getMD5String(MD5Util.java:98)</div><div class="line"></div><div class="line">	at com.buzzinate.common.util.hash.MD5Util.getMD5String(MD5Util.java:94)</div></pre></td></tr></table></figure>
<p>改用apache的commons-codec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt; </div><div class="line"></div><div class="line">           &lt;groupId&gt;commons-codec&lt;/groupId&gt; </div><div class="line"></div><div class="line">           &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; </div><div class="line"></div><div class="line">           &lt;version&gt;1.10&lt;/version&gt; </div><div class="line"></div><div class="line">       &lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>使用方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public static String encodeMD5Hex(String data)     </div><div class="line"></div><div class="line"> &#123;</div><div class="line"></div><div class="line">          return DigestUtils.md5Hex(data);      </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法是线程安全的</p>
<h1 id="Eclipse闪退"><a href="#Eclipse闪退" class="headerlink" title="Eclipse闪退"></a>Eclipse闪退</h1><p>每次闪退后都提示查看\workspace.metadata.log，发现有如下异常信息记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">!ENTRY org.eclipse.e4.ui.workbench.swt 4 2 2016-08-23 08:42:49.516  </div><div class="line">!MESSAGE Problems occurred when invoking code from plug-in: &quot;org.eclipse.e4.ui.workbench.swt&quot;.  </div><div class="line">!STACK 0  </div><div class="line">java.lang.IllegalArgumentException: Argument cannot be null</div></pre></td></tr></table></figure>
<p>出现该问题的原因是：由于项目没有正常关闭运行而导致”workbench.xmi”中的”persistedState”标签还保持在运行时的配置造成的。</p>
<p>解决办法：</p>
<p>找到<code>&lt;workspace&gt;/.metadata/.plugins/org.eclipse.e4.workbench/workbench.xmi</code>文件，将其删掉，再重启Eclipse，恢复正常。</p>
<h1 id="ConcurrentModificationException"><a href="#ConcurrentModificationException" class="headerlink" title="ConcurrentModificationException"></a>ConcurrentModificationException</h1><p><a href="http://www.cnblogs.com/dolphin0520/p/3933551.html" target="_blank" rel="noopener">http://www.cnblogs.com/dolphin0520/p/3933551.html</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/机器学习/机器学习笔记-最大熵/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/机器学习/机器学习笔记-最大熵/" class="post-title-link" itemprop="url">机器学习笔记-最大熵</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-03-17 20:50:31" itemprop="dateModified" datetime="2018-03-17T20:50:31+08:00">2018-03-17</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/机器学习/" itemprop="url" rel="index"><span itemprop="name">机器学习</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1、最大熵原理"><a href="#1、最大熵原理" class="headerlink" title="1、最大熵原理"></a>1、最大熵原理</h1><p>日常生活中，很多事情的发生表现出一定的随机性，试验的结果往往是不确定的，也不知道这个随机现象所服从的概率分布。<strong>最大熵的实质</strong>就是，在已知部分知识的前提下，关于未知分布最合理的推断就是符合已知知识最不确定或者最随机的推断。任何其他的选择都意味着我们增加了其他的约束和假设。</p>
<p>将最大熵应用到分类，就是最大熵模型。给定一个训练集：</p>
<script type="math/tex; mode=display">
T = \{  (x_1,y_1),  (x_2,y_2),..., (x_N,y_N)\}</script><p>其中$x_i \in X$是输入，$y_i \in Y$是输出，X和Y表示输入和输出空间。N为样本数。<strong>目标是</strong>，利用最大熵原理选出一个最好的分类模型，即对于任意给定的输入$x \in X$，可以以概率$p(y|x)$输出$y \in Y$ 。</p>
<p>按照最大熵原理，应该<strong>优先保证模型满足已知的所有约束</strong>。思路是，从训练数据T中抽取若干有用的特征，要求这些特征在T上关于经验分布$\tilde{p}(x,y)$的数学期望与它们在模型中关于$p(x,y)$的数学期望相等。这样，一个特征就是一个约束了。</p>
<p>这里就涉及到，<strong>特征如何刻画？经验分布如何表示？</strong></p>
<h1 id="2、特征函数"><a href="#2、特征函数" class="headerlink" title="2、特征函数"></a>2、特征函数</h1><p>假设通过特征选择，抽取若干特征。特征通常由特征函数来表示。例如</p>
<script type="math/tex; mode=display">
f(x,y) =\left\{\begin{matrix}
\begin{aligned}
& 1，若x,y满足某个事实 \\ 
& 0，否则
\end{aligned}
\end{matrix}\right.</script><p>这里的特征不是指输入的某个特征，而是指输入和输出共同的特征。</p>
<blockquote>
<p>例如，假设我们需要判断“打”是动词还是量词，已知的训练数据有</p>
<p>(x1,y1)=(一打火柴，量词);</p>
<p>(x2,y2)=(三打啤酒，量词);</p>
<p>(x3,y3)=(打电话，动词);</p>
<p>(x4,y4)=(打篮球，动词);</p>
<p>通过观察，发现“打”前面是数字时，是量词，“打”后面是名词时，是动词。这就是从训练数据中提取的两个特征，可分别用特征函数表示为</p>
</blockquote>
<h1 id="3、经验分布"><a href="#3、经验分布" class="headerlink" title="3、经验分布"></a>3、经验分布</h1><p>经验（概率）分布就是通过对训练集T进行统计得到的分布，用$\tilde p$表示。这里列举两个经验分布</p>
<script type="math/tex; mode=display">
\tilde p(x,y) = \frac {count(x,y)} {N} , \tilde p(x)=\frac {count(x)} {N}</script><p>其中，count表示出现的次数。</p>
<h1 id="4、约束条件"><a href="#4、约束条件" class="headerlink" title="4、约束条件"></a>4、约束条件</h1><p>对于任意一个特征函数f，$E<em>{\tilde p}f$ 表示f在训练数据T上关于$\tilde p(x,y)$的数学期望， $E</em>{p}f$ 表示f在训练数据T上关于$p(x,y)$的数学期望。按照期望的定义，我们有</p>
<script type="math/tex; mode=display">
E_{\tilde p}f=\sum_{x,y}\tilde p(x,y)f(x,y)</script><script type="math/tex; mode=display">
E_{ p}f=\sum_{x,y} p(x,y)f(x,y)</script><p>其中，p(x,y)是未知的，而建模的目标是生成$p(y|x)$，因此，根据Bayes定理，$p(x,y)=p(x)p(y|x)$。在样本数量足够的条件下，$p(x)$可以用$\tilde p(x)$近似表示。这样</p>
<script type="math/tex; mode=display">
E_{ p}f=\sum_{x,y} \tilde p(x)p(y|x)f(x,y)</script><p>对于概率分布$p(y|x)$，我们希望特征f的期望值应该和从训练集中得到的特征期望值是一致的，因此，<strong>增加约束</strong></p>
<script type="math/tex; mode=display">
E_{ p}f=E_{\tilde p}f</script><p>假设我们从训练集中抽取了n个特征，相应的，便有n个特征函数$f_i(i=1,2,…,n)$以及n个约束条件</p>
<script type="math/tex; mode=display">
C_i:E_{ p}(f_i)=E_{\tilde p}(f_i) \tag {3-1}</script><blockquote>
<p>关于约束条件的几何解释</p>
<p><img src="/2017/07/12/机器学习/机器学习笔记-最大熵/最大熵1.png" alt="最大熵1"></p>
<p>（a）：P是所有可能的概率空间，此时没有约束条件，所有的概率模型$p(y|x)$都是允许的；</p>
<p>（b）：增加了一个线性约束条件$C_1$，此时，目标分布$p(y|x)$只能落在由$C_1$定义的线段上；</p>
<p>（c）：在（b）的基础上增加了另一个约束条件$C_2$ ，且$C_1 \cap C_2  \neq \varnothing$。此时，目标分布只能落在交点上，即被唯一确定；</p>
<p>（d）：在（b）基础上增加了另一个约束$C_3$，且$C_1 \cap C_2  = \varnothing$，此时不存在能够同时满足$C_1$和$C_3$的$p(y|x)$。</p>
</blockquote>
<p>利用（3-1）定义的约束条件，我们定义P的一个子空间</p>
<script type="math/tex; mode=display">
C=\{p \in P | E_p(f_i)={\tau}_i, i=1,2,...,n\}</script><h1 id="5、最大熵模型"><a href="#5、最大熵模型" class="headerlink" title="5、最大熵模型"></a>5、最大熵模型</h1><p>由于我们的目标是获得一个条件分布，因此这里也采用相应的条件熵</p>
<script type="math/tex; mode=display">
H(p(y|x))=-\sum_{x,y} \tilde p(x)p(y|x)\log p(y|x)</script><p>可以看出这里也是用$\tilde p(x)$来近似$p(x)$。以下将$H(p(y|x))$简记为$H(p)$。至此，可以给出最大熵模型的完整描述。</p>
<p>对于给定的训练集T，特征函数$f_i(x,y), i=1,2,…n$，最大熵模型就是求解</p>
<script type="math/tex; mode=display">
\underset {p \in C} {max} \ \  H(p) = \begin{pmatrix}
-\sum_{x,y} \tilde p(x)p(y|x)\log p(y|x)
\end{pmatrix}, \\
s.t. \sum_y p(y|x)=1 \tag {5-1} \\
s.t. \ C=\{p \in P | E_p(f_i)={\tau}_i, i=1,2,...,n\}</script><p>其中的s.t.是为了保证$p(y|x)$是一个（合法的）条件概率分布。</p>
<p>等价于一个求极小值问题</p>
<script type="math/tex; mode=display">
\underset {p \in C} {min} \ \  -H(p) = \begin{pmatrix}
\sum_{x,y} \tilde p(x)p(y|x)\log p(y|x)
\end{pmatrix}, \\
s.t. \sum_y p(y|x)=1 \tag {5-2} \\
s.t. \ C=\{p \in P | E_p(f_i)={\tau}_i, i=1,2,...,n\}</script><h1 id="6、模型求解"><a href="#6、模型求解" class="headerlink" title="6、模型求解"></a>6、模型求解</h1><p>对于5-1的求解，主要思路和步骤如下：</p>
<ol>
<li>利用Lagrange乘子将最大熵模型由一个带约束的最优化问题转为无约束的最优化问题，这是一个<strong>极小极大问题（min max）</strong>。</li>
<li>利用对偶问题等价性，转化为求解上一步得到的极大/极小问题的对偶问题，也是一个极大极小问题。</li>
</ol>
<h2 id="6-1-原始问题和对偶问题"><a href="#6-1-原始问题和对偶问题" class="headerlink" title="6.1 原始问题和对偶问题"></a>6.1 原始问题和对偶问题</h2><p>根据（5-2），引入拉格朗日乘子$\lambda=(\lambda_0,\lambda_1,…,\lambda_n)^T$，定义拉格朗日函数</p>
<script type="math/tex; mode=display">
L(p,\lambda) = -H(p) + \lambda_0(1-\sum_y p(y|x))+\sum_{i=1}^n\lambda_i(\tau_i-E_p(f_i))  \tag{6-1}</script><p>利用对偶性，求解（6-1）的<strong>原始问题</strong>表示为：</p>
<script type="math/tex; mode=display">
\underset {p \in C} {min}\  \underset {\lambda} {max}\ L(p,\lambda) \tag{6-2}</script><p><strong>对偶问题</strong>为：</p>
<script type="math/tex; mode=display">
\underset {\lambda} {max}\ \underset {p \in C} {min}\  L(p,\lambda) \tag{6-3}</script><p>由于$H(p)$是关于p的凸函数，因此要求解最大熵模型，只需求解对偶问题（6-3）即可。</p>
<h3 id="6-1-1-指数形式的解"><a href="#6-1-1-指数形式的解" class="headerlink" title="6.1.1 指数形式的解"></a>6.1.1 指数形式的解</h3><p>首先求解内部的极小问题。由于$\underset {p \in C} {min}\  L(p,\lambda)$是关于$\lambda$的函数，将其记做：</p>
<script type="math/tex; mode=display">
\Psi (\lambda) =\underset {p \in C} {min}\  L(p,\lambda) = L(p_{\lambda}, \lambda) \tag {6-4}</script><p>其中</p>
<script type="math/tex; mode=display">
p_{\lambda}=\underset {p \in C} {argmin}\ L(p,\lambda)=p_{\lambda}(y|x) \tag {6-5}</script><p>根据拉格朗日乘子法，求$L(p,\lambda)$对$p(y|x)$的偏导，得（求解过程略）：</p>
<script type="math/tex; mode=display">
p_{\lambda}=\frac {1} {Z_{\lambda}(x)} \ \exp(\sum_{i=1}^n \lambda_i f_i(x,y)) \tag{6-6}</script><p>其中，</p>
<script type="math/tex; mode=display">
Z_{\lambda}(x)=\sum_y \exp(\sum_{i=1}^n \lambda_i f_i(x,y)) \tag{6-7}</script><p>称为<strong>规范化因子</strong>（normalizing factor）。注意，此时已经没有$\lambda_0$了。</p>
<p>由（6-6）定义的$p_{\lambda}$就是最大熵模型的解，它具有<strong>指数形式</strong>。其中，$\lambda_i$就是特征$f_i$的权重，越大表示特征越重要。</p>
<h3 id="6-1-2-最大似然估计"><a href="#6-1-2-最大似然估计" class="headerlink" title="6.1.2 最大似然估计"></a>6.1.2 最大似然估计</h3><p>得到对偶问题的内层极小值问题的解之后，接着求解外层的极大值问题$\underset {\lambda} {max} \ \Psi(\lambda)$。</p>
<p>设其解为</p>
<script type="math/tex; mode=display">
\lambda^* = \underset {\lambda} {argmax} \ \Psi(\lambda) \tag{6-8}</script><p>则最大熵模型的解为</p>
<script type="math/tex; mode=display">
p^*=p_{\lambda^*} \tag{6-9}</script><p>根据推导，最大化$\Psi(\lambda)$与最大似然估计是等价的！</p>
<h1 id="7、最优化方法"><a href="#7、最优化方法" class="headerlink" title="7、最优化方法"></a>7、最优化方法</h1><p>通用的方法有梯度下降，拟牛顿法等，最大熵模型有两个量身定做的方法：通用迭代尺度法（Generalized Iterative Scaling，GIS）和改进的迭代尺度法（Impoved Iterative Scaling，IIS）。</p>
<h2 id="7-1-GIS算法"><a href="#7-1-GIS算法" class="headerlink" title="7.1 GIS算法"></a>7.1 GIS算法</h2><blockquote>
<p>算法1：</p>
<p>S1：初始化参数，令$\lambda=0$</p>
<p>S2：计算$E_{\tilde p}(f_i),\ i=1,2,…,n$</p>
<p>S3：执行一次迭代，对参数做一次刷新。</p>
<p>​    计算$E<em>{p</em>{\lambda}}(f_i)$</p>
<p>​    FOR i=1,2,…,n DO {</p>
<p>​        $\lambda<em>i\  += \ \eta \log\frac {E</em>{\tilde p}(f<em>i)} {E</em>{p_{\lambda}}(f_i)}$</p>
<p>​    }</p>
<p>S4：检查是否收敛，若未收敛则继续S3</p>
</blockquote>
<p>其中，$\eta$是学习率，在实际中取$\frac {1} {C}$，$$，表示训练数据中包含特征最多的那个样本所包含的特征个数。</p>
<script type="math/tex; mode=display">
\Delta\lambda_i=\eta \log\frac {E_{\tilde p}(f_i)} {E_{p_{\lambda}}(f_i)}</script><p>是校正量。</p>
<p>每次迭代，先用当前的权重估算每个特征$f<em>i$在训练数据中的概率分布的期望，然后逐个与相应的经验分布的期望比较，其偏差程度通过$\log\frac {E</em>{\tilde p}(f<em>i)} {E</em>{p_{\lambda}}(f_i)}$来进行刻画。</p>
<p>收敛条件就是当两次迭代的$\lambda$在一个较小的范围。</p>
<p>GIS每次迭代时间很长，不太稳定，容易溢出，一般不会使用。</p>
<h2 id="7-2-IIS算法"><a href="#7-2-IIS算法" class="headerlink" title="7.2 IIS算法"></a>7.2 IIS算法</h2><p>与GIS的不同主要在$\Delta\lambda_i$的计算上。IIS通过求解方程</p>
<script type="math/tex; mode=display">
\sum_{x,y} \tilde p(x)p(y|x)f_i(x,y)\exp(\Delta\lambda_i\sum_{i=1}^nf_i(x,y))=\tilde p(f_i)</script><p>1）若$\sum<em>{i=1}^nf_i(x,y)$为常数，即对任意样本(x,y)，都有$\sum</em>{i=1}^nf_i(x,y)=C$，则</p>
<script type="math/tex; mode=display">
\Delta\lambda_i=\frac {1} {C} \log\frac {E_{\tilde p}(f_i)} {E_{p_{\lambda}}(f_i)}</script><p>此时，IIS可以看做是GIS的一种推广。</p>
<p>2）若$\sum_{i=1}^nf_i(x,y)$不是常数，则需要通过数值方式来求解$\Delta\lambda_i$，如牛顿法。</p>
<h1 id="8、优缺点"><a href="#8、优缺点" class="headerlink" title="8、优缺点"></a>8、优缺点</h1><p>优点是：在建模时，只需要集中精力选取特征，不需要花费精力考虑如何使用这些特征，可以灵活使用不同类型的特征。</p>
<p>缺点是计算量大。</p>
<p>参考</p>
<p>【1】 <a href="http://blog.csdn.net/itplus/article/details/26550273" target="_blank" rel="noopener">最大熵学习笔记</a></p>
<p>【2】统计学习方法</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/机器学习和深度学习算法理论/CNN/CNN/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/机器学习和深度学习算法理论/CNN/CNN/" class="post-title-link" itemprop="url">CNN</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 09:28:37" itemprop="dateModified" datetime="2019-06-16T09:28:37+08:00">2019-06-16</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/深度学习/" itemprop="url" rel="index"><span itemprop="name">深度学习</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="卷积核"><a href="#卷积核" class="headerlink" title="卷积核"></a>卷积核</h1><p>也称为滤波器。</p>
<p>权重共享：卷积核的权重（矩阵的值）对于不同位置的所有输入都是相同的。</p>
<h2 id="卷积操作的意义"><a href="#卷积操作的意义" class="headerlink" title="卷积操作的意义"></a>卷积操作的意义</h2><p>例如，有整体边缘滤波器Ke，横向边缘滤波器Kh，纵向边缘滤波器Kv。</p>
<script type="math/tex; mode=display">
K_e=\begin{bmatrix}
0 & -4 & 0\\ 
-4 & 16 & -4\\ 
0 & -4 & 0
\end{bmatrix}\ \ K_h=\begin{bmatrix}
1 & 2 & 1\\ 
0 & 0 & 0\\ 
-1 & -2 & -1
\end{bmatrix}\ \ K_v=\begin{bmatrix}
1 & 0 & -1\\ 
2 & 0 & -2\\ 
1 & 0 & -1
\end{bmatrix}</script><p>若某像素位于物体边缘，则周边像素与该像素会有明显差异，用Ke可以放大边缘和周边的差异，起到边缘检测的作用。同理，Kh、Kv可以保留横向、纵向的边缘信息。</p>
<h1 id="池化层"><a href="#池化层" class="headerlink" title="池化层"></a>池化层</h1><p>也叫汇合层。通常操作有平均值池化（average-pooling）和最大值汇合（max-pooling）。与卷积核操作不同，池化层不包含需要学习的参数。仅指定汇合类型，核大小（kernel size）和步长（stride）。</p>
<p>汇合的结果相对输入降小了，是一种降采样（down-sampling）操作。也可以看成是一个用p范数（p-norm）作为非线性映射的卷积操作。当p趋于正无穷时就是最大值汇合。</p>
<p>汇合层的引入是仿照人的视觉系统对视觉输入对象进行降维和抽象。作用有：</p>
<p>1）特征不变性（feature invariant）。使模型更关注是否存在某些特征而不是特征具体的位置。</p>
<p>2）特征降维。</p>
<p>3）一定程度上防止过拟合。</p>
<h1 id="全连接层"><a href="#全连接层" class="headerlink" title="全连接层"></a>全连接层</h1><p>fully connected layers</p>
<p>参考：</p>
<p>【1】解析卷积神经网络.pdf</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/hadoop-spark/hive笔记/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/hadoop-spark/hive笔记/" class="post-title-link" itemprop="url">hive笔记</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-19 13:06:22" itemprop="dateModified" datetime="2019-06-19T13:06:22+08:00">2019-06-19</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/hadoop-spark/" itemprop="url" rel="index"><span itemprop="name">hadoop-spark</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="插入hive表控制part文件数量"><a href="#插入hive表控制part文件数量" class="headerlink" title="插入hive表控制part文件数量"></a>插入hive表控制part文件数量</h1><p><a href="http://blog.sina.com.cn/s/blog_604c7cdd0102wbsw.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_604c7cdd0102wbsw.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-- 每个文件上限500M</div><div class="line">set hive.exec.reducers.bytes.per.reducer=512000000;</div><div class="line">insert overwrite table carthage.gps_address_info_weekly_bak PARTITION(DATA_DATE=&apos;2019-01-15&apos;)</div><div class="line">select * from carthage.gps_address_info DISTRIBUTE by RAND();</div><div class="line">-- DISTRIBUTE by RAND()主要靠这个控制reduce的文件数</div></pre></td></tr></table></figure>
<h1 id="strict模式"><a href="#strict模式" class="headerlink" title="strict模式"></a>strict模式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set hive.mapred.mode=strict</div></pre></td></tr></table></figure>
<p>有助于前置解决一些语法和可能的逻辑错误。</p>
<h1 id="限制小文件数量"><a href="#限制小文件数量" class="headerlink" title="限制小文件数量"></a>限制小文件数量</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set mapred.max.split.size=256000000;        -- 决定每个map处理的最大的文件大小，单位为B</div><div class="line">set mapred.min.split.size.per.node=10000000;         -- 节点中可以处理的最小的文件大小</div><div class="line">set mapred.min.split.size.per.rack=10000000;          -- 机架中可以处理的最小的文件大小</div></pre></td></tr></table></figure>
<h1 id="查询时如何去掉重复数据"><a href="#查询时如何去掉重复数据" class="headerlink" title="查询时如何去掉重复数据"></a>查询时如何去掉重复数据</h1><p>假设数据为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">name  adx        tran_id                  cost        ts</div><div class="line">ck        5         125.168.10.0           33.00   1407234660</div><div class="line">ck        5         187.18.99.00           33.32   1407234661</div><div class="line">ck        5         125.168.10.0           33.24   1407234661</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from (select *,row_number() over (partition by tran_id order by timestamp asc) num from table) t where t.num=1;</div></pre></td></tr></table></figure>
<blockquote>
<p>附上：<br><strong>ROW_NUMBER() OVER函数的基本用法 </strong></p>
<p>语法：ROW_NUMBER() OVER(PARTITION BY COLUMN ORDER BY COLUMN) </p>
<p>简单的说row_number()从1开始，为每一条分组记录返回一个数字，这里的ROW_NUMBER() OVER (ORDER BY xlh DESC) 是先把xlh列降序，再为降序以后的没条xlh记录返回一个序号。<br>示例： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; xlh           row_num </div><div class="line">&gt; 1700              1 </div><div class="line">&gt; 1500              2 </div><div class="line">&gt; 1085              3 </div><div class="line">&gt; 710                4 </div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>row_number() OVER (PARTITION BY COL1 ORDER BY COL2) 表示根据COL1分组，在分组内部根据 COL2排序，而此函数计算的值就表示每组内部排序后的顺序编号（组内连续的唯一的) </p>
</blockquote>
<h1 id="split后的数组长度"><a href="#split后的数组长度" class="headerlink" title="split后的数组长度"></a>split后的数组长度</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">size(split(driving_districts,&apos;;&apos;))</div></pre></td></tr></table></figure>
<h1 id="切换队列"><a href="#切换队列" class="headerlink" title="切换队列"></a>切换队列</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set mapred.job.queue.name=data;</div></pre></td></tr></table></figure>
<p>sqoop切换队列是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-D mapred.job.queue.name=data</div></pre></td></tr></table></figure>
<h1 id="加载hdfs的udf"><a href="#加载hdfs的udf" class="headerlink" title="加载hdfs的udf"></a>加载hdfs的udf</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ADD JAR hdfs://iclick/zyz/udf/zyz_udf2.jar;</div><div class="line">CREATE TEMPORARY FUNCTION get_region as &apos;org.apache.hadoop.hive.ql.udf.Ip2GeoCodeUDF&apos;;</div></pre></td></tr></table></figure>
<h1 id="Hive-Trash"><a href="#Hive-Trash" class="headerlink" title="Hive Trash"></a>Hive Trash</h1><p>hive删除表时，会移除表的元数据和数据，而HDFS上的数据，如果配置了Trash，会移到.Trash/Current目录下。删除外部表时，表中的数据不会被删除。</p>
<h1 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h1><p>用groupby代替distinct，少用orderby</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">同事写了个hive的sql语句，执行效率特别慢，跑了一个多小时程序只是map完了，reduce进行到20%。</div><div class="line">该Hive语句如下：</div><div class="line">select count(distinct ip) </div><div class="line">from (select ip as ip from comprehensive.f_client_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot;  </div><div class="line">union all </div><div class="line">select pub_ip as ip from f_app_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot; </div><div class="line">union all select ip as ip from format_log.format_pv1 where year=&quot;2013&quot; and month=&quot;10&quot; and url_first_id=1 </div><div class="line">) d </div><div class="line"></div><div class="line">       分析：select ip as ip from comprehensive.f_client_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot;这个语句筛选出来的数据约有10亿条，select pub_ip as ip from f_app_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot;约有10亿条条，select ip as ip from format_log.format_pv1 where year=&quot;2013&quot; and month=&quot;10&quot; and url_first_id=1 筛选出来的数据约有10亿条，总的数据量大约30亿条。这么大的数据量，使用disticnt函数，所有的数据只会shuffle到一个reducer上，导致reducer数据倾斜严重。</div><div class="line">       解决办法：</div><div class="line">       首先，通过使用groupby，按照ip进行分组。改写后的sql语句如下：</div><div class="line">select count(*) </div><div class="line">from </div><div class="line">(select ip </div><div class="line">from</div><div class="line">(select ip as ip from comprehensive.f_client_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot; </div><div class="line">union all </div><div class="line">select pub_ip as ip from f_app_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot; </div><div class="line">union all select ip as ip from format_log.format_pv1 where year=&quot;2013&quot; and month=&quot;10&quot; and url_first_id=1</div><div class="line">) d </div><div class="line">group by ip ) b </div><div class="line">       然后，合理的设置reducer数量，将数据分散到多台机器上。set mapred.reduce.tasks=50; </div><div class="line">       经过优化后，速度提高非常明显。整个作业跑完大约只需要20多分钟的时间。</div></pre></td></tr></table></figure>
<p>提高order by的性能<a href="https://blog.csdn.net/djd1234567/article/details/51917603" target="_blank" rel="noopener">https://blog.csdn.net/djd1234567/article/details/51917603</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">Hive中的order by跟传统的sql语言中的order by作用是一样的，会对查询的结果做一次全局排序，所以说，只有hive的sql中制定了order by所有的数据都会到同一个reducer进行处理（不管有多少map，也不管文件有多少的block只会启动一个reducer）。但是对于大量数据这 将会消耗很长的时间去执行。</div><div class="line"></div><div class="line">    这里跟传统的sql还有一点区别：如果指定了hive.mapred.mode=strict（默认值是nonstrict）,这时就必须指定limit 来限制输出条数，原因是：所有的数据都会在同一个reducer端进行，数据量大的情况下可能不能出结果，那么在这样的严格模式下，必须指定输出的条数。</div><div class="line"></div><div class="line">    所以数据量大的时候能不用order by就不用，可以使用sort by结合distribute by来进行实现。sort by是局部排序，而distribute by是控制map怎么划分reducer。</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    Hive中指定了sort by，那么在每个reducer端都会做排序，也就是说保证了局部有序（每个reducer出来的数据是有序的，但是不能保证所有的数据是有序的，除非只有一个reducer），好处是：执行了局部排序之后可以为接下去的全局排序提高不少的效率（其实就是做一次归并排序就可以做到全局排序了）</div><div class="line"></div><div class="line"></div><div class="line">    ditribute by是控制map的输出在reducer是如何划分的，举个例子，我们有一张表，mid是指这个store所属的商户，money是这个商户的盈利，name是这个store的名字</div><div class="line"></div><div class="line">store:</div><div class="line"></div><div class="line"></div><div class="line">mid	money	name</div><div class="line">AA	15.0	商店1</div><div class="line">AA	20.0	商店2</div><div class="line">BB	22.0	商店3</div><div class="line">CC	44.0	商店4</div><div class="line">    执行hive语句：</div><div class="line"></div><div class="line">[sql] view plain copy</div><div class="line">select mid, money, name from store distribute by mid sort by mid asc, money asc  </div><div class="line">我 们所有的mid相同的数据会被送到同一个reducer去处理，这就是因为指定了distribute by mid，这样的话就可以统计出每个商户中各个商店盈利的排序了（这个肯定是全局有序的，因为相同的商户会放到同一个reducer去处理）。这里需要注意 的是distribute by必须要写在sort by之前。</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">cluster by</div><div class="line">    cluster by的功能就是distribute by和sort by相结合，如下2个语句是等价的：</div><div class="line"></div><div class="line">[sql] view plain copy</div><div class="line">select mid, money, name from store cluster by mid  </div><div class="line">select mid, money, name from store distribute by mid sort by mid  </div><div class="line">    如果需要获得与上面的中语句一样的效果：</div><div class="line"></div><div class="line">[sql] view plain copy</div><div class="line">select mid, money, name from store cluster by mid sort by money  </div><div class="line">    注意被cluster by指定的列只能是降序，不能指定asc和desc。</div></pre></td></tr></table></figure>
<h1 id="问题集"><a href="#问题集" class="headerlink" title="问题集"></a>问题集</h1><h2 id="查询ES表报错"><a href="#查询ES表报错" class="headerlink" title="查询ES表报错"></a>查询ES表报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed with exception java.io.IOException:org.elasticsearch.hadoop.rest.EsHadoopInvalidRequest: The number of slices [1126] is too large. It must be less than [1024]. This limit can be set by changing the [index.max_slices_per_scroll] index level settin</div></pre></td></tr></table></figure>
<p>修改es的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PUT /megacorp/_settings</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">  &quot;index&quot;: &#123;</div><div class="line"></div><div class="line">    &quot;max_slices_per_scroll&quot; : 1126</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="上传hive-UDF包后重启hive-server报错"><a href="#上传hive-UDF包后重启hive-server报错" class="headerlink" title="上传hive UDF包后重启hive server报错"></a>上传hive UDF包后重启hive server报错</h2><h2 id="hive-udf没有权限执行"><a href="#hive-udf没有权限执行" class="headerlink" title="hive udf没有权限执行"></a>hive udf没有权限执行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error while compiling statement: FAILED: SemanticException No valid privileges User dmp does not have privileges for CREATEFUNCTION The required privileges: Server=server1-&gt;URI=file:///home/hive/aux_libs/carthage-common-udf-hive-test.jar-&gt;action=*;</div></pre></td></tr></table></figure>
<h2 id="没有找到jar包的报错"><a href="#没有找到jar包的报错" class="headerlink" title="没有找到jar包的报错"></a>没有找到jar包的报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error while compiling statement: FAILED: SemanticException [Error 10014]: Line 1:7 Wrong arguments &apos;70.0&apos;: org.apache.hadoop.hive.ql.metadata.HiveException: Unable to execute method public java.lang.String com.mljr.carthage.common.geo.udf.hive.UDFGeoLocation.evaluate(java.lang.Double,java.lang.Double) on object com.mljr.carthage.common.geo.udf.hive.UDFGeoLocation@54ee9573 of class com.mljr.carthage.common.geo.udf.hive.UDFGeoLocation with arguments &#123;50.0:java.lang.Double, 70.0:java.lang.Double&#125; of size 2</div></pre></td></tr></table></figure>
<p>其他都是可以的，就这个udf的第二个参数一直报错。经测试，还是UDF本身的问题，跟参数的设置没有关系。</p>
<p>最后发现问题是udf的jar包上传后，关联的一些jar包没有打进去，手动加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;plugin&gt;</div><div class="line">				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div class="line">				&lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</div><div class="line">				&lt;version&gt;1.6&lt;/version&gt;</div><div class="line">				&lt;executions&gt;</div><div class="line">					&lt;execution&gt;</div><div class="line">						&lt;phase&gt;package&lt;/phase&gt;</div><div class="line">						&lt;goals&gt;</div><div class="line">							&lt;goal&gt;shade&lt;/goal&gt;</div><div class="line">						&lt;/goals&gt;</div><div class="line">						&lt;configuration&gt;</div><div class="line">							&lt;artifactSet&gt;</div><div class="line">								&lt;includes&gt;</div><div class="line">									&lt;include&gt;com.mljr.carthage:carthage-common-geo&lt;/include&gt;</div><div class="line">									&lt;include&gt;com.alibaba:fastjson&lt;/include&gt;</div><div class="line">									&lt;include&gt;com.github.davidmoten:geo&lt;/include&gt;</div><div class="line">									&lt;include&gt;com.github.davidmoten:grumpy-core&lt;/include&gt;</div><div class="line">								&lt;/includes&gt;</div><div class="line">							&lt;/artifactSet&gt;</div><div class="line">						&lt;/configuration&gt;</div><div class="line">					&lt;/execution&gt;</div><div class="line">				&lt;/executions&gt;</div><div class="line">			&lt;/plugin&gt;</div></pre></td></tr></table></figure>
<h1 id="hive用高版本的UDF"><a href="#hive用高版本的UDF" class="headerlink" title="hive用高版本的UDF"></a>hive用高版本的UDF</h1><p>在hive2.0中有类似于months_between的函数，可以实现2个时间之间的月份差。但是低版本没有这个函数</p>
<p>解决：</p>
<p>下载hive-2.1源码包</p>
<p><a href="http://mirrors.hust.edu.cn/apache/hive/hive-2.2.0/" target="_blank" rel="noopener">http://mirrors.hust.edu.cn/apache/hive/hive-2.2.0/</a></p>
<p>导入eclipse，查找months_between</p>
<p>在org.apache.hadoop.hive.ql.udf.generic包下找到GenericUDFMonthsBetween类，移植即可</p>
<p>/ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDFMonthsBetween.java</p>
<h1 id="String转date"><a href="#String转date" class="headerlink" title="String转date"></a>String转date</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select cast(to_date(from_unixtime(unix_timestamp(&apos;12-05-2010&apos;, &apos;dd-MM-yyyy&apos;))) as date)</div></pre></td></tr></table></figure>
<h1 id="MapJoin异常问题处理总结"><a href="#MapJoin异常问题处理总结" class="headerlink" title="MapJoin异常问题处理总结"></a>MapJoin异常问题处理总结</h1><p><a href="https://yq.aliyun.com/articles/64306" target="_blank" rel="noopener">https://yq.aliyun.com/articles/64306</a></p>
<h1 id="替换hive分隔符"><a href="#替换hive分隔符" class="headerlink" title="替换hive分隔符"></a>替换hive分隔符</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i &apos;.bak&apos; &apos;s/^A/,/g&apos; baseinfo05.csv</div></pre></td></tr></table></figure>
<p><code>^A</code>要用ctrl+V+A打出来</p>
<h1 id="LOAD-DATA"><a href="#LOAD-DATA" class="headerlink" title="LOAD DATA"></a>LOAD DATA</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LOAD DATA [LOCAL] INPATH &apos;filepath&apos; [OVERWRITE] INTO TABLE tablename[PARTITION (partcol1=val1,partcol2=val2,…)]</div></pre></td></tr></table></figure>
<p>最好不要用LOCAL，要从hadoop加载数据。local读的是hive服务器的本地路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># coding:utf-8</div><div class="line">from pyhive import hive</div><div class="line">from TCLIService.ttypes import TOperationState</div><div class="line"></div><div class="line"># 打开hive连接</div><div class="line">hiveConn = hive.connect(host=&apos;192.168.83.135&apos;,port=11111,username=&apos;hadoop&apos;)</div><div class="line">cursor = hiveConn.cursor()</div><div class="line"></div><div class="line"># 执行sql语句</div><div class="line">sql = &apos;&apos;&apos; LOAD DATA LOCAL INPATH &apos;/home/hadoop/HivePy/employee.txt&apos; OVERWRITE INTO TABLE userdbbypy.employee &apos;&apos;&apos;</div><div class="line">cursor.execute(sql, async=True)</div><div class="line"></div><div class="line"># 得到执行语句的状态</div><div class="line">status = cursor.poll().operationState</div><div class="line">print &quot;status:&quot;,status</div><div class="line"></div><div class="line"># 关闭hive连接</div><div class="line">cursor.close()</div><div class="line">hiveConn.close()</div></pre></td></tr></table></figure>
<h1 id="return-code-3"><a href="#return-code-3" class="headerlink" title="return code 3"></a>return code 3</h1><p>试试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set hive.vectorized.execution.enabled=false;</div></pre></td></tr></table></figure>
<h1 id="hive锁表"><a href="#hive锁表" class="headerlink" title="hive锁表"></a>hive锁表</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Completed compiling command</div></pre></td></tr></table></figure>
<p>若卡在上面的语句，说明锁表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">show locks carthage_dev.baseinfo_personal_info;</div><div class="line">-- 如果是</div><div class="line"></div><div class="line">unlock table dwh_dml_risk_dev.rec_car_operation;</div><div class="line">show locks carthage_dev.baseinfo_personal_info partition(data_date=&apos;20180517&apos;);</div><div class="line">unlock table dwh_dml_risk_dev.rec_car_operation partition(data_date=&apos;2018-09-30&apos;);</div></pre></td></tr></table></figure>
<p>hive解锁的脚本是<code>all_hive_unlock.sh</code></p>
<h1 id="hive新增列报错"><a href="#hive新增列报错" class="headerlink" title="hive新增列报错"></a>hive新增列报错</h1><p>在添加字段是可以通过CASCADE关键字来，避免出现这种问题。如alter table table_name add columns(age int) CASCADE</p>
<p><a href="https://qubole.zendesk.com/hc/en-us/articles/115002396646-Hive-Null-Pointer-Exception-in-select-query-after-modifying-table-definition" target="_blank" rel="noopener">https://qubole.zendesk.com/hc/en-us/articles/115002396646-Hive-Null-Pointer-Exception-in-select-query-after-modifying-table-definition</a></p>
<blockquote>
<p>This can happen in the scenario where table definition and specific partition definition is different, and the underlying data matches table definition but not partition definition.</p>
<p>When a table with partitions is altered to add a column using statement:</p>
<p><em>ALTER TABLE <tablename> ADD COLUMNS (c1 int);</tablename></em></p>
<p>The table definition for existing partitions don’t get modified as per the above statement. As a result of this there is a mismatch between partition and table definition. </p>
<p>This is ok if the partition data matches the definition of partition, but if the data matches definition of table itself, NPE is thrown as there is a mismatch in data vs definition.</p>
<p>To avoid this issue, this statement should be used in hadoop2</p>
<p><em>ALTER TABLE <tablename> ADD COLUMNS (c1 int) CASCADE;</tablename></em> </p>
<p>In case of hadoop1, CASCADE option is not available. Hence, as long as the table is external table, following can be done:</p>
<ol>
<li>Drop and recreate partitions for this table</li>
<li>Alter partition definition for specific partition having issues</li>
</ol>
</blockquote>
<p>用了cascade 无效。</p>
<p>找到原因：</p>
<p>hive表是ORC格式的，因此cascade无效，若改成text格式则成功。</p>
<p>解决方案：</p>
<p>若必须是ORC格式，建表是先预留若干字段，后期改名字</p>
<h1 id="hive分区解锁"><a href="#hive分区解锁" class="headerlink" title="hive分区解锁"></a>hive分区解锁</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">show locks carthage_dev.baseinfo_personal_info;</div><div class="line">unlock table carthage_dev.baseinfo_personal_info;</div><div class="line">show locks carthage_dev.baseinfo_personal_info partition(data_date=&apos;20180517&apos;);</div><div class="line">unlock table carthage_dev.baseinfo_personal_info partition(data_date=&apos;20180517&apos;);</div></pre></td></tr></table></figure>
<p>解锁的技巧：</p>
<p>1、定位哪张表锁住，可以分批执行sql，定位关键表</p>
<p>2、show locks并下载，观察锁表的状态，通过</p>
<p><code>show locks table extends</code>可以看依赖的表</p>
<p>3、用脚本all_hive_unlock.sh解锁</p>
<h2 id="hive-column-rename"><a href="#hive-column-rename" class="headerlink" title="hive column rename"></a>hive column rename</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alter table carthage_dev.gps_wx_stop_status CHANGE stop_region_center_lon stop_status_center_lon string</div></pre></td></tr></table></figure>
<h1 id="hive配置"><a href="#hive配置" class="headerlink" title="hive配置"></a>hive配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-- 输出为gzip</div><div class="line">set hive.exec.compress.output=true;    </div><div class="line">set mapred.output.compression.codec=org.apache.hadoop.io.compress.GzipCodec;</div><div class="line">-- 输出为一个文件</div><div class="line">set mapred.reduce.tasks=1;</div></pre></td></tr></table></figure>
<h1 id="hive-timestamp转时间"><a href="#hive-timestamp转时间" class="headerlink" title="hive timestamp转时间"></a>hive timestamp转时间</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">from_unixtime(unix_timestamp(),‘yyyy/MM/dd HH:mm:ss’);</div><div class="line"></div><div class="line">from_unixtime(cast(cast(time as bigint)/1000 as bigint),&apos;yyyy/MM/dd HH:mm:ss&apos;)</div></pre></td></tr></table></figure>
<h1 id="常用日期函数"><a href="#常用日期函数" class="headerlink" title="常用日期函数"></a>常用日期函数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">to_date：日期时间转日期函数    </div><div class="line">	select to_date(&apos;2018-04-02 13:34:12&apos;);   输出：2018-04-02   </div><div class="line">from_unixtime：转化unix时间戳到当前时区的时间格式    </div><div class="line">	select from_unixtime(1524573762,&apos;yyyy-MM-dd HH:mm:ss&apos;);    输出：2018-04-24 20:42:42</div><div class="line">unix_timestamp：获取当前unix时间戳    </div><div class="line">	select unix_timestamp();    输出：1524573762  </div><div class="line">	select unix_timestamp(&apos;2018-04-01 13:01:20&apos;);  输出：1522558880</div><div class="line">datediff：返回开始日期减去结束日期的天数    </div><div class="line">	select datediff(&apos;2018-04-09&apos;,&apos;2018-04-01&apos;);    输出：8    </div><div class="line">date_sub：返回日期前n天的日期    </div><div class="line">	select date_sub(&apos;2018-04-09&apos;,4);    输出：2018-04-05    </div><div class="line">date_add：返回日期后n天的日期    </div><div class="line">	select date_add(&apos;2018-04-09&apos;,4);    输出：2018-04-13  </div><div class="line">add_months：月份增加函数</div><div class="line">	select add_months(&apos;2018-02-10&apos;, 2 );    输出：2018-04-10 </div><div class="line">last_day：返回当月底日期</div><div class="line">	select last_day(&apos;2018-02-21&apos;);    输出：2018-02-28</div></pre></td></tr></table></figure>
<h1 id="hive-字符串函数"><a href="#hive-字符串函数" class="headerlink" title="hive 字符串函数"></a>hive 字符串函数</h1><p><strong>1. 字符串长度函数：length</strong></p>
<p>语法: length(string A)</p>
<p>返回值: int</p>
<p>说明：返回字符串A的长度</p>
<p>举例：</p>
<p>hive&gt; select length(‘abcedfg’) from lxw_dual;</p>
<p>7</p>
<p><strong>2. 字符串反转函数：reverse</strong></p>
<p>语法: reverse(string A)</p>
<p>返回值: string</p>
<p>说明：返回字符串A的反转结果</p>
<p>举例：</p>
<p>hive&gt; select reverse(abcedfg’) from lxw_dual;</p>
<p>gfdecba</p>
<p><strong>3. 字符串连接函数：concat</strong></p>
<p>语法: concat(string A, string B…)</p>
<p>返回值: string</p>
<p>说明：返回输入字符串连接后的结果，支持任意个输入字符串</p>
<p>举例：</p>
<p>hive&gt; select concat(‘abc’,’def’,’gh’) from lxw_dual;</p>
<p>abcdefgh</p>
<p><strong>4. 带分隔符字符串连接函数：concat_ws</strong></p>
<p>语法: concat_ws(string SEP, string A, string B…)</p>
<p>返回值: string</p>
<p>说明：返回输入字符串连接后的结果，SEP表示各个字符串间的分隔符</p>
<p>举例：</p>
<p>hive&gt; select concat_ws(‘,’,’abc’,’def’,’gh’) from lxw_dual;</p>
<p>abc,def,gh</p>
<p><strong>5. 字符串截取函数：substr,substring</strong></p>
<p>语法: substr(string A, int start),substring(string A, int start)</p>
<p>返回值: string</p>
<p>说明：返回字符串A从start位置到结尾的字符串</p>
<p>举例：</p>
<p>hive&gt; select substr(‘abcde’,3) from lxw_dual;</p>
<p>cde</p>
<p>hive&gt; select substring(‘abcde’,3) from lxw_dual;</p>
<p>cde</p>
<p>hive&gt;  selectsubstr(‘abcde’,-1) from lxw_dual;  （和ORACLE相同）</p>
<p>e</p>
<p><strong>6. 字符串截取函数：substr,substring</strong></p>
<p>语法: substr(string A, int start, int len),substring(string A, intstart, int len)</p>
<p>返回值: string</p>
<p>说明：返回字符串A从start位置开始，长度为len的字符串</p>
<p>举例：</p>
<p>hive&gt; select substr(‘abcde’,3,2) from lxw_dual;</p>
<p>cd</p>
<p>hive&gt; select substring(‘abcde’,3,2) from lxw_dual;</p>
<p>cd</p>
<p>hive&gt;select substring(‘abcde’,-2,2) from lxw_dual;</p>
<p>de</p>
<p><strong>7. 字符串转大写函数：upper,ucase</strong></p>
<p>语法: upper(string A) ucase(string A)</p>
<p>返回值: string</p>
<p>说明：返回字符串A的大写格式</p>
<p>举例：</p>
<p>hive&gt; select upper(‘abSEd’) from lxw_dual;</p>
<p>ABSED</p>
<p>hive&gt; select ucase(‘abSEd’) from lxw_dual;</p>
<p>ABSED</p>
<p><strong>8. 字符串转小写函数：lower,lcase</strong></p>
<p>语法: lower(string A) lcase(string A)</p>
<p>返回值: string</p>
<p>说明：返回字符串A的小写格式</p>
<p>举例：</p>
<p>hive&gt; select lower(‘abSEd’) from lxw_dual;</p>
<p>absed</p>
<p>hive&gt; select lcase(‘abSEd’) from lxw_dual;</p>
<p>absed</p>
<p><strong>9. 去空格函数：trim</strong></p>
<p>语法: trim(string A)</p>
<p>返回值: string</p>
<p>说明：去除字符串两边的空格</p>
<p>举例：</p>
<p>hive&gt; select trim(‘ abc ‘) from lxw_dual;</p>
<p>abc</p>
<p><strong>10. 左边去空格函数：ltrim</strong></p>
<p>语法: ltrim(string A)</p>
<p>返回值: string</p>
<p>说明：去除字符串左边的空格</p>
<p>举例：</p>
<p>hive&gt; select ltrim(‘ abc ‘) from lxw_dual;</p>
<p>abc</p>
<p><strong>11. 右边去空格函数：rtrim</strong></p>
<p>语法: rtrim(string A)</p>
<p>返回值: string</p>
<p>说明：去除字符串右边的空格</p>
<p>举例：</p>
<p>hive&gt; select rtrim(‘ abc ‘) from lxw_dual;</p>
<p>abc</p>
<p><strong>12. 正则表达式替换函数：regexp_replace</strong></p>
<p>语法: regexp_replace(string A, string B, string C)</p>
<p>返回值: string</p>
<p>说明：将字符串A中的符合java正则表达式B的部分替换为C。注意，在有些情况下要使用转义字符,类似oracle中的regexp_replace函数。</p>
<p>举例：</p>
<p>hive&gt; select regexp_replace(‘foobar’, ‘oo|ar’, ‘’) from lxw_dual;</p>
<p>fb</p>
<p><strong>13. 正则表达式解析函数：regexp_extract</strong></p>
<p>语法: regexp_extract(string subject, string pattern, int index)</p>
<p>返回值: string</p>
<p>说明：将字符串subject按照pattern正则表达式的规则拆分，返回index指定的字符。</p>
<p>举例：</p>
<p>hive&gt; select regexp_extract(‘foothebar’, ‘foo(.*?)(bar)’, 1) fromlxw_dual;</p>
<p>the</p>
<p>hive&gt; select regexp_extract(‘foothebar’, ‘foo(.*?)(bar)’, 2) fromlxw_dual;</p>
<p>bar</p>
<p>hive&gt; select regexp_extract(‘foothebar’, ‘foo(.*?)(bar)’, 0) fromlxw_dual;</p>
<p>foothebar</p>
<p><strong>注意，在有些情况下要使用转义字符，下面的等号要用双竖线转义，这是java**</strong>正则表达式的规则。**</p>
<p>select data_field,</p>
<p>​     regexp_extract(data_field,’.*?bgStart\=(<sup><a href="#fn_&" id="reffn_&">&</a></sup>+)’,1) as aaa,</p>
<p>​     regexp_extract(data_field,’.*?contentLoaded_headStart\=(<sup><a href="#fn_&" id="reffn_&">&</a></sup>+)’,1) as bbb,</p>
<p>​     regexp_extract(data_field,’.*?AppLoad2Req\=(<sup><a href="#fn_&" id="reffn_&">&</a></sup>+)’,1) as ccc</p>
<p>​     from pt_nginx_loginlog_st</p>
<p>​     where pt = ‘2012-03-26’limit 2;</p>
<p><strong>14. URL解析函数：parse_url</strong></p>
<p>语法: parse_url(string urlString, string partToExtract [, stringkeyToExtract])</p>
<p>返回值: string</p>
<p>说明：返回URL中指定的部分。partToExtract的有效值为：HOST, PATH, QUERY, REF, PROTOCOL, AUTHORITY, FILE, and USERINFO.</p>
<p>举例：</p>
<p>hive&gt; selectparse_url(‘<a href="http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1" target="_blank" rel="noopener">http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1</a>‘, ‘HOST’) fromlxw_dual;</p>
<p>facebook.com</p>
<p>hive&gt; selectparse_url(‘<a href="http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1" target="_blank" rel="noopener">http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1</a>‘, ‘QUERY’,’k1’) from lxw_dual;</p>
<p>v1</p>
<p><strong>15. json解析函数：get_json_object</strong></p>
<p>语法: get_json_object(string json_string, string path)</p>
<p>返回值: string</p>
<p>说明：解析json的字符串json_string,返回path指定的内容。如果输入的json字符串无效，那么返回NULL。</p>
<p>举例：</p>
<p>hive&gt; select get_json_object(‘{“store”:</p>
<p>>  {“fruit”:[{“weight”:8,”type”:”apple”},{“weight”:9,”type”:”pear”}],</p>
<p>>   “bicycle”:{“price”:19.95,”color”:”red”}</p>
<p>>   },</p>
<p>> “email”:”amy@only_for_json_udf_test.net”,</p>
<p>>  “owner”:”amy”</p>
<p>> }</p>
<p>> ‘,’$.owner’) from lxw_dual;</p>
<p>amy</p>
<p><strong>16. 空格字符串函数：space</strong></p>
<p>语法: space(int n)</p>
<p>返回值: string</p>
<p>说明：返回长度为n的字符串</p>
<p>举例：</p>
<p>hive&gt; select space(10) from lxw_dual;</p>
<p>hive&gt; select length(space(10)) from lxw_dual;</p>
<p>10</p>
<p><strong>17. 重复字符串函数：repeat</strong></p>
<p>语法: repeat(string str, int n)</p>
<p>返回值: string</p>
<p>说明：返回重复n次后的str字符串</p>
<p>举例：</p>
<p>hive&gt; select repeat(‘abc’,5) from lxw_dual;</p>
<p>abcabcabcabcabc</p>
<p><strong>18. 首字符ascii函数：ascii</strong></p>
<p>语法: ascii(string str)</p>
<p>返回值: int</p>
<p>说明：返回字符串str第一个字符的ascii码</p>
<p>举例：</p>
<p>hive&gt; select ascii(‘abcde’) from lxw_dual;</p>
<p>97</p>
<p><strong>19. 左补足函数：lpad</strong></p>
<p>语法: lpad(string str, int len, string pad)</p>
<p>返回值: string</p>
<p>说明：将str进行用pad进行左补足到len位</p>
<p>举例：</p>
<p>hive&gt; select lpad(‘abc’,10,’td’) from lxw_dual;</p>
<p>tdtdtdtabc</p>
<p><strong>注意：与GP**</strong>，ORACLE<strong>**不同，pad</strong> <strong>不能默认</strong></p>
<p><strong>20. 右补足函数：rpad</strong></p>
<p>语法: rpad(string str, int len, string pad)</p>
<p>返回值: string</p>
<p>说明：将str进行用pad进行右补足到len位</p>
<p>举例：</p>
<p>hive&gt; select rpad(‘abc’,10,’td’) from lxw_dual;</p>
<p>abctdtdtdt</p>
<p><strong>21. 分割字符串函数: split</strong></p>
<p>语法:  split(string str, stringpat)</p>
<p>返回值:  array</p>
<p>说明: 按照pat字符串分割str，会返回分割后的字符串数组</p>
<p>举例：</p>
<p>hive&gt; select split(‘abtcdtef’,’t’) from lxw_dual;</p>
<p>[“ab”,”cd”,”ef”]</p>
<p><strong>22. 集合查找函数:find_in_set</strong></p>
<p>语法: find_in_set(string str, string strList)</p>
<p>返回值: int</p>
<p>说明: 返回str在strlist第一次出现的位置，strlist是用逗号分割的字符串。如果没有找该str字符，则返回0</p>
<p>举例：</p>
<p>hive&gt; select find_in_set(‘ab’,’ef,ab,de’) from lxw_dual;</p>
<p>2</p>
<p>hive&gt; select find_in_set(‘at’,’ef,ab,de’) from lxw_dual;</p>
<p>0</p>
<p>instr</p>
<h1 id="group后拼接"><a href="#group后拼接" class="headerlink" title="group后拼接"></a>group后拼接</h1><p>group_concat( [distinct] 要连接的字段 [order by 排序字段 asc/desc ] [separator ‘分隔符’] )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select userid,bankid,group_concat(cast(creditlimit as string))</div><div class="line">from vdm_fin.cc_user_bill_0724</div><div class="line">group by userid,bankid</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/hadoop-spark/hive笔记/pic/70.png" alt="è¿éåå¾çæè¿°"></p>
<p><strong>hive实现相同的功能：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SELECT id,</div><div class="line">concat_ws(&apos;|&apos;, collect_set(str)) </div><div class="line">FROM t  </div><div class="line">GROUP BY id;1234</div></pre></td></tr></table></figure>
<p>主意:collect_set 只能返回不重复的集合<br>若要返回带重复的要用collect_list</p>
<p>2、collect_list 展示子表排序后结果，collect_set 不受子表排序影响<br>select phone,collect_list(user_id) ,collect_set(user_id) from<br>(select * from a order by order_time asc)b<br>group by phone<br>结果：123456789    [1,1,3,2,2]    [1,3,2]</p>
<p>a表数据如下<br>phone    user_id order_time<br>123456789    1    2018/8/23<br>123456789    3    2018/8/24<br>123456789    2    2018/8/25<br>123456789    1    2018/8/22<br>123456789    2    2018/8/26</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/读书/计算机程序的构造和解释/CH3/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/读书/计算机程序的构造和解释/CH3/" class="post-title-link" itemprop="url">第三章 模块化、对象和状态</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 16:02:58" itemprop="dateModified" datetime="2019-06-28T16:02:58+08:00">2019-06-28</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读书/" itemprop="url" rel="index"><span itemprop="name">读书</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第三章-模块化、对象和状态"><a href="#第三章-模块化、对象和状态" class="headerlink" title="第三章 模块化、对象和状态"></a>第三章 模块化、对象和状态</h1><h2 id="前两章回顾"><a href="#前两章回顾" class="headerlink" title="前两章回顾"></a>前两章回顾</h2><ol>
<li>如何组合<strong>基本过程</strong>和<strong>基本数据</strong></li>
<li>如何构造各种<strong>复合对象</strong>(组合过程/数据)</li>
<li><strong>抽象</strong>在控制和处理程序复杂性中的重要作用</li>
</ol>
<blockquote>
<p>简单问题1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; cons、car和cdr的含义</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>简单问题2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; ;写出以下函数的等价lambda表达式</div><div class="line">&gt; (define (add a b)</div><div class="line">&gt;   (+ a b))</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>但对于程序设计而言，上面这三种手段还不够用，有效设计大型系统，还需要一些组织系统的原则，这体现在下面两方面：</p>
<ol>
<li>只有高效算法，不足以构造出良好的大型系统</li>
<li>系统的功能分解，结构组织和管理与算法一样重要(或更甚之)</li>
</ol>
<p>在大型系统的复杂性问题上，仅学会抽象的思维还不够，还需要一些能帮我们<strong>构造模块化的大型系统的策略</strong>。在这一章，会学习两种组织策略。</p>
<ul>
<li><strong>基于对象的策略</strong></li>
</ul>
<blockquote>
<p>真实系统中的对象随着时间的进展不断变化，模拟它们的系统对象也吸引相应地变化</p>
</blockquote>
<ul>
<li><strong>基于流处理的策略</strong></li>
</ul>
<blockquote>
<p>关注流过系统的信息流</p>
</blockquote>
<h2 id="3-1-赋值和局部状态"><a href="#3-1-赋值和局部状态" class="headerlink" title="3.1 赋值和局部状态"></a>3.1 赋值和局部状态</h2><h3 id="3-1-1-局部状态变量"><a href="#3-1-1-局部状态变量" class="headerlink" title="3.1.1 局部状态变量"></a>3.1.1 局部状态变量</h3><blockquote>
<p>例子：银行取钱</p>
</blockquote>
<p>用withdraw表示该行为，入参amount表示取钱的数量，若账户有足够的钱，返回余额；否则返回Insufficient funds。</p>
<p>为了实现withdraw，我们用一个变量balance表示余额，withdraw检查balance是否够amount，如果是，</p>
<p><code>balance -= amount</code></p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> balance <span class="number">100</span>)</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">withdraw</span> amount)</div><div class="line">  (<span class="name">if</span> (<span class="name">&gt;=</span> balance amount)</div><div class="line">      (<span class="name">begin</span> (<span class="name">set!</span> balance (<span class="name">-</span> balance amount))</div><div class="line">             balance)</div><div class="line">      <span class="string">"Insufficient funds"</span>))</div><div class="line"></div><div class="line">-----------------</div><div class="line">&gt; (<span class="name">withdraw</span> <span class="number">50</span>)</div><div class="line"><span class="number">50</span></div><div class="line">&gt; (<span class="name">withdraw</span> <span class="number">50</span>)</div><div class="line"><span class="number">0</span></div><div class="line">&gt; (<span class="name">withdraw</span> <span class="number">50</span>)</div><div class="line"><span class="string">"Insufficient funds"</span></div></pre></td></tr></table></figure>
<p>其中，set的语法是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(set! &lt;name&gt; &lt;new-value&gt; )</div></pre></td></tr></table></figure>
<p>begin描述对表达式的求值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(begin &lt;exp1&gt;&lt;exp2&gt;...&lt;expk&gt;)</div></pre></td></tr></table></figure>
<p>按顺序求值，并返回最后一个表达式的值。</p>
<p>可以看出，这里的balance是全局变量，在哪里都能读取或修改这个值。如果将其作为局部变量，就只能通过withdraw来访问balance，这样才能更准确的模拟balance这个概念。</p>
<p>于是将其转为局部变量。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> new-withdraw</div><div class="line">  (<span class="name">let</span> ((<span class="name">balance</span> <span class="number">100</span>))</div><div class="line">    (<span class="name">lambda</span> (<span class="name">amount</span>)</div><div class="line">      (<span class="name">if</span> (<span class="name">&gt;=</span> balance amount)</div><div class="line">          (<span class="name">begin</span> (<span class="name">set!</span> balance (<span class="name">-</span> balance amount))</div><div class="line">             balance)</div><div class="line">      <span class="string">"Insufficient funds"</span>))))</div></pre></td></tr></table></figure>
<p>其中，let创建一个包含局部变量的环境，并设初始值。</p>
<p>make-withdraw创建一种”提款处理器”，它的形参balance描述了有关账户的初始值。(把balance当形参传入)</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-withdraw</span> balance)</div><div class="line">  (<span class="name">lambda</span> (<span class="name">amount</span>)</div><div class="line">    (<span class="name">if</span> (<span class="name">&gt;=</span> balance amount)</div><div class="line">        (<span class="name">begin</span> (<span class="name">set!</span> balance (<span class="name">-</span> balance amount))</div><div class="line">               balance)</div><div class="line">        <span class="string">"Insufficient funds"</span>)))</div><div class="line"></div><div class="line">(<span class="name">define</span> W1 (<span class="name">make-withdraw</span> <span class="number">100</span>))</div><div class="line">(<span class="name">define</span> W2 (<span class="name">make-withdraw</span> <span class="number">100</span>))</div><div class="line"></div><div class="line">-----------------</div><div class="line">&gt; (<span class="name">W1</span> <span class="number">50</span>)</div><div class="line"><span class="number">50</span></div><div class="line">&gt; (<span class="name">W2</span> <span class="number">60</span>)</div><div class="line"><span class="number">40</span></div></pre></td></tr></table></figure>
<p>可以看出，W1和W2是完全独立的对象，每个都有自己的局部状态变量balance。</p>
<p>再创建一个存钱的对象make-account</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-account</span> balance)</div><div class="line">  (<span class="name">define</span> (<span class="name">withdraw</span> amount)</div><div class="line">    (<span class="name">if</span> (<span class="name">&gt;=</span> balance amount)</div><div class="line">        (<span class="name">begin</span> (<span class="name">set!</span> balance (<span class="name">-</span> balance amount))</div><div class="line">               balance)</div><div class="line">        <span class="string">"Insufficient funds"</span>))</div><div class="line">  </div><div class="line">  (<span class="name">define</span> (<span class="name">deposit</span> amount)</div><div class="line">    (<span class="name">set!</span> balance (<span class="name">+</span> balance amount))</div><div class="line">    balance)</div><div class="line"></div><div class="line">  (<span class="name">define</span> (<span class="name">dispatch</span> m)</div><div class="line">    (<span class="name">cond</span> ((<span class="name">eq</span>? m 'withdraw) withdraw)</div><div class="line">          ((<span class="name">eq</span>? m 'deposit) deposit)</div><div class="line">          (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></div><div class="line">                       m))))</div><div class="line"></div><div class="line">  dispatch)</div></pre></td></tr></table></figure>
<p>对make-account的每次调用都会设置好一个带有balance的环境，在这个环境中，定义了能访问balance的过程deposit和withdraw，另外还有一个过程dispatch，它以一个字符串作为输入，返回这两个局部过程之一。</p>
<p>该过程可以这样使用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&gt; (define acc (make-account 100))</div><div class="line"></div><div class="line">; 对acc的每次调用将返回局部定义的过程</div><div class="line">&gt; (acc 'withdraw)</div><div class="line">#&lt;procedure:withdraw&gt;</div><div class="line"></div><div class="line">; 这个过程随后被应用于给定的amount</div><div class="line">&gt; ((acc 'withdraw) 50)</div><div class="line">50</div><div class="line"></div><div class="line">&gt; ((acc 'withdraw) 60)</div><div class="line">"Insufficient funds"</div><div class="line"></div><div class="line">&gt; ((acc 'deposit) 40)</div><div class="line">90</div><div class="line"></div><div class="line">&gt; ((acc 'withdraw) 60)</div><div class="line">30</div><div class="line"></div><div class="line">; 这样将产生另一个完全独立的对象，维护自己的局部balance</div><div class="line">&gt; (define acc2 (make-account 1000))</div></pre></td></tr></table></figure>
<h3 id="3-1-2-引进赋值带来的利益"><a href="#3-1-2-引进赋值带来的利益" class="headerlink" title="3.1.2 引进赋值带来的利益"></a>3.1.2 引进赋值带来的利益</h3><blockquote>
<p>例子：考虑设计一个过程rand，每次被调用就返回一个随机整数</p>
</blockquote>
<p>“随机”是指，对rand的反复调用将产生出一系列的数，这一序列具有均匀分布的统计性质。</p>
<p>假设现在有一个过程rand-update，如果给定一个数x1，执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">x2 = (rand-update x1)</div><div class="line">x3 = (rand-update x2)</div></pre></td></tr></table></figure>
<p>得到序列x1, x2, x3…将具有我们希望的性质</p>
<p>可以将rand时限为一个带局部状态变量x的过程，初始化为某个固定值random-init，对rand的每次调用算出当前x的rand-update值，返回作为随机数，并将其更新为x的新值</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> random-init <span class="number">7</span>)</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">rand-update</span> x)</div><div class="line">  (<span class="name">let</span> ((<span class="name">a</span> <span class="number">27</span>) (<span class="name">b</span> <span class="number">26</span>) (<span class="name">m</span> <span class="number">127</span>))</div><div class="line">    (<span class="name">modulo</span> (<span class="name">+</span> (<span class="name">*</span> a x) b) m)))</div></pre></td></tr></table></figure>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> rand</div><div class="line">  (<span class="name">let</span> ((<span class="name">x</span> random-init))</div><div class="line">    (<span class="name">lambda</span> ()</div><div class="line">      (<span class="name">set!</span> x (<span class="name">rand-update</span> x))</div><div class="line">      x)))</div></pre></td></tr></table></figure>
<p>当然，你也可以在需要随机数的时候直接调用rand-update，生成同样的随机数序列。但缺点是，这就<strong>需要程序中任何使用随机数的地方都必须显式的记住x的值</strong>，在生成下一个时，将x的值传给rand-update作为参数。</p>
<p>考虑用随机数实现<strong><em>蒙特卡洛法</em></strong> monte-carlo</p>
<blockquote>
<p> 蒙特卡洛模拟：从总体抽取大量随机样本，并通过这些随机样本估计这一随机事件的概率，将这个概率作为问题的解。</p>
</blockquote>
<p>比如，$6/\pi^2$是随机选取的两个整数之间没有公共因子（最大公因子（greatest common divisor，GCD）是1）的概率。</p>
<p>则可以通过每次随机选择两个证书并检查它们的GCD是否为1来近似的获得这个概率，π的近似求值。（Cesaro定理）</p>
<p><a href="https://zhuanlan.zhihu.com/p/47978393" target="_blank" rel="noopener">理解黎曼猜想（二）两个自然数互质的概率是多少？</a></p>
<p>那么，这个过程的核心就是蒙特卡洛模拟（monte-carlo），<strong>它以做某个实验的次数，以及这个实现本身作为参数</strong>。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">estimate-pi</span> trials)</div><div class="line">  (<span class="name">sqrt</span> (<span class="name">/</span> <span class="number">6</span> (<span class="name">monte-carlo</span> trials cesaro-test))))</div><div class="line"></div><div class="line"><span class="comment">; Cesaro实验</span></div><div class="line">(<span class="name">define</span> (<span class="name">cesaro-test</span>)</div><div class="line">  (<span class="name">=</span> (<span class="name">gcd</span> (<span class="name">rand</span>) (<span class="name">rand</span>)) <span class="number">1</span>))</div><div class="line"></div><div class="line"><span class="comment">; 做某个实验的次数，以及这个实现本身作为参数</span></div><div class="line">(<span class="name">define</span> (<span class="name">monte-carlo</span> trials experiment)</div><div class="line">  (<span class="name">define</span> (<span class="name">iter</span> trials-remaining trials-passed)</div><div class="line">    (<span class="name">cond</span> ((<span class="name">=</span> trials-remaining <span class="number">0</span>)</div><div class="line">           (<span class="name">/</span> trials-passed trials))</div><div class="line">          ((<span class="name">experiment</span>)</div><div class="line">           (<span class="name">iter</span> (<span class="name">-</span> trials-remaining <span class="number">1</span>) (<span class="name">+</span> trials-passed <span class="number">1</span>)))</div><div class="line">          (<span class="name">else</span></div><div class="line">           (<span class="name">iter</span> (<span class="name">-</span> trials-remaining <span class="number">1</span>) trials-passed))))</div><div class="line">  (<span class="name">iter</span> trials <span class="number">0</span>))</div><div class="line"></div><div class="line">---------------------</div><div class="line">&gt; (<span class="name">estimate-pi</span> <span class="number">50</span>)</div><div class="line"><span class="number">2.449489742783178</span></div></pre></td></tr></table></figure>
<p>现在试一下不用rand，直接用rand-update，如果不使用赋值去模拟局部状态，则</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">random-gcd-test</span> trials initial-x)</div><div class="line">  (<span class="name">define</span> (<span class="name">iter</span> trials-remaining trials-passed x)</div><div class="line">    (<span class="name">let</span> ((<span class="name">x1</span> (<span class="name">rand-update</span> x)))</div><div class="line">      (<span class="name">let</span> ((<span class="name">x2</span> (<span class="name">rand-update</span> x1)))</div><div class="line">        (<span class="name">cond</span> ((<span class="name">=</span> trials-remaining <span class="number">0</span>)</div><div class="line">               (<span class="name">/</span> trials-passed trials))</div><div class="line">              ((<span class="name">=</span> (<span class="name">gcd</span> x1 x2) <span class="number">1</span>)</div><div class="line">               (<span class="name">iter</span> (<span class="name">-</span> trials-remaining <span class="number">1</span>)</div><div class="line">                     (<span class="name">+</span> trials-passed <span class="number">1</span>)</div><div class="line">                     x2))</div><div class="line">              (<span class="name">else</span></div><div class="line">                (<span class="name">iter</span> (<span class="name">-</span> trials-remaining <span class="number">1</span>)</div><div class="line">                      trials-passed</div><div class="line">                      x2))))))</div><div class="line">  (<span class="name">iter</span> trials <span class="number">0</span> initial-x))</div></pre></td></tr></table></figure>
<p>很明显看到区别，在上面的方法中，蒙特卡洛可以<strong>抽象出一个公共方法，不限制experiment的具体形式</strong>，而下面的方法中，由于没有随机数生成器的局部状态，random-gcd-test必须显式的操作随机数x1和x2。</p>
<p>赋值和局部变量的好处：</p>
<blockquote>
<p>从复杂计算的角度来看，其他部分都像是<strong>随着时间不断变化，而它们自己隐藏起随时间变化的内部状态</strong>（比如银行账户和随机数生成器）。因此在进行系统抽象的时候，用<strong>局部变量去模拟系统的状态</strong>，用对这些<strong>变量的赋值去模拟状态的变化</strong>。</p>
</blockquote>
<h3 id="3-1-3-引进赋值的代价"><a href="#3-1-3-引进赋值的代价" class="headerlink" title="3.1.3 引进赋值的代价"></a>3.1.3 引进赋值的代价</h3><p>只要不使用赋值，以同样参数对同意过程的两次求值<strong>一定能产生同样的效果</strong>，就像在计算数学函数。不用任何赋值的程序设计成为<strong>函数式编程</strong>。</p>
<p><em>赋值如何让事情复杂化了？</em></p>
<p>来看make-withdraw的一个简化版本，其中不再关注是否有足够余额的问题：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; The Costs of Introducing Assignment</span></div><div class="line">(<span class="name">define</span> (<span class="name">make-simplified-withdraw</span> balance)</div><div class="line">  (<span class="name">lambda</span> (<span class="name">amount</span>)</div><div class="line">    (<span class="name">set!</span> balance (<span class="name">-</span> balance amount))</div><div class="line">    balance))</div><div class="line">(<span class="name">define</span> W (<span class="name">make-simplified-withdraw</span> <span class="number">25</span>))</div><div class="line"></div><div class="line">&gt; (<span class="name">W</span> <span class="number">20</span>)</div><div class="line"><span class="number">5</span></div><div class="line">&gt; (<span class="name">W</span> <span class="number">20</span>)</div><div class="line"><span class="number">-15</span></div></pre></td></tr></table></figure>
<p>如果没有set</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-decrementer</span> balance)</div><div class="line">  (<span class="name">lambda</span> (<span class="name">amount</span>)</div><div class="line">    (<span class="name">-</span> balance amount)))</div><div class="line">(<span class="name">define</span> D (<span class="name">make-decrementer</span> <span class="number">25</span>))</div><div class="line"></div><div class="line">&gt; (<span class="name">D</span> <span class="number">20</span>)</div><div class="line"><span class="number">5</span></div><div class="line"></div><div class="line">&gt; (<span class="name">D</span> <span class="number">20</span>)</div><div class="line"><span class="number">5</span></div></pre></td></tr></table></figure>
<p>用<strong>代换模型</strong>来解释<code>make-decrementer</code>如何工作。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">((<span class="name">make-decrementer</span> <span class="number">25</span>) <span class="number">20</span>)</div><div class="line"></div><div class="line"><span class="comment">; 25代替balance</span></div><div class="line">((<span class="name">lambda</span> (<span class="name">amount</span>) (<span class="name">-</span> <span class="number">25</span> amount)) <span class="number">20</span>)</div><div class="line"></div><div class="line"><span class="comment">; 应用运算符，20代替lambda中的amount</span></div><div class="line">(<span class="name">-</span> <span class="number">25</span> <span class="number">20</span>)</div></pre></td></tr></table></figure>
<p>类似的，来看<code>make-simplified-withdraw</code>如何工作</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">((make-simplified-withdraw 25)   20)</div><div class="line"></div><div class="line">; 25代替balance</div><div class="line">((lambda (amount) (set! balance (- 25 amount)) 25)   20))</div><div class="line"></div><div class="line">; 20代替lambda中的amount，先将balance设为5，再返回25</div><div class="line">(set! balance (- 25 20)) 25</div></pre></td></tr></table></figure>
<p>可见这里如果用<strong>代换模型</strong>，则这个过程首先将balance设为5，再返回25，显示是有问题的。造成这种问题的根源是：</p>
<p>在代换模型中，语言的符号（如balance）就是<strong>值的名字</strong>，而一旦引进了<strong>set和变量的值可以变化</strong>的想法，一个变量就不再是一个简单的名字了。</p>
<p><strong>同一和变化</strong></p>
<p>从这里暴露出的问题，远远不是打破了一个简单的计算模型，其意义要深远得多。一旦将变化引入了我们的计算模型，许多以前非常简单明了的概念现在都变得有问题了。</p>
<p>首先考虑两个物体实际上“<strong>同一</strong>”的概念。如果一个语言在表达式里支持“同一的东西可以相互替换”的概念，这样替换不会改变表达式的值，这个语言就称为是具有<font color="#FF0033" size="5">引用透明性</font>。</p>
<p>在我们的计算机语言包含了赋值操作之后，也就打破了引用透明性，产生了<strong>副作用</strong>。</p>
<ul>
<li><strong>修改变量的值</strong></li>
<li>IO 操作，如写数据到磁盘</li>
<li>UI 操作，如修改了一个按钮的可操作状态</li>
</ul>
<p><a href="https://juejin.im/post/5a58134751882573370794cc" target="_blank" rel="noopener">引用透明性和等式推理</a></p>
<p><strong>命令式编程的缺陷</strong></p>
<p>除了引入变量和赋值导致计算模型的复杂性之外，还容易出现一些不会在函数式编程中出现的错误，比如：</p>
<p>1.2.1节的迭代求阶乘</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">factorial</span> n)</div><div class="line">  (<span class="name">define</span> (<span class="name">iter</span> product counter)</div><div class="line">    (<span class="name">if</span> (<span class="name">&gt;</span> counter n)</div><div class="line">      product</div><div class="line">        <span class="comment">; 注意这里</span></div><div class="line">      (<span class="name">iter</span> (<span class="name">*</span> counter product)</div><div class="line">	    (<span class="name">+</span> counter <span class="number">1</span>))))</div><div class="line">  (<span class="name">iter</span> <span class="number">1</span> <span class="number">1</span>))</div></pre></td></tr></table></figure>
<p>如果用命令式编程，显式的通过赋值去更新变量product和counter的值</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">factorial</span> n)</div><div class="line">  (<span class="name">let</span> ((<span class="name">product</span> <span class="number">1</span>)</div><div class="line">	(<span class="name">counter</span> <span class="number">1</span>))</div><div class="line">    (<span class="name">define</span> (<span class="name">iter</span>)</div><div class="line">      (<span class="name">if</span> (<span class="name">&gt;</span> counter n)</div><div class="line">	product</div><div class="line">          <span class="comment">; 这两行的陷阱</span></div><div class="line">	(<span class="name">begin</span> (<span class="name">set!</span> product (<span class="name">*</span> counter product))</div><div class="line">	       (<span class="name">set!</span> counter (<span class="name">+</span> counter <span class="number">1</span>))</div><div class="line">	       (<span class="name">iter</span>))))</div><div class="line">    (<span class="name">iter</span>)))</div></pre></td></tr></table></figure>
<p>上述写法是正确的，但是如果颠倒其中两行的顺序</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;(set! counter (+ counter 1))</span></div><div class="line"><span class="comment">;(set! product (* counter product))</span></div></pre></td></tr></table></figure>
<p>结果就不对了。一般来说，<strong>带有赋值操作的程序强迫人们去考虑赋值的相对顺序，以保证每个语句所用的是被修改变量的正确版本</strong>。</p>
<p>接下来要解决的问题就是，要给涉及赋值的表达式提供一种区别于之前的计算模型。</p>
<h2 id="3-2-求值的环境模型"><a href="#3-2-求值的环境模型" class="headerlink" title="3.2 求值的环境模型"></a>3.2 求值的环境模型</h2><p>之前说<strong>代换模型</strong>不再适用于赋值表达式。由于赋值操作的存在，此时的变量必须以某种方式指定了一个“位置”，相应的值可以存储在那里。在我们的新求值模型里，这种位置将维持在称为 <strong>环境</strong> 的结构中。</p>
<p>一些概念：</p>
<p>1）<strong>环境</strong>：<strong>框架</strong>的一个序列</p>
<p>2）<strong>框架</strong>：每个框架包含着一些 <strong>约束</strong> 的表格</p>
<p>3）<strong>约束</strong>：变量名和值相关联。（在一个框架里，任何变量至多只能有一个约束）</p>
<p>4）<strong>指针</strong>：每个框架还包含着一个<strong>指针</strong>，指向这一框架的<em>外围环境</em>。</p>
<p>5）<strong>变量</strong>：一个<em>变量</em>相对于某个特定环境的<em>值</em>，</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/3_1.png" alt="img"></p>
<p>​                                                                                一个简单的环境结构</p>
<p>1、2、3是三个框架，  ABCD都是环境指针，其中CD指向同一个环境。</p>
<p>环境对于求值过程是至关重要的，因为它确定了表达式求值的上下文。假设始终有一个全局环境，只包含一个框架（没有外围环境），这个环境包含所有关于基本过程的符号的值。</p>
<h3 id="3-2-1-求值规则"><a href="#3-2-1-求值规则" class="headerlink" title="3.2.1 求值规则"></a>3.2.1 求值规则</h3><p>在求值的环境模型中，过程只能通过一种方式创建，那就是通过求值一个lambda表达式。例如</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">square</span> x)</div><div class="line">  (<span class="name">*</span> x x))</div></pre></td></tr></table></figure>
<p>过程定义的语法形式，不过是作为隐含lambda表达式的语法糖，等价于</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> square</div><div class="line">  (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">*</span> x x))</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/3_3.png" alt="img"></p>
<p>过程对象的环境部分是一个指向全局环境的指针，因此产生这个过程的lambda表达式是在全局环境中求值的。</p>
<p>这里增加了一个新约束：将过程对象约束给符号square。一般来说，<strong>define就是把一个新的约束加入到框架中</strong>。</p>
<p>假设现在对表达式<code>(square 5)</code>求值，结果是创建了一个新环境——E1。</p>
<p>1）E1从一个框架开始，这个框架包含5赋值给x的约束。</p>
<p>2）E1引出的指针表示这个框架的外围环境是全局环境</p>
<p><strong>过程应用的环境模型</strong>：</p>
<ul>
<li>将一个过程对象应用于一组实际参数，将<strong>构造出一个新框架</strong>，其中将过程的<strong>形式参数约束到调用时的实际参数</strong>，而后在构造起的这一新环境的<strong>上下文中求值过程体</strong>。这个新框架的外围环境就是作为被应用的那个过程对象的一部分的环境。</li>
<li>相对于一个给定环境<strong>求值一个 lambda表达式</strong>，将会创建起一个过程对象，这个过程对象是一个序对，由该 lambda表达式 的正文和一个指向环境的指针组成，这一指针指向的就是创建这个过程对象时的环境。</li>
</ul>
<p>关于<code>set!</code>的行为方式</p>
<p>在某个环境里求值 <strong><em>赋值表达式</em></strong> 时，要求我们首先在环境中确定有关变量的约束位置，而后再修改这个约束，使之表示这个新值。</p>
<p>这也就是说，首先需要<strong>找到包含这个变量的约束的第一个框架，而后修改这一框架</strong>。如果该变量在环境中没有约束，将报告一个错误。</p>
<h3 id="3-2-2-简单过程的应用"><a href="#3-2-2-简单过程的应用" class="headerlink" title="3.2.2 简单过程的应用"></a>3.2.2 简单过程的应用</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">square</span> x)</div><div class="line">  (<span class="name">*</span> x x))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">sum-of-squares</span> x y)</div><div class="line">  (<span class="name">+</span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">f</span> a)</div><div class="line">  (<span class="name">sum-of-squares</span> (<span class="name">+</span> a <span class="number">1</span>) (<span class="name">*</span> a <span class="number">2</span>)))</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/3_4.png" alt="img"></p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/3_5.png" alt="img"></p>
<p>求值 <code>(f 5)</code>：</p>
<ol>
<li>创建一个新环境 <code>E1</code>，参数 <code>a</code> 被约束到 5。在 <code>E1</code> 中求值 <code>(sum-of-square (+ a 1) (* a2))</code></li>
<li>求值组合式，首先求值子表达式。第一个子表达式 <code>sum-of-square</code> 以一个过程对象为值。（在 <code>E1</code> 的框架中未寻找到约束，而后进入有关的外围环境，并找到约束）</li>
<li>创建环境 <code>E2</code>，现在需要把过程对象 <code>sum-of-square</code> 应用于实参 6 和 10。</li>
</ol>
<h2 id="3-3-用变动的数据做模拟"><a href="#3-3-用变动的数据做模拟" class="headerlink" title="3.3 用变动的数据做模拟"></a>3.3 用变动的数据做模拟</h2><h3 id="3-3-1-变动的表结构"><a href="#3-3-1-变动的表结构" class="headerlink" title="3.3.1 变动的表结构"></a>3.3.1 变动的表结构</h3><p>针对序对的基本改变函数是set-car!和set-cdr!。<code>set-car!</code>要求两个参数，其中第一个参数必须是一个序对。然后修改这个序对，将它的car指针替换为指向set-car!第二个参数的指针。</p>
<p>假设x是<code>((a b) c d)</code>，y是<code>(e f)</code>，执行</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190612130259772.png" alt="image-20190612130259772"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(set-car! x y)</div></pre></td></tr></table></figure>
<p>修改x约束的那个表，将它的car用y的值取代。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190612130309732.png" alt="image-20190612130309732"></p>
<p><strong>共享和相等</strong></p>
<p>当不同的数据对象共享某些序对时，会产生一些问题。例如，考虑下面的结构：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> x (<span class="name">list</span> 'a 'b))</div><div class="line">(<span class="name">define</span> z1 (<span class="name">cons</span> x x))</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617143714166.png" alt="image-20190617143714166"></p>
<p>这里的z1是一个序对，car和cdr都指向同一个序对x。</p>
<p>再看另一个结构</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> z2 </div><div class="line">  (<span class="name">cons</span> (<span class="name">list</span> 'a 'b) (<span class="name">list</span> 'a 'b)))</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617143741708.png" alt="image-20190617143741708"></p>
<p>两个表(a, b)的各个序对互不相同，虽然其中的符号是共享的。</p>
<p>作为表考虑，z1和z2表示同一个表<code>((a b) a b)</code>。一般而言，如果我们只用cons、car、cdr，z1和z2看不出差别。然而，<strong>如果允许修改表结构，共享的情况就会体现出差别</strong>。考虑下面的过程：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">set-to-wow!</span> x)</div><div class="line">  (<span class="name">set-car!</span> (<span class="name">car</span> x) 'wow)</div><div class="line">  x)</div></pre></td></tr></table></figure>
<p>将<code>set-to-wow!</code>应用于z1和z2，将产生不同的结果。对于z1，修改car也就同时修改了cdr。而对于z2，只修改了car。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; z1</div><div class="line">((<span class="name">a</span> b) a b)</div><div class="line"></div><div class="line">&gt; (<span class="name">set-to-wow!</span> z1)</div><div class="line">((<span class="name">wow</span> b) wow b)</div><div class="line"></div><div class="line">&gt; z2</div><div class="line">((<span class="name">a</span> b) a b)</div><div class="line"></div><div class="line">&gt; (<span class="name">set-to-wow!</span> z2)</div><div class="line">((<span class="name">wow</span> b) a b)</div></pre></td></tr></table></figure>
<p>检测表结构是否共享的一种方式是使用<strong>谓词eq?</strong>。谓词<code>(eq? x y)</code>检查x和y作为指针是否相等。这样，对于z1和z2，<code>(eq? (car z1) (cdr z1))</code> 为true <code>(eq? (car z2) (cdr z2))</code> 为false。</p>
<h3 id="3-3-2-队列的表示"><a href="#3-3-2-队列的表示" class="headerlink" title="3.3.2 队列的表示"></a>3.3.2 队列的表示</h3><p>利用<code>set-car!</code> 和 <code>set-cdr!</code>，我们可以用序对构造出一些单靠cons、car、cdr无法构造的数据结构。这一节展示如何构造<strong>队列</strong>。</p>
<p>一个队列是一个序对，数据只能从一端插入（队列的尾），另一端删除（队列的首）。下面显示一个初始是空的队列，之后插入a和b，再删除a，再插入c和d，再删除b。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617145657417.png" alt="image-20190617145657417"></p>
<p>队列可以看做是由下面一组操作定义的结构：</p>
<ul>
<li>一个构造函数(make-queue) ，返回一个空队列。</li>
<li>两个选择函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(empty-queue? ⟨queue⟩)</div></pre></td></tr></table></figure>
<p>检查队列是否为空</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(front-queue ⟨queue⟩)</div></pre></td></tr></table></figure>
<p>返回队首的对象，如果空就报错。</p>
<ul>
<li>两个改变函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(insert-queue! ⟨queue⟩ ⟨item⟩)</div></pre></td></tr></table></figure>
<p>插入队尾，返回修改后的队列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(delete-queue! ⟨queue⟩)</div></pre></td></tr></table></figure>
<p>删除队首对象，返回修改后的队列。</p>
<p>队列可以表示成一个常规的表，用car、cdr来完成上述操作。但是效率很低，为了插入一个数据项，需要扫描整个表，有<code>O(n)</code>的时间复杂度。那么简单修改一下表的表示方式，就可以只需<code>O(1)</code>的时间复杂度。方法就是加入一个指向队列尾的指针，这里就有两个指针<code>front-ptr</code> 和<code>rear-ptr</code>。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617155741378.png" alt="image-20190617155741378"></p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">front-ptr</span> queue) (<span class="name">car</span> queue))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">rear-ptr</span> queue) (<span class="name">cdr</span> queue))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">set-front-ptr!</span> queue item) </div><div class="line">  (<span class="name">set-car!</span> queue item))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">set-rear-ptr!</span> queue item) </div><div class="line">  (<span class="name">set-cdr!</span> queue item))</div></pre></td></tr></table></figure>
<p>现在来实现队列的其他操作</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(define (empty-queue? queue) </div><div class="line">  (null? (front-ptr queue)))</div><div class="line">  </div><div class="line">(define (make-queue) (cons '() '()))</div><div class="line"></div><div class="line">(define (front-queue queue)</div><div class="line">  (if (empty-queue? queue)</div><div class="line">      (error "FRONT called with an </div><div class="line">              empty queue" queue)</div><div class="line">      (car (front-ptr queue))))</div></pre></td></tr></table></figure>
<p>如果要插入一个对象，按照下图的方式，</p>
<p>1）创建一个新队列，car是需要插入的项，cdr是空表。</p>
<p>2）若队列原来是空，就让<code>front-ptr</code> 和<code>rear-ptr</code>共同指向新序对。否则就修改rear-ptr，而指向新序对。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617162453179.png" alt="image-20190617162453179"></p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">insert-queue!</span> queue item)</div><div class="line">  (<span class="name">let</span> ((<span class="name">new-pair</span> (<span class="name">cons</span> item '())))</div><div class="line">    (<span class="name">cond</span> ((<span class="name">empty-queue</span>? queue)</div><div class="line">           (<span class="name">set-front-ptr!</span> queue new-pair)</div><div class="line">           (<span class="name">set-rear-ptr!</span> queue new-pair)</div><div class="line">           queue)</div><div class="line">          (<span class="name">else</span> (<span class="name">set-cdr!</span> (<span class="name">rear-ptr</span> queue) </div><div class="line">                          new-pair)</div><div class="line">                (<span class="name">set-rear-ptr!</span> queue new-pair)</div><div class="line">                queue))))</div></pre></td></tr></table></figure>
<p>要删除对象，就修改front-ptr，指向第二个数据项。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(define (delete-queue! queue)</div><div class="line">  (cond ((empty-queue? queue)</div><div class="line">         (error "DELETE! called with </div><div class="line">                 an empty queue" queue))</div><div class="line">        (else (set-front-ptr! </div><div class="line">               queue </div><div class="line">               (cdr (front-ptr queue)))</div><div class="line">              queue)))</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617165406898.png" alt="image-20190617165406898"></p>
<h3 id="3-3-3-表格的表示"><a href="#3-3-3-表格的表示" class="headerlink" title="3.3.3 表格的表示"></a>3.3.3 表格的表示</h3><p>首先考虑一维表格的问题，每个记录实现为key和value的序对。这些记录连接起来就构成一个序对的表。为了向表格里面插入记录时有可以修改的位置，将这种表格构造为一种<strong>带有表头单元的表</strong>。表开头有一个“哑”记录——存放一个特殊符号，<code>*table*</code>。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617170617702.png" alt="image-20190617170617702"></p>
<p>为了从表格中提取信息，定义lookup过程，以key为参数，返回value。lookup基于assoc定义。assoc返回key的那条记录。lookup检查assoc返回的记录是否为假，而后返回value。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">lookup</span> key table)</div><div class="line">  (<span class="name">let</span> ((<span class="name">record</span> (<span class="name">assoc</span> key (<span class="name">cdr</span> table))))</div><div class="line">    (<span class="name">if</span> record</div><div class="line">        (<span class="name">cdr</span> record)</div><div class="line">        false)))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">assoc</span> key records)</div><div class="line">  (<span class="name">cond</span> ((<span class="name">null</span>? records) false)</div><div class="line">        ((<span class="name">equal</span>? key (<span class="name">caar</span> records)) </div><div class="line">         (<span class="name">car</span> records))</div><div class="line">        (<span class="name">else</span> (<span class="name">assoc</span> key (<span class="name">cdr</span> records)))))</div></pre></td></tr></table></figure>
<p>如果是插入操作，</p>
<p>1）首先用assoc检查表格中是否有这个key，如果没有，就cons这个key和value，构造出一个新记录。接着插入到表的最前面，位于哑记录之后。</p>
<p>2）如果表格中存在这个记录，就用该记录的cdr设置为这个新值。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">insert!</span> key value table)</div><div class="line">  (<span class="name">let</span> ((<span class="name">record</span> (<span class="name">assoc</span> key (<span class="name">cdr</span> table))))</div><div class="line">    (<span class="name">if</span> record</div><div class="line">        (<span class="name">set-cdr!</span> record value)</div><div class="line">        (<span class="name">set-cdr!</span> table</div><div class="line">                  (<span class="name">cons</span> (<span class="name">cons</span> key value) </div><div class="line">                        (<span class="name">cdr</span> table)))))</div><div class="line">  'ok)</div></pre></td></tr></table></figure>
<p>在构造一个新表时，只需创建起一个包含符号<code>*table*</code>的表。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-table</span>)</div><div class="line">  (<span class="name">list</span> '*table*))</div></pre></td></tr></table></figure>
<p><strong>二维表格</strong></p>
<p>二维表格的每个值用两个key索引。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/../../../../../../Desktop/image-20190617172806860.png" alt="image-20190617172806860"></p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190617172821310.png" alt="image-20190617172821310"></p>
<p>二维表的查询。先用第一个key确定对应的子表格，而后用第二个key确定value。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">lookup</span> key-1 key-2 table)</div><div class="line">  (<span class="name">let</span> ((<span class="name">subtable</span> (<span class="name">assoc</span> key-1 (<span class="name">cdr</span> table))))</div><div class="line">    (<span class="name">if</span> subtable</div><div class="line">        (<span class="name">let</span> ((<span class="name">record</span> </div><div class="line">               (<span class="name">assoc</span> key-2 (<span class="name">cdr</span> subtable))))</div><div class="line">          (<span class="name">if</span> record (<span class="name">cdr</span> record) false))</div><div class="line">        false)))</div></pre></td></tr></table></figure>
<p>二维表的插入。首先用assoc查看key-1是否有一个子表格，没有就构造，其中只包含一个记录<code>(key-2, value)</code>。若有，就将新值插入该子表格。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">insert!</span> key-1 key-2 value table)</div><div class="line">  (<span class="name">let</span> ((<span class="name">subtable</span> (<span class="name">assoc</span> key-1 (<span class="name">cdr</span> table))))</div><div class="line">    (<span class="name">if</span> subtable</div><div class="line">        (<span class="name">let</span> ((<span class="name">record</span> </div><div class="line">               (<span class="name">assoc</span> key-2 (<span class="name">cdr</span> subtable))))</div><div class="line">          (<span class="name">if</span> record</div><div class="line">              (<span class="name">set-cdr!</span> record value)</div><div class="line">              (<span class="name">set-cdr!</span> </div><div class="line">               subtable</div><div class="line">               (<span class="name">cons</span> (<span class="name">cons</span> key-2 value)</div><div class="line">                     (<span class="name">cdr</span> subtable)))))</div><div class="line">        (<span class="name">set-cdr!</span> </div><div class="line">         table</div><div class="line">         (<span class="name">cons</span> (<span class="name">list</span> key-1 (<span class="name">cons</span> key-2 value))</div><div class="line">               (<span class="name">cdr</span> table)))))</div><div class="line">  'ok)</div></pre></td></tr></table></figure>
<p><strong>创建局部表格</strong></p>
<p>上述的lookup和insert!都以整个表格为参数，这也使我们可以将它们用到包含多个表格的程序中。处理多个表格的方式是为每个表格提供一对独立的lookup和insert！过程。</p>
<p>实现的方案是，用过程表示表格，将表格表示为一个以局部状态的方式维持一个内部表格的对象。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">(define (make-table)</div><div class="line">  (let ((local-table (list '*table*)))</div><div class="line">    (define (lookup key-1 key-2)</div><div class="line">      (let ((subtable </div><div class="line">             (assoc key-1 (cdr local-table))))</div><div class="line">        (if subtable</div><div class="line">            (let ((record </div><div class="line">                   (assoc key-2 </div><div class="line">                          (cdr subtable))))</div><div class="line">              (if record (cdr record) false))</div><div class="line">            false)))</div><div class="line">    (define (insert! key-1 key-2 value)</div><div class="line">      (let ((subtable </div><div class="line">             (assoc key-1 (cdr local-table))))</div><div class="line">        (if subtable</div><div class="line">            (let ((record </div><div class="line">                   (assoc key-2 </div><div class="line">                          (cdr subtable))))</div><div class="line">              (if record</div><div class="line">                  (set-cdr! record value)</div><div class="line">                  (set-cdr! </div><div class="line">                   subtable</div><div class="line">                   (cons (cons key-2 value)</div><div class="line">                         (cdr subtable)))))</div><div class="line">            (set-cdr! </div><div class="line">             local-table</div><div class="line">             (cons (list key-1</div><div class="line">                         (cons key-2 value))</div><div class="line">                   (cdr local-table)))))</div><div class="line">      'ok)</div><div class="line">    (define (dispatch m)</div><div class="line">      (cond ((eq? m 'lookup-proc) lookup)</div><div class="line">            ((eq? m 'insert-proc!) insert!)</div><div class="line">            (else (error "Unknown operation: </div><div class="line">                          TABLE" m))))</div><div class="line">    dispatch))</div></pre></td></tr></table></figure>
<p>利用make-table，我们可以实现get和put操作</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> operation-table (<span class="name">make-table</span>))</div><div class="line">(<span class="name">define</span> get (<span class="name">operation-table</span> 'lookup-proc))</div><div class="line">(<span class="name">define</span> put (<span class="name">operation-table</span> 'insert-proc!))</div></pre></td></tr></table></figure>
<p>这两个操作都访问同一个局部表格，这一表格被封装在由对make-table的调用创建起的对象里面。</p>
<h3 id="3-3-4-数字电路的模拟器"><a href="#3-3-4-数字电路的模拟器" class="headerlink" title="3.3.4 数字电路的模拟器"></a>3.3.4 数字电路的模拟器</h3><p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190618100752926.png" alt="image-20190618100752926"></p>
<p>连接基本组件来构造更复杂的功能。比如下面的<strong>半加器</strong>电路，包括一个或门，两个与门和一个非门。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190618101130329.png" alt="image-20190618101130329"></p>
<p>当A=1或B=1之一是1时，S=1，当A=1且B=1时，C=1。</p>
<blockquote>
<p><strong>半加器</strong></p>
<p>半加器是实现两个一位二进制数加法运算的器件。它具有两个输入端(被加数A和加数B)及输出端Y。 [1] </p>
<p>A和B是相加的两个数，S是半加和数，C是进位数。</p>
<p>所谓半加就是不考虑进位的加法，它的真值表如下 (见表)：</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190618103146103.png" alt="image-20190618103146103"></p>
</blockquote>
<p>现在要构造一个程序来模拟数字逻辑电路。最基本元素是make-wire，用于构造连线。比如可以构造出</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> a (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> b (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> c (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> d (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> e (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> s (<span class="name">make-wire</span>))</div></pre></td></tr></table></figure>
<p>如果需要把一个功能连到一组连线上，就调用一个构造这类功能的过程，参数就是连线。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(<span class="name">or-gate</span> a b d)</div><div class="line">ok</div><div class="line"></div><div class="line">(<span class="name">and-gate</span> a b c)</div><div class="line">ok</div><div class="line"></div><div class="line">(<span class="name">inverter</span> c e)</div><div class="line">ok</div><div class="line"></div><div class="line">(<span class="name">and-gate</span> d e s)</div><div class="line">ok</div></pre></td></tr></table></figure>
<p>再拼接成<strong>半加器</strong>。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">half-adder</span> a b s c)</div><div class="line">  (<span class="name">let</span> ((<span class="name">d</span> (<span class="name">make-wire</span>)) (<span class="name">e</span> (<span class="name">make-wire</span>)))</div><div class="line">    (<span class="name">or-gate</span> a b d)</div><div class="line">    (<span class="name">and-gate</span> a b c)</div><div class="line">    (<span class="name">inverter</span> c e)</div><div class="line">    (<span class="name">and-gate</span> d e s)</div><div class="line">    'ok))</div></pre></td></tr></table></figure>
<p>在这个基础上，可以再构建<strong>全加器</strong>。</p>
<blockquote>
<p><strong>全加器</strong></p>
<p>全加器能进行加数、被加数和低位来的进位信号相加，并根据求和结果给出该位的进位信号。</p>
<p>当多位数相加时，半加器可用于最低位求和，并给出进位数。第二位的相加有两个待加数和，还有一个来自前面低位送来的进位数。这三个数相加，得出本位和数（全加和数）和进位数。这种就是“全加“，下表为全加器的逻辑状态表。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/o4YBAFtYGTaAfKmzAAAvuawUHgA437.png" alt="åå å¨åå¨å å¨çåçååºå«ï¼ç»æååè½ï¼"></p>
</blockquote>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">full-adder</span> a b c-in sum c-out)</div><div class="line">  (<span class="name">let</span> ((<span class="name">c1</span> (<span class="name">make-wire</span>)) </div><div class="line">        (<span class="name">c2</span> (<span class="name">make-wire</span>))</div><div class="line">        (<span class="name">s</span>  (<span class="name">make-wire</span>)))</div><div class="line">    (<span class="name">half-adder</span> b c-in s c1)</div><div class="line">    (<span class="name">half-adder</span> a s sum c2)</div><div class="line">    (<span class="name">or-gate</span> c1 c2 c-out)</div><div class="line">    'ok))</div></pre></td></tr></table></figure>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190618113425796.png" alt="image-20190618113425796"></p>
<p>从模拟器的角度，各种功能块构成了基础，将功能块连接起来就是这里的组合方法，而将特定的连接模式定义为过程就是这里的抽象方法。</p>
<h4 id="基本功能块"><a href="#基本功能块" class="headerlink" title="基本功能块"></a><strong>基本功能块</strong></h4><p>基本功能块使得在一根连线上的信号变化能够影响其他连线上的信号。我们添加如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(get-signal ⟨wire⟩)</div></pre></td></tr></table></figure>
<p>返回连线上信号的当前值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(set-signal! ⟨wire⟩ ⟨new value⟩)</div></pre></td></tr></table></figure>
<p>将连线上信号修改为新的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(add-action! ⟨wire⟩ ⟨procedure of no arguments⟩)</div></pre></td></tr></table></figure>
<p>改变信号值就需要执行该过程。这种过程是一些媒介，能够将相应连线上值的变化传递到其他的连线。</p>
<p>利用这些过程，可以定义基本的数字逻辑功能了。为了把输入通过一个反门连接到输出，用add-action! 为输入关联一个过程，当输入路线的值改变时，执行这一过程。</p>
<p>先看<strong>非门</strong>，在一个inverter-delay后将输出线路设置为这个新值。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">inverter</span> input output)</div><div class="line">  (<span class="name">define</span> (<span class="name">invert-input</span>)</div><div class="line">    (<span class="name">let</span> ((<span class="name">new-value</span> </div><div class="line">           (<span class="name">logical-not</span> (<span class="name">get-signal</span> input))))</div><div class="line">      (<span class="name">after-delay</span> </div><div class="line">       inverter-delay</div><div class="line">       (<span class="name">lambda</span> ()</div><div class="line">         (<span class="name">set-signal!</span> output new-value)))))</div><div class="line">  </div><div class="line">  (<span class="name">add-action!</span> input invert-input)</div><div class="line">  'ok)</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">logical-not</span> s)</div><div class="line">  (<span class="name">cond</span> ((<span class="name">=</span> s <span class="number">0</span>) <span class="number">1</span>)</div><div class="line">        ((<span class="name">=</span> s <span class="number">1</span>) <span class="number">0</span>)</div><div class="line">        (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Invalid signal"</span> s))))</div></pre></td></tr></table></figure>
<p>下面是<strong>与门</strong>的定义。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">and-gate</span> a1 a2 output)</div><div class="line">  (<span class="name">define</span> (<span class="name">and-action-procedure</span>)</div><div class="line">    (<span class="name">let</span> ((<span class="name">new-value</span></div><div class="line">           (<span class="name">logical-and</span> (<span class="name">get-signal</span> a1) </div><div class="line">                        (<span class="name">get-signal</span> a2))))</div><div class="line">      (<span class="name">after-delay</span> </div><div class="line">       and-gate-delay</div><div class="line">       (<span class="name">lambda</span> ()</div><div class="line">         (<span class="name">set-signal!</span> output new-value)))))</div><div class="line">  </div><div class="line">  (<span class="name">add-action!</span> a1 and-action-procedure)</div><div class="line">  (<span class="name">add-action!</span> a2 and-action-procedure)</div><div class="line">  'ok)</div></pre></td></tr></table></figure>
<h4 id="线路的表示"><a href="#线路的表示" class="headerlink" title="线路的表示"></a><strong>线路的表示</strong></h4><p>一条线路是一个具有两个局部状态变量的计算对象：一个是信号值signal-value（初值为0），一个是一组过程action-procedures，在信号值改变时，这些过程需要运行。类似于在3.1.1中处理银行账户的做法实现：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">(define (make-wire)</div><div class="line">  (let ((signal-value 0) </div><div class="line">        (action-procedures '()))</div><div class="line">       </div><div class="line">    (define (set-my-signal! new-value)</div><div class="line">      (if (not (= signal-value new-value))</div><div class="line">          (begin (set! signal-value new-value)</div><div class="line">                 (call-each </div><div class="line">                  action-procedures))</div><div class="line">          'done))</div><div class="line">       </div><div class="line">    (define (accept-action-procedure! proc)</div><div class="line">      (set! action-procedures </div><div class="line">            (cons proc action-procedures))</div><div class="line">      (proc))</div><div class="line">       </div><div class="line">    (define (dispatch m)</div><div class="line">      (cond ((eq? m 'get-signal) </div><div class="line">             signal-value)</div><div class="line">            ((eq? m 'set-signal!) </div><div class="line">             set-my-signal!)</div><div class="line">            ((eq? m 'add-action!) </div><div class="line">             accept-action-procedure!)</div><div class="line">            (else (error "Unknown operation: </div><div class="line">                          WIRE" m))))</div><div class="line">    dispatch))</div></pre></td></tr></table></figure>
<p><code>set-my-signal!</code>检查新的信号值是否实际改变了线路上的信号，如果是，就用<code>call-each</code>运行每个动作过程。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">call-each</span> procedures)</div><div class="line">  (<span class="name">if</span> (<span class="name">null</span>? procedures)</div><div class="line">      'done</div><div class="line">      (<span class="name">begin</span> ((<span class="name">car</span> procedures))</div><div class="line">             (<span class="name">call-each</span> (<span class="name">cdr</span> procedures)))))</div></pre></td></tr></table></figure>
<p>一旦设置好dispatch过程，就可以提供以下访问线路中局部操作的过程：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">get-signal</span> wire)</div><div class="line">  (<span class="name">wire</span> 'get-signal))</div><div class="line">(<span class="name">define</span> (<span class="name">set-signal!</span> wire new-value)</div><div class="line">  ((<span class="name">wire</span> 'set-signal!) new-value))</div><div class="line">(<span class="name">define</span> (<span class="name">add-action!</span> wire action-procedure)</div><div class="line">  ((<span class="name">wire</span> 'add-action!) action-procedure))</div></pre></td></tr></table></figure>
<h4 id="待处理表agenda"><a href="#待处理表agenda" class="headerlink" title="待处理表agenda"></a><strong>待处理表agenda</strong></h4><p>最后是after-delay的实现。要维护一个称为待处理表的数据结构，包含需要完成的事项清单。定义如下操作：</p>
<ul>
<li><code>(make-agenda)</code> 返回一个新的空agenda.</li>
<li><code>(empty-agenda? ⟨agenda⟩)</code> .</li>
<li><code>(first-agenda-item ⟨agenda⟩)</code> 返回agenda第一个item.</li>
<li><code>(remove-first-agenda-item! ⟨agenda⟩)</code> .</li>
<li><code>(add-to-agenda! ⟨time⟩ ⟨action⟩ ⟨agenda⟩)</code> </li>
<li><code>(current-time ⟨agenda⟩)</code> 返回当时的模拟时间。</li>
</ul>
<p>用<code>the-agenda</code>表示特定的待处理表。以下过程向<code>the-agenda</code>中插入一个新item</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">after-delay</span> delay action)</div><div class="line">  (<span class="name">add-to-agenda!</span> </div><div class="line">   (<span class="name">+</span> delay (<span class="name">current-time</span> the-agenda))</div><div class="line">   action</div><div class="line">   the-agenda))</div></pre></td></tr></table></figure>
<p>agenda中的模拟过程用propagate实现，它操作<code>the-agenda</code>，顺序执行agenda的每个过程。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">propagate</span>)</div><div class="line">  (<span class="name">if</span> (<span class="name">empty-agenda</span>? the-agenda)</div><div class="line">      'done</div><div class="line">      (<span class="name">let</span> ((<span class="name">first-item</span> </div><div class="line">             (<span class="name">first-agenda-item</span> the-agenda)))</div><div class="line">        (<span class="name">first-item</span>)</div><div class="line">        (<span class="name">remove-first-agenda-item!</span> the-agenda)</div><div class="line">        (<span class="name">propagate</span>))))</div></pre></td></tr></table></figure>
<h4 id="一个简单的实例模拟"><a href="#一个简单的实例模拟" class="headerlink" title="一个简单的实例模拟"></a>一个简单的实例模拟</h4><p>下面过程将一个<strong>监测器</strong>放到一个线路上，用于显示模拟器的活动。这一过程会告诉相应线路，只要它的值改变了，就打印出新的值，同时打印当前时间和线路名称。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">probe</span> name wire)</div><div class="line">  (<span class="name">add-action!</span> </div><div class="line">   wire</div><div class="line">   (<span class="name">lambda</span> ()</div><div class="line">     (<span class="name">newline</span>)</div><div class="line">     (<span class="name">display</span> name)</div><div class="line">     (<span class="name">display</span> <span class="string">" "</span>)</div><div class="line">     (<span class="name">display</span> (<span class="name">current-time</span> the-agenda))</div><div class="line">     (<span class="name">display</span> <span class="string">"  New-value = "</span>)</div><div class="line">     (<span class="name">display</span> (<span class="name">get-signal</span> wire)))))</div></pre></td></tr></table></figure>
<p>我们从初始化待处理表和描述各种功能块的延时开始</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> the-agenda (<span class="name">make-agenda</span>))</div><div class="line">(<span class="name">define</span> inverter-delay <span class="number">2</span>)</div><div class="line">(<span class="name">define</span> and-gate-delay <span class="number">3</span>)</div><div class="line">(<span class="name">define</span> or-gate-delay <span class="number">5</span>)</div></pre></td></tr></table></figure>
<p>现在定义4条线路，在其中两条线路上安装监测器</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> input-1 (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> input-2 (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> sum (<span class="name">make-wire</span>))</div><div class="line">(<span class="name">define</span> carry (<span class="name">make-wire</span>))</div><div class="line"></div><div class="line">(<span class="name">probe</span> 'sum sum)</div><div class="line">sum <span class="number">0</span>  New-value = <span class="number">0</span></div><div class="line"></div><div class="line">(<span class="name">probe</span> 'carry carry)</div><div class="line">carry <span class="number">0</span>  New-value = <span class="number">0</span></div></pre></td></tr></table></figure>
<p>然后将这些线路连接到一个半加器电路上</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(<span class="name">half-adder</span> input-1 input-2 sum carry)</div><div class="line">ok</div><div class="line"></div><div class="line">(<span class="name">set-signal!</span> input-1 <span class="number">1</span>)</div><div class="line">done</div><div class="line"></div><div class="line">(<span class="name">propagate</span>)</div><div class="line">sum <span class="number">8</span>  New-value = <span class="number">1</span></div><div class="line">done</div></pre></td></tr></table></figure>
<p>在时间8, sum上的信号变为1。现在到了模拟开始之后的8个时间单位。在这一点上，我们可 以将input-2上的信号设置为1，并让有关的值向前传播：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">set-signal!</span> input-2 <span class="number">1</span>)</div><div class="line">done</div><div class="line"></div><div class="line">(<span class="name">propagate</span>)</div><div class="line">carry <span class="number">11</span>  New-value = <span class="number">1</span></div><div class="line">sum <span class="number">16</span>  New-value = <span class="number">0</span></div><div class="line">done</div></pre></td></tr></table></figure>
<p>在时间11处，carry变成1，16处sum变成0。</p>
<h4 id="agenda的实现"><a href="#agenda的实现" class="headerlink" title="agenda的实现"></a>agenda的实现</h4><p>这种待处理表由一些时间段组成，每个时间段是由一个数值（表示时间）和一个队列(见练习3.32)组成的序对，在这个队列里，保存着那些已经安排好的，应该在这一时间段运行的过程。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-time-segment</span> time queue)</div><div class="line">  (<span class="name">cons</span> time queue))</div><div class="line">(<span class="name">define</span> (<span class="name">segment-time</span> s) (<span class="name">car</span> s))</div><div class="line">(<span class="name">define</span> (<span class="name">segment-queue</span> s) (<span class="name">cdr</span> s))</div></pre></td></tr></table></figure>
<p>我们将用3.3.2节描述的队列操作完成在时间段队列上的操作。<br>待处理表本身就是时间段的一个一维表格。与3.3.3节所示的表格的不同之处，就在于这 些时间段应该按照时间递增的顺序排列。此外，我们还需在待处理表的头部保存一个当前时 间（即，此前最后被处理的那个动作的时间）。一个新构造出的待处理表里没有时间段，其当前时间是0。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-agenda</span>) (<span class="name">list</span> <span class="number">0</span>))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">current-time</span> agenda) (<span class="name">car</span> agenda))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">set-current-time!</span> agenda time)</div><div class="line">  (<span class="name">set-car!</span> agenda time))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">segments</span> agenda) (<span class="name">cdr</span> agenda))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">set-segments!</span> agenda segments)</div><div class="line">  (<span class="name">set-cdr!</span> agenda segments))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">first-segment</span> agenda) </div><div class="line">  (<span class="name">car</span> (<span class="name">segments</span> agenda)))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">rest-segments</span> agenda) </div><div class="line">  (<span class="name">cdr</span> (<span class="name">segments</span> agenda)))</div></pre></td></tr></table></figure>
<p>若一个agenda没有时间段，那它就是空的</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">empty-agenda</span>? agenda)</div><div class="line">  (<span class="name">null</span>? (<span class="name">segments</span> agenda)))</div></pre></td></tr></table></figure>
<p>为了将一个动作加入待处理表，</p>
<p>1）我们首先要检査这个待处理表是否为空。如果真是这样，那么就<strong>创建一个新的时间段</strong>，并将这个时间段装入待处理表里。</p>
<p>2）否则我们就扫描整个的待处理表，检査其中各个时间段的时间。如果发现某个时间段具有合适的时间，那么就把这个动作加入与之关联的队列里。如果碰到了某个比需要预约的时间更晚的时间，那么就将一个新的时间段插入待处理表，插入这个位置之前。如果到达了待处理表的末尾，我们就必须在最后加上一个新的时间段。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">add-to-agenda!</span> time action agenda)</div><div class="line">  (<span class="name">define</span> (<span class="name">belongs-before</span>? segments)</div><div class="line">    (<span class="name">or</span> (<span class="name">null</span>? segments)</div><div class="line">        (<span class="name">&lt;</span> time </div><div class="line">           (<span class="name">segment-time</span> (<span class="name">car</span> segments)))))</div><div class="line">  </div><div class="line">  (<span class="name">define</span> (<span class="name">make-new-time-segment</span> time action)</div><div class="line">    (<span class="name">let</span> ((<span class="name">q</span> (<span class="name">make-queue</span>)))</div><div class="line">      (<span class="name">insert-queue!</span> q action)</div><div class="line">      (<span class="name">make-time-segment</span> time q)))</div><div class="line">  </div><div class="line">  (<span class="name">define</span> (<span class="name">add-to-segments!</span> segments)</div><div class="line">    (<span class="name">if</span> (<span class="name">=</span> (<span class="name">segment-time</span> (<span class="name">car</span> segments)) time)</div><div class="line">        (<span class="name">insert-queue!</span> </div><div class="line">         (<span class="name">segment-queue</span> (<span class="name">car</span> segments))</div><div class="line">         action)</div><div class="line">        (<span class="name">let</span> ((<span class="name">rest</span> (<span class="name">cdr</span> segments)))</div><div class="line">          (<span class="name">if</span> (<span class="name">belongs-before</span>? rest)</div><div class="line">              (<span class="name">set-cdr!</span></div><div class="line">               segments</div><div class="line">               (<span class="name">cons</span> (<span class="name">make-new-time-segment</span> </div><div class="line">                      time </div><div class="line">                      action)</div><div class="line">                     (<span class="name">cdr</span> segments)))</div><div class="line">              (<span class="name">add-to-segments!</span> rest)))))</div><div class="line">  (<span class="name">let</span> ((<span class="name">segments</span> (<span class="name">segments</span> agenda)))</div><div class="line">    (<span class="name">if</span> (<span class="name">belongs-before</span>? segments)</div><div class="line">        (<span class="name">set-segments!</span></div><div class="line">         agenda</div><div class="line">         (<span class="name">cons</span> (<span class="name">make-new-time-segment</span> </div><div class="line">                time </div><div class="line">                action)</div><div class="line">               segments))</div><div class="line">        (<span class="name">add-to-segments!</span> segments))))</div></pre></td></tr></table></figure>
<p>从待处理表中<strong>删除第一项</strong>的过程，应该删去第一个时间段的队列前端的那一项。如果删 除使这个时间段变空了，我们就将这个时间段也从时间段的表里删去:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">remove-first-agenda-item!</span> agenda)</div><div class="line">  (<span class="name">let</span> ((<span class="name">q</span> (<span class="name">segment-queue</span> </div><div class="line">            (<span class="name">first-segment</span> agenda))))</div><div class="line">    (<span class="name">delete-queue!</span> q)</div><div class="line">    (<span class="name">if</span> (<span class="name">empty-queue</span>? q)</div><div class="line">        (<span class="name">set-segments!</span> </div><div class="line">         agenda </div><div class="line">         (<span class="name">rest-segments</span> agenda)))))</div></pre></td></tr></table></figure>
<p>找出待处理表中里第一项，也就是找出其第一个时间段队列里的第一项。无论何时提取 这个项时，都需要更新待处理表的当前时间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(define (first-agenda-item agenda)</div><div class="line">  (if (empty-agenda? agenda)</div><div class="line">      (error "Agenda is empty: </div><div class="line">              FIRST-AGENDA-ITEM")</div><div class="line">      (let ((first-seg </div><div class="line">             (first-segment agenda)))</div><div class="line">        (set-current-time! </div><div class="line">         agenda </div><div class="line">         (segment-time first-seg))</div><div class="line">        (front-queue </div><div class="line">         (segment-queue first-seg)))))</div></pre></td></tr></table></figure>
<h3 id="3-3-5-约束的传播"><a href="#3-3-5-约束的传播" class="headerlink" title="3.3.5 约束的传播"></a>3.3.5 约束的传播</h3><p>在传统上，<strong>计算机程序总被组织成一种单向的计算，它们对一些事先给定的参数执行某些操作，产生出所需要的输出。</strong>但在另一方面，我们也经常需要模拟一些<strong>由各种量之间的关系描述的系统</strong>。例如，某个机械结构的数学模型里可能包含着这样的一些信息：在一个金属杆的偏转量d与作用于这个杆的力F、杆的长度L、截面面积A和弹性模数之间的关系可以由下面方程描述</p>
<script type="math/tex; mode=display">
dAE=FL</script><p>这种关系并不是单向的，<strong>给定了其中任意的4个量，我们就可以利用它计算出第5个量</strong>。然而，<strong>要将这种方程翻译到传统的程序设计语言，就会迫使我们选出一个量，要求基于另外的4个量去计算出它</strong>。这样，一个用于计算面积A的过程将不能用于计算偏转量。虽然对于A和d的计算都出自这同一个方程。</p>
<p>在这一节里，我们要描绘一种语言的设计，这种语言将使我们可以基于各种关系进行工作。这一语言里的基本元素就是基本约束，它们描述了在不同量之间的某种特定关系。例如，<code>(adder a b c)</code>描述的是量a、b和c之间必须有关系$a+b=c$，<code>(multiplier x y z)</code>描述的是约束关系$xy=z$，而<code>(constant 3.14 x)</code>表示x的值永远都是3.14。</p>
<p>我们的语言里还提供了一些方法，使它们可以用于组合各种基本约束，以便去描述更复杂的关系。在这里，我们将通过构造<strong>约束网络</strong>的方式组合起各种约束，在这种约束网络里，约束通过<strong>连接器</strong>连接起来。连接器是一种对象，它们可以“保存”一个值，使之能参与一个<br>或者多个约束。例如，我们知道在华氏温度和摄氏温度之间的关系是：</p>
<script type="math/tex; mode=display">
9C=5(F-32)</script><p>这样的约束就可以看做是一个网络。通过基本<strong>加法约束</strong>、<strong>乘法约束</strong>和<strong>常量约束</strong>组成。在这个图里，我们看到左边的乘法块有三个引线，分别标记为 m1 、 m2 和p。该乘法约束的这些引线以如下方式连接到网络的其他部分：引线 m1连到连接器 C ，这个连接器将保存摄氏温度。引线 m2 接在连接器 w ，该连接器还连接着一个保存常量 9 的约束块。引线 p 被这一乘法块约束到 m1和 m2 的乘积，它还连接到另一个乘法块的引线p。另一乘法块的 m2连接到常量 5 ，它的 m1 连接到另一加法块的一条引线上。</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/image-20190618163207055.png" alt="image-20190618163207055"></p>
<h4 id="约束系统的使用"><a href="#约束系统的使用" class="headerlink" title="约束系统的使用"></a>约束系统的使用</h4><p>首先调用构造函数make-connector，创建起两个连接器C和F</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> C (<span class="name">make-connector</span>))</div><div class="line">(<span class="name">define</span> F (<span class="name">make-connector</span>))</div><div class="line">(<span class="name">celsius-fahrenheit-converter</span> C F)</div><div class="line">ok</div></pre></td></tr></table></figure>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">celsius-fahrenheit-converter</span> c f)</div><div class="line">  (<span class="name">let</span> ((<span class="name">u</span> (<span class="name">make-connector</span>))</div><div class="line">        (<span class="name">v</span> (<span class="name">make-connector</span>))</div><div class="line">        (<span class="name">w</span> (<span class="name">make-connector</span>))</div><div class="line">        (<span class="name">x</span> (<span class="name">make-connector</span>))</div><div class="line">        (<span class="name">y</span> (<span class="name">make-connector</span>)))</div><div class="line">    (<span class="name">multiplier</span> c w u)</div><div class="line">    (<span class="name">multiplier</span> v x u)</div><div class="line">    (<span class="name">adder</span> v y f)</div><div class="line">    (<span class="name">constant</span> <span class="number">9</span> w)</div><div class="line">    (<span class="name">constant</span> <span class="number">5</span> x)</div><div class="line">    (<span class="name">constant</span> <span class="number">32</span> y)</div><div class="line">    'ok))</div></pre></td></tr></table></figure>
<h4 id="约束系统的实现"><a href="#约束系统的实现" class="headerlink" title="约束系统的实现"></a>约束系统的实现</h4><p>类似于数字电路模拟器。虽然约束系统里的基本对象在某些方面更复杂一些,但整个系统却更为简单,因为这里完全不需要关心待处理表和时间延迟等等问题。</p>
<p>连接器的基本操作包括</p>
<ul>
<li><code>(has-value? ⟨connector⟩)</code> .</li>
<li><code>(get-value ⟨connector⟩)</code> .</li>
<li><code>(set-value! ⟨connector⟩ ⟨new-value⟩ ⟨informant⟩)</code> </li>
<li><code>(forget-value! ⟨connector⟩ ⟨retractor⟩)</code> 要求连接器忘记改值。</li>
<li><code>(connect ⟨connector⟩ ⟨new-constraint⟩)</code> 通过连接器参与一个新约束。</li>
</ul>
<p>通过<code>inform-about-value</code>与各个相关约束通信，这一过程告知给定的约束，该连接器有了新值。而<code>inform-about-no-value</code>告知该连接器丧失了原有的值。</p>
<p><code>adder</code>在被求和连接器a1和a2和连接器sum之间构造出一个加法约束。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">; adder将一个新的加法约束连接到指定连接器。me就代表那个加法约束。</div><div class="line">(define (adder a1 a2 sum)</div><div class="line">  ; 当加法约束得到了通知，知道自己的一个连接器有了新值后，process-new-value就会被调用。</div><div class="line">  (define (process-new-value)</div><div class="line">    (cond ((and (has-value? a1) </div><div class="line">                (has-value? a2))</div><div class="line">           (set-value! sum</div><div class="line">                       (+ (get-value a1) </div><div class="line">                          (get-value a2))</div><div class="line">                       me))</div><div class="line">          ((and (has-value? a1) </div><div class="line">                (has-value? sum))</div><div class="line">           (set-value! a2</div><div class="line">                       (- (get-value sum) </div><div class="line">                          (get-value a1))</div><div class="line">                       me))</div><div class="line">          ((and (has-value? a2) </div><div class="line">                (has-value? sum))</div><div class="line">           (set-value! a1</div><div class="line">                       (- (get-value sum) </div><div class="line">                          (get-value a2))</div><div class="line">                       me))))</div><div class="line">  ; 如果加法对象被告知自己的一个连接器丢失了值，就要求所有连接器丢掉值，然后再执行process-new-value。</div><div class="line">  (define (process-forget-value)</div><div class="line">    (forget-value! sum me)</div><div class="line">    (forget-value! a1 me)</div><div class="line">    (forget-value! a2 me)</div><div class="line">    (process-new-value))</div><div class="line">  </div><div class="line">  (define (me request)</div><div class="line">    (cond ((eq? request 'I-have-a-value)</div><div class="line">           (process-new-value))</div><div class="line">          ((eq? request 'I-lost-my-value)</div><div class="line">           (process-forget-value))</div><div class="line">          (else (error "Unknown request: </div><div class="line">                        ADDER" request))))</div><div class="line">  (connect a1 me)</div><div class="line">  (connect a2 me)</div><div class="line">  (connect sum me)</div><div class="line">  me)</div></pre></td></tr></table></figure>
<p><code>adder</code>将一个新的加法约束连接到指定连接器。<code>me</code>就代表那个加法约束。</p>
<p>当加法约束得到了通知，知道自己的一个连接器有了新值后，<code>process-new-value</code>就会被调用。</p>
<p>如果加法对象被告知自己的一个连接器丢失了值，就要求所有连接器丢掉值，然后再执行<code>process-new-value</code>。</p>
<p>乘法对象类似于加法对象。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">(define (multiplier m1 m2 product)</div><div class="line">  </div><div class="line">  (define (process-new-value)</div><div class="line">    (cond ((or (and (has-value? m1) </div><div class="line">                    (= (get-value m1) 0))</div><div class="line">               (and (has-value? m2) </div><div class="line">                    (= (get-value m2) 0)))</div><div class="line">           (set-value! product 0 me))</div><div class="line">          ((and (has-value? m1) </div><div class="line">                (has-value? m2))</div><div class="line">           (set-value! product</div><div class="line">                       (* (get-value m1) </div><div class="line">                          (get-value m2))</div><div class="line">                       me))</div><div class="line">          ((and (has-value? product) </div><div class="line">                (has-value? m1))</div><div class="line">           (set-value! m2</div><div class="line">                       (/ (get-value product) </div><div class="line">                          (get-value m1))</div><div class="line">                       me))</div><div class="line">          ((and (has-value? product) </div><div class="line">                (has-value? m2))</div><div class="line">           (set-value! m1</div><div class="line">                       (/ (get-value product) </div><div class="line">                          (get-value m2))</div><div class="line">                       me))))</div><div class="line">  </div><div class="line">  (define (process-forget-value)</div><div class="line">    (forget-value! product me)</div><div class="line">    (forget-value! m1 me)</div><div class="line">    (forget-value! m2 me)</div><div class="line">    (process-new-value))</div><div class="line">  (define (me request)</div><div class="line">    (cond ((eq? request 'I-have-a-value)</div><div class="line">           (process-new-value))</div><div class="line">          ((eq? request 'I-lost-my-value)</div><div class="line">           (process-forget-value))</div><div class="line">          (else</div><div class="line">           (error "Unknown request: </div><div class="line">                   MULTIPLIER" </div><div class="line">                  request))))</div><div class="line">  (connect m1 me)</div><div class="line">  (connect m2 me)</div><div class="line">  (connect product me)</div><div class="line">  me)</div></pre></td></tr></table></figure>
<p>最后，<strong>监视器</strong>在指定连接器被设置或取消值的时候打印出一个消息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(define (probe name connector)</div><div class="line">  (define (print-probe value)</div><div class="line">    (newline) (display "Probe: ")</div><div class="line">    (display name) (display " = ")</div><div class="line">    (display value))</div><div class="line">  (define (process-new-value)</div><div class="line">    (print-probe (get-value connector)))</div><div class="line">  (define (process-forget-value)</div><div class="line">    (print-probe "?"))</div><div class="line">  (define (me request)</div><div class="line">    (cond ((eq? request 'I-have-a-value)</div><div class="line">           (process-new-value))</div><div class="line">          ((eq? request 'I-lost-my-value)</div><div class="line">           (process-forget-value))</div><div class="line">          (else (error "Unknown request: </div><div class="line">                        PROBE" request))))</div><div class="line">  (connect connector me)</div><div class="line">  me)</div></pre></td></tr></table></figure>
<h4 id="连接器的表示"><a href="#连接器的表示" class="headerlink" title="连接器的表示"></a>连接器的表示</h4><p>连接器用带有局部状态变量value，informant和constraint的过程对象表示，value中保存这个连接器的当前值，informant是设置连接器值的对象，constraint是这一连接器所涉及的所有约束的表。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">(define (make-connector)</div><div class="line">  (let ((value false) </div><div class="line">        (informant false) </div><div class="line">        (constraints '()))</div><div class="line">    ; 当出现了设置一个连接器的要求时，该连接器的局部过程set-my-value就会被调用。</div><div class="line">    (define (set-my-value newval setter)</div><div class="line">      ; 如果这一连接器当时并没有值，那么它就设置自己的值，并在informant里记录下要求设置当前值的那个约束</div><div class="line">      (cond ((not (has-value? me))</div><div class="line">             (set! value newval)</div><div class="line">             (set! informant setter)</div><div class="line">             ; 而后这一连接器将通知它所参与的所有约束，除了刚刚要求设置值的那个约束之外</div><div class="line">             (for-each-except </div><div class="line">              setter</div><div class="line">              inform-about-value</div><div class="line">              constraints))</div><div class="line">            ((not (= value newval))</div><div class="line">             (error "Contradiction" </div><div class="line">                    (list value newval)))</div><div class="line">            (else 'ignored)))</div><div class="line">       </div><div class="line">    ; 当连接器被要求忘记自己的值时，它就会去运行局部过程forget-my-value。</div><div class="line">    (define (forget-my-value retractor)</div><div class="line">      ; 首先检査这一要求是否来自原先设置值的同一个对象</div><div class="line">      (if (eq? retractor informant)</div><div class="line">          (begin (set! informant false)</div><div class="line">                 ; 如果情况确实如此，连接器就通知它所参与的所有约束，告知它们自己的值已经没有了。</div><div class="line">                 (for-each-except </div><div class="line">                  retractor</div><div class="line">                  inform-about-no-value</div><div class="line">                  constraints))</div><div class="line">          'ignored))</div><div class="line">       </div><div class="line">    ; connect向约束表里加入一个新约束（如果它以前不在表里)。如果这个连接器已经有值，它就会将这一事实通知这个新约束。</div><div class="line">    (define (connect new-constraint)</div><div class="line">      (if (not (memq new-constraint </div><div class="line">                     constraints))</div><div class="line">          (set! constraints</div><div class="line">                (cons new-constraint </div><div class="line">                      constraints)))</div><div class="line">      (if (has-value? me)</div><div class="line">          (inform-about-value new-constraint))</div><div class="line">      'done)</div><div class="line">       </div><div class="line">    ; 连接器过程me完成对于内部过程服务的分派工作，它同时也作为这个连接器对象的代表</div><div class="line">    (define (me request)</div><div class="line">      (cond ((eq? request 'has-value?)</div><div class="line">             (if informant true false))</div><div class="line">            ((eq? request 'value) value)</div><div class="line">            ((eq? request 'set-value!) </div><div class="line">             set-my-value)</div><div class="line">            ((eq? request 'forget) </div><div class="line">             forget-my-value)</div><div class="line">            ((eq? request 'connect) connect)</div><div class="line">            (else (error "Unknown operation: </div><div class="line">                          CONNECTOR"</div><div class="line">                         request))))</div><div class="line">    me))</div></pre></td></tr></table></figure>
<p>当出现了设置一个连接器的要求时，该连接器的局部过程set-my-value就会被调用。如果这一连接器当时并没有值，那么它就设置自己的值，并在informant里记录下要求设置当前值的那个约束。而后这一连接器将通知它所参与的所有约束，除了刚刚要求设置值的<br>那个约束之外。这一工作通过下面的迭代过程完成，它将一个指定过程应用于一个表中的所有对象，除了一个给定的例外：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; 将一个指定过程应用于一个表中的所有对象</span></div><div class="line">(<span class="name">define</span> (<span class="name">for-each-except</span> exception </div><div class="line">                         procedure </div><div class="line">                         list)</div><div class="line">  (<span class="name">define</span> (<span class="name">loop</span> items)</div><div class="line">    (<span class="name">cond</span> ((<span class="name">null</span>? items) 'done)</div><div class="line">          ((<span class="name">eq</span>? (<span class="name">car</span> items) exception) </div><div class="line">           (<span class="name">loop</span> (<span class="name">cdr</span> items)))</div><div class="line">          (<span class="name">else</span> (<span class="name">procedure</span> (<span class="name">car</span> items))</div><div class="line">                (<span class="name">loop</span> (<span class="name">cdr</span> items)))))</div><div class="line">  (<span class="name">loop</span> list))</div></pre></td></tr></table></figure>
<p>下面几个过程为分派提供了一个语法界面：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">has-value</span>? connector)</div><div class="line">  (<span class="name">connector</span> 'has-value?))</div><div class="line">(<span class="name">define</span> (<span class="name">get-value</span> connector)</div><div class="line">  (<span class="name">connector</span> 'value))</div><div class="line">(<span class="name">define</span> (<span class="name">set-value!</span> connector </div><div class="line">                    new-value </div><div class="line">                    informant)</div><div class="line">  ((<span class="name">connector</span> 'set-value!) </div><div class="line">   new-value </div><div class="line">   informant))</div><div class="line">(<span class="name">define</span> (<span class="name">forget-value!</span> connector retractor)</div><div class="line">  ((<span class="name">connector</span> 'forget) retractor))</div><div class="line">(<span class="name">define</span> (<span class="name">connect</span> connector new-constraint)</div><div class="line">  ((<span class="name">connector</span> 'connect) new-constraint))</div></pre></td></tr></table></figure>
<h2 id="3-4-并发：时间是一个本质问题"><a href="#3-4-并发：时间是一个本质问题" class="headerlink" title="3.4 并发：时间是一个本质问题"></a>3.4 并发：时间是一个本质问题</h2><p>在并发的情况下，由赋值引入的复杂性问题将变得更加严重。</p>
<h3 id="3-4-1-并发系统中时间的性质"><a href="#3-4-1-并发系统中时间的性质" class="headerlink" title="3.4.1 并发系统中时间的性质"></a>3.4.1 并发系统中时间的性质</h3><p>假设由Peter和Paul进行的取款被实现为两个独立的进程，共享同一个变量balance</p>
<p><img src="/2017/07/12/读书/计算机程序的构造和解释/CH3/pic/TB2lzajiVXXXXcHXXXXXXXXXXXX_!!581166664.png" alt="Peterä¸Paulåæ¶ååä¸ä¸ªè´¦æ·çä¸ç§åºæ¯"></p>
<p><strong>并发程序的正确行为</strong></p>
<ul>
<li>1）对并发地一种可能限制方式是：规定能修改共享状态变量的两个操作都不允许同时发生。（<strong>低效</strong>）</li>
<li>2）另一种不严厉的方式是：保证并发系统产生的结果与各个进程<strong>按照某种方式顺序运行产生出的结果</strong>完全一样。<ul>
<li>2.1）它并没有要求各个进程实际上顺序地运行，而只是要求它们<strong>产生的结果与 <em>假设</em> 它们顺序运行所产生的结果相同</strong>。</li>
<li>2.2）一个并发程序完全可能产生多于一个 “正确的” 结果，因为我们只要求其结果与按照 <em>某种</em> 方式顺序化的结果相同。</li>
</ul>
</li>
</ul>
<p>对于2.2），比如Peter和Paul的共享账户有100，Peter存入40，同时Paul取出账户中钱的一半。则可能产生两种余额，70或90。</p>
<h3 id="3-4-2-控制并发的机制"><a href="#3-4-2-控制并发的机制" class="headerlink" title="3.4.2 控制并发的机制"></a>3.4.2 控制并发的机制</h3><p>在设计并发系统时，设法做出一些一般性的机制，使我们可能<strong>限制并行进程之间的交错情况</strong>，以保证程序具有正确的行为方式。<br>人们已经为此目的而开发了许多不同的机制，我们讨论其中的一种：<strong>串行化组</strong>（serializer）</p>
<p><strong>对共享变量的串行访问</strong></p>
<p><strong>串行化</strong>：使进程可以并发地执行，但是其中也有一些过程不能并发地执行。</p>
<p>Scheme的串行化</p>
<p>通过<strong>串行化组</strong>实现这种限制。构造的方式是调用make-serializer，这一过程的实现将在后面给出。对一个给定串行化组的所有调用返回的串行化过程都属于同一个集合。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-account</span> balance)</div><div class="line">  (<span class="name">define</span> (<span class="name">withdraw</span> amount)</div><div class="line">    (<span class="name">if</span> (<span class="name">&gt;=</span> balance amount)</div><div class="line">        (<span class="name">begin</span> (<span class="name">set!</span> balance (<span class="name">-</span> balance amount))</div><div class="line">               balance)</div><div class="line">        <span class="string">"Insufficient funds"</span>))</div><div class="line">  </div><div class="line">  (<span class="name">define</span> (<span class="name">deposit</span> amount)</div><div class="line">    (<span class="name">set!</span> balance (<span class="name">+</span> balance amount))</div><div class="line">    balance)</div><div class="line"></div><div class="line">  <span class="comment">; 关键改动</span></div><div class="line">  (<span class="name">let</span> ((<span class="name">protected</span> (<span class="name">make-serializer</span>)))</div><div class="line">    (<span class="name">define</span> (<span class="name">dispatch</span> m)</div><div class="line">      (<span class="name">cond</span> ((<span class="name">eq</span>? m 'withdraw) (<span class="name">protected</span> withdraw))</div><div class="line">            ((<span class="name">eq</span>? m 'deposit) (<span class="name">protected</span> deposit))</div><div class="line">            ((<span class="name">eq</span>? m 'balance) deposit)</div><div class="line">            (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Unknown request -- MAKE-ACCOUNT"</span></div><div class="line">                         m))))</div></pre></td></tr></table></figure>
<p><strong>使用多重共享资源的复杂性</strong></p>
<p>如果只存在一个共享资源（如银行账户），串行化的使用问题相对简单。如果存在多项共享资源，并发程序的设计就可能变得非常难以把握了。</p>
<p>比如现在可以交换两个账户的余额。假设Peter和Paul都能访问账户a1, a2, a3。Peter要交换a1和a3，同时Paul要交换a1和a2，虽然对单个账户做了串行化，但交换操作还是可能产生不正确的结果。</p>
<p><strong>串行化的实现</strong></p>
<p>使用<strong>互斥元（mutex）</strong>的同步机制来实现串行化。mutex是一种对象，提供两种操作</p>
<p>1）获取（acquired）</p>
<p>2）释放（released）</p>
<p>一旦一个mutex被获取，对它的任何操作都必须等released之后。</p>
<p>在make-serializer的实现中，关联一个mutex。<strong>给定一个过程p，串行化组先返回一个mutex，再运行p，然后释放mutex，这样就能保证这个串行化组产生的所有过程中，一次只能运行一个p</strong>。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">make-serializer</span>)</div><div class="line">   (<span class="name">let</span> ((<span class="name">mutex</span> (<span class="name">make-mutex</span>))</div><div class="line">         (<span class="name">lambda</span> (<span class="name">p</span>)</div><div class="line">           (<span class="name">define</span> (<span class="name">serialized-p</span> . args)</div><div class="line">             (<span class="name">mutex</span> 'acquired)</div><div class="line">             (<span class="name">let</span> ((<span class="name">val</span> (<span class="name">apply</span> p args)))</div><div class="line">               (<span class="name">mutex</span> 'release)</div><div class="line">               val))</div><div class="line">           serialized-p))))</div></pre></td></tr></table></figure>
<p>mutex是一个Boolean，在mutex的构造函数中，初始化为false。</p>
<p>在acquired时，先判断是否为false，若是，设置为true然后使用；否则在循环中等待，直到检测为false。</p>
<p>在acquired操作时，有一个<code>test-and-set!</code>方法，用于检查mutex并返回结果，其中若检查结果为false，在返回false之前还要设置为true。</p>
<p>这里的关键是，<code>test-and-set!</code>必须以原子操作的方式执行。比如说，一旦某进程检查了一个mutex发现是false，就必须在其他进程检查这个mutex之前完成为true的设置，否则mutex的机制就失效了。目前多CPU的电脑中提供了专门指令，直接在硬件中支持原子操作。</p>
<p><strong>死锁</strong></p>
<p>比如Peter要交换a2和a1，则进入了保护a2的串行化进程；Paul同时要交换a1和a2，则进入了保护a1的串行化进程。于是双方都无法继续了。</p>
<p>避免死锁的一种方式，就是首先给每个账户确定一个<strong>唯一的标识编号</strong>，再重写serialized-exchange，使每个进程总是首先去<strong>保护较低编号</strong>的账户。</p>
<p><strong>并发性、时间和通信</strong></p>
<p>我们已经看到，在并发系统的程序设计中，为什么需要去控制不同进程访问共享变量的事件发生的顺序，也看到了如何通过审慎地使用串行化去完成这方面的控制。但是并发性的基本问题比这些更深刻，因为，从一种更基本的观点看，“共享状态”究竟意味着什么，这件事常常并不清楚。</p>
<p>像<code>test-and-set!</code>这样的机制，都要求进程能在任意时刻去检查一个全局性的共享标志。在实现新型高速处理器时，由于在那里需要采用各种优化技术，例如流水线和缓存，因此就不可能在每个时刻都保持存储器内容的一致性，此时完成上述的检查将很有问题，也必然非常低效。正因为这样，在当前的多处理器系统里，串行化方式正在被并发控制的各种新技术取代，比如<strong>屏障同步</strong></p>
<h2 id="3-5-流"><a href="#3-5-流" class="headerlink" title="3.5 流"></a>3.5 流</h2><p>流是另一种模拟现实物理世界的设计策略，其核心思想就是<strong>用数学概念上的函数来表示一现实物体的改变</strong>，比如对象X，可以用<code>X(t)</code>来表示，如果我们想集中关心的是一个个时刻的x，那么就可以将它看作一个变化的量。如果关注的是这些值的整个时间史，那么就不需要强调其中的变化——这一函数本身是没有改变的。</p>
<p>在第二章我们学习了<strong>序列</strong>和<strong>表</strong>的概念（P84）。从抽象的观点看，流也是一个序列，但如果把流表示为表，必能完全揭示流处理的威力。这里要引入一种叫“<strong>延时求值</strong>”的技术。</p>
<h3 id="3-5-1-流作为延时的表"><a href="#3-5-1-流作为延时的表" class="headerlink" title="3.5.1 流作为延时的表"></a>3.5.1 流作为延时的表</h3><p>我们之前建立了一些对序列操作的抽象机制，比如map、filter、accumulate等。但如果我们将序列表示为表，表达可以更优雅，但效率很低。</p>
<p>例如，要计算一个区间内的素数之和。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">accumulate</span> op initial sequence)</div><div class="line">  (<span class="name">if</span> (<span class="name">null</span>? sequence)</div><div class="line">    initial</div><div class="line">    (<span class="name">op</span> (<span class="name">car</span> sequence)</div><div class="line">        (<span class="name">accumulate</span> op initial (<span class="name">cdr</span> sequence)))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">prime</span>? n)</div><div class="line">  (<span class="name">define</span> (<span class="name">iter</span> n next)</div><div class="line">    (<span class="name">cond</span> ((<span class="name">=</span> n next) #t)</div><div class="line">          ((<span class="name">=</span> <span class="number">0</span> (<span class="name">remainder</span> n next)) #f)</div><div class="line">          (<span class="name">else</span> (<span class="name">iter</span> n (<span class="name">+</span> next <span class="number">1</span>)))))</div><div class="line">  (<span class="name">iter</span> n <span class="number">2</span>))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">enumerate-interval</span> low high)</div><div class="line">  (<span class="name">if</span> (<span class="name">&gt;</span> low high)</div><div class="line">    '()</div><div class="line">    (<span class="name">cons</span> low (<span class="name">enumerate-interval</span> (<span class="name">+</span> low <span class="number">1</span>) high))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">filter</span> predicate sequence)</div><div class="line">  (<span class="name">cond</span> ((<span class="name">null</span>? sequence) '())</div><div class="line">        ((<span class="name">predicate</span> (<span class="name">car</span> sequence))</div><div class="line">         (<span class="name">cons</span> (<span class="name">car</span> sequence)</div><div class="line">               (<span class="name">filter</span> predicate (<span class="name">cdr</span> sequence))))</div><div class="line">        (<span class="name">else</span> (<span class="name">filter</span> predicate (<span class="name">cdr</span> sequence)))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">sum-primes</span> a b)</div><div class="line">  (<span class="name">define</span> (<span class="name">iter</span> count accum)</div><div class="line">    (<span class="name">cond</span> ((<span class="name">&gt;</span> count b) accum)</div><div class="line">          ((<span class="name">prime</span>? count) (<span class="name">iter</span> (<span class="name">+</span> count <span class="number">1</span>) (<span class="name">+</span> count accum))</div><div class="line">          (<span class="name">else</span> (<span class="name">iter</span> (<span class="name">+</span> count <span class="number">1</span>) accum))))</div><div class="line">    (<span class="name">iter</span> a <span class="number">0</span>)))</div></pre></td></tr></table></figure>
<p>如果用序列操作</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">sum-primes</span> a b)</div><div class="line">  (<span class="name">accumulate</span> + </div><div class="line">              <span class="number">0</span></div><div class="line">              (<span class="name">filter</span> prime? (<span class="name">enumerate-interval</span> a b))))</div></pre></td></tr></table></figure>
<p>在执行计算时，第一个程序只需要<strong>维护正在累积的和</strong>。第二个程序只有<strong>等enumate-interval构造完成这一区间所有整数的表之后</strong>，过滤器才能开始工作。这就需要大量的中间存储，增加计算开销。</p>
<p>流是一种非常巧妙的想法，使我们<strong>既可以利用各种序列操作，又不会带来将序列作为表操作的性能代价</strong>。</p>
<p>从表面上看，流也是表，但对他们进行操作的过程的名字不同。有构造函数cons-stream，以及两个选择函数stream-car和stream-cdr，满足如下约束</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">stream-car</span> (<span class="name">cons-stream</span> x y))=x</div><div class="line">(<span class="name">stream-cdr</span> (<span class="name">cons-stream</span> x y))=y</div></pre></td></tr></table></figure>
<p>我们用和第二章各种表操作（如list-ref，map和for-each等）类似的方式来操作流。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">stream-ref</span> s n)</div><div class="line">  (<span class="name">if</span> (<span class="name">=</span> n <span class="number">0</span>)</div><div class="line">      (<span class="name">stream-car</span> s)</div><div class="line">      (<span class="name">stream-ref</span> (<span class="name">stream-cdr</span> s) (<span class="name">-</span> n <span class="number">1</span>))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-map</span> proc s)</div><div class="line">  (<span class="name">if</span> (<span class="name">stream-null</span>? s)</div><div class="line">      the-empty-stream</div><div class="line">      (<span class="name">cons-stream</span> </div><div class="line">       (<span class="name">proc</span> (<span class="name">stream-car</span> s))</div><div class="line">       (<span class="name">stream-map</span> proc (<span class="name">stream-cdr</span> s)))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-for-each</span> proc s)</div><div class="line">  (<span class="name">if</span> (<span class="name">stream-null</span>? s)</div><div class="line">      'done</div><div class="line">      (<span class="name">begin</span> </div><div class="line">        (<span class="name">proc</span> (<span class="name">stream-car</span> s))</div><div class="line">        (<span class="name">stream-for-each</span> proc </div><div class="line">                         (<span class="name">stream-cdr</span> s)))))</div></pre></td></tr></table></figure>
<p>核心的诉求是，<strong>对于流的cdr的求值要等到真正通过过程stream-cdr去访问它的时候再做，而不是在构造stream-cdr的时候做</strong>。</p>
<p>流的实现将基于一种称为<strong>delay</strong>的特殊形式，对于<code>(delay &lt;exp&gt;)</code>的求值不是对表达式求值，而是返回一个称为 <strong>延时对象</strong> 的对象。这个对象可以看做是对未来某个时间要对表达式求值的一个允诺。</p>
<p>和delay一起的还有一个<strong>force</strong>的过程，它以一个延时对象为参数，执行相应的求值工作，也就是说，force就用来迫使delay完成所允诺的求值。下面用这两个概念来构造流。</p>
<p>cons-stream的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(cons-stream ⟨a⟩ ⟨b⟩)</div></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(cons ⟨a⟩ (delay ⟨b⟩))</div></pre></td></tr></table></figure>
<p>可见，定义的时候，b还没有放到cons的cdr中。再看对cons的取值，</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">stream-car</span> stream) </div><div class="line">  (<span class="name">car</span> stream))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-cdr</span> stream) </div><div class="line">  (<span class="name">force</span> (<span class="name">cdr</span> stream)))</div></pre></td></tr></table></figure>
<p><strong>流实现的行为方式</strong></p>
<p>我们再来看之前的过滤出素数的例子</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">stream-car</span> </div><div class="line"> (<span class="name">stream-cdr</span></div><div class="line">  (<span class="name">stream-filter</span> </div><div class="line">   prime? (<span class="name">stream-enumerate-interval</span> </div><div class="line">           <span class="number">10000</span> <span class="number">1000000</span>))))</div></pre></td></tr></table></figure>
<p>计算开始于对参数10000 1000000调用stream-enumerate-interval。它的实现是</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">stream-enumerate-interval</span> low high)</div><div class="line">  (<span class="name">if</span> (<span class="name">&gt;</span> low high)</div><div class="line">      the-empty-stream</div><div class="line">      (<span class="name">cons-stream</span></div><div class="line">       low</div><div class="line">       (<span class="name">stream-enumerate-interval</span> (<span class="name">+</span> low <span class="number">1</span>)</div><div class="line">                                  high))))</div></pre></td></tr></table></figure>
<p>这样，由stream-enumerate-interval返回的结果就是通过cons-stream形成的：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">cons</span> <span class="number">10000</span></div><div class="line">      (<span class="name">delay</span> </div><div class="line">        (<span class="name">stream-enumerate-interval</span> </div><div class="line">         <span class="number">10001</span> </div><div class="line">         <span class="number">1000000</span>)))</div></pre></td></tr></table></figure>
<p>也就是说，当stream-enumerate-interval返回一个流的时候，car是10000，而cdr是一个<strong>允诺</strong>，表示当需要的时候，才在这个区间中枚举更多的内容。</p>
<p>再来看这个流程构建后的过滤</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">stream-filter</span> pred stream)</div><div class="line">  (<span class="name">cond</span> ((<span class="name">stream-null</span>? stream) </div><div class="line">         the-empty-stream)</div><div class="line">        ((<span class="name">pred</span> (<span class="name">stream-car</span> stream))</div><div class="line">         (<span class="name">cons-stream</span> </div><div class="line">          (<span class="name">stream-car</span> stream)</div><div class="line">          (<span class="name">stream-filter</span> </div><div class="line">           pred</div><div class="line">           (<span class="name">stream-cdr</span> stream))))</div><div class="line">        (<span class="name">else</span> (<span class="name">stream-filter</span> </div><div class="line">               pred </div><div class="line">               (<span class="name">stream-cdr</span> stream)))))</div></pre></td></tr></table></figure>
<p>首先检查stream-car，因为这个数不是素数（10000），再进一步检查stream-cdr，这个时候对stream-cdr的调用会迫使系统对延时的stream-enumerate-interval求值，这一次就返回</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">cons</span> <span class="number">10001</span></div><div class="line">      (<span class="name">delay</span> </div><div class="line">        (<span class="name">stream-enumerate-interval</span> </div><div class="line">         <span class="number">10002</span> </div><div class="line">         <span class="number">1000000</span>)))</div></pre></td></tr></table></figure>
<p>如此进行，直到找到第一个素数10007，此时stream-filter根据其定义返回</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="name">cons-stream</span> </div><div class="line"> (<span class="name">stream-car</span> stream)</div><div class="line"> (<span class="name">stream-filter</span> pred (<span class="name">stream-cdr</span> stream)))</div></pre></td></tr></table></figure>
<p>相当于</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">cons</span> <span class="number">10007</span></div><div class="line">      (<span class="name">delay</span></div><div class="line">        (<span class="name">stream-filter</span></div><div class="line">         prime?</div><div class="line">         (<span class="name">cons</span> <span class="number">10008</span></div><div class="line">               (<span class="name">delay</span></div><div class="line">                 (<span class="name">stream-enumerate-interval</span> </div><div class="line">                  <span class="number">10009</span> <span class="number">1000000</span>))))))</div></pre></td></tr></table></figure>
<p>这样在stream-cdr中，又迫使延时的stream-filter求值，转而再去迫使stream-enumerate-interval求值，直到再找到下一个素数……</p>
<p>一般而言，可以将延时求值看做是一种“由需要驱动”的设计，其中流处理的每个阶段都仅仅活动到足够满足下一阶段的需要。</p>
<p><strong>delay和force的实现</strong></p>
<p>delay必须包装起一个表达式，使其可以在以后根据需要求值。delay实际上也是一个lambda表达式的语法糖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(delay ⟨exp⟩)</div><div class="line">=</div><div class="line">(lambda () ⟨exp⟩)</div></pre></td></tr></table></figure>
<p>而force就是简单调用由delay产生的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(define (force delayed-object)</div><div class="line">  (delayed-object))</div></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://blog.csdn.net/congyihao/article/details/60747909" target="_blank" rel="noopener">Java 8 - 通过lambda表达式进行惰性计算</a></p>
<p>lambda表达式的出现使得JDK8内部发生了很多有趣的变化, 其中就包括惰性计算的特性.<br>这里以JDK标准库中的Logger为例, 1.8以前的log方法有如下签名:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(Level level, String msg)</span> </span>&#123;</div><div class="line">&gt;         <span class="keyword">if</span> (!isLoggable(level)) &#123;</div><div class="line">&gt;             <span class="keyword">return</span>;</div><div class="line">&gt;         &#125;</div><div class="line">&gt;         LogRecord lr = <span class="keyword">new</span> LogRecord(level, msg);</div><div class="line">&gt;         doLog(lr);</div><div class="line">&gt;     &#125;</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>也就是说客户端程序调用log方法的时候, 无论最终是否触发log行为, <code>msg</code>始终是要被计算的. 若计算<code>msg</code>是非常耗时的行为, 那么无疑会造成不必要的开销. 下面是一个调用的例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; log(Level.WARNING, <span class="string">"Log msg: "</span> + someExpensiveOperation());</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>在java 1.8版本出现之后, 该方法多了如下重载:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(Level level, Supplier&lt;String&gt; msgSupplier)</span> </span>&#123;</div><div class="line">&gt;         <span class="keyword">if</span> (!isLoggable(level)) &#123;</div><div class="line">&gt;             <span class="keyword">return</span>;</div><div class="line">&gt;         &#125;</div><div class="line">&gt;         LogRecord lr = <span class="keyword">new</span> LogRecord(level, msgSupplier.get());</div><div class="line">&gt;         doLog(lr);</div><div class="line">&gt;     &#125;</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p><code>Supplier</code>是一个<code>FunctionalInterface</code>, 也就是说现在的<code>log</code>方法可以接受一个无参的lambda表达式作为参数, 而计算的过程也被延迟到了<code>supplier.get()</code>的调用时. 改进后的调用例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="comment">// 注意: 传入的lambda表达式并不会立即执行, 而是在log中判断isLoggable(level)成功后才会执行</span></div><div class="line">&gt; log(Level.WARNING, () -&gt; <span class="string">"Log msg: "</span> + someExpensiveOperation());</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>这里还存在一个优化。有时需要多次对同一个delay求值，这就需要delay能保存上一次求出的值。于是可以将delay实现为一种特殊的记忆过程，它以一个无参过程为参数，返回该过程的记忆性版本。这种记忆性过程在第一次执行时将结果保存，下一次求值时再返回之前保存的</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">memo-proc</span> proc)</div><div class="line">  (<span class="name">let</span> ((<span class="name">already-run</span>? false) (<span class="name">result</span> false))</div><div class="line">    (<span class="name">lambda</span> ()</div><div class="line">      (<span class="name">if</span> (<span class="name">not</span> already-run?)</div><div class="line">          (<span class="name">begin</span> (<span class="name">set!</span> result (<span class="name">proc</span>))</div><div class="line">                 (<span class="name">set!</span> already-run? true)</div><div class="line">                 result)</div><div class="line">          result))))</div></pre></td></tr></table></figure>
<p>此后再定义delay，使得<code>(delay ⟨exp⟩)</code>等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(memo-proc (lambda () ⟨exp⟩))</div></pre></td></tr></table></figure>
<h3 id="3-5-2-无穷流"><a href="#3-5-2-无穷流" class="headerlink" title="3.5.2 无穷流"></a>3.5.2 无穷流</h3><p>用流表示无穷长的序列。</p>
<p>比如以下的流可以表示所有正整数序列。这是一个无穷长的流。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">integers-starting-from</span> n)</div><div class="line">  (<span class="name">cons-stream</span> </div><div class="line">   n (<span class="name">integers-starting-from</span> (<span class="name">+</span> n <span class="number">1</span>))))</div><div class="line">(<span class="name">define</span> integers (<span class="name">integers-starting-from</span> <span class="number">1</span>))</div><div class="line"></div><div class="line">&gt; (<span class="name">stream-ref</span> integers <span class="number">100</span>)</div><div class="line"><span class="number">101</span></div></pre></td></tr></table></figure>
<p>用这个就可以表示，例如不能被7整除的整数的流</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">divisible</span>? x y) (<span class="name">=</span> (<span class="name">remainder</span> x y) <span class="number">0</span>))</div><div class="line"></div><div class="line">(<span class="name">define</span> no-sevens</div><div class="line">  (<span class="name">stream-filter</span> (<span class="name">lambda</span> (<span class="name">x</span>) </div><div class="line">                   (<span class="name">not</span> (<span class="name">divisible</span>? x <span class="number">7</span>)))</div><div class="line">                 integers))</div></pre></td></tr></table></figure>
<p>之后在用访问这个流元素的方式找出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; (stream-ref no-sevens 100)</div><div class="line">117</div></pre></td></tr></table></figure>
<p>也可以定义斐波那契数列的无穷流</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">fibgen</span> a b)</div><div class="line">  (<span class="name">cons-stream</span> a (<span class="name">fibgen</span> b (<span class="name">+</span> a b))))</div><div class="line">(<span class="name">define</span> fibs (<span class="name">fibgen</span> <span class="number">0</span> <span class="number">1</span>))</div><div class="line"></div><div class="line">------------------</div><div class="line">&gt; (<span class="name">stream-ref</span> fibs <span class="number">6</span>)</div><div class="line"><span class="number">8</span></div></pre></td></tr></table></figure>
<p>这样定义出的<code>fibs</code>是一个序对，其car是0，cdr是一个求值<code>(fibgen 1 1)</code>的允诺。求该表达式时，又将产生一个序对，car是，cdr是<code>(fibgen 1 2)</code>。</p>
<p><strong>隐式的定义流</strong></p>
<p>上面的integers和fibs是通过描述“生成”过程的方式定义的，这种过程是一个个的计算出流的元素。另一种就是<strong>隐式的求值</strong>。</p>
<p>例如，下面表达式将ones定义为1的一个无穷流。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(define ones (cons-stream 1 ones))</div></pre></td></tr></table></figure>
<p>这种方式就像在定义一个递归过程：这里的ones是一个序对，car是1，cdr是求值ones的一个允诺。而对cdr的求值又得到了一个1和cdr的允诺。</p>
<p>add-streams操作产生出两个给定流的逐对元素之和</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">add-streams</span> s1 s2) </div><div class="line">  (<span class="name">stream-map</span> + s1 s2))</div></pre></td></tr></table></figure>
<p>现在可以用另一种方式定义整数流integers</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> integers </div><div class="line">  (<span class="name">cons-stream</span> <span class="number">1</span> (<span class="name">add-streams</span> ones integers)))</div><div class="line"></div><div class="line">&gt; (<span class="name">stream-ref</span> integers <span class="number">10</span>)</div><div class="line"><span class="number">11</span></div></pre></td></tr></table></figure>
<p>首元素是1，其余是ones和integers之和。这样，integers的第二个元素就是1加上integers的第一个元素，也就是2。第三个元素就是1加上integers的第二个元素，也就是3。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; 原版integers定义</span></div><div class="line">(<span class="name">define</span> (<span class="name">integers-starting-from</span> n)</div><div class="line">  (<span class="name">cons-stream</span> </div><div class="line">   n (<span class="name">integers-starting-from</span> (<span class="name">+</span> n <span class="number">1</span>))))</div><div class="line">(<span class="name">define</span> integers (<span class="name">integers-starting-from</span> <span class="number">1</span>))</div></pre></td></tr></table></figure>
<p>同样的风格也可以定义出斐波那契数列</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> fibs </div><div class="line">  (<span class="name">cons-stream</span> </div><div class="line">   <span class="number">0</span> (<span class="name">cons-stream</span></div><div class="line">      <span class="number">1</span> (<span class="name">add-streams</span> </div><div class="line">         (<span class="name">stream-cdr</span> fibs) fibs))))</div><div class="line"></div><div class="line">&gt; (<span class="name">stream-ref</span> fibs <span class="number">11</span>)</div><div class="line"><span class="number">89</span></div></pre></td></tr></table></figure>
<p>这个定义是fib是一个从0和1开始的流，而这个流的其余部分都可以通过加起流fibs和移动了一个位置的fibs而得到</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">    1 1 2 3 5  8 13 21 … = (stream-cdr fibs)</div><div class="line">    0 1 1 2 3  5  8 13 … = fibs</div><div class="line">0 1 1 2 3 5 8 13 21 34 … = fibs</div></pre></td></tr></table></figure>
<h3 id="3-5-5-函数式程序的模块化和对象的模块化"><a href="#3-5-5-函数式程序的模块化和对象的模块化" class="headerlink" title="3.5.5 函数式程序的模块化和对象的模块化"></a>3.5.5 函数式程序的模块化和对象的模块化</h3><p>正如在3.1.2中看到的，引进赋值的主要收益就是使我们可以<strong>增强系统的模块化</strong>，把一个大系统的状态中的某些部分封装，或者说<strong>“隐藏”到局部变量里</strong>。</p>
<p>流模型可以<strong>提供等价的模块化，同时又不必使用赋值</strong>。为了展示这方面的情况，我们可以重新实现前面在 3.1.2 节看过的π的蒙特卡罗估计，这次从流的观点出发来做。</p>
<p>这里的一个关键性的模块化问题，就是我们希望<strong>将一个随机数生成器的内部状态隐蔽起来，隔离在使用随机数的程序之外</strong>。从过程 <code>rand-update</code> 开始，它所提供的一系列值就是我们所需的随机数，用它作为一个随机数生成器：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> rand</div><div class="line">  (<span class="name">let</span> ((<span class="name">x</span> random-init))</div><div class="line">    (<span class="name">lambda</span> ()</div><div class="line">      (<span class="name">set!</span> x (<span class="name">rand-update</span> x))</div><div class="line">      x)))</div></pre></td></tr></table></figure>
<p>在这个流的描述中，看不到什么随机数生成器。在这里只有一个随机数的流，通过对rand-update的一系列顺序调用产生：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> random-numbers</div><div class="line">  (<span class="name">cons-stream</span> random-init</div><div class="line">               (<span class="name">stream-map</span> rand-update </div><div class="line">                           random-numbers)))</div></pre></td></tr></table></figure>
<p>用它构造出在<code>random-numbers</code>流中顺序的数对上的的Cesaro实验的输出流</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">map-successive-pairs</span> f s)</div><div class="line">  (<span class="name">cons-stream</span></div><div class="line">   (<span class="name">f</span> (<span class="name">stream-car</span> s) </div><div class="line">      (<span class="name">stream-car</span> (<span class="name">stream-cdr</span> s)))</div><div class="line">   (<span class="name">map-successive-pairs</span> </div><div class="line">    f (<span class="name">stream-cdr</span> (<span class="name">stream-cdr</span> s)))))</div><div class="line"></div><div class="line">(<span class="name">define</span> cesaro-stream</div><div class="line">  (<span class="name">map-successive-pairs</span></div><div class="line">   (<span class="name">lambda</span> (<span class="name">r1</span> r2) (<span class="name">=</span> (<span class="name">gcd</span> r1 r2) <span class="number">1</span>))</div><div class="line">   random-numbers))</div></pre></td></tr></table></figure>
<p>现在将<code>cesaro-stream</code>扔进<code>monte-carlo</code>过程，该过程生成一个可能性估计的流。得到的结果就变换到一个估计π值的流。这一版本的程序<strong>不需要用参数去告诉它试多少次</strong>，只要查看更后面的值，就可以得到更好的π的估计。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">(<span class="name">define</span> (<span class="name">monte-carlo</span> experiment-stream </div><div class="line">                     passed </div><div class="line">                     failed)</div><div class="line">  (<span class="name">define</span> (<span class="name">next</span> passed failed)</div><div class="line">    (<span class="name">cons-stream</span></div><div class="line">     (<span class="name">/</span> passed (<span class="name">+</span> passed failed))</div><div class="line">     (<span class="name">monte-carlo</span></div><div class="line">      (<span class="name">stream-cdr</span> experiment-stream) </div><div class="line">      passed </div><div class="line">      failed)))</div><div class="line">  (<span class="name">if</span> (<span class="name">stream-car</span> experiment-stream)</div><div class="line">      (<span class="name">next</span> (<span class="name">+</span> passed <span class="number">1</span>) failed)</div><div class="line">      (<span class="name">next</span> passed (<span class="name">+</span> failed <span class="number">1</span>))))</div><div class="line"></div><div class="line">(<span class="name">define</span> pi</div><div class="line">  (<span class="name">stream-map</span></div><div class="line">   (<span class="name">lambda</span> (<span class="name">p</span>) (<span class="name">sqrt</span> (<span class="name">/</span> <span class="number">6</span> p)))</div><div class="line">   (<span class="name">monte-carlo</span> cesaro-stream <span class="number">0</span> <span class="number">0</span>)))</div><div class="line"></div><div class="line">------------------------</div><div class="line">&gt; (<span class="name">stream-ref</span> pi <span class="number">1000</span>)</div><div class="line"><span class="number">3.24037034920393</span></div></pre></td></tr></table></figure>
<p>而且，这一方法也非常模块化，这里<strong>构造了一个一般性的monte-carlo过程，它可以处理任何试验，而且这里没有赋值，也没有局部状态</strong>。</p>
<p>附：流执行的预先定义函数</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;; stream-&gt;list</span></div><div class="line"></div><div class="line">(<span class="name">define</span> stream-&gt;list</div><div class="line">  (<span class="name">lambda</span> (<span class="name">strm</span> n)</div><div class="line">    (<span class="name">if</span> (<span class="name">or</span> (<span class="name">stream-null</span>? strm) (<span class="name">zero</span>? n))</div><div class="line">        '()</div><div class="line">        (<span class="name">cons</span> (<span class="name">stream-car</span> strm)</div><div class="line">              (<span class="name">stream-&gt;list</span> (<span class="name">stream-cdr</span> strm) (<span class="name">sub1</span> n))))))</div><div class="line"></div><div class="line"></div><div class="line">(<span class="name">define-syntax</span> delay</div><div class="line">  (<span class="name">syntax-rules</span> ()</div><div class="line">    ((<span class="name">_</span> exp) (<span class="name">lambda</span> () exp))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">force</span> delayed-object)</div><div class="line">  (<span class="name">delayed-object</span>))</div><div class="line"></div><div class="line">(<span class="name">define-syntax</span> cons-stream</div><div class="line">  (<span class="name">syntax-rules</span> ()</div><div class="line">    ((<span class="name">_</span> a b) (<span class="name">cons</span> a (<span class="name">delay</span> b)))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-car</span> stream) (<span class="name">car</span> stream))</div><div class="line"> </div><div class="line">(<span class="name">define</span> (<span class="name">stream-cdr</span> stream) (<span class="name">force</span> (<span class="name">cdr</span> stream)))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-null</span>? stream)</div><div class="line">  (<span class="name">null</span>? stream))</div><div class="line"></div><div class="line">(<span class="name">define</span> the-empty-stream '())</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-ref</span> s n)</div><div class="line">  (<span class="name">if</span> (<span class="name">=</span> n <span class="number">0</span>)</div><div class="line">      (<span class="name">stream-car</span> s)</div><div class="line">      (<span class="name">stream-ref</span> (<span class="name">stream-cdr</span> s) (<span class="name">-</span> n <span class="number">1</span>))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-map</span> proc . argstreams)</div><div class="line">  (<span class="name">if</span> (<span class="name">stream-null</span>? (<span class="name">car</span> argstreams))</div><div class="line">      the-empty-stream</div><div class="line">      (<span class="name">cons-stream</span></div><div class="line">       (<span class="name">apply</span> proc (<span class="name">map</span> stream-car argstreams))</div><div class="line">       (<span class="name">apply</span> stream-map</div><div class="line">              (<span class="name">cons</span> proc</div><div class="line">                    (<span class="name">map</span> stream-cdr</div><div class="line">                         argstreams))))))</div><div class="line"></div><div class="line">(<span class="name">define</span> (<span class="name">stream-filter</span> pred stream)</div><div class="line">  (<span class="name">cond</span> ((<span class="name">stream-null</span>? stream) the-empty-stream)</div><div class="line">        ((<span class="name">pred</span> (<span class="name">stream-car</span> stream))</div><div class="line">         (<span class="name">cons-stream</span> (<span class="name">stream-car</span> stream)</div><div class="line">                      (<span class="name">stream-filter</span> pred (<span class="name">stream-cdr</span> stream))))</div><div class="line">        (<span class="name">else</span> (<span class="name">stream-filter</span> pred (<span class="name">stream-cdr</span> stream)))))</div></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://liujiacai.net/blog/2015/12/26/sicp-chapter3-summary/" target="_blank" rel="noopener">SICP 第三章总结</a></p>
<p><a href="https://github.com/rsy56640/daily_learning/tree/master/SICP#3" target="_blank" rel="noopener">SICP note</a></p>
<p><a href="https://sicp.liujiacai.net/chap3/exercise.html" target="_blank" rel="noopener">第三章习题索引</a></p>
<p><a href="https://sarabander.github.io/sicp/html/3_002e5.xhtml" target="_blank" rel="noopener">第三章英文版</a></p>
<p><a href="https://wizardforcel.gitbooks.io/sicp-py/content/" target="_blank" rel="noopener">SICP Python 描述 中文版</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2017/07/12/hadoop-spark/spark/spark笔记-操作elastic-search/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer"/>
      <meta itemprop="description" content="Record and Think!"/>
      <meta itemprop="image" content="/images/avatar.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/12/hadoop-spark/spark/spark笔记-操作elastic-search/" class="post-title-link" itemprop="url">spark笔记-操作elastic search</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-12 11:49:53" itemprop="dateCreated datePublished" datetime="2017-07-12T11:49:53+08:00">2017-07-12</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-01-30 15:50:16" itemprop="dateModified" datetime="2018-01-30T15:50:16+08:00">2018-01-30</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/hadoop-spark/" itemprop="url" rel="index"><span itemprop="name">hadoop-spark</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="最简单的例子"><a href="#最简单的例子" class="headerlink" title="最简单的例子"></a>最简单的例子</h1><p>1、在pom.xml中增加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;elasticsearch-spark_2.10&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;2.2.1&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>2、在spark的main中导入<code>org.elasticsearch.spark</code>包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">import org.elasticsearch.spark._</div></pre></td></tr></table></figure></p>
<p>3、在spark的conf中增加如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set(&quot;es.index.auto.create&quot;, &quot;true&quot;).set(&quot;es.nodes&quot;, &quot;192.168.37.129&quot;).set(&quot;es.port&quot;,&quot;9200&quot;)</div></pre></td></tr></table></figure></p>
<p>其中，<code>es.nodes</code>是ElasticSearch的host</p>
<p>4、简单的写法如下<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> conf = ...</div><div class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)         </div><div class="line"></div><div class="line"><span class="keyword">val</span> numbers = <span class="type">Map</span>(<span class="string">"one"</span> -&gt; <span class="number">1</span>, <span class="string">"two"</span> -&gt; <span class="number">2</span>, <span class="string">"three"</span> -&gt; <span class="number">3</span>)</div><div class="line"><span class="keyword">val</span> airports = <span class="type">Map</span>(<span class="string">"arrival"</span> -&gt; <span class="string">"Otopeni"</span>, <span class="string">"SFO"</span> -&gt; <span class="string">"San Fran"</span>)</div><div class="line"></div><div class="line">sc.makeRDD(<span class="type">Seq</span>(numbers, airports)).saveToEs(<span class="string">"spark/docs"</span>)</div></pre></td></tr></table></figure></p>
<p>也可以用case class来写<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Trip</span>(<span class="params">departrue: <span class="type">String</span>, arrival: <span class="type">String</span></span>)</span></div><div class="line">    </div><div class="line"><span class="keyword">val</span> upTrip = <span class="type">Trip</span>(<span class="string">"OTF"</span>, <span class="string">"SFO"</span>)</div><div class="line"><span class="keyword">val</span> downTrip = <span class="type">Trip</span>(<span class="string">"MUC"</span>, <span class="string">"OTP"</span>)</div><div class="line"></div><div class="line"><span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">Seq</span>(upTrip, downTrip))</div><div class="line"><span class="type">EsSpark</span>.saveToEs(rdd, <span class="string">"spark/docs"</span>)</div></pre></td></tr></table></figure></p>
<p>5、在Elastic Search的Sense中查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /spark/docs/_search</div></pre></td></tr></table></figure></p>
<p>返回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 4,</div><div class="line">  &quot;timed_out&quot;: false,</div><div class="line">  &quot;_shards&quot;: &#123;</div><div class="line">    &quot;total&quot;: 5,</div><div class="line">    &quot;successful&quot;: 5,</div><div class="line">    &quot;failed&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;max_score&quot;: 1,</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;spark&quot;,</div><div class="line">        &quot;_type&quot;: &quot;docs&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AVSkEdTv9l_YEZuMmxgt&quot;,</div><div class="line">        &quot;_score&quot;: 1,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;arrival&quot;: &quot;Otopeni&quot;,</div><div class="line">          &quot;SFO&quot;: &quot;San Fran&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;spark&quot;,</div><div class="line">        &quot;_type&quot;: &quot;docs&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AVSkEdZp9l_YEZuMmxgu&quot;,</div><div class="line">        &quot;_score&quot;: 1,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;one&quot;: 1,</div><div class="line">          &quot;three&quot;: 3,</div><div class="line">          &quot;two&quot;: 2</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试通过</p>
<h1 id="与spark-streaming结合"><a href="#与spark-streaming结合" class="headerlink" title="与spark streaming结合"></a>与spark streaming结合</h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建 StreamingContext，5秒一个批次</span></div><div class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sc, <span class="type">Seconds</span>(<span class="number">3</span>))</div><div class="line"><span class="keyword">val</span> lines = ssc.socketTextStream(<span class="string">"192.168.37.129"</span>, <span class="number">9999</span>)</div><div class="line"><span class="comment">// 对每一行数据执行 Split 操作</span></div><div class="line"><span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">" "</span>))</div><div class="line"><span class="comment">// 统计 word 的数量</span></div><div class="line"><span class="keyword">val</span> pairs = words.map(word =&gt; (word, <span class="number">1</span>))</div><div class="line"></div><div class="line">pairs.foreachRDD&#123;</div><div class="line">x =&gt;</div><div class="line">x.saveToEs(<span class="string">"spark/words"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">ssc.start()</div><div class="line">ssc.awaitTermination()</div></pre></td></tr></table></figure>
<p>pairs是一个DSteamRDD，通过foreachRDD来遍历其中的每个RDD，对于每个RDD，可以saveToEs</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/29/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><span class="page-number current">30</span><a class="page-number" href="/page/31/">31</a><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/31/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Schwimmer</p>
              <div class="site-description motion-element" itemprop="description">Record and Think!</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">315</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">55</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Schwimmer</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.5.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>



  

  


  <script src="/js/next-boot.js?v=7.2.0"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
