<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Record and Think!">
<meta property="og:type" content="website">
<meta property="og:title" content="Schwimmer&#39;s Blog">
<meta property="og:url" content="https://schwimmer.github.io/page/20/index.html">
<meta property="og:site_name" content="Schwimmer&#39;s Blog">
<meta property="og:description" content="Record and Think!">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Schwimmer&#39;s Blog">
<meta name="twitter:description" content="Record and Think!">





  
  
  <link rel="canonical" href="https://schwimmer.github.io/page/20/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Schwimmer's Blog</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143240576-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-143240576-1');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Schwimmer's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/04/03/地理信息挖掘/computing with spatial trajectories/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/04/03/地理信息挖掘/computing with spatial trajectories/" class="post-title-link" itemprop="url">computing with spatial trajectories</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-03 21:55:41" itemprop="dateCreated datePublished" datetime="2018-04-03T21:55:41+08:00">2018-04-03</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-05 14:43:51" itemprop="dateModified" datetime="2019-07-05T14:43:51+08:00">2019-07-05</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/地理信息处理和挖掘/" itemprop="url" rel="index"><span itemprop="name">地理信息处理和挖掘</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/04/03/地理信息挖掘/computing with spatial trajectories/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/03/地理信息挖掘/computing with spatial trajectories/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>专著<code>computing with spatial trajectories.pdf</code></p>
<p><strong>第一章</strong>：数据预处理。对于位置点的高采样可以生成精确轨迹，但会数据量过大影响性能。所以要设计轨迹数据的压缩方法。同时，轨迹数据会生成离群点和噪音，要过滤这些。</p>
<p>对于<strong>压缩</strong>，有离线数据的批处理模式，和在线数据的在线模式。</p>
<p>对于<strong>消除噪音</strong>，包括mean and median filtering，the Kalman filter, the particle filter.</p>
<p><strong>第二章</strong>：数据量大，处理时间长，数据集没有很好的组织。比如，要查找跨十字路口的轨迹原理简单，但是在在线系统中采用直接扫描的方式遍历大量数据是不可行的。同时，我们需要搜索满足特定条件的轨迹数据。比如我们可以检索旅行者在特定时间穿过指定区域的数据，以帮助旅行规划。</p>
<p>第二章介绍了在轨迹数据库中经常用到的<strong>查询类型和查询方法</strong>。</p>
<p><strong>第三章</strong>：一般的GPS设备有10米以上的误差，这些移动的轨迹数据就比较难精确定位到POI上，尤其在高密度的城市区域。同时，对象在连续的移动，而位置只能按时间离线的更新，则两个更新点之间是不确定的。导致这种long-interval updates的原因是save energy consumption和communication bandwidth。当interval逐渐增大时，对轨迹搜索会带来新的挑战。</p>
<p>为解决上述的<strong>不确定性问题</strong>，第三章介绍了对不确定性表达和建模的Moving Objects Databases(MOD)模型。同时讨论了处理时空查询的高效算法。要注意的是，<strong>第二章介绍的查询方法没有考虑不确定性</strong>。</p>
<p><strong>第四章</strong>：LBS的<strong>隐私问题</strong>。通常有两种类型的LBS。</p>
<p>snapshot LBS，移动用户只需要在得到想要的信息时汇报当前位置。事实上，当使用此类服务时，用户并不需要告诉LBS他的当前位置。比如，找到附近的宾馆只需要一个粗的地理范围。</p>
<p>continuous LBS，用户必须持续汇报位置，比如导航。保护用户隐私更困难。</p>
<p><strong>第五章</strong>：分析<strong>轨迹模式</strong>。比如一个个体的轨迹包含什么模式，一组轨迹是否有相似模式。也可以轨迹聚类。比如，找到有相似空间形状的轨迹的clusters，能够帮助检测热门驾驶路线。另外，判断一群一起移动的人可用于探索社交关系。</p>
<p><strong>第六章</strong>：用户<strong>行为认知</strong>。空间轨迹隐含了用户的行为和活动。通过多人的活动信息，能够估计相关性。</p>
<p><strong>第七章</strong>：<strong>车辆轨迹挖掘</strong>。可以挖掘路网信息，交通状况，司机行为。用于优化路线等。</p>
<p><strong>第八九章</strong>：用户喜欢分享位置信息，可以挖掘用户关系。</p>
<h1 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h1><p>车的轨迹一天1400条，若分析一个月的数据才需要压缩？</p>
<h2 id="批量压缩"><a href="#批量压缩" class="headerlink" title="批量压缩"></a>批量压缩</h2><p>batched compression techniques</p>
<h2 id="在线压缩"><a href="#在线压缩" class="headerlink" title="在线压缩"></a>在线压缩</h2><p>on-line data reduction</p>
<p>1） 使用线段拟合尽可能多的轨迹点。主要关注空间属性</p>
<p>2）预测轨迹，并上报偏离预测的点。为了预测，需要关注速度、朝向等。</p>
<p>压缩的时候计算误差</p>
<p>1）perpendicular Euclidean distance</p>
<p><img src="/Users/david/Library/Application Support/typora-user-images/image-20181005095933362.png" alt="image-20181005095933362"></p>
<p>2）synchronized Euclidean distance</p>
<p>安装时间计算投影的误差</p>
<p><img src="/Users/david/Library/Application Support/typora-user-images/image-20181005110407128.png" alt="image-20181005110407128"></p>
<p><img src="/Users/david/Library/Application Support/typora-user-images/image-20181005110439685.png" alt="image-20181005110439685"></p>
<h1 id="去噪音"><a href="#去噪音" class="headerlink" title="去噪音"></a>去噪音</h1><p>P46</p>
<p>Kalman Filter</p>
<p>Particle Filter</p>
<h1 id="CH2-轨迹索引"><a href="#CH2-轨迹索引" class="headerlink" title="CH2 轨迹索引"></a>CH2 轨迹索引</h1><p>应用场景：</p>
<p>1）轨迹和点（查询某段时间在某个地点附近的轨迹点）</p>
<p>2）轨迹和区域（查询某段时间某个轨迹经过的区域）</p>
<p>3）轨迹和轨迹（某段时间内相似路径的轨迹）</p>
<h2 id="轨迹查询的类别"><a href="#轨迹查询的类别" class="headerlink" title="轨迹查询的类别"></a>轨迹查询的类别</h2><h1 id="CH5-轨迹模式挖掘"><a href="#CH5-轨迹模式挖掘" class="headerlink" title="CH5 轨迹模式挖掘"></a>CH5 轨迹模式挖掘</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>轨迹模式的应用案例：</p>
<p>1、交通优化应用[25]需要找到一组相似的轨迹，来指示一起行驶物体的相关性。例如，拼车应用需要找到相同轨迹组的司机，从而降低交通费用。或者检测相同轨迹的送货卡车以更好指定送货规划。</p>
<p>2、预测方法[50]能够探索轨迹的知识，用于理解物体行为。这些知识可用于提供有效通知effective notifications，用于精准推送广告，提供定制化LBS服务。</p>
<p>3、相关专业需要研究动物的迁徙轨迹。</p>
<p>4、团队体育运动能够提供运动员的轨迹数据。</p>
<p>5、交通应用，使用轨迹研究聚集和离群crowds and outliers。挖掘离群点可用于检测和移除错误数据，或者用于判断危险驾驶行为。</p>
<h2 id="Overview-of-Trajectory-Patterns"><a href="#Overview-of-Trajectory-Patterns" class="headerlink" title="Overview of Trajectory Patterns"></a>Overview of Trajectory Patterns</h2>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark工作机制/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/04/03/hadoop-spark/spark/spark工作机制/" class="post-title-link" itemprop="url">spark工作机制</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-03 21:55:41" itemprop="dateCreated datePublished" datetime="2018-04-03T21:55:41+08:00">2018-04-03</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-04-08 12:00:54" itemprop="dateModified" datetime="2018-04-08T12:00:54+08:00">2018-04-08</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/spark/" itemprop="url" rel="index"><span itemprop="name">spark</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/04/03/hadoop-spark/spark/spark工作机制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/03/hadoop-spark/spark/spark工作机制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="spark应用执行机制"><a href="#spark应用执行机制" class="headerlink" title="spark应用执行机制"></a>spark应用执行机制</h1><h2 id="Spark执行机制总览"><a href="#Spark执行机制总览" class="headerlink" title="Spark执行机制总览"></a>Spark执行机制总览</h2><p>1、RDD的Action算子触发Job的提交；</p>
<p>2、提交到Spark的Job生成RDD DAG；</p>
<p>3、由DAGSchedule转化为Stage DAG；</p>
<p>4、每个Stage中产生相应的Task集合；</p>
<p>5、TaskScheduler将Task分发到Executor执行。</p>
<p>6、每个Task对应一个数据块，使用用户定义的函数处理数据块。</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark工作机制/spark应用转换流程.png" alt=""></p>
<h2 id="Spark执行的底层实现原理"><a href="#Spark执行的底层实现原理" class="headerlink" title="Spark执行的底层实现原理"></a>Spark执行的底层实现原理</h2><p>对RDD的块管理通过BlockManager完成。BlockManager将数据抽象为数据块，在内存或磁盘存储。</p>
<p>在Executor中会创建线程池，tasks通过线程池并发执行。</p>
<h2 id="Spark应用的概念"><a href="#Spark应用的概念" class="headerlink" title="Spark应用的概念"></a>Spark应用的概念</h2><p>执行模式有Local，Standalone，YARN，Mesos。</p>
<p><a href="https://blog.csdn.net/cds86333774/article/details/51216452" target="_blank" rel="noopener">Spark的三种分布式部署模式：Standalone, Mesos,Yarn</a></p>
<p>Standalone可以单独部署到一个集群中，无需依赖任何其他资源管理系统。</p>
<p>借鉴Spark开发模式，我们可以得到一种开发新型计算框架的一般思路：先设计出它的standalone模式，为了快速开发，起初不需要考虑服务（比如master/slave）的容错性，之后再开发相应的wrapper，将stanlone模式下的服务原封不动的部署到资源管理系统yarn或者mesos上，由资源管理系统负责服务本身的容错。</p>
<p>目前Spark在standalone模式下是没有任何单点故障问题的，这是借助zookeeper实现的，思想类似于Hbase master单点故障解决方案。将Spark standalone与MapReduce比较，会发现它们两个在架构上是完全一致的。</p>
<p>集群启动后，用jps在主节点会看到Master进程，从节点看到Worker进程。其中Master负责接收客户端提交的作业，管理Worker。</p>
<p>Mesos官方推荐模式。有粗粒度和细粒度模式。</p>
<p>YARN。目前仅支持粗粒度模式。</p>
<p>如果使用Standalone模式，只需要提供Hadoop的HDFS支持；如果使用Yarn模式，则同时需要提供Hadoop的Yarn。</p>
<p>根据Driver Program是否在集群中运行，又可以分为Cluster和Client模式。</p>
<p>一个应用的基本组件包括：</p>
<ul>
<li>Application：用户写的Spark程序。</li>
<li>Driver Program：运行Application的main函数并创建SparkContext</li>
<li>RDD Graph：当RDD遇到Action算子时，将之前所有算子形成一个DAG，也就是RDD Graph。再在Spark中转化为Job，提交到集群执行。一个App可以包含多个Job。</li>
<li>Job：一个RDD Graph触发的作业。</li>
<li>Stage：每个Job根据RDD的宽依赖关系被切分成多个Stage，每个Stage包含一组Task。</li>
<li>Task：一个分区对应一个Task，Task封装好后装入Executor的线程池执行。</li>
</ul>
<h1 id="spark作业提交"><a href="#spark作业提交" class="headerlink" title="spark作业提交"></a>spark作业提交</h1><p>以WordCount为例说明RDD从转换到作业提交的过程</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.textFile(<span class="string">"/User/david/key.txt"</span>).flatMap(line=&gt;line.split(<span class="string">" "</span>)).map(word=&gt;(word,<span class="number">1</span>)).reduceByKey(_+_)</span><br></pre></td></tr></table></figure>
<p>步骤1：<code>val rawFile = sc.textFile(&quot;/User/david/key.txt&quot;)</code></p>
<p>textFile先生成HadoopRDD，然后再通过map操作生成MappedRDD。在spark-shell中可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val rawFile = sc.textFile(&quot;/User/david/key.txt&quot;)</span><br><span class="line">rawFile: org.apache.spark.rdd.RDD[String] = /User/david/key.txt MapPartitionsRDD[3] at textFile at &lt;console&gt;:27</span><br><span class="line">1.6.3版本变成了MapPartitionsRDD</span><br></pre></td></tr></table></figure>
<p>步骤2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val splittedText = rawFile.flatMap(line=&gt;line.split(&quot; &quot;))</span><br></pre></td></tr></table></figure>
<p>flatMap将原来的MappedRDD转换为FlatMappedRDD。</p>
<p>步骤3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val wordCount = splittedText.map(word=&gt;(word,1))</span><br></pre></td></tr></table></figure>
<p>步骤4：<code>reduceByKey</code></p>
<h2 id="作业执行"><a href="#作业执行" class="headerlink" title="作业执行"></a>作业执行</h2><p>spark执行中相关概念</p>
<p><a href="https://blog.csdn.net/u013013024/article/details/72876427" target="_blank" rel="noopener">Spark中Task，Partition，RDD、节点数、Executor数、core数目的关系和Application，Driver，Job，Task，Stage理解</a></p>
<p><img src="http://www.zezhi.net/wp-content/uploads/2016/04/spark-learning.png" alt=""></p>
<p>若干个block合并成一个输入分片InputSplit，一个InputSplit对应一个Task，一个Task生成一个Partition。</p>
<p>随后这些具体的Task每个都会被分配到集群上的某个节点的某个<strong>Executor</strong>去执行。</p>
<ul>
<li>每个节点可以启一个或多个Executor。</li>
<li>每个Executor由若干<strong>core</strong>组成，每个Executor的每个core<strong>一次只能执行一个</strong>Task。</li>
<li>每个<strong>Task</strong>执行的结果就是生成了目标<strong>RDD</strong>的一个<strong>partiton</strong>。每个partition再下一步又由一个task来执行。</li>
</ul>
<p><strong>注意: </strong>这里的core是虚拟的core而不是机器的物理CPU核，可以理解为就是Executor的一个工作线程。</p>
<p>而 Task被执行的并发度 = Executor数目 * 每个Executor核数。</p>
<p>所以，如果一共要执行8个task，但只有一个Executor，2个core，则并发度是2。那么需要分成4个批次，每次并发执行两个Task。</p>
<p>至于<strong>partition的数目</strong>：</p>
<ul>
<li>对于数据读入阶段，例如sc.textFile，输入文件被划分为多少InputSplit就会需要多少初始Task。</li>
<li>在Map阶段partition数目保持不变。</li>
<li>在Reduce阶段，RDD的聚合会触发shuffle操作，聚合后的RDD的partition数目跟具体操作有关，例如repartition操作会聚合成指定分区数，还有一些算子是可配置的。</li>
</ul>
<p>在任务提交中主要涉及Driver和Executor两个节点。</p>
<p><strong>Driver</strong>可以理解为我们自己编写的程序。主要解决</p>
<ul>
<li>RDD依赖性分析，以生成DAG</li>
<li>根据RDD DAG将Job分割为多个stage</li>
<li>Stage确认后，生成相应的task，分发到Executor执行。</li>
</ul>
<p><strong>Executor</strong>：在每个WorkerNode上为某应用启动的一个进程，是一个执行task的容器。一个Executor执行多个Task。</p>
<p>另外</p>
<p><strong>Job</strong>：包含很多task的并行计算，可以认为<strong>是Spark RDD 里面的action</strong>,每个action的计算会生成一个job。</p>
<p>　　用户提交的Job会提交给DAGScheduler，Job会被分解成Stage和Task。</p>
<p> Spark中的Job和MR中Job不一样。MR中Job主要是Map或者Reduce Job。而<strong>Spark的Job其实很好区别，一个action算子就算一个Job</strong>，比方说count，first等。</p>
<p><strong>Stage</strong>：</p>
<p><strong>一个Job会被拆分为多组Task，每组任务被称为一个Stage就像Map Stage， Reduce Stage</strong>。</p>
<p>　　Stage的划分在RDD的论文中有详细的介绍，简单的说是以shuffle和result这两种类型来划分。在Spark中有两类task，一类是shuffleMapTask，一类是resultTask，第一类task的输出是shuffle所需数据，第二类task的输出是result，stage的划分也以此为依据，shuffle之前的所有变换是一个stage，shuffle之后的操作是另一个stage。比如 rdd.parallize(1 to 10).foreach(println) 这个操作没有shuffle，直接就输出了，那么只有它的task是resultTask，stage也只有一个；如果是rdd.map(x =&gt; (x, 1)).reduceByKey(<em> + </em>).foreach(println), 这个job因为有reduce，所以有一个shuffle过程，那么reduceByKey之前的是一个stage，执行shuffleMapTask，输出shuffle所需的数据，reduceByKey到最后是一个stage，直接就输出结果了。如果job中有多次shuffle，那么每个shuffle之前都是一个stage。</p>
<p><strong>Task</strong></p>
<p>即 stage 下的一个任务执行单元，一般来说，<strong>一个 rdd 有多少个 partition，就会有多少个 task</strong>，因为每一个 task 只是处理一个 partition 上的数据.</p>
<h3 id="依赖性分析和stage划分"><a href="#依赖性分析和stage划分" class="headerlink" title="依赖性分析和stage划分"></a>依赖性分析和stage划分</h3><p>RDD之间的依赖分为窄依赖和宽依赖。</p>
<p>窄依赖是指父RDD所有输出都会被执行的子RDD消费，也就是输出路径固定。例如如下的Transformation：</p>
<p>map、flatMap、filter、sample</p>
<p>宽依赖是指父RDD输出会由不同子RDD消费，输出路径不固定。例如：</p>
<p>sortByKey、reduceByKey、groupByKey、cogroupByKey、join、cartensian</p>
<p>调度器（Scheduler）会计算RDD之间的依赖关系，将窄依赖的RDD归并到同一个stage，而宽依赖则作为划分不同Stage的判断标准。<strong>宽依赖和窄依赖的边界就是stage的划分点</strong></p>
<h2 id="任务的创建和分发"><a href="#任务的创建和分发" class="headerlink" title="任务的创建和分发"></a>任务的创建和分发</h2><p>由Executor执行的Task分为ShuffleMapTask和ResultTask两种，相当于Map和Reduce。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/04/03/hadoop-spark/spark/spark算子分类及功能/" class="post-title-link" itemprop="url">spark算子分类及功能</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-03 21:55:41" itemprop="dateCreated datePublished" datetime="2018-04-03T21:55:41+08:00">2018-04-03</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-22 15:12:16" itemprop="dateModified" datetime="2018-06-22T15:12:16+08:00">2018-06-22</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/spark/" itemprop="url" rel="index"><span itemprop="name">spark</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/04/03/hadoop-spark/spark/spark算子分类及功能/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/03/hadoop-spark/spark/spark算子分类及功能/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>大致分为3类：</p>
<p>1、Value数据类型的Transformation算子。不触发提交作业，针对处理的数据项是Value型的数据。</p>
<p>2、Key-Value型的Transformation算子。针对Key-Value数据对。</p>
<p>3、Action算子。触发SparkContext提交Job。</p>
<h1 id="Value型Transformation算子"><a href="#Value型Transformation算子" class="headerlink" title="Value型Transformation算子"></a>Value型Transformation算子</h1><p>可以根据RDD变换算子的输入分区与输出分区关系分为以下几个类型：</p>
<ul>
<li>输入分区和输出分区一对一型；</li>
<li>多对一型；</li>
<li>多对多型；</li>
<li>输出为输入子集型。</li>
</ul>
<h2 id="一对一型"><a href="#一对一型" class="headerlink" title="一对一型"></a>一对一型</h2><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>等action触发提交后，在同一个stage中运算。</p>
<h3 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h3><h3 id="mapPartitions"><a href="#mapPartitions" class="headerlink" title="mapPartitions"></a>mapPartitions</h3><p>map是对rdd中的每一个元素进行操作，而mapPartitions(foreachPartition)则是对rdd中的<strong>每个分区的迭代器</strong>进行操作。</p>
<p>如果在map过程中需要频繁创建额外的对象(例如将rdd中的数据通过jdbc写入<a href="http://lib.csdn.net/base/mysql" target="_blank" rel="noopener">数据库</a>,map需要为每个元素创建一个链接而mapPartition为每个partition创建一个链接),则mapPartitions效率比map高的多。</p>
<p>SparkSql或DataFrame默认会对程序进行mapPartition的优化。</p>
<h3 id="与map的区别"><a href="#与map的区别" class="headerlink" title="与map的区别"></a>与map的区别</h3><p><a href="https://blog.csdn.net/lsshlsw/article/details/48627737" target="_blank" rel="noopener">https://blog.csdn.net/lsshlsw/article/details/48627737</a></p>
<p>使用map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">val a = sc.parallelize(1 to 9, 3)</span><br><span class="line">def mapDoubleFunc(a : Int) : (Int,Int) = &#123;</span><br><span class="line">    (a,a*2)</span><br><span class="line">&#125;</span><br><span class="line">val mapResult = a.map(mapDoubleFunc)</span><br><span class="line"></span><br><span class="line">println(mapResult.collect().mkString)</span><br></pre></td></tr></table></figure>
<p>使用mapPartitions</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">val a = sc.parallelize(1 to 9, 3)</span><br><span class="line">  def doubleFunc(iter: Iterator[Int]) : Iterator[(Int,Int)] = &#123;</span><br><span class="line">    var res = List[(Int,Int)]()</span><br><span class="line">    while (iter.hasNext)</span><br><span class="line">    &#123;</span><br><span class="line">      val cur = iter.next;</span><br><span class="line">      res .::= (cur,cur*2)</span><br><span class="line">    &#125;</span><br><span class="line">    res.iterator</span><br><span class="line">  &#125;</span><br><span class="line">val result = a.mapPartitions(doubleFunc)</span><br><span class="line">println(result.collect().mkString)</span><br></pre></td></tr></table></figure>
<h3 id="glom"><a href="#glom" class="headerlink" title="glom"></a>glom</h3><p>将每个RDD分区形成一个数组。</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/glom.png" alt=""></p>
<h2 id="多对一型"><a href="#多对一型" class="headerlink" title="多对一型"></a>多对一型</h2><h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><p>++符号相当于union</p>
<h2 id="cartesian"><a href="#cartesian" class="headerlink" title="cartesian"></a>cartesian</h2><p>对两个RDD中所有元素进行笛卡尔积操作。</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/cartesian.png" alt=""></p>
<h2 id="多对多型"><a href="#多对多型" class="headerlink" title="多对多型"></a>多对多型</h2><h3 id="groupBy"><a href="#groupBy" class="headerlink" title="groupBy"></a>groupBy</h3><p>例如</p>
<p>1）将用户数据预处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val cleanF = sc.clean(f)</span><br></pre></td></tr></table></figure>
<p>2）对数据map进行函数操作，最后再对groupByKey进行分组操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.map(t =&gt; (cleanF(t), t)).groupByKey(p)</span><br></pre></td></tr></table></figure>
<p>其中，p确定了分区个数和分区函数，也就决定了并行化的程度。</p>
<h2 id="子集型"><a href="#子集型" class="headerlink" title="子集型"></a>子集型</h2><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h3><h3 id="substract"><a href="#substract" class="headerlink" title="substract"></a>substract</h3><p>集合的差操作。RDD1去除RDD2交集中的所有元素。</p>
<h3 id="sample"><a href="#sample" class="headerlink" title="sample"></a>sample</h3><p>采样。可以设定有放回的采样、百分比、随机种子。</p>
<h3 id="takeSample"><a href="#takeSample" class="headerlink" title="takeSample"></a>takeSample</h3><p>不使用相对比例采样，而是按设定的采样个数进行采样。同时返回结果也不是RDD，而是相当于对采样后的数据进行Collect()，返回单机的数组。</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/takeSample.png" alt=""></p>
<h2 id="Cache型"><a href="#Cache型" class="headerlink" title="Cache型"></a>Cache型</h2><h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><p>将RDD从磁盘缓存到内存，相当于<code>persist(MEMORY_ONLY)</code> 的功能。</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/cache.png" alt=""></p>
<h2 id="persist"><a href="#persist" class="headerlink" title="persist"></a>persist</h2><p>缓存到哪里，由StorageLevel枚举类型决定。有以下几种类型的组合：DISK磁盘，MEMORY内存，SER数据是否序列化存储。可以缓存的模式有</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/persist缓存模式.png" alt=""></p>
<h1 id="Key-Value型Transformation算子"><a href="#Key-Value型Transformation算子" class="headerlink" title="Key-Value型Transformation算子"></a>Key-Value型Transformation算子</h1><h2 id="输入和输出分区一对一"><a href="#输入和输出分区一对一" class="headerlink" title="输入和输出分区一对一"></a>输入和输出分区一对一</h2><h3 id="mapValues"><a href="#mapValues" class="headerlink" title="mapValues"></a>mapValues</h3><p>针对(Key, Value)型数据中的Value进行Map操作，而不对key进行处理。</p>
<p>比如<code>a=&gt;a+2</code>只对value进行+2操作</p>
<h2 id="对单个或两个RDD聚集"><a href="#对单个或两个RDD聚集" class="headerlink" title="对单个或两个RDD聚集"></a>对单个或两个RDD聚集</h2><p>单个RDD聚集</p>
<h3 id="combineByKey"><a href="#combineByKey" class="headerlink" title="combineByKey"></a>combineByKey</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">combineByKey[C](createCombiner:(V)=&gt; C,</span><br><span class="line">mergeValue:(C, V)=&gt; C,</span><br><span class="line">mergeCombiners:(C, C)=&gt; C,</span><br><span class="line">partitioner: Partitioner</span><br><span class="line">mapSideCombine: Boolean = true,</span><br><span class="line">serializer: Serializer =null): RDD[(K, C)]</span><br></pre></td></tr></table></figure>
<p>其中，</p>
<p><code>createCombiner:(V)=&gt;C</code> 会遍历分区中的所有元素，因此每个元素的键要么还没有遇到过，要么就<br>和之前的某个元素的键相同。如果这是一个新的元素， combineByKey() 会使用一个叫作 createCombiner() 的函数来创建 。</p>
<p><code>mergeValue</code> 当C已经存在的情况下,需要merge,如把item V加到seq C中,或者叠加。</p>
<p><code>mergeCombiners</code> 合并两个C</p>
<p><code>partitioner</code> 分区器，Shuffle时需要通过Partitioner的分区策略进行分区。</p>
<p><code>mapSideCombine</code> 为了减小传输量,很多combine可以在map端先做。例如,叠加可以先在一个partition中把所有相同的Key的Value叠加，再shuffle。</p>
<p><code>serializer</code> 传输序列化</p>
<p>整个过程相当于将元素为<code>(int,int)</code>的转变为了<code>(int, Seq[Int])</code>的RDD。</p>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/combineByKey.png" alt=""></p>
<h3 id="reduceByKey"><a href="#reduceByKey" class="headerlink" title="reduceByKey"></a>reduceByKey</h3><p>是combineByKey的一种简单情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def reduceByKey(partitioner: Partitioner, func: (V, V) =&gt; V): RDD[(K, V)] = &#123;</span><br><span class="line">	combineByKey[V]((v: V) =&gt; v, func, func, partitioner)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/reduceByKey.png" alt=""></p>
<h3 id="combineByKey和reduceByKey区别"><a href="#combineByKey和reduceByKey区别" class="headerlink" title="combineByKey和reduceByKey区别"></a>combineByKey和reduceByKey区别</h3><p>转自<a href="https://www.zhihu.com/question/45420080/answer/99044117" target="_blank" rel="noopener">请教Spark 中 combinebyKey 和 reduceByKey的传入函数参数的区别？</a>例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> testData = sc.parallelize(<span class="type">Seq</span>((<span class="string">"t1"</span>, <span class="number">1</span>), (<span class="string">"t1"</span>, <span class="number">2</span>), (<span class="string">"t1"</span>, <span class="number">3</span>), (<span class="string">"t2"</span>, <span class="number">2</span>), (<span class="string">"t2"</span>, <span class="number">5</span>)))</span><br><span class="line"><span class="keyword">val</span> testDataCombine = testData.combineByKey(x=&gt;x,(x:<span class="type">Int</span>,y:<span class="type">Int</span>)=&gt;x+y,(x:<span class="type">Int</span>,y:<span class="type">Int</span>)=&gt;x+y)</span><br><span class="line"><span class="keyword">val</span> testDataReduce = testData.reduceByKey((x,y)=&gt;x+y)</span><br></pre></td></tr></table></figure>
<p>combineByKey要指定x和y的Int类型，不然会报错无法识别”+”这个方法符，而reduceByKey不用指派类型。</p>
<p>从两者的方法签名</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PairRDDFunctions</span>[<span class="type">K</span>, <span class="type">V</span>](<span class="params">...</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">reduceByKey</span></span>(func: (<span class="type">V</span>, <span class="type">V</span>) =&gt; <span class="type">V</span>): <span class="type">RDD</span>[(<span class="type">K</span>, <span class="type">V</span>)]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">combineByKey</span></span>[<span class="type">C</span>](</span><br><span class="line">      createCombiner: <span class="type">V</span> =&gt; <span class="type">C</span>,</span><br><span class="line">      mergeValue: (<span class="type">C</span>, <span class="type">V</span>) =&gt; <span class="type">C</span>,</span><br><span class="line">      mergeCombiners: (<span class="type">C</span>, <span class="type">C</span>) =&gt; <span class="type">C</span>): <span class="type">RDD</span>[(<span class="type">K</span>, <span class="type">C</span>)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 reduceByKey 的 func 参数的类型只依赖于 PairRDDFunction 的类型参数 V，在这个例子里也就是 Int。于是 func 的类型已经确定为 (Int, Int) =&gt; Int，所以就不需要额外标识类型了。</p>
<p>而 combineByKey 比 reduceByKey 更加通用，它允许各个 partition 在 shuffle 前先做 local reduce 得到一个类型为 C 的中间值，待 shuffle 后再做合并得到各个 key 对应的 C。也就是说<strong>C可以是任意定义的数据类型</strong>，所以必须要指定数据类型，在上面的例子中比较简单，看不出来。</p>
<p>以求均值为例，我们可以让每个 partiton 先求出单个 partition 内各个 key 对应的所有整数的和 sum 以及个数 count，然后返回一个 pair (sum, count)。在 shuffle 后累加各个 key 对应的所有 sum 和 count，再相除得到均值：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sumCountPairs: <span class="type">RDD</span>[(<span class="type">String</span>, (<span class="type">Int</span>, <span class="type">Long</span>))] = testData.combineByKey(</span><br><span class="line">  (_: <span class="type">Int</span>) =&gt; (<span class="number">0</span>, <span class="number">0</span>L),</span><br><span class="line"></span><br><span class="line">  (pair: (<span class="type">Int</span>, <span class="type">Long</span>), value: <span class="type">Int</span>) =&gt;</span><br><span class="line">    (pair._1 + value, pair._2 + <span class="number">1</span>L),</span><br><span class="line"></span><br><span class="line">  (pair1: (<span class="type">Int</span>, <span class="type">Long</span>), pair2: (<span class="type">Int</span>, <span class="type">Long</span>)) =&gt;</span><br><span class="line">    (pair1._1 + part2._1, pair2._2 + pair2._2)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> averages: <span class="type">RDD</span>[<span class="type">String</span>, <span class="type">Double</span>] = sumCountPairs.mapValues &#123;</span><br><span class="line">  <span class="keyword">case</span> (sum, <span class="number">0</span>L) =&gt; <span class="number">0</span>D</span><br><span class="line">  <span class="keyword">case</span> (sum, count) =&gt; sum.toDouble / count</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的C就通过V定义成了<code>(Int, Long)</code></p>
<p>另一个，学生平均成绩的例子</p>
<p><a href="https://blog.csdn.net/t1dmzks/article/details/70249743" target="_blank" rel="noopener">https://blog.csdn.net/t1dmzks/article/details/70249743</a></p>
<p><a href="https://www.edureka.co/blog/apache-spark-combinebykey-explained" target="_blank" rel="noopener">https://www.edureka.co/blog/apache-spark-combinebykey-explained</a></p>
<h3 id="partitionBy"><a href="#partitionBy" class="headerlink" title="partitionBy"></a>partitionBy</h3><p>对RDD进行分区操作。如果原有RDD的partitioner与现有的一致，则不变；否则相当于根据partitioner生成一个新的ShuffledRDD。</p>
<p>对两个RDD进行聚集</p>
<h3 id="？cogroup"><a href="#？cogroup" class="headerlink" title="？cogroup"></a>？cogroup</h3><p>将连个RDD协同划分。每个RDD中相同Key的元素分别聚合为一个集合，并返回两个RDD中对应Key的元素集合的迭代器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(K, (Iterable[V], Iterable[W]))</span><br></pre></td></tr></table></figure>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>对两个需要连接的RDD进行cogroup操作。之后形成新的RDD，对每个key下的元素进行笛卡尔积操作，返回的结果再flat。函数实现为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">this.cogroup(other, partitioner).flatMapValues &#123; case (vs, ws) =&gt;</span><br><span class="line">for (v &lt;- vs; w &lt;- ws) yield (v, w) &#125;</span><br></pre></td></tr></table></figure>
<p>本质就是通过cogroup先进行协同划分，再通过flatMapValues将合并的数据打散。</p>
<p>例如</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.sql.types.&#123;<span class="type">DataTypes</span>, <span class="type">StructField</span>, <span class="type">StructType</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.&#123;<span class="type">Row</span>, <span class="type">SQLContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Run</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"test"</span>).setMaster(<span class="string">"local"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">    sc.setLogLevel(<span class="string">"ERROR"</span>)</span><br><span class="line">    <span class="keyword">val</span> sqlContext = <span class="keyword">new</span> <span class="type">SQLContext</span>(sc)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * id      name</span></span><br><span class="line"><span class="comment">      * 1       zhangsan</span></span><br><span class="line"><span class="comment">      * 2       lisi</span></span><br><span class="line"><span class="comment">      * 3       wangwu</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">val</span> idName = sc.parallelize(<span class="type">Array</span>((<span class="number">1</span>, <span class="string">"zhangsan"</span>), (<span class="number">2</span>, <span class="string">"lisi"</span>), (<span class="number">3</span>, <span class="string">"wangwu"</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * id      age</span></span><br><span class="line"><span class="comment">      * 1       30</span></span><br><span class="line"><span class="comment">      * 2       29</span></span><br><span class="line"><span class="comment">      * 4       21</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">val</span> idAge = sc.parallelize(<span class="type">Array</span>((<span class="number">1</span>, <span class="number">30</span>), (<span class="number">2</span>, <span class="number">29</span>), (<span class="number">4</span>, <span class="number">21</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** *******************************RDD **********************************/</span></span><br><span class="line"></span><br><span class="line">    println(<span class="string">"*********************************RDD**********************************"</span>)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n内关联（inner join）\n"</span>)</span><br><span class="line">    <span class="comment">// 内关联（inner join）</span></span><br><span class="line">    <span class="comment">//  只保留两边id相等的部分</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(zhangsan,30))</span></span><br><span class="line"><span class="comment">      * (2,(lisi,29))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.join(idAge).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n左外关联（left out join）\n"</span>)</span><br><span class="line">    <span class="comment">// 左外关联（left out join）</span></span><br><span class="line">    <span class="comment">// 以左边的数据为标准, 左边的数据一律保留</span></span><br><span class="line">    <span class="comment">// 右边分三情况:</span></span><br><span class="line">    <span class="comment">//      一: 左边的id, 右边有, 则合并数据; (1,(zhangsan,Some(30)))</span></span><br><span class="line">    <span class="comment">//      二: 左边的id, 右边没有, 则右边为空; (3,(wangwu,None))</span></span><br><span class="line">    <span class="comment">//      三: 右边的id, 左边没有, 则不保留; 右边有id为4的行, 但结果中并未保留</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(zhangsan,Some(30)))</span></span><br><span class="line"><span class="comment">      * (2,(lisi,Some(29)))</span></span><br><span class="line"><span class="comment">      * (3,(wangwu,None))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.leftOuterJoin(idAge).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n右外关联（right outer join）\n"</span>)</span><br><span class="line">    <span class="comment">// 右外关联（right outer join）</span></span><br><span class="line">    <span class="comment">// 以右边的数据为标准, 右边的数据一律保留</span></span><br><span class="line">    <span class="comment">// 左边分三种情况:</span></span><br><span class="line">    <span class="comment">//      一: 右边的id, 左边有, 则合并数据; (1,(Some(zhangsan),30))</span></span><br><span class="line">    <span class="comment">//      二: 右边的id, 左边没有, 则左边为空; (4,(None,21))</span></span><br><span class="line">    <span class="comment">//      三: 左边的id, 右边没有, 则不保留; 左边有id为3的行, 但结果中并为保留</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(Some(zhangsan),30))</span></span><br><span class="line"><span class="comment">      * (2,(Some(lisi),29))</span></span><br><span class="line"><span class="comment">      * (4,(None,21))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.rightOuterJoin(idAge).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n全外关联（full outer join）\n"</span>)</span><br><span class="line">    <span class="comment">// 全外关联（full outer join）</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * (1,(Some(zhangsan),Some(30)))</span></span><br><span class="line"><span class="comment">      * (2,(Some(lisi),Some(29)))</span></span><br><span class="line"><span class="comment">      * (3,(Some(wangwu),None))</span></span><br><span class="line"><span class="comment">      * (4,(None,Some(21)))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.fullOuterJoin(idAge).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** *******************************DataFrame **********************************/</span></span><br><span class="line">    <span class="keyword">val</span> schema1 = <span class="type">StructType</span>(<span class="type">Array</span>(<span class="type">StructField</span>(<span class="string">"id"</span>, <span class="type">DataTypes</span>.<span class="type">IntegerType</span>, nullable = <span class="literal">true</span>), <span class="type">StructField</span>(<span class="string">"name"</span>, <span class="type">DataTypes</span>.<span class="type">StringType</span>, nullable = <span class="literal">true</span>)))</span><br><span class="line">    <span class="keyword">val</span> idNameDF = sqlContext.createDataFrame(idName.map(t =&gt; <span class="type">Row</span>(t._1, t._2)), schema1)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> schema2 = <span class="type">StructType</span>(<span class="type">Array</span>(<span class="type">StructField</span>(<span class="string">"id"</span>, <span class="type">DataTypes</span>.<span class="type">IntegerType</span>, nullable = <span class="literal">true</span>), <span class="type">StructField</span>(<span class="string">"age"</span>, <span class="type">DataTypes</span>.<span class="type">IntegerType</span>, nullable = <span class="literal">true</span>)))</span><br><span class="line">    <span class="keyword">val</span> idAgeDF = sqlContext.createDataFrame(idAge.map(t =&gt; <span class="type">Row</span>(t._1, t._2)), schema2)</span><br><span class="line">    println(<span class="string">"*********************************DataFrame**********************************"</span>)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n内关联（inner join）\n"</span>)</span><br><span class="line">    <span class="comment">// 相当于调用, idNameDF.join(idAgeDF, Seq("id"), "inner").collect().foreach(println)</span></span><br><span class="line">    <span class="comment">// 这里只是调用了封装的API</span></span><br><span class="line">    idNameDF.join(idAgeDF, <span class="string">"id"</span>).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n左外关联（left out join）\n"</span>)</span><br><span class="line">    idNameDF.join(idAgeDF, <span class="type">Seq</span>(<span class="string">"id"</span>), <span class="string">"left_outer"</span>).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n右外关联（right outer join）\n"</span>)</span><br><span class="line">    idNameDF.join(idAgeDF, <span class="type">Seq</span>(<span class="string">"id"</span>), <span class="string">"right_outer"</span>).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\n全外关联（full outer join）\n"</span>)</span><br><span class="line">    idNameDF.join(idAgeDF, <span class="type">Seq</span>(<span class="string">"id"</span>), <span class="string">"outer"</span>).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\nleft semi join\n"</span>)</span><br><span class="line">    <span class="comment">// left semi join</span></span><br><span class="line">    <span class="comment">// 左边的id, 在右边有, 就保留左边的数据; 右边的数据不保留, 只有id的有意义的</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * [1,zhangsan]</span></span><br><span class="line"><span class="comment">      * [2,lisi]</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idNameDF.join(idAgeDF, <span class="type">Seq</span>(<span class="string">"id"</span>), <span class="string">"leftsemi"</span>).collect().foreach(println)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当出现相同Key时, join会出现笛卡尔积, 而cogroup的处理方式不同</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SQLContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Run</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"test"</span>).setMaster(<span class="string">"local"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">    sc.setLogLevel(<span class="string">"ERROR"</span>)</span><br><span class="line">    <span class="keyword">val</span> sqlContext = <span class="keyword">new</span> <span class="type">SQLContext</span>(sc)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * id      name</span></span><br><span class="line"><span class="comment">      * 1       zhangsan</span></span><br><span class="line"><span class="comment">      * 2       lisi</span></span><br><span class="line"><span class="comment">      * 3       wangwu</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">val</span> idName = sc.parallelize(<span class="type">Array</span>((<span class="number">1</span>, <span class="string">"zhangsan"</span>), (<span class="number">2</span>, <span class="string">"lisi"</span>), (<span class="number">3</span>, <span class="string">"wangwu"</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * id      age</span></span><br><span class="line"><span class="comment">      * 1       30</span></span><br><span class="line"><span class="comment">      * 2       29</span></span><br><span class="line"><span class="comment">      * 4       21</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">val</span> idAge = sc.parallelize(<span class="type">Array</span>((<span class="number">1</span>, <span class="number">30</span>), (<span class="number">2</span>, <span class="number">29</span>), (<span class="number">4</span>, <span class="number">21</span>)))</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\ncogroup\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(CompactBuffer(zhangsan),CompactBuffer(30)))</span></span><br><span class="line"><span class="comment">      * (2,(CompactBuffer(lisi),CompactBuffer(29)))</span></span><br><span class="line"><span class="comment">      * (3,(CompactBuffer(wangwu),CompactBuffer()))</span></span><br><span class="line"><span class="comment">      * (4,(CompactBuffer(),CompactBuffer(21)))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.cogroup(idAge).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\njoin\n"</span>)</span><br><span class="line">    <span class="comment">// fullOuterJoin于cogroup的结果类似, 只是数据结构不一样</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(Some(zhangsan),Some(30)))</span></span><br><span class="line"><span class="comment">      * (2,(Some(lisi),Some(29)))</span></span><br><span class="line"><span class="comment">      * (3,(Some(wangwu),None))</span></span><br><span class="line"><span class="comment">      * (4,(None,Some(21)))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.fullOuterJoin(idAge).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * id      score</span></span><br><span class="line"><span class="comment">      * 1       100</span></span><br><span class="line"><span class="comment">      * 2       90</span></span><br><span class="line"><span class="comment">      * 2       95</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">val</span> idScore = sc.parallelize(<span class="type">Array</span>((<span class="number">1</span>, <span class="number">100</span>), (<span class="number">2</span>, <span class="number">90</span>), (<span class="number">2</span>, <span class="number">95</span>)))</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\ncogroup, 出现相同id时\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(CompactBuffer(zhangsan),CompactBuffer(100)))</span></span><br><span class="line"><span class="comment">      * (2,(CompactBuffer(lisi),CompactBuffer(90, 95)))</span></span><br><span class="line"><span class="comment">      * (3,(CompactBuffer(wangwu),CompactBuffer()))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.cogroup(idScore).collect().foreach(println)</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"\njoin, 出现相同id时\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * (1,(Some(zhangsan),Some(100)))</span></span><br><span class="line"><span class="comment">      * (2,(Some(lisi),Some(90)))</span></span><br><span class="line"><span class="comment">      * (2,(Some(lisi),Some(95)))</span></span><br><span class="line"><span class="comment">      * (3,(Some(wangwu),None))</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    idName.fullOuterJoin(idScore).collect().foreach(println)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Actions算子"><a href="#Actions算子" class="headerlink" title="Actions算子"></a>Actions算子</h1><h2 id="无输出"><a href="#无输出" class="headerlink" title="无输出"></a>无输出</h2><h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><h3 id="foreachPartitions"><a href="#foreachPartitions" class="headerlink" title="foreachPartitions"></a>foreachPartitions</h3><p>Foreach与ForeachPartition都是在每个partition中对iterator进行操作,</p>
<p>不同的是,foreach是直接在每个partition中直接对iterator执行foreach操作,而传入的function只是在foreach内部使用,</p>
<p>而foreachPartition是在每个partition中把iterator给传入的function,让function自己对iterator进行处理（可以避免内存溢出）.</p>
<h2 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h2><h3 id="saveAsTextFile"><a href="#saveAsTextFile" class="headerlink" title="saveAsTextFile"></a>saveAsTextFile</h3><p>将数据输出，存储到HDFS的指定目录。</p>
<h3 id="saveAsObjectFile"><a href="#saveAsObjectFile" class="headerlink" title="saveAsObjectFile"></a>saveAsObjectFile</h3><p>将分区中每10个元素组成一个Array，然后将这个Array序列化，映射为<code>(Null, BytesWritable(Y))</code>的元素，写入HDFS为SequenceFile的格式。</p>
<h2 id="Scala集合和数据类型"><a href="#Scala集合和数据类型" class="headerlink" title="Scala集合和数据类型"></a>Scala集合和数据类型</h2><h3 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h3><p>相当于toArray，但toArray已经过时不推荐使用。collect将RDD返回为一个单机的scala Array数组。</p>
<h3 id="collectAsMap"><a href="#collectAsMap" class="headerlink" title="collectAsMap"></a>collectAsMap</h3><p>返回一个单机的HashMap。对于重复Key的RDD，后面覆盖前面的。</p>
<h3 id="reduceByKeyLocally"><a href="#reduceByKeyLocally" class="headerlink" title="reduceByKeyLocally"></a>reduceByKeyLocally</h3><p>先对RDD整体进行reduce再collectAsMap。</p>
<h3 id="lookup"><a href="#lookup" class="headerlink" title="lookup"></a>lookup</h3><p>Lookup函数对(Key,Value)型的RDD操作，返回指定Key对应的元素形成的Seq。这</p>
<p>个函数处理优化的部分在于，如果这个RDD包含分区器，则只会对应处理K所在的分区，然</p>
<p>后返回由(K,V)形成的Seq。如果RDD不包含分区器，则需要对全RDD元素进行暴力扫描</p>
<p>处理，搜索指定K对应的元素。</p>
<h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p>返回最大的k个元素</p>
<h3 id="take"><a href="#take" class="headerlink" title="take"></a>take</h3><p>返回最小的k个</p>
<h3 id="takeOrdered"><a href="#takeOrdered" class="headerlink" title="takeOrdered"></a>takeOrdered</h3><p>返回最小的k个元素，并且在返回的数组中保持元素的顺序。</p>
<h3 id="first"><a href="#first" class="headerlink" title="first"></a>first</h3><p>相当于top(1)，可以定义排序的方式Ordering[T]</p>
<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>相当于对RDD中的元素进行reduceLeft函数的操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Some(iter.reduceLeft(cleanF))</span><br></pre></td></tr></table></figure>
<p>先对每个分区的集合进行reduceLeft，结果形成一个元素，再对这个结果做reduceLeft。</p>
<p>例如，用户自定义函数为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f:(A,B)=&gt;(A._1+&quot;@&quot;+B._1,A._2+B._2)</span><br></pre></td></tr></table></figure>
<p><img src="//schwimmer.github.io/2018/04/03/hadoop-spark/spark/spark算子分类及功能/reduce.png" alt=""></p>
<h3 id="fold"><a href="#fold" class="headerlink" title="fold"></a>fold</h3><p>和reduce原理相同，接收与reduce接收的函数签名相同的函数，不同点是，另外再加上一个初始值作为第一次调用的结果。</p>
<h3 id="aggregate"><a href="#aggregate" class="headerlink" title="aggregate"></a>aggregate</h3><p>可以对两个不同类型的元素进行聚合，即支持异构。它先聚合每一个分区里的元素，然后将所有结果返回回来，再用一个给定的conbine方法以及给定的初始值zero value进行聚合。</p>
<blockquote>
<p>没懂</p>
<p>aggreagate与fold和reduce的不同之处在于,aggregate相当于采用归并的方式进行数<br>据聚集,这种聚集是并行化的。而在fold和reduce函数的运算过程中,每个分区中需要进行<br>串行处理,每个分区串行计算完结果,结果再按之前的方式进行聚集,并返回最终聚集结<br>果。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def aggregate [U: ClassTag] (zeroValue: U) (seqOp: (U,T)=&gt;U，combOp: (U,U)=&gt;U):U</span><br></pre></td></tr></table></figure>
<p>由以上可以看到，(zeroValue: U)是给定一个初值，后半部分有两个函数，seqOp与combOp。<br>seqOp相当于是在各个分区里进行的聚合操作，它支持(U,T)=&gt;U，也就是支持不同类型的聚合。<br>combOp是将seqOp后的结果再进行聚合，此时的结果全部是U类，只能进行同构聚合。</p>
<h1 id="两个特殊变量"><a href="#两个特殊变量" class="headerlink" title="两个特殊变量"></a>两个特殊变量</h1><h2 id="broadcast"><a href="#broadcast" class="headerlink" title="broadcast"></a>broadcast</h2><p>用于广播Map Side Join中的小表，以及广播大变量等场景。这些数据集合在单节点内存能够容纳,不需要像RDD那样在节点之间打散存储。Spark运行时把广播变量数据发到各个节点,并保存下来,后续计算可以复用。</p>
<p>相比Hadoop的distributed cache，广播的内容可以跨作业共享。</p>
<h2 id="accumulator"><a href="#accumulator" class="headerlink" title="accumulator"></a>accumulator</h2><p>允许做全局累加操作，如accumulator变量广泛使用在应用中记录当前的运行指标的情景。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/04/01/算法与数据结构/布隆过滤器/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/04/01/算法与数据结构/布隆过滤器/" class="post-title-link" itemprop="url">未命名</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-04-01 21:08:16" itemprop="dateCreated datePublished" datetime="2018-04-01T21:08:16+08:00">2018-04-01</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-02-18 19:00:46" itemprop="dateModified" datetime="2019-02-18T19:00:46+08:00">2019-02-18</time>
              </span>
            
          

          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/04/01/算法与数据结构/布隆过滤器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/01/算法与数据结构/布隆过滤器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自《程序员代码面试指南 IT名企算法与数据结构题目最优解 ,左程云著》</p>
<p>如果碰到网页黑名单系统、爬虫的网址判重等，如果系统容忍一定程度的失误率，但对空间要求比较严格，往往是要求了解布隆过滤器。</p>
<p>一个布隆过滤器精确代表一个集合，并可以精确判断一个元素是否在集合中。但是有多精确，取决于具体的设计，但不可能完全正确。</p>
<h1 id="哈希函数"><a href="#哈希函数" class="headerlink" title="哈希函数"></a>哈希函数</h1><p>输入是任意，输出是固定范围，假设为S，并具有如下性质：</p>
<p>1、典型的哈希函数都有无限的输入值域。</p>
<p>2、传入相同的输入值，返回值一样。</p>
<p>3、传入不同输入值，返回值可能一样，也可能不一样。</p>
<p>4、最重要的性质：很多不同输入值得到的返回值会均匀分布在S上。</p>
<p>第4点是评价一个哈希函数优劣的关键，这种均匀分布与输入值出现的规律无关。比如MD5和SHA1算法。</p>
<h1 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>假设有一个长度为m的bit类型的数组，即数组中每个位置只占一个bit，每个bit只有0和1两种状态</p>
<p><img src="//schwimmer.github.io/2018/04/01/算法与数据结构/布隆过滤器/bit array.png" alt=""></p>
<p>再假设一共有k个哈希函数，这些函数的输出域S都大于或等于m，且这些哈希函数彼此独立。那么对同一个输入对象，经过k个哈希函数算出来的结果也是独立的。对算出来的每个结果都对m取余，然后再bit array上把相应位置设置1。</p>
<p><img src="//schwimmer.github.io/2018/04/01/算法与数据结构/布隆过滤器/bit array mod.png" alt=""></p>
<p>把bit类型的数组记为bitMap。处理完所有输入对象后，可能bitMap中已经有很多位置被涂黑。至此，一个布隆过滤器生成完毕，这个代表之前所有输入对象组成的集合。</p>
<p>在检查阶段，如何检查某一个对象是否是之前的某一个输入对象？</p>
<blockquote>
<p>一个输入对象，通过k个哈希算出k个值，把k个值对m取余，在bitMap上看这些位置是不是都是黑，如果有一个不为黑，则一定不在集合。如果都是黑，说明在集合，但是这里存在误判。</p>
</blockquote>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>如果bitMap的大小m相比于输入对象的个数n过小，失误率会变大。</p>
<p>假设黑名单中样本个数为100亿个，记为n；失误率不希望超过0.01%，记为p；每个样本（url）大小64B，当然这个大小不会影响布隆过滤器的大小。</p>
<p>所以n=100亿，p=0.01%，布隆过滤器的大小m由以下公式确定：</p>
<script type="math/tex; mode=display">
m = - \frac{n*\ln p}{(\ln 2)^2}</script><p>根据公式计算出m=19.19n，大约20n，即需要2000亿个bit，也即是25G。</p>
<p>哈希函数的个数由以下公式决定：</p>
<script type="math/tex; mode=display">
k = \ln 2 * \frac {m} {n}</script><p>计算出约为14个。</p>
<p>然后用25GB的bitMap再单独实现14个哈希函数，根据如上描述生成布隆过滤器。</p>
<p>失误率的计算</p>
<p>失误率就是某个不认识的url，经过k个哈希函数后，在布隆过滤器取余后发现这些位置上都是黑，这样的情况称为一个失误。那么<strong>失误率就是看k个位置都是黑的概率</strong>。</p>
<p>假设k个哈希函数独立，对于某一个bit位，一个输入对象在被k个哈希函数散列后，这个位置依然没有被涂黑的概率为：</p>
<script type="math/tex; mode=display">
(1-\frac 1 m)^k</script><p>经过n个输入对象后，这个位置依然没有被涂黑的概率为：</p>
<script type="math/tex; mode=display">
(1-\frac 1 m)^{kn}</script><p>被涂黑的概率就是</p>
<script type="math/tex; mode=display">
1-(1-\frac 1 m)^{kn}</script><p>则在检查阶段，检查k个位置都为黑的概率为：</p>
<script type="math/tex; mode=display">
(1-(1-\frac 1 m)^{kn})^k = (1-(1-\frac 1 m)^{-m*- \frac {-kn} {m}})^k</script><p>在$x \to 0$时，$(1+x)^{\frac 1 x} \to e$ 。这里m是很大的数，所以$-\frac 1m \to 0$，则简化为</p>
<script type="math/tex; mode=display">
(1-e^{\frac {-nk} {m}})^k</script><h2 id="误报的解决"><a href="#误报的解决" class="headerlink" title="误报的解决"></a>误报的解决</h2><p>通过建立白名单防止误报。比如已经发现某个样本不在布隆过滤器，但每次计算后结果都显示其在布隆过滤器中，则可以把该样本加入白名单中，以后就知道的确不在过滤器中。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>爬虫项目中用到了布隆过滤器</p>
<p><code>[SimpleBloomFilter.java](../../../../gitlab/data-platform/page-feature/rtbreq-frontier/src/main/java/com/buzzinate/util/SimpleBloomFilter.java)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.buzzinate.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.BitSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBloomFilter</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Logger logger = Logger.getLogger(SimpleBloomFilter.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> SimpleBloomFilter instance = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SIZE = Integer.MAX_VALUE;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] seeds = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123; <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">61</span> &#125;;</span><br><span class="line">	<span class="keyword">private</span> BitSet bits = <span class="keyword">new</span> BitSet(DEFAULT_SIZE);</span><br><span class="line">	<span class="keyword">private</span> SimpleHash[] func = <span class="keyword">new</span> SimpleHash[seeds.length];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> String filename = <span class="string">"/opt/tomcat/bloomfilter"</span>;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">SimpleBloomFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; seeds.length; i++) &#123;</span><br><span class="line">			func[i] = <span class="keyword">new</span> SimpleHash(DEFAULT_SIZE, seeds[i]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> BitSet <span class="title">getBits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> bits;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBits</span><span class="params">(BitSet bits)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.bits = bits;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (SimpleHash f : func) &#123;</span><br><span class="line">			bits.set(f.hash(value), <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">boolean</span> ret = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">for</span> (SimpleHash f : func) &#123;</span><br><span class="line">			ret = ret &amp;&amp; bits.get(f.hash(value));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; DEFAULT_SIZE;i ++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(bits.get(i))&#123;</span><br><span class="line">					count ++ ;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			logger.info(<span class="string">"bloomfilter true bits:"</span>+count);</span><br><span class="line">			</span><br><span class="line">			File file = <span class="keyword">new</span> File(filename+<span class="string">".tmp"</span>);</span><br><span class="line">			logger.info(<span class="string">"save bloomfilter, path "</span>+ file.getAbsolutePath());</span><br><span class="line">			ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(</span><br><span class="line">					<span class="keyword">new</span> FileOutputStream(file, <span class="keyword">false</span>));</span><br><span class="line">			oos.writeObject(bits);</span><br><span class="line">			</span><br><span class="line">			oos.flush();</span><br><span class="line">			oos.close();</span><br><span class="line">			file.renameTo(<span class="keyword">new</span> File(filename));</span><br><span class="line">			logger.info(<span class="string">"saved bloomfilter to "</span> + file.getAbsolutePath());</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			logger.error(e, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BitSet <span class="title">readBit</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		BitSet bits = <span class="keyword">new</span> BitSet(DEFAULT_SIZE);</span><br><span class="line">		File file = <span class="keyword">new</span> File(filename);</span><br><span class="line">		<span class="keyword">if</span>(StringUtils.isNotBlank(path))&#123;</span><br><span class="line">			file = <span class="keyword">new</span> File(path);</span><br><span class="line">		&#125;</span><br><span class="line">		logger.info(<span class="string">"read bloomfilter, path "</span>+ file.getAbsolutePath());</span><br><span class="line">		<span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">			logger.info(file.getAbsolutePath()+<span class="string">" not exists!"</span>);</span><br><span class="line">			<span class="keyword">return</span> bits;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">					file));</span><br><span class="line">			bits = (BitSet) ois.readObject();</span><br><span class="line">			ois.close();</span><br><span class="line">			<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; DEFAULT_SIZE;i ++)&#123;</span><br><span class="line">				<span class="keyword">if</span>(bits.get(i))&#123;</span><br><span class="line">					count ++ ;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			logger.info(<span class="string">"bloomfilter true bits:"</span>+count);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			logger.error(<span class="string">"read bloomfilter fail!"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> bits;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 内部类，simpleHash</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleHash</span> </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">int</span> cap;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">int</span> seed;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">SimpleHash</span><span class="params">(<span class="keyword">int</span> cap, <span class="keyword">int</span> seed)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.cap = cap;</span><br><span class="line">			<span class="keyword">this</span>.seed = seed;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">int</span> len = value.length();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">				result = seed * result + value.charAt(i);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> (cap - <span class="number">1</span>) &amp; result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SimpleBloomFilter <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(instance == <span class="keyword">null</span>)&#123;</span><br><span class="line">			instance = <span class="keyword">new</span> SimpleBloomFilter();</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">new</span> File(filename).exists())&#123;</span><br><span class="line">				instance.setBits(instance.readBit(<span class="string">""</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> instance;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 改变实例</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">changeInstance</span><span class="params">(String path)</span></span>&#123;</span><br><span class="line">		SimpleBloomFilter tmpInstance = <span class="keyword">new</span> SimpleBloomFilter();</span><br><span class="line">		File file = <span class="keyword">new</span> File(path);</span><br><span class="line">		<span class="keyword">if</span>(System.currentTimeMillis() - file.lastModified() &lt; <span class="number">3600</span> * <span class="number">1000</span>)&#123;</span><br><span class="line">			tmpInstance.setBits(tmpInstance.readBit(path));</span><br><span class="line">			instance = tmpInstance;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回bit为1的数量</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">trueBits</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; DEFAULT_SIZE;i ++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(instance.bits.get(i))&#123;</span><br><span class="line">				count ++ ;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> count;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SimpleBloomFilter filter = <span class="keyword">new</span> SimpleBloomFilter();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;<span class="number">100000</span>; i++) &#123;</span><br><span class="line">			filter.add(i + <span class="string">""</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">long</span> t1 = System.currentTimeMillis();</span><br><span class="line">		filter.saveBit();</span><br><span class="line">		<span class="keyword">long</span> t2 = System.currentTimeMillis();</span><br><span class="line">		System.out.println(<span class="string">"it takes "</span> + (t2 - t1)+<span class="string">"ms"</span>);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line"><span class="comment">//		System.out.println("add end");</span></span><br><span class="line"><span class="comment">//		int cnt = 0;</span></span><br><span class="line"><span class="comment">//		for (int i = 200000; i &gt; 100000; i--) &#123;</span></span><br><span class="line"><span class="comment">//			if (filter.contains(i + "")) &#123;</span></span><br><span class="line"><span class="comment">//				cnt++;</span></span><br><span class="line"><span class="comment">//			&#125;</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//		System.out.println("total:" + cnt / 300000000.0);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/03/31/编程语言学习/JAVA/java笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/31/编程语言学习/JAVA/java笔记/" class="post-title-link" itemprop="url">java技巧总结（不断更新中）</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-31 10:30:28" itemprop="dateCreated datePublished" datetime="2018-03-31T10:30:28+08:00">2018-03-31</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-03 22:55:27" itemprop="dateModified" datetime="2019-07-03T22:55:27+08:00">2019-07-03</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/03/31/编程语言学习/JAVA/java笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/31/编程语言学习/JAVA/java笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="list转array"><a href="#list转array" class="headerlink" title="list转array"></a>list转array</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Double&gt; scores = <span class="keyword">new</span> ArrayList&lt;Double&gt;();</span><br><span class="line"></span><br><span class="line">Double[] arrays = scores.toArray(<span class="keyword">new</span> Double[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<h1 id="log4j打印catch堆栈信息"><a href="#log4j打印catch堆栈信息" class="headerlink" title="log4j打印catch堆栈信息"></a>log4j打印catch堆栈信息</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.error(e.getMessage(),e);</span><br></pre></td></tr></table></figure>
<h1 id="判断字符类型"><a href="#判断字符类型" class="headerlink" title="判断字符类型"></a>判断字符类型</h1><h2 id="判断中文字符"><a href="#判断中文字符" class="headerlink" title="判断中文字符"></a>判断中文字符</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Character.isLetter()</span><br></pre></td></tr></table></figure>
<h2 id="判断是否为英文或数字"><a href="#判断是否为英文或数字" class="headerlink" title="判断是否为英文或数字"></a>判断是否为英文或数字</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAlphaOrDigit</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a><strong>文件读写</strong></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">String encoding = &quot;GBK&quot;;</span><br><span class="line">		String lineText = null;</span><br><span class="line">		File file = new File(&quot;D:\\00projects\\20buzz-cookie-info\\chinaz.json&quot;);</span><br><span class="line">		if (file.isFile() &amp;&amp; file.exists()) &#123;</span><br><span class="line">			BufferedReader read = new BufferedReader(new InputStreamReader(</span><br><span class="line">					new FileInputStream(file), encoding));</span><br><span class="line">			while((lineText=read.readLine())!=null)&#123;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			read.close();</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h1 id="读tar-gz"><a href="#读tar-gz" class="headerlink" title="读tar.gz"></a>读tar.gz</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; content = GzipUtil.readAllLines(Thread.currentThread().getContextClassLoader()</span><br><span class="line">                    .getResourceAsStream(filename));</span><br></pre></td></tr></table></figure>
<h1 id="读resource的文件"><a href="#读resource的文件" class="headerlink" title="读resource的文件"></a>读resource的文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BufferedReader br = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			br = new BufferedReader(new InputStreamReader(Thread.currentThread().getContextClassLoader()</span><br><span class="line">					.getResourceAsStream(modelFilePath), &quot;utf8&quot;));</span><br><span class="line">			</span><br><span class="line">	/*		 br = new BufferedReader(new InputStreamReader(new</span><br><span class="line">			 FileInputStream(modelFilePath),</span><br><span class="line">			 &quot;utf8&quot;));*/</span><br><span class="line">			String line = &quot;&quot;;</span><br><span class="line">			while ((line = br.readLine()) != null) &#123;</span><br><span class="line">				String[] dataArr = line.split(&quot;\t&quot;);</span><br><span class="line">				if(dataArr.length == 2)&#123;</span><br><span class="line">					enToCh.put(dataArr[0], dataArr[1]);</span><br><span class="line">					chToEn.put(dataArr[1], dataArr[0]);</span><br><span class="line">				&#125;				</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				br.close();</span><br><span class="line">			&#125; catch (IOException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h2 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BufferedWriter bw = null;</span><br><span class="line">File f = new File(path);</span><br><span class="line">bw = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(f),&quot;gbk&quot;));</span><br><span class="line">bw.write(JSON.toJSONString(lookalikeNode));</span><br><span class="line">bw.write(&quot;\n&quot;);</span><br><span class="line">bw.close();</span><br></pre></td></tr></table></figure>
<h1 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h1><h2 id="日期和字符串互转"><a href="#日期和字符串互转" class="headerlink" title="日期和字符串互转"></a>日期和字符串互转</h2><p>字符串转日期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//2017-05-26-16-40-13</span><br><span class="line">SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd-HH-mm-ss&quot;);</span><br><span class="line">Date date = simpleDateFormat.parse(xmoEvent.getOpxdate());</span><br></pre></td></tr></table></figure>
<p>日期输出为字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">simpleDateFormat = new SimpleDateFormat(&quot;yyyyMMdd&quot;);</span><br><span class="line">System.out.println(simpleDateFormat.format(date));</span><br></pre></td></tr></table></figure>
<p>当前日期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">System.currentTimeMillis()</span><br><span class="line">或者</span><br><span class="line">Date date = new Date(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">字符串表示</span><br><span class="line">SimpleDateFormat simpleDateFormat  = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">Date date = new Date(System.currentTimeMillis());</span><br><span class="line">System.out.println(simpleDateFormat.format(date));</span><br></pre></td></tr></table></figure>
<h2 id="两个日期之间的天数和周数"><a href="#两个日期之间的天数和周数" class="headerlink" title="两个日期之间的天数和周数"></a>两个日期之间的天数和周数</h2><p><a href="http://www.jb51.net/article/100441.htm" target="_blank" rel="noopener">http://www.jb51.net/article/100441.htm</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Calendar end = Calendar.getInstance();</span><br><span class="line">//取日期是一年中第几天</span><br><span class="line">d1 = end.get(Calendar.DAY_OF_YEAR)</span><br><span class="line"></span><br><span class="line">//两个日期相隔几周</span><br><span class="line">(d2-d1)/7</span><br><span class="line">//星期中相隔几天</span><br><span class="line"></span><br><span class="line">Date转为Calendar</span><br></pre></td></tr></table></figure>
<h2 id="日期加减"><a href="#日期加减" class="headerlink" title="日期加减"></a>日期加减</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Calendar calendar = Calendar.getInstance();//此时打印它获取的是系统当前时间</span><br><span class="line">        calendar.add(Calendar.DATE, -1);    //得到前一天</span><br><span class="line"></span><br><span class="line">String  yestedayDate</span><br><span class="line"></span><br><span class="line">= new SimpleDateFormat("yyyy-MM-dd").format(cal.getTime());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        calendar.add(Calendar.MONTH, -1);    //得到前一个月</span><br><span class="line">        int year = calendar.get(Calendar.YEAR);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       int month = calendar.get(Calendar.MONTH)+1; //输出前一月的时候要记得加1</span><br></pre></td></tr></table></figure>
<h2 id="String-Date-Calendar之间的转换"><a href="#String-Date-Calendar之间的转换" class="headerlink" title="String Date Calendar之间的转换"></a>String Date Calendar之间的转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.Calendar 转化 String</span><br><span class="line"></span><br><span class="line">Calendar calendat = Calendar.getInstance();</span><br><span class="line"></span><br><span class="line">SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"></span><br><span class="line">String dateStr = sdf.format(calendar.getTime());</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.String 转化Calendar</span><br><span class="line"></span><br><span class="line">String str=<span class="string">"2012-5-27"</span>;</span><br><span class="line"></span><br><span class="line">SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"></span><br><span class="line">Date date =sdf.parse(str);</span><br><span class="line"></span><br><span class="line">Calendar calendar = Calendar.getInstance();</span><br><span class="line"></span><br><span class="line">calendar.setTime(date);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.Date 转化String</span><br><span class="line"></span><br><span class="line">SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"></span><br><span class="line">String dateStr=sdf.format(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">4</span>.String 转化Date</span><br><span class="line"></span><br><span class="line">String str=<span class="string">"2012-5-27"</span>;</span><br><span class="line"></span><br><span class="line">SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"></span><br><span class="line">Date date= sdf.parse(str);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">5</span>.Date 转化Calendar</span><br><span class="line"></span><br><span class="line">Calendar calendar = Calendar.getInstance();</span><br><span class="line"></span><br><span class="line">calendar.setTime(<span class="keyword">new</span> java.util.Date());</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">6</span>.Calendar转化Date</span><br><span class="line"></span><br><span class="line">Calendar calendar = Calendar.getInstance();</span><br><span class="line"></span><br><span class="line">java.util.Date date =calendar.getTime();</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">7</span>.String 转成 Timestamp</span><br><span class="line"></span><br><span class="line">Timestamp ts = Timestamp.valueOf(<span class="string">"2012-1-14 08:11:00"</span>);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">8</span>.Date 转 TimeStamp</span><br><span class="line"></span><br><span class="line">SimpleDateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">String time = df.format(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">Timestamp ts = Timestamp.valueOf(time);</span><br></pre></td></tr></table></figure>
<h1 id="读写json"><a href="#读写json" class="headerlink" title="读写json"></a>读写json</h1><h2 id="常规解析"><a href="#常规解析" class="headerlink" title="常规解析"></a>常规解析</h2><p>对于某个json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"classic_payload"</span>:&#123;<span class="attr">"opxvrsn"</span>:<span class="string">"ut"</span>,<span class="attr">"opxuid"</span>:<span class="string">"0"</span>,<span class="attr">"opxclientid"</span>:<span class="string">"1127"</span>,<span class="attr">"opxcounter"</span>:<span class="string">"1"</span>,<span class="attr">"rnum"</span>:<span class="string">"4208937089424580.5"</span>,<span class="attr">"re"</span>:<span class="string">"http%3A%2F%2Fwww.liba.com%2Findex.shtml"</span>,<span class="attr">"opxpid"</span>:<span class="string">"201705221928320003451270013251741"</span>,<span class="attr">"opxsid"</span>:<span class="string">"2ebfa12ef6fe88985d2c1b04ea8d22df"</span>,<span class="attr">"opxdate"</span>:<span class="string">"2017-05-26-16-40-13"</span>,<span class="attr">"opxip"</span>:<span class="string">"120.92.161.27"</span>,<span class="attr">"opxleadsite"</span>:<span class="string">"http://www.liba.com/index.shtml"</span>,<span class="attr">"opxreferringsite"</span>:<span class="string">"http%3A%2F%2Fshuaxinfuwu.nipponpaint.com.cn%2Findex.aspx%3Futm_medium%3DVM%26utm_source%3DLB"</span>,<span class="attr">"useragent"</span>:<span class="string">"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"</span>,<span class="attr">"language"</span>:<span class="string">"zh-CN,zh;q=0.8,zh-TW;q=0.6,en-US;q=0.4,en;q=0.2"</span>,<span class="attr">"accept"</span>:<span class="string">"*/*"</span>,<span class="attr">"connection"</span>:<span class="string">"close"</span>,<span class="attr">"encoding"</span>:<span class="string">"gzip, deflate"</span>,<span class="attr">"hversion"</span>:<span class="string">"HTTP/1.0"</span>,<span class="attr">"frompaidsearch"</span>:<span class="number">0</span>,<span class="attr">"hascookie"</span>:<span class="number">0</span>,<span class="attr">"opxeventid"</span>:<span class="string">"13057"</span>&#125;,<span class="attr">"machine"</span>:<span class="string">"10.11.10.12"</span>,<span class="attr">"uuid"</span>:<span class="string">"318553958122302938064698429658924956664"</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//取其中某个字段</span><br><span class="line">JSONObject jsonObj = JSONObject.parseObject(content);</span><br><span class="line">String uuid = jsonObj.getString(&quot;uuid&quot;);</span><br><span class="line"></span><br><span class="line">//如果是数组</span><br><span class="line">JSONArray array = json.getJSONArray(&quot;result&quot;);  </span><br><span class="line">List&lt;Keyword&gt; keywords = new ArrayList&lt;&gt;();  </span><br><span class="line">for (int i = 0; i &lt; array.size(); i++) &#123;  </span><br><span class="line">    JSONObject jo = array.getJSONObject(i);  </span><br><span class="line">    assertEquals(topic.getId(), jo.getInteger(&quot;topicId&quot;));  </span><br><span class="line">    keywords.add(new Keyword(topic, jo.getInteger(&quot;id&quot;), jo.getString(&quot;keyword&quot;), null,  </span><br><span class="line">            jo.getJSONArray(&quot;spiderTopics&quot;), jo.getString(&quot;updatedAt&quot;), jo.getString(&quot;createdAt&quot;)));  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">//如果是某个类</span><br></pre></td></tr></table></figure>
<h2 id="解析JSONArray"><a href="#解析JSONArray" class="headerlink" title="解析JSONArray"></a>解析JSONArray</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">List&lt;IP&gt; iplist = <span class="keyword">new</span> ArrayList&lt;IP&gt;();</span><br><span class="line">iplist.add(<span class="keyword">new</span> IP(<span class="string">"1.4.255.255"</span>));</span><br><span class="line">iplist.add(<span class="keyword">new</span> IP(<span class="string">"1.0.255.255"</span>));</span><br><span class="line">iplist.add(<span class="keyword">new</span> IP(<span class="string">"1.2.255.255"</span>));</span><br><span class="line"></span><br><span class="line">String ipliststr = JSON.toJSONString(iplist);</span><br><span class="line"></span><br><span class="line">List&lt;IP&gt; ipl = <span class="keyword">new</span> ArrayList&lt;IP&gt;(JSONArray.parseArray(ipliststr,IP.class));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (IP ip : ipl) &#123;</span><br><span class="line">  System.out.println(ip.getIp_address());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析的类中有嵌套的ArrayList&lt;类&gt;，可以直接解析，但对ArrayList的命名有要求，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private ArrayList&lt;KeywordItem&gt; keywordItems;</span><br></pre></td></tr></table></figure>
<h2 id="解析为复杂集合"><a href="#解析为复杂集合" class="headerlink" title="解析为复杂集合"></a>解析为复杂集合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TypeReference&lt;HashMap&lt;String, ArrayList&lt;WebPageInfo&gt;&gt;&gt; ty = new TypeReference&lt;HashMap&lt;String, ArrayList&lt;WebPageInfo&gt;&gt;&gt;()&#123;&#125;;</span><br><span class="line">	      </span><br><span class="line">			try &#123;</span><br><span class="line">				d2wps = JSON.parseObject(info,ty);</span><br><span class="line">			&#125; catch (Exception e) &#123;</span><br><span class="line">				continue;</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h2 id="比较两个double是否相等"><a href="#比较两个double是否相等" class="headerlink" title="比较两个double是否相等"></a>比较两个double是否相等</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">long thisBits    = Double.doubleToLongBits(d1);</span><br><span class="line">        long anotherBits = Double.doubleToLongBits(d2);</span><br><span class="line">        return (thisBits == anotherBits ?  0 : // Values are equal</span><br></pre></td></tr></table></figure>
<h1 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//匹配的是括号中的内容，匹配时，先matcher.find()，然后找group，group（0）是本身。group（1）是第一个括号内容</span></span><br><span class="line"><span class="comment">//这里匹配的是可能包括&amp;，然后有q=，括号是提取的内容，用懒惰模式。最后要么是结尾，要么是&amp;，</span></span><br><span class="line">Pattern pattern = Pattern.compile(<span class="string">"&amp;?(q|p|wd|word|query)=(.*?)(&amp;|$)"</span>);</span><br><span class="line">Matcher matcher = pattern.matcher(url.getQuery());</span><br><span class="line"><span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">	System.out.println(matcher.group(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="String转char"><a href="#String转char" class="headerlink" title="String转char"></a>String转char</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char[] chars = word.toCharArray();</span><br></pre></td></tr></table></figure>
<h1 id="hdfs"><a href="#hdfs" class="headerlink" title="hdfs"></a>hdfs</h1><p>读数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FSDataInputStream dis = null;</span><br><span class="line">FileSystem fs = FileSystem.get(HDFSHandler.conf);</span><br><span class="line">dis = fs.open(new Path(modelFile));</span><br></pre></td></tr></table></figure>
<h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><h2 id="ArrayList拼接成String"><a href="#ArrayList拼接成String" class="headerlink" title="ArrayList拼接成String"></a>ArrayList拼接成String</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; wordSet = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">StringUtils.join(wordSet, <span class="string">" "</span>);</span><br></pre></td></tr></table></figure>
<h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><h3 id="一句话初始化"><a href="#一句话初始化" class="headerlink" title="一句话初始化"></a>一句话初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;() &#123;&#123;</span><br><span class="line">    add(<span class="string">"A"</span>);</span><br><span class="line">    add(<span class="string">"B"</span>);</span><br><span class="line">    add(<span class="string">"C"</span>);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; places = Arrays.asList(<span class="string">"Buenos Aires"</span>, <span class="string">"Córdoba"</span>, <span class="string">"La Plata"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化一个 List，而不是 ArrayList</span></span><br><span class="line">List&lt;String&gt; list = [<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化的更好看些</span></span><br><span class="line">List&lt;Long&gt; cptIds = Lists.newArrayList();</span><br></pre></td></tr></table></figure>
<h2 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列"></a>优先级队列</h2><p><a href="http://blog.csdn.net/hiphopmattshi/article/details/7334487" target="_blank" rel="noopener">java中PriorityQueue优先级队列使用方法</a></p>
<p>优先级队列是不同于先进先出队列的另一种队列。每次从队列中取出的是具有最高优先权的元素。如果不提供Comparator的话，优先队列中元素默认按自然顺序排列，也就是数字默认是小的在队列头，字符串则按字典序排列。</p>
<p>如果想实现按照自己的意愿进行优先级排列的队列的话，需要实现Comparator接口。下面的方法，实现了根据某个变量，来进行优先级队列的建立。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;test&gt; OrderIsdn =  <span class="keyword">new</span> Comparator&lt;test&gt;()&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(test o1, test o2)</span> </span>&#123;  </span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub  </span></span><br><span class="line">        <span class="keyword">int</span> numbera = o1.getPopulation();  </span><br><span class="line">        <span class="keyword">int</span> numberb = o2.getPopulation();  </span><br><span class="line">        <span class="keyword">if</span>(numberb &gt; numbera)   <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(numberb&lt;numbera)  <span class="keyword">return</span> -<span class="number">1</span>; </span><br><span class="line">        <span class="keyword">else</span>  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line">Queue&lt;test&gt; priorityQueue =  <span class="keyword">new</span> PriorityQueue&lt;test&gt;(<span class="number">11</span>,OrderIsdn);</span><br></pre></td></tr></table></figure>
<h1 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h1><p>TreeSet中的对象要实现comparable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class KeywordItem implements Comparable&lt;KeywordItem&gt; &#123;</span><br><span class="line">	public String name;</span><br><span class="line">	public Double score;</span><br><span class="line">	</span><br><span class="line">	public KeywordItem(String name, Double score) &#123;</span><br><span class="line">		this.name = name;</span><br><span class="line">		this.score = score;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return this.name + &quot;\t&quot; + score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public int compareTo(KeywordItem o) &#123;</span><br><span class="line">		if (this.score &lt; o.score) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return -1;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入的时候自动比较</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TreeSet&lt;KeywordItem&gt; looklikeCodeTree = new TreeSet&lt;KeywordItem&gt;();</span><br><span class="line">if (entry.getValue() &gt; this.minLookLike) &#123;</span><br><span class="line">								looklikeCodeTree.add(new KeywordItem(entry.getKey().toString(), entry.getValue()));</span><br><span class="line">								if (looklikeCodeTree.size() &gt; maxLookLikeTagCnt) &#123;</span><br><span class="line">									looklikeCodeTree.pollLast();</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br></pre></td></tr></table></figure>
<h1 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line"><span class="comment">//随机打印一些日志</span></span><br><span class="line"><span class="keyword">if</span> (random.nextDouble() &lt; <span class="number">0.00001</span> ) &#123;</span><br><span class="line">	logger.info(JSON.toJSONString(obj));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="二维数组"><a href="#二维数组" class="headerlink" title="二维数组"></a>二维数组</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int[][] arr = new int[3][5];</span><br></pre></td></tr></table></figure>
<h1 id="URLDecoder"><a href="#URLDecoder" class="headerlink" title="URLDecoder"></a>URLDecoder</h1><ul>
<li>Illegal hex characters in escape (%) pattern - For input string: “u0”</li>
</ul>
<ul>
<li>Incomplete trailing escape (%) pattern</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchString=URLDecoder.decode(searchString.replaceAll(&quot;%&quot;, &quot;%25&quot;),&quot;utf-8&quot;);</span><br></pre></td></tr></table></figure>
<h1 id="List对象的去重"><a href="#List对象的去重" class="headerlink" title="List对象的去重"></a>List对象的去重</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def dedupBy[T](list: List[T])(f: T =&gt; String): List[T] = &#123;</span><br><span class="line">    val buf = new ListBuffer[T]</span><br><span class="line">    val set = new HashSet[String]</span><br><span class="line">    list foreach &#123; e =&gt;</span><br><span class="line">      val key = f(e)</span><br><span class="line">      if (!set.contains(key)) &#123;</span><br><span class="line">        buf += e</span><br><span class="line">        set += key</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buf.result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h1><h2 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h2><h2 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h2><p>两者的使用参考InterestTimerTask.java</p>
<p><a href="http://www.importnew.com/15731.html" target="_blank" rel="noopener">http://www.importnew.com/15731.html</a></p>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>setnx是「<strong>SET</strong> if <strong>N</strong>ot e<strong>X</strong>ists」的缩写，可以用来实现锁。如果setnx存在，则执行更新，更新后删除这个key。在锁的时候，其他对redis的访问要么等待，要么用过期的缓存</p>
<p>注意要加上锁的过期时间，防止请求意外退出而锁得不到释放。</p>
<h1 id="检测语言"><a href="#检测语言" class="headerlink" title="检测语言"></a>检测语言</h1><p>是否为繁体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String simpleText = TraditionalChineseDictionary.convertToSimplifiedChinese(text);</span><br><span class="line">if (!simpleText.equals(text)) &#123;</span><br><span class="line">    			lang =  &quot;zh-hk&quot;;</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<p>是否为英文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isEnglish(String str) &#123;</span><br><span class="line">		String regEx = &quot;[a-zA-Z]+&quot;;</span><br><span class="line">		Pattern p = Pattern.compile(regEx);</span><br><span class="line">		Matcher m = p.matcher(str);</span><br><span class="line">		if (m.find()) &#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>是否为中文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isChinese(String str) &#123;</span><br><span class="line">		String regEx = &quot;[\\u4e00-\\u9fa5]+&quot;;</span><br><span class="line">		Pattern p = Pattern.compile(regEx);</span><br><span class="line">		Matcher m = p.matcher(str);</span><br><span class="line">		if (m.find()) &#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h1 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1><p>定义一个枚举类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public enum TypeGroup &#123;</span><br><span class="line">	</span><br><span class="line">	CN(&quot;cn&quot;), EN(&quot;en&quot;), CN_EN(&quot;cn_en&quot;),BR(&quot;br&quot;),ALL(&quot;all&quot;);</span><br><span class="line">	private final String type; </span><br><span class="line">	</span><br><span class="line">	private TypeGroup(String type) &#123;  </span><br><span class="line">	     this.type = type;  </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public String getType() &#123;</span><br><span class="line">		return type;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="jsoup"><a href="#jsoup" class="headerlink" title="jsoup"></a>jsoup</h1><h2 id="获取url的html"><a href="#获取url的html" class="headerlink" title="获取url的html"></a>获取url的html</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String url = &quot;http://www.jb51.net/softjc/414254.html&quot;;</span><br><span class="line">String html = Jsoup.connect(url).userAgent(&quot;Mozilla&quot;).get().toString();</span><br><span class="line">System.out.println(html);</span><br></pre></td></tr></table></figure>
<h1 id="get请求"><a href="#get请求" class="headerlink" title="get请求"></a>get请求</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * 向指定URL发送GET方法的请求</span><br><span class="line">	 * </span><br><span class="line">	 */</span><br><span class="line">	public static String get(String url) &#123;</span><br><span class="line">		BufferedReader in = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			URL realUrl = new URL(url);</span><br><span class="line">			// 打开和URL之间的连接</span><br><span class="line">			URLConnection connection = realUrl.openConnection();</span><br><span class="line">			// 设置通用的请求属性</span><br><span class="line">			connection.setRequestProperty(&quot;accept&quot;, &quot;*/*&quot;);</span><br><span class="line">			connection.setRequestProperty(&quot;connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">			connection.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)&quot;);</span><br><span class="line">			connection.setConnectTimeout(5000);</span><br><span class="line">			connection.setReadTimeout(5000);</span><br><span class="line">			// 建立实际的连接</span><br><span class="line">			connection.connect();</span><br><span class="line">			// 定义 BufferedReader输入流来读取URL的响应</span><br><span class="line">			in = new BufferedReader(new InputStreamReader(connection.getInputStream()));</span><br><span class="line">			StringBuffer sb = new StringBuffer();</span><br><span class="line">			String line;</span><br><span class="line">			while ((line = in.readLine()) != null) &#123;</span><br><span class="line">				sb.append(line);</span><br><span class="line">			&#125;</span><br><span class="line">			return sb.toString();</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			LOG.error(&quot;Exception occur when send http get request!&quot;, e);</span><br><span class="line">		&#125;</span><br><span class="line">		// 使用finally块来关闭输入流</span><br><span class="line">		finally &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				if (in != null) &#123;</span><br><span class="line">					in.close();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; catch (Exception e2) &#123;</span><br><span class="line">				e2.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h1 id="list排序"><a href="#list排序" class="headerlink" title="list排序"></a>list排序</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static List&lt;Integer&gt; intList = Arrays.asList(2, 3, 1);</span><br><span class="line">Collections.sort(intList);</span><br></pre></td></tr></table></figure>
<p>结果默认是正序排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1,2,3</span><br></pre></td></tr></table></figure>
<p>如何实现逆序呢，这就要使用第二种方式了，即通过实现Comparator接口的compare方法来完成自定义排序，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Collections.sort(intList,<span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 返回值为int类型，大于0表示正序，小于0表示逆序</span></span><br><span class="line">                <span class="keyword">return</span> o2-o1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="随机打乱"><a href="#随机打乱" class="headerlink" title="随机打乱"></a>随机打乱</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collections.shuffle</span><br></pre></td></tr></table></figure>
<h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><h2 id="最简单的多线程"><a href="#最简单的多线程" class="headerlink" title="最简单的多线程"></a>最简单的多线程</h2><p>如果要测试多线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class MyThread extends Thread &#123;</span><br><span class="line">	public MyThread(String name) &#123;</span><br><span class="line">		super(name);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public void run() &#123;</span><br><span class="line">		for (int i = 0; i &lt; 20; i++) &#123;</span><br><span class="line">			System.out.println(Thread.currentThread().getName());</span><br><span class="line">			try &#123;</span><br><span class="line">				Thread.sleep(1000l);</span><br><span class="line">			&#125; catch (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">		MyThread myThread1 = new MyThread(&quot;myThread1&quot;);</span><br><span class="line">		MyThread myThread2 = new MyThread(&quot;myThread2&quot;);</span><br><span class="line">		myThread1.start();</span><br><span class="line">		myThread2.start();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>能看到两个线程交替打印</p>
<h2 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h2><p>保证在高并发的情况下只有一个线程能够访问这个属性值。</p>
<h2 id="AtomicBoolean"><a href="#AtomicBoolean" class="headerlink" title="AtomicBoolean"></a>AtomicBoolean</h2><p>使用 AtomicBoolean 高效并发处理 “只初始化一次” 的功能要求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static AtomicBoolean initialized = new AtomicBoolean(false);</span><br><span class="line">public void init()</span><br><span class="line">&#123;</span><br><span class="line">   if( initialized.compareAndSet(false, true) )</span><br><span class="line">   &#123;</span><br><span class="line">       // 这里放置初始化代码....</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多线程下的类"><a href="#多线程下的类" class="headerlink" title="多线程下的类"></a>多线程下的类</h2><p><code>/geo-poi/src/main/java/com/iclick/geo/search/GeoPois.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, GeoPois&gt; mRegistry = <span class="keyword">new</span> ConcurrentHashMap&lt;String, GeoPois&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> GeoPois <span class="title">getInstance</span><span class="params">(String cityname)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mRegistry.get(cityname) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mRegistry.put(cityname, <span class="keyword">new</span> GeoPois(cityname));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mRegistry.get(cityname);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="jar包替换文件"><a href="#jar包替换文件" class="headerlink" title="jar包替换文件"></a>jar包替换文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar -uvf pig-ext-lite-1.0-SNAPSHOT.jar sensitive_words.txt</span><br></pre></td></tr></table></figure>
<p>这里的sensitive_words.txt会放到jar包的根目录，若存在则会替换</p>
<p>执行java任务</p>
<h1 id="Double判断相等"><a href="#Double判断相等" class="headerlink" title="Double判断相等"></a>Double判断相等</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (new java.math.BigDecimal(distance).compareTo(new java.math.BigDecimal(-1.0)) == 0)</span><br></pre></td></tr></table></figure>
<h1 id="POJO命名规则"><a href="#POJO命名规则" class="headerlink" title="POJO命名规则"></a>POJO命名规则</h1><p><a href="https://www.cnblogs.com/yxnchinahlj/archive/2012/02/24/2366110.html" target="_blank" rel="noopener">https://www.cnblogs.com/yxnchinahlj/archive/2012/02/24/2366110.html</a></p>
<p>POJO是DO/DTO/BO/VO的统称。</p>
<p><strong>POJO：POJO（Plain Ordinary Java Object）简单的Java对象</strong>，实际就是普通JavaBeans，是为了避免和EJB混淆所创造的简称。通指没有使用Entity Beans的普通java对象，可以把POJO作为支持业务逻辑的协助类。</p>
<p>POJO实质上可以理解为简单的实体类，顾名思义POJO类的作用是方便程序员使用数据库中的数据表，对于广大的程序员，可以很方便的将POJO类当做对象来进行使用，当然也是可以方便的调用其get,set方法。POJO类也给我们在struts框架中的配置带来了很大的方便。</p>
<p><em>一个POJO持久化以后就是PO</em></p>
<p><em>直接用它传递、传递过程中就是DTO直接用来对应表示层就是VO</em></p>
<h1 id="java如何计算程序运行时间"><a href="#java如何计算程序运行时间" class="headerlink" title="java如何计算程序运行时间"></a>java如何计算程序运行时间</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">long startTime = System.currentTimeMillis();    //获取开始时间</span><br><span class="line"></span><br><span class="line">doSomething();    //测试的代码段</span><br><span class="line"></span><br><span class="line">long endTime = System.currentTimeMillis();    //获取结束时间</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;程序运行时间：&quot; + (endTime - startTime) + &quot;ms&quot;);    //输出程序运行时间</span><br></pre></td></tr></table></figure>
<h1 id="用泛型来解析json"><a href="#用泛型来解析json" class="headerlink" title="用泛型来解析json"></a>用泛型来解析json</h1><p><a href="https://www.cnblogs.com/jpfss/p/9928747.html" target="_blank" rel="noopener">https://www.cnblogs.com/jpfss/p/9928747.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;T&gt; T parseJson(String json, Class&lt;T&gt; object) &#123;</span><br><span class="line">        T t = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            t = JacksonUtil.getObjectMapper().readValue(json, object);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return t;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="jackson解析json"><a href="#jackson解析json" class="headerlink" title="jackson解析json"></a>jackson解析json</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JacksonUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">getObjectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="comment">//序列化的时候序列对象的所有属性</span></span><br><span class="line">        objectMapper.setSerializationInclusion(JsonInclude.Include.ALWAYS);</span><br><span class="line">        <span class="comment">//反序列化的时候如果多了其他属性,不抛出异常</span></span><br><span class="line">        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//如果是空对象的时候,不抛异常</span></span><br><span class="line">        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">parseJson</span><span class="params">(String json, Class&lt;T&gt; object)</span> </span>&#123;</span><br><span class="line">        T t = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t = getObjectMapper().readValue(json, object);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="反射和泛型"><a href="#反射和泛型" class="headerlink" title="反射和泛型"></a>反射和泛型</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 获取方法 scala语法</span><br><span class="line">gdav.app_code = clazz.getDeclaredMethod(&quot;getAppCode&quot;).invoke(x).asInstanceOf[String]</span><br><span class="line"></span><br><span class="line">// java语法</span><br><span class="line">// getDeclaredMethod，第一个参数是方法名，后面是形参；invoke第一个是类的实例，第二个实参</span><br><span class="line">ResponseResult ret = (ResponseResult)AnalysisController.class.getDeclaredMethod(methodName, SearchStopAreaVO.class).invoke(analysisController, searchStopAreaVO);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/03/31/hadoop-spark/数据仓库框架对比/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/31/hadoop-spark/数据仓库框架对比/" class="post-title-link" itemprop="url">数据仓库框架对比</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-31 10:30:28" itemprop="dateCreated datePublished" datetime="2018-03-31T10:30:28+08:00">2018-03-31</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop-spark/" itemprop="url" rel="index"><span itemprop="name">hadoop-spark</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/03/31/hadoop-spark/数据仓库框架对比/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/31/hadoop-spark/数据仓库框架对比/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.zhihu.com/question/41541395?sort=created" target="_blank" rel="noopener">presto、druid、sparkSQL、kylin的对比分析，如性能、架构等，有什么异同？</a></p>
<ul>
<li><p>商业系统</p>
</li>
<li><ul>
<li>InfoBright</li>
<li>Greenplum（已开源）、HP Vertica、TeraData、Palo、ExaData、RedShift、BigQuery（Dremel）</li>
</ul>
</li>
<li><p>开源实现</p>
</li>
<li><ul>
<li>Impala、Presto、Spark SQL、Drill、Hawq</li>
<li>Druid、Pinot</li>
<li>Kylin</li>
</ul>
</li>
</ul>
<p>presto、druid、sparkSQL、kylin可以分为三类。</p>
<ul>
<li>presto和spark sql都是解决分布式查询问题，提供SQL查询能力，但数据加载不一定能保证实时。</li>
<li>Druid是保证数据实时写入，但查询上不支持SQL，或者说目前只支持部分SQL，我个人觉得适合用于工业大数据，比如一堆传感器实时写数据的场景。</li>
<li>Kylin是MOLAP，就是将数据先进行预聚合，然后把多维查询变成了key-value查询。基本思路是预先对数据作多维索引，查询时只扫描索引而不访问原始数据从而提速。</li>
</ul>
<p>大数据查询目前来讲可以大体分为三类：</p>
<p>1、基于hbase预聚合的。适合<strong>相对固定的业务报表类需求</strong>。需要指定预聚合的指标，在数据接入的时候根据指定的指标进行聚合运算，只需要统计少量维度即可满足业务报表需求。比如Opentsdb,Kylin,Druid等</p>
<p>2、基于Parquet列式存储的，基本是完全基于内存的并行计算，Parquet系能降低存储空间，提高IO效率，以离线处理为主，<strong>很难提高数据写的实时性，超大表的join支持可能不够好</strong>。spark sql也算类似，但它在内存不足时可以spill disk来支持超大数据查询和join。比如Presto, Drill，Impala等</p>
<p>3、基于lucene外部索引的，比如ElasticSearch和Solr,能够满足的的查询场景远多于传统的数据库存储，但对于日志、行为类时序数据，所有的搜索请求都也必须搜索所有的分片，另外，对于聚合分析场景的支持也是软肋    </p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/03/31/地理信息挖掘/经纬度判断城市/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/31/地理信息挖掘/经纬度判断城市/" class="post-title-link" itemprop="url">经纬度判断城市</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-31 10:30:28" itemprop="dateCreated datePublished" datetime="2018-03-31T10:30:28+08:00">2018-03-31</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-05 14:40:53" itemprop="dateModified" datetime="2019-07-05T14:40:53+08:00">2019-07-05</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/地理信息处理和挖掘/" itemprop="url" rel="index"><span itemprop="name">地理信息处理和挖掘</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/03/31/地理信息挖掘/经纬度判断城市/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/31/地理信息挖掘/经纬度判断城市/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/geo-poi/src/main/java/com/iclick/geo/search/Geolocation.java</span><br></pre></td></tr></table></figure>
<p>有数据<code>district_v2.tar.gz</code> 包括每个行政区划的边界经纬度和中心经纬度</p>
<h2 id="district-v2的结构"><a href="#district-v2的结构" class="headerlink" title="district_v2的结构"></a>district_v2的结构</h2><p>爬去的高德的数据</p>
<p>每行对应一个城市的区县</p>
<p>citycode 城市代码</p>
<p>adcode是全国行政区划代码</p>
<p>code编码数据来源于国家标准行政区划代码（adcode）映射表《》</p>
<p>解析数据，将每个district的边界坐标保存到<code>districts</code> 。对于一个经纬度，遍历每个district，判断点是否在多边形内，找到所属行政区划。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 判断目标点是否在多边形内(由多个点组成)&lt;br/&gt;  </span></span><br><span class="line"><span class="comment"> *   </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> px 目标点的经度坐标  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> py 目标点的纬度坐标  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> polygonXA 多边形的经度坐标集合  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> polygonYA 多边形的纬度坐标集合  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPointInPolygon</span> <span class="params">( <span class="keyword">double</span> px , <span class="keyword">double</span> py , ArrayList&lt;Double&gt; polygonXA , ArrayList&lt;Double&gt; polygonYA )</span>    </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">boolean</span> isInside = <span class="keyword">false</span>;    </span><br><span class="line">    <span class="keyword">double</span> ESP = <span class="number">1e-9</span>;    </span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;    </span><br><span class="line">    <span class="keyword">double</span> linePoint1x;    </span><br><span class="line">    <span class="keyword">double</span> linePoint1y;    </span><br><span class="line">    <span class="keyword">double</span> linePoint2x = <span class="number">180</span>;    </span><br><span class="line">    <span class="keyword">double</span> linePoint2y;    </span><br><span class="line">  </span><br><span class="line">    linePoint1x = px;    </span><br><span class="line">    linePoint1y = py;    </span><br><span class="line">    linePoint2y = py;    </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; polygonXA.size() - <span class="number">1</span>; i++)    </span><br><span class="line">    &#123;    </span><br><span class="line">        <span class="keyword">double</span> cx1 = polygonXA.get(i);    </span><br><span class="line">        <span class="keyword">double</span> cy1 = polygonYA.get(i);    </span><br><span class="line">        <span class="keyword">double</span> cx2 = polygonXA.get(i + <span class="number">1</span>);    </span><br><span class="line">        <span class="keyword">double</span> cy2 = polygonYA.get(i + <span class="number">1</span>);   </span><br><span class="line">        <span class="comment">//如果目标点在任何一条线上  </span></span><br><span class="line">        <span class="keyword">if</span> ( isPointOnLine(px, py, cx1, cy1, cx2, cy2) )    </span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;    </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//如果线段的长度无限小(趋于零)那么这两点实际是重合的，不足以构成一条线段  </span></span><br><span class="line">        <span class="keyword">if</span> ( Math.abs(cy2 - cy1) &lt; ESP )    </span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="keyword">continue</span>;    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="comment">//第一个点是否在以目标点为基础衍生的平行纬度线  </span></span><br><span class="line">        <span class="keyword">if</span> ( isPointOnLine(cx1, cy1, linePoint1x, linePoint1y, linePoint2x, linePoint2y) )    </span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="comment">//第二个点在第一个的下方,靠近赤道纬度为零(最小纬度)  </span></span><br><span class="line">            <span class="keyword">if</span> ( cy1 &gt; cy2 )    </span><br><span class="line">                count++;    </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//第二个点是否在以目标点为基础衍生的平行纬度线  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( isPointOnLine(cx2, cy2, linePoint1x, linePoint1y, linePoint2x, linePoint2y) )    </span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="comment">//第二个点在第一个的上方,靠近极点(南极或北极)纬度为90(最大纬度)  </span></span><br><span class="line">            <span class="keyword">if</span> ( cy2 &gt; cy1 )    </span><br><span class="line">                count++;    </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">//由两点组成的线段是否和以目标点为基础衍生的平行纬度线相交  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( isIntersect(cx1, cy1, cx2, cy2, linePoint1x, linePoint1y, linePoint2x, linePoint2y) )    </span><br><span class="line">        &#123;    </span><br><span class="line">            count++;    </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">if</span> ( count % <span class="number">2</span> == <span class="number">1</span> )    </span><br><span class="line">    &#123;    </span><br><span class="line">        isInside = <span class="keyword">true</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> isInside;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以用geojson配合qgis的api，geojson文件为<code>BOUNT_poly.geojson</code></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/03/31/编程语言学习/PYTHON/python笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/31/编程语言学习/PYTHON/python笔记/" class="post-title-link" itemprop="url">Python技巧总结</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-31 10:28:31" itemprop="dateCreated datePublished" datetime="2018-03-31T10:28:31+08:00">2018-03-31</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-05 12:55:49" itemprop="dateModified" datetime="2019-07-05T12:55:49+08:00">2019-07-05</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/03/31/编程语言学习/PYTHON/python笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/31/编程语言学习/PYTHON/python笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="json操作"><a href="#json操作" class="headerlink" title="json操作"></a>json操作</h1><h2 id="1-1-json转字符串"><a href="#1-1-json转字符串" class="headerlink" title="1.1  json转字符串"></a>1.1  json转字符串</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = json.loads(s)</span><br></pre></td></tr></table></figure>
<h2 id="1-2-遍历json的key"><a href="#1-2-遍历json的key" class="headerlink" title="1.2 遍历json的key"></a>1.2 遍历json的key</h2><p>将json当做dict，用dict的方法遍历</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for k,v in result.items():</span><br><span class="line">    print result[k]</span><br></pre></td></tr></table></figure>
<h2 id="1-3-读json文件"><a href="#1-3-读json文件" class="headerlink" title="1.3 读json文件"></a>1.3 读json文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line"></span><br><span class="line">f = open(&quot;/home/david/keywordjson&quot;)</span><br><span class="line"></span><br><span class="line">result = json.load(f,encoding=&apos;utf-8&apos;)</span><br><span class="line">for k,v in result.items():</span><br><span class="line">    print result[k]</span><br></pre></td></tr></table></figure>
<h2 id="1-4-报错"><a href="#1-4-报错" class="headerlink" title="1.4 报错"></a>1.4 报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Python json.loads shows ValueError: Extra data</span><br></pre></td></tr></table></figure>
<p><a href="https://stackoverflow.com/questions/21058935/python-json-loads-shows-valueerror-extra-data" target="_blank" rel="noopener">https://stackoverflow.com/questions/21058935/python-json-loads-shows-valueerror-extra-data</a></p>
<h2 id="1-5-判断是否包含key"><a href="#1-5-判断是否包含key" class="headerlink" title="1.5 判断是否包含key"></a>1.5 判断是否包含key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jsonObject 是个json</span><br><span class="line">if (key in jsonObject) :</span><br><span class="line">    print &apos;有&apos;</span><br><span class="line">else:</span><br><span class="line">    print &apos;没有&apos;</span><br></pre></td></tr></table></figure>
<h1 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h1><h2 id="2-1-读CSV文件"><a href="#2-1-读CSV文件" class="headerlink" title="2.1 读CSV文件"></a>2.1 读CSV文件</h2><p>csv文件的格式如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id,click,hour,C1,C2,C3,C4,C5</span><br><span class="line">123,1,14091123,a,b,c,d,e</span><br></pre></td></tr></table></figure>
<p>读取的方式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from csv import DictReader</span><br><span class="line"></span><br><span class="line"># t是每行的index，row是每行的具体数据，dict型</span><br><span class="line">for t, row in enumerate(DictReader(open(path))):</span><br><span class="line">        ID = row[&apos;id&apos;]</span><br></pre></td></tr></table></figure>
<h2 id="2-2-按行读普通文件"><a href="#2-2-按行读普通文件" class="headerlink" title="2.2 按行读普通文件"></a>2.2 按行读普通文件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">'../result/ctrout-featurelist-1-10.dat'</span>):</span><br><span class="line">    <span class="comment">#要去掉换行符</span></span><br><span class="line">    arr = line.strip(<span class="string">'\n'</span>).split(<span class="string">','</span>)</span><br><span class="line">    <span class="keyword">if</span> len(arr) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            prectr.append(float(arr[<span class="number">0</span>]))</span><br><span class="line">            onlinectr.append(float(arr[<span class="number">1</span>]))</span><br><span class="line">            isclick.append(<span class="number">1</span> <span class="keyword">if</span> arr[<span class="number">2</span>]==<span class="string">'true'</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>上述方法不够严谨，为防止读取时出错，应该用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">with codecs.open(fname, &quot;r&quot;) as f:</span><br><span class="line">       for line in f.readlines():</span><br><span class="line">       # 按行读是带换行符的，要用strip去掉</span><br><span class="line">           data = line.strip(&apos;\n&apos;).split()</span><br></pre></td></tr></table></figure>
<h2 id="读文件转成二维数组"><a href="#读文件转成二维数组" class="headerlink" title="读文件转成二维数组"></a>读文件转成二维数组</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(file)</span>:</span></span><br><span class="line">    <span class="string">'''read raw date from a file '''</span></span><br><span class="line">    Instances = []</span><br><span class="line">    fp = open(file, <span class="string">'r'</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fp:</span><br><span class="line">        line = line.strip(<span class="string">'\n'</span>)  <span class="comment"># discard '\n'</span></span><br><span class="line">        <span class="keyword">if</span> line != <span class="string">''</span>:</span><br><span class="line">            Instances.append(line.split(<span class="string">','</span>))</span><br><span class="line">    fp.close()</span><br><span class="line">    <span class="keyword">return</span> (Instances)</span><br></pre></td></tr></table></figure>
<h2 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">filename = &apos;write_data.txt&apos;</span><br><span class="line">with open(filename,&apos;w&apos;) as f: # 如果filename不存在会自动创建， &apos;w&apos;表示写数据，写之前会清空文件中的原有数据！</span><br><span class="line">    f.write(&quot;I am Meringue.\n&quot;)</span><br><span class="line">    f.write(&quot;I am now studying in NJTECH.\n&quot;)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line">f = open(&apos;test.txt&apos;, &apos;w&apos;) # 若是&apos;wb&apos;就表示写二进制文件</span><br><span class="line">f.write(&apos;Hello, world!&apos;)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<h2 id="判断文件是否存在"><a href="#判断文件是否存在" class="headerlink" title="判断文件是否存在"></a>判断文件是否存在</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">os.path.exists(test_file.txt)</span><br><span class="line">#True</span><br><span class="line"></span><br><span class="line">os.path.exists(no_exist_file.txt)</span><br><span class="line">#False</span><br></pre></td></tr></table></figure>
<h1 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h1><h2 id="3-1-hash"><a href="#3-1-hash" class="headerlink" title="3.1 hash"></a>3.1 hash</h2><p>返回对象的hash值，返回的哈希值是使用一个整数表示，通常使用在字典里，以便实现快速查询键值。参数object输入是数字类型时，是根据数值来计算的，比如1和1.0计算出来是一样的哈希值，因此说这个函数是不区分不同的数值类型。</p>
<h1 id="日期操作"><a href="#日期操作" class="headerlink" title="日期操作"></a>日期操作</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">dstr = <span class="string">'20170228'</span></span><br><span class="line"></span><br><span class="line">d2 =  datetime.datetime.strptime(dstr,<span class="string">'%Y%m%d'</span>) + datetime.timedelta(days=<span class="number">1</span>)</span><br><span class="line">d2str = d2.strftime(<span class="string">'%Y%m%d'</span>)</span><br><span class="line"><span class="comment"># 结果是20170301</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前日期并格式化</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">time.strftime(<span class="string">'%Y%m%d'</span>,time.localtime(time.time()))</span><br><span class="line">time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>,time.localtime(time.time()))</span><br><span class="line"><span class="comment"># 如果要获取datetime类型的当前时间</span></span><br><span class="line">datetime.datetime.now()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日期加减</span></span><br><span class="line"><span class="comment">#datetime.timedelta(days, seconds, microseconds)</span></span><br><span class="line">d1 = datetime.date.today()</span><br><span class="line"><span class="comment"># 加一天：</span></span><br><span class="line">d2 = d1 + datetime.timedelta(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 減一天：</span></span><br><span class="line">d2 = d1 + datetime.timedelta(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当天日期的格式化</span></span><br><span class="line">datetime.date.today().strftime(<span class="string">'%Y%m%d'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串转日期</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">detester = ‘<span class="number">2017</span><span class="number">-01</span><span class="number">-01</span><span class="string">'</span></span><br><span class="line"><span class="string">date = datetime.datetime.strptime(detester,’%Y-%m-%d'</span>)</span><br><span class="line">                                  </span><br><span class="line"><span class="comment"># 日期转字符串</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="comment"># python3的</span></span><br><span class="line">date = datetime.now()</span><br><span class="line">detester = date.strftime(‘%Y-%m-%d<span class="string">')        </span></span><br><span class="line"><span class="string">                         </span></span><br><span class="line"><span class="string"># 比较两个时间之差</span></span><br><span class="line"><span class="string">nowtime=datetime.datetime.today()</span></span><br><span class="line"><span class="string">(nowtime-gpstime_datetime).seconds</span></span><br></pre></td></tr></table></figure>
<h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><h2 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">runToday=date.today().strftime(&apos;%y-%m-%d&apos;)</span><br><span class="line">b=time.strptime(runToday,&apos;%y-%m-%d&apos;)</span><br><span class="line">btime = datetime(*b[:3])</span><br><span class="line">&quot;,&quot;.join([&quot;/shortdata/persona/xid_present_info/&quot; + (btime - timedelta(x)).strftime(&apos;%y-%m-%d&apos;) for x in range(2,13)])</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;/shortdata/persona/xid_present_info/17-05-08,/shortdata/persona/xid_present_info/17-05-07,/shortdata/persona/xid_present_info/17-05-06,/shortdata/persona/xid_present_info/17-05-05,/shortdata/persona/xid_present_info/17-05-04,/shortdata/persona/xid_present_info/17-05-03,/shortdata/persona/xid_present_info/17-05-02,/shortdata/persona/xid_present_info/17-05-01,/shortdata/persona/xid_present_info/17-04-30,/shortdata/persona/xid_present_info/17-04-29,/shortdata/persona/xid_present_info/17-04-28&apos;</span><br></pre></td></tr></table></figure>
<h2 id="字符串定位"><a href="#字符串定位" class="headerlink" title="字符串定位"></a>字符串定位</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">str_1=<span class="string">'wo shi yi zhi da da niu  '</span></span><br><span class="line">char_1=<span class="string">'i'</span></span><br><span class="line">nPos=str_1.index(char_1)</span><br><span class="line">print(nPos)</span><br><span class="line">运行结果：<span class="number">7</span></span><br><span class="line"></span><br><span class="line">========是使用find==========</span><br><span class="line"></span><br><span class="line">str_1=<span class="string">'wo shi yi zhi da da niu  '</span></span><br><span class="line">char_1=<span class="string">'i'</span></span><br><span class="line">nPos=str_1.find(char_1)</span><br><span class="line">print(nPos)</span><br><span class="line">结果：<span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">========如何查找所有‘i’在字符串中位置呢？===========</span><br><span class="line"></span><br><span class="line"><span class="comment">#开挂模式</span></span><br><span class="line">str_1=<span class="string">'wo shi yi zhi da da niu  '</span></span><br><span class="line">char_1=str(input(<span class="string">'Please input the Char you want:'</span>))</span><br><span class="line">count=<span class="number">0</span></span><br><span class="line">str_list=list(str_1)</span><br><span class="line"><span class="keyword">for</span> each_char <span class="keyword">in</span> str_list:</span><br><span class="line">    count+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> each_char==char_1:</span><br><span class="line">        print(each_char,count<span class="number">-1</span>)</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">Please input the Char you want:i</span><br><span class="line">i <span class="number">0</span></span><br><span class="line">i <span class="number">1</span></span><br><span class="line">i <span class="number">2</span></span><br><span class="line">i <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h2 id="除法后转float"><a href="#除法后转float" class="headerlink" title="除法后转float"></a>除法后转float</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 加个点即可</span><br><span class="line">scale = state.shape[1] / 720.</span><br></pre></td></tr></table></figure>
<h2 id="除法后保留int"><a href="#除法后保留int" class="headerlink" title="除法后保留int"></a>除法后保留int</h2><p>python的int做除法后会变float，难道python3才有的特性？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">documents = [<span class="string">"Human machine interface for lab abc computer applications"</span>,</span><br><span class="line">             <span class="string">"A survey of user opinion of computer system response time"</span>,</span><br><span class="line">             <span class="string">"The EPS user interface management system"</span>,</span><br><span class="line">             <span class="string">"System and human system engineering testing of EPS"</span>]</span><br><span class="line">stoplist = set(<span class="string">'for a of the and to in'</span>.split())</span><br><span class="line"></span><br><span class="line">texts = [[word <span class="keyword">for</span> word <span class="keyword">in</span> document.lower().split() <span class="keyword">if</span> word <span class="keyword">not</span> <span class="keyword">in</span> stoplist]</span><br><span class="line">		<span class="keyword">for</span> document <span class="keyword">in</span> documents]</span><br></pre></td></tr></table></figure>
<h1 id="hdfs操作"><a href="#hdfs操作" class="headerlink" title="hdfs操作"></a>hdfs操作</h1><p><a href="https://snakebite.readthedocs.io/en/latest/client.html" target="_blank" rel="noopener">https://snakebite.readthedocs.io/en/latest/client.html</a></p>
<h1 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h1><h2 id="定义类"><a href="#定义类" class="headerlink" title="定义类"></a>定义类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class model_evaluation(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self, prectrArr, onlinectrArr, isclickArr):</span><br><span class="line">        self.prectrArr = prectrArr</span><br><span class="line">        self.onlinectrArr = onlinectrArr</span><br><span class="line">        self.isclickArr = isclickArr</span><br></pre></td></tr></table></figure>
<h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def main(argv=None):</span><br><span class="line">    if argv == None:</span><br><span class="line">        argv = sys.argv</span><br><span class="line">     </span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="nohup执行"><a href="#nohup执行" class="headerlink" title="nohup执行"></a>nohup执行</h1><p>nohup python -u download_bing_api.py &gt;&gt; result.log &amp; </p>
<p>可以输出print的内容</p>
<h1 id="max"><a href="#max" class="headerlink" title="max"></a>max</h1><p>初级技巧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tmp = max(1,2,4)</span><br><span class="line">print(tmp)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#可迭代对象</span><br><span class="line">a = [1, 2, 3, 4, 5, 6]</span><br><span class="line">tmp = max(a)</span><br><span class="line">print(tmp)</span><br></pre></td></tr></table></figure>
<p>中级技巧：key属性的使用</p>
<p>当key参数不为空时，就以key的函数对象为判断的标准。<br>如果我们想找出一组数中绝对值最大的数，就可以配合lamda先进行处理，再找出最大值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = [-9, -8, 1, 3, -4, 6]</span><br><span class="line">tmp = max(a, key=lambda x: abs(x))</span><br><span class="line">print(tmp)</span><br></pre></td></tr></table></figure>
<p>高级技巧：找出字典中值最大的那组数据</p>
<p>如果有一组商品，其名称和价格都存在一个字典中，可以用下面的方法快速找到价格最贵的那组商品：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">prices = &#123;</span><br><span class="line">    &apos;A&apos;:123,</span><br><span class="line">    &apos;B&apos;:450.1,</span><br><span class="line">    &apos;C&apos;:12,</span><br><span class="line">    &apos;E&apos;:444,</span><br><span class="line">&#125;</span><br><span class="line"># 在对字典进行数据操作的时候，默认只会处理key，而不是value</span><br><span class="line"># 先使用zip把字典的keys和values翻转过来，再用max取出值最大的那组数据</span><br><span class="line">max_prices = max(zip(prices.values(), prices.keys()))</span><br><span class="line">print(max_prices) # (450.1, &apos;B&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="画图"><a href="#画图" class="headerlink" title="画图"></a>画图</h1><p>画圆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np   </span><br><span class="line">import matplotlib.pyplot as plt  </span><br><span class="line">from matplotlib.patches import Polygon  </span><br><span class="line">import matplotlib.patches as mpatches  </span><br><span class="line"></span><br><span class="line">for i in range(0,r,600):</span><br><span class="line">    plt.plot(np.cos(t)*i, np.sin(t)*i)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>去掉坐标轴</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ax=plt.subplot(111)</span><br><span class="line">ax.set_xticks([])  </span><br><span class="line">ax.set_yticks([])</span><br></pre></td></tr></table></figure>
<h2 id="直方图"><a href="#直方图" class="headerlink" title="直方图"></a>直方图</h2><p><a href="https://www.jb51.net/article/144693.htm" target="_blank" rel="noopener">教你利用Python玩转histogram直方图的五种方法</a></p>
<h1 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h1><h2 id="subprocess"><a href="#subprocess" class="headerlink" title="subprocess"></a>subprocess</h2><p>运行python的时候，我们都是在创建并运行一个进程。像Linux进程那样，一个进程可以fork一个子进程，并让这个子进程exec另外一个程序。在Python中，我们通过标准库中的subprocess包来fork一个子进程，并运行一个外部的程序。</p>
<p>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat = subprocess.Popen([&quot;hadoop&quot;, &quot;fs&quot;, &quot;-du&quot;, abspath], stdout=subprocess.PIPE)</span><br></pre></td></tr></table></figure>
<p>Popen对象创建后，主程序不会自动等待子进程完成。我们必须调用对象的wait()方法，父进程才会等待 (也就是阻塞block)，举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import subprocess</span><br><span class="line">&gt;&gt;&gt; child = subprocess.Popen([&apos;ping&apos;,&apos;-c&apos;,&apos;4&apos;,&apos;blog.linuxeye.com&apos;])</span><br><span class="line">&gt;&gt;&gt; print &apos;parent process&apos;</span><br></pre></td></tr></table></figure>
<p>从运行结果中看到，父进程在开启子进程之后并没有等待child的完成，而是直接运行print。对比等待的情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import subprocess</span><br><span class="line">&gt;&gt;&gt; child = subprocess.Popen(&apos;ping -c4 blog.linuxeye.com&apos;,shell=True)</span><br><span class="line">&gt;&gt;&gt; child.wait()</span><br><span class="line">&gt;&gt;&gt; print &apos;parent process&apos;</span><br></pre></td></tr></table></figure>
<p>从运行结果中看到，父进程在开启子进程之后并等待child的完成后，再运行print。<br>此外，你还可以在父进程中对子进程进行其它操作，比如我们上面例子中的child对象:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">child.poll() # 检查子进程状态</span><br><span class="line">child.kill() # 终止子进程</span><br><span class="line">child.send_signal() # 向子进程发送信号</span><br><span class="line">child.terminate() # 终止子进程</span><br></pre></td></tr></table></figure>
<p>子进程的PID存储在child.pid，子进程的标准输入、标准输出和标准错误如下属性分别表示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">child.stdin</span><br><span class="line">child.stdout</span><br><span class="line">child.stderr</span><br></pre></td></tr></table></figure>
<p>例如<code>lbspoi.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_poi_content</span><span class="params">(self)</span>:</span></span><br><span class="line">        city_list = []</span><br><span class="line">        cmd_out = subprocess.Popen(</span><br><span class="line">            <span class="string">" hadoop fs -ls /shortdata/mobile_poi_raw/day_id=%s|awk -F'city=' 'NF==2&#123;print $2&#125;'"</span> % (self.today),</span><br><span class="line">            stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> cmd_out.stdout:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> len(line) &gt; <span class="number">0</span>:</span><br><span class="line">                city_list.append(line)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> city_code <span class="keyword">in</span> city_list:</span><br><span class="line">            sql = <span class="string">"pig -p MOBILE_POI_RAW=/shortdata/mobile_poi_raw/day_id=%s/city=%s "</span> \</span><br><span class="line">                  <span class="string">"-p CITY_CODE=%s -p MOBILE_POI_INFO=/shortdata/persona/mobile_poi/%s/%s "</span> \</span><br><span class="line">                  <span class="string">"/opt/pig_home/mobile_poi/GeneratePoiContent.pig"</span> % (</span><br><span class="line">                      self.today, city_code, city_code, self.today, city_code)</span><br><span class="line">            taskCmd(sql)</span><br><span class="line">            sql = <span class="string">"alter table mobile_poi "</span> \</span><br><span class="line">                  <span class="string">"add partition (day_id='%s',city_code='%s') "</span> \</span><br><span class="line">                  <span class="string">"location '/shortdata/persona/mobile_poi/%s/%s';"</span> % (self.today, city_code, self.today, city_code)</span><br><span class="line">            cmd = <span class="string">'hive -e "use persona; %s"'</span> % (sql)</span><br><span class="line">            taskCmd(cmd)</span><br></pre></td></tr></table></figure>
<h1 id="Python模块安装方法"><a href="#Python模块安装方法" class="headerlink" title="Python模块安装方法"></a>Python模块安装方法</h1><p>一、方法1： 单文件模块<br>直接把文件拷贝到 $python_dir/Lib</p>
<p>二、方法2： 多文件模块，带setup.py</p>
<p>下载模块包，进行解压，进入模块文件夹，执行：<br>python setup.py install</p>
<p>三、 方法3：easy_install 方式</p>
<p>先下载ez_setup.py,运行python ez_setup 进行easy_install工具的安装，之后就可以使用easy_install进行安装package了。<br>easy_install packageName<br>easy_install package.egg</p>
<p>四、 方法4：pip 方式</p>
<p>先进行pip工具的安裝：easy_install pip（pip 可以通过easy_install 安裝，而且也会装到 Scripts 文件夹下。）</p>
<p>安裝：pip install PackageName</p>
<p>更新：pip install -U PackageName</p>
<p>移除：pip uninstall PackageName</p>
<p>搜索：pip search PackageName</p>
<p>帮助：pip help</p>
<h1 id="输出日志"><a href="#输出日志" class="headerlink" title="输出日志"></a>输出日志</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">logger = logging.getLogger(<span class="string">"eventToKafka"</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"><span class="comment"># 建立一个filehandler来把日志记录在文件里，级别为debug以上</span></span><br><span class="line">fh = logging.FileHandler(<span class="string">"/home/hdbatch/fh.log"</span>)</span><br><span class="line">fh.setLevel(logging.DEBUG)</span><br><span class="line"><span class="comment"># 建立一个streamhandler来把日志打在CMD窗口上，级别为error以上</span></span><br><span class="line">ch = logging.StreamHandler()</span><br><span class="line">ch.setLevel(logginng.ERROR)</span><br><span class="line"><span class="comment"># 设置日志格式</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span>)</span><br><span class="line">ch.setFormatter(formatter)</span><br><span class="line">fh.setFormatter(formatter)</span><br><span class="line"><span class="comment">#将相应的handler添加在logger对象中</span></span><br><span class="line">logger.addHandler(ch)</span><br><span class="line">logger.addHandler(fh)</span><br><span class="line"><span class="comment"># 开始打日志</span></span><br><span class="line">logger.debug(<span class="string">"debug message"</span>)</span><br><span class="line">logger.info(<span class="string">"info message"</span>)</span><br><span class="line">logger.warn(<span class="string">"warn message"</span>)</span><br><span class="line">logger.error(<span class="string">"error message"</span>)</span><br><span class="line">logger.critical(<span class="string">"critical message"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="输出到excel"><a href="#输出到excel" class="headerlink" title="输出到excel"></a>输出到excel</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import xlwt</span><br><span class="line">from datetime import datetime</span><br><span class="line"> </span><br><span class="line">style0 = xlwt.easyxf(&apos;font: name Times New Roman, color-index red, bold on&apos;,num_format_str=&apos;#,##0.00&apos;)</span><br><span class="line">style1 = xlwt.easyxf(num_format_str=&apos;D-MMM-YY&apos;)</span><br><span class="line"> </span><br><span class="line">wb = xlwt.Workbook(encoding=&apos;utf-8&apos;)</span><br><span class="line">ws = wb.add_sheet(&apos;A Test Sheet&apos;)</span><br><span class="line">ln = 1</span><br><span class="line"></span><br><span class="line">for line in open(&apos;/home/david/taxo.txt&apos;):</span><br><span class="line">    arr = line.strip(&apos;\n&apos;).split(&apos;|&apos;)</span><br><span class="line">    if len(arr) &gt; 0:</span><br><span class="line">        try:</span><br><span class="line">            print arr[0]</span><br><span class="line">            ws.write(ln,0,arr[0])</span><br><span class="line">            print arr[1]</span><br><span class="line">            ws.write(ln,1,arr[1])</span><br><span class="line">            print arr[2]</span><br><span class="line">            ws.write(ln,2,arr[2])</span><br><span class="line">            ln += 1</span><br><span class="line">        except ValueError:</span><br><span class="line">            print ValueError.message</span><br><span class="line">            continue</span><br><span class="line"> </span><br><span class="line">wb.save(&apos;/home/david/example.xls&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="用nohup执行python程序时，print无法输出"><a href="#用nohup执行python程序时，print无法输出" class="headerlink" title="用nohup执行python程序时，print无法输出"></a>用nohup执行python程序时，print无法输出</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nohup python test.py &gt; nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">发现nohup.out中显示不出来python程序中print的东西。</span><br><span class="line"></span><br><span class="line">这是因为python的输出有缓冲，导致nohup.out并不能够马上看到输出。</span><br><span class="line"></span><br><span class="line">python 有个-u参数，使得python不启用缓冲。</span><br><span class="line"></span><br><span class="line">nohup python -u test.py &gt; nohup.out 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<h1 id="latin1转utf8"><a href="#latin1转utf8" class="headerlink" title="latin1转utf8"></a>latin1转utf8</h1><p>很多语料库下载后都是latin1编码，是乱码</p>
<h1 id="判断变量是否为None"><a href="#判断变量是否为None" class="headerlink" title="判断变量是否为None"></a>判断变量是否为None</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">三种主要的写法有：</span><br><span class="line"></span><br><span class="line">第一种：if X is None;</span><br><span class="line"></span><br><span class="line">第二种：if not X；</span><br><span class="line"></span><br><span class="line">当X为None,  False, 空字符串&quot;&quot;, 0, 空列表[], 空字典&#123;&#125;, 空元组()这些时，not X为真，即无法分辨出他们之间的不同。</span><br><span class="line"></span><br><span class="line">第三种：if not X is None;</span><br></pre></td></tr></table></figure>
<p> 在Python中，None、空列表[]、空字典{}、空元组()、0等一系列代表空和无的对象会被转换成False。除此之外的其它对象都会被转化成True。</p>
<p>在命令if not 1中，1便会转换为bool类型的True。not是逻辑运算符非，not 1则恒为False。因此<a href="https://www.baidu.com/s?wd=if%E8%AF%AD%E5%8F%A5&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1d9uWmYPvFbmHbzrjcznAcd0ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6KdThsqpZwYTjCEQLGCpyw9Uz4Bmy-bIi4WUvYETgN-TLwGUv3En1cYPjDdPHfL" target="_blank" rel="noopener">if语句</a>if not 1之下的语句，永远不会执行。</p>
<p>对比：foo is None 和 foo == None</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class Foo(object):</span><br><span class="line">       def __eq__(self, other):</span><br><span class="line">           return True</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; f = Foo()</span><br><span class="line">&gt;&gt;&gt; f == None</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; f is None</span><br><span class="line">False</span><br></pre></td></tr></table></figure>
<h1 id="输入参数判断"><a href="#输入参数判断" class="headerlink" title="输入参数判断"></a>输入参数判断</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(&quot;-v&quot;, &quot;--verbosity&quot;, help=&quot;increase output verbosity&quot;)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">if args.verbosity:</span><br><span class="line">        print &quot;verbosity turned on&quot;</span><br></pre></td></tr></table></figure>
<ol>
<li>一种是通过一个<code>-</code>来指定的短参数，如<code>-h</code>；</li>
<li>一种是通过<code>--</code>来指定的长参数，如<code>--help</code></li>
</ol>
<p>这两种方式可以同存，也可以只存在一个。通过解析后，其值保存在<code>args.verbosity</code>变量中<br>用法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yarving@yarving-VirtualBox /tmp $ python prog.py -v 1</span><br><span class="line">verbosity turned on</span><br><span class="line"></span><br><span class="line">yarving@yarving-VirtualBox /tmp $ python prog.py --verbosity 1</span><br><span class="line">verbosity turned on</span><br><span class="line"></span><br><span class="line">yarving@yarving-VirtualBox /tmp $ python prog.py -h           </span><br><span class="line">usage: prog.py [-h] [-v VERBOSITY]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -v VERBOSITY, --verbosity VERBOSITY</span><br><span class="line">                        increase output verbosity</span><br><span class="line"></span><br><span class="line">yarving@yarving-VirtualBox /tmp $ python prog.py -v </span><br><span class="line">usage: prog.py [-h] [-v VERBOSITY]</span><br><span class="line">prog.py: error: argument -v/--verbosity: expected one argument</span><br></pre></td></tr></table></figure>
<p>或者这样使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">'--phone'</span>, default=<span class="string">'Android'</span>, choices=[<span class="string">'Android'</span>, <span class="string">'IOS'</span>], type=str, help=<span class="string">'mobile phone OS'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--sensitivity'</span>, default=<span class="number">2.045</span>, type=float, help=<span class="string">'constant for press time'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--serverURL'</span>, default=<span class="string">'http://localhost:8100'</span>, type=str, help=<span class="string">'ServerURL for wda Client'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--resource'</span>, default=<span class="string">'resource'</span>, type=str, help=<span class="string">'resource dir'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--debug'</span>, default=<span class="keyword">None</span>, type=str, help=<span class="string">'debug mode, specify a directory for storing log files.'</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="comment"># print(args)</span></span><br><span class="line"></span><br><span class="line">    AI = WechatAutoJump(args.phone, args.sensitivity, args.serverURL, args.debug, args.resource)</span><br></pre></td></tr></table></figure>
<p>type定义了输入的数据类型，如果不符合会报错</p>
<p>后面也可以给args增加新的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">args.vocab_size=50</span><br></pre></td></tr></table></figure>
<h1 id="搜索指定目录下的文件"><a href="#搜索指定目录下的文件" class="headerlink" title="搜索指定目录下的文件"></a>搜索指定目录下的文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import glob</span><br><span class="line"># 搜索目录下的所有png文件，返回的是所有路径的列表</span><br><span class="line">glob.glob(os.path.join(self.resource_dir, &apos;circle/*.png&apos;))</span><br></pre></td></tr></table></figure>
<h1 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import shutil</span><br><span class="line">shutil.copyfile(&apos;state.png&apos;, os.path.join(self.debug, &apos;state_&#123;:03d&#125;.png&apos;.format(self.step)))</span><br></pre></td></tr></table></figure>
<h1 id="codecs"><a href="#codecs" class="headerlink" title="codecs"></a>codecs</h1><p>普通的open打开会有编码问题，用codecs.open打开后，再写入数据就不会有问题</p>
<p><a href="https://www.cnblogs.com/buptldf/p/4805879.html" target="_blank" rel="noopener">https://www.cnblogs.com/buptldf/p/4805879.html</a></p>
<blockquote>
<p>这种方法可以指定一个编码打开文件，使用这个方法打开的文件读取返回的将是unicode。写入时，如果参数 是unicode，则使用open()时指定的编码进行编码后写入；如果是str，则先根据源代码文件声明的字符编码，解码成unicode后再进行前述 操作。相对内置的open()来说，这个方法比较不容易在编码上出现问题。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with codecs.open(input_file, &quot;r&quot;, encoding=self.encoding) as f:</span><br><span class="line">            data = f.read()</span><br></pre></td></tr></table></figure>
<p>这里的read就是读取整个文本，换行符为<code>\r\n</code></p>
<h1 id="with"><a href="#with" class="headerlink" title="with"></a>with</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with codecs.open(input_file, &quot;r&quot;, encoding=self.encoding) as f:</span><br><span class="line">            data = f.read()</span><br></pre></td></tr></table></figure>
<p>使用with后不管with中的代码出现什么错误，都会进行对当前对象进行清理工作。</p>
<p>例如file的file.close()方法，无论with中出现任何错误，都会执行file.close（）方法</p>
<p>with语句类似</p>
<p>　　try :</p>
<p>　　except:</p>
<p>　　finally:</p>
<p>的功能：但是with语句更简洁。而且更安全。代码量更少。</p>
<h1 id="collections"><a href="#collections" class="headerlink" title="collections"></a>collections</h1><p>collections模块自Python 2.4版本开始被引入，包含了dict、set、list、tuple以外的一些特殊的容器类型，分别是：</p>
<ul>
<li>OrderedDict类：排序字典，是字典的子类。引入自2.7。</li>
<li>namedtuple()函数：命名元组，是一个工厂函数。引入自2.6。</li>
<li>Counter类：为hashable对象计数，是字典的子类。引入自2.7。</li>
<li>deque：双向队列。引入自2.4。</li>
<li>defaultdict：使用工厂函数创建字典，使不用考虑缺失的字典键。引入自2.5。</li>
</ul>
<h2 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h2><p>Counter类的目的是用来跟踪值出现的次数。它是一个无序的容器类型，以字典的键值对形式存储，其中元素作为key，其计数作为value。计数值可以是任意的Interger（包括0和负数）。Counter类和其他语言的bags或multisets很相似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = collections.Counter(&apos;sdfsadfag&apos;)</span><br></pre></td></tr></table></figure>
<p>Counter({‘a’: 2, ‘s’: 2, ‘d’: 2, ‘f’: 2, ‘g’: 1})</p>
<p>counter对象的常用操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sum(c.values())  <span class="comment"># 所有计数的总数</span></span><br><span class="line">c.clear()  <span class="comment"># 重置Counter对象，注意不是删除</span></span><br><span class="line">list(c)  <span class="comment"># 将c中的键转为列表</span></span><br><span class="line">set(c)  <span class="comment"># 将c中的键转为set</span></span><br><span class="line">dict(c)  <span class="comment"># 将c中的键值对转为字典</span></span><br><span class="line">c.items()  <span class="comment"># 转为(elem, cnt)格式的列表</span></span><br><span class="line">Counter(dict(list_of_pairs))  <span class="comment"># 从(elem, cnt)格式的列表转换为Counter类对象</span></span><br><span class="line">c.most_common()[:-n:<span class="number">-1</span>]  <span class="comment"># 取出计数最少的n-1个元素</span></span><br><span class="line">c += Counter()  <span class="comment"># 移除0和负值</span></span><br></pre></td></tr></table></figure>
<h1 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h1><p>默认是升序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; L=[(&apos;b&apos;,2),(&apos;a&apos;,1),(&apos;c&apos;,3),(&apos;d&apos;,4)]</span><br><span class="line">&gt;&gt;&gt; sorted(L, cmp=lambda x,y:cmp(x[1],y[1]))   # 利用cmp函数</span><br><span class="line">[(&apos;a&apos;, 1), (&apos;b&apos;, 2), (&apos;c&apos;, 3), (&apos;d&apos;, 4)]</span><br><span class="line">&gt;&gt;&gt; sorted(L, key=lambda x:x[1])               # 利用key</span><br><span class="line">[(&apos;a&apos;, 1), (&apos;b&apos;, 2), (&apos;c&apos;, 3), (&apos;d&apos;, 4)]</span><br><span class="line"># 变成降序</span><br><span class="line">sorted(L, key=lambda x:-x[1])</span><br></pre></td></tr></table></figure>
<h1 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; a = [1,2,3]</span><br><span class="line">&gt;&gt;&gt; b = [4,5,6]</span><br><span class="line">&gt;&gt;&gt; c = [4,5,6,7,8]</span><br><span class="line">&gt;&gt;&gt; zipped = zip(a,b)     # 打包为元组的列表</span><br><span class="line">[(1, 4), (2, 5), (3, 6)]</span><br><span class="line">&gt;&gt;&gt; zip(a,c)              # 元素个数与最短的列表一致</span><br><span class="line">[(1, 4), (2, 5), (3, 6)]</span><br><span class="line">&gt;&gt;&gt; zip(*zipped)          # 与 zip 相反，可理解为解压，返回二维矩阵式</span><br><span class="line">[(1, 2, 3), (4, 5, 6)]</span><br></pre></td></tr></table></figure>
<h2 id="zip循环"><a href="#zip循环" class="headerlink" title="zip循环"></a>zip循环</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = [<span class="number">9</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>length = len(a) <span class="keyword">if</span> len(a)&lt;len(b) <span class="keyword">else</span> len(b)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>length</span><br><span class="line"></span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = zip(a,b)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c</span><br><span class="line"></span><br><span class="line">[(<span class="number">1</span>, <span class="number">9</span>), (<span class="number">2</span>, <span class="number">8</span>), (<span class="number">3</span>, <span class="number">7</span>), (<span class="number">4</span>, <span class="number">6</span>), (<span class="number">5</span>, <span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt;zip(*c)</span><br><span class="line"></span><br><span class="line">[(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>), (<span class="number">9</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = []</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> x,y <span class="keyword">in</span> zip(a,b):</span><br><span class="line"></span><br><span class="line">　　      d.append(x+y)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line"></span><br><span class="line">[<span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>]</span><br></pre></td></tr></table></figure>
<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><p><a href="http://blog.csdn.net/bh20077/article/details/6070278" target="_blank" rel="noopener">http://blog.csdn.net/bh20077/article/details/6070278</a></p>
<p>如果希望透明地存储 Python 对象，而不丢失其身份和类型等信息，则需要某种形式的对象序列化：它是一个将任意复杂的对象转成对象的文本或二进制表示的过程。同样，必须能够将对象经过序列化后的形式恢复到原有的对象。在 Python 中，这种序列化过程称为 pickle，可以将对象 pickle 成字符串、磁盘上的文件或者任何类似于文件的对象，也可以将这些字符串、文件或任何类似于文件的对象 unpickle 成原来的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入</span></span><br><span class="line"><span class="comment"># 这里的chars是字符的列表</span></span><br><span class="line"><span class="keyword">with</span> open(vocab_file, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            cPickle.dump(chars, f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取</span></span><br><span class="line"><span class="keyword">with</span> open(vocab_file, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            self.chars = cPickle.load(f)</span><br></pre></td></tr></table></figure>
<h1 id="map"><a href="#map" class="headerlink" title="map"></a>map</h1><p><strong>map()</strong> 会根据提供的函数对指定序列做映射。</p>
<p>第一个参数 function 以参数序列中的每一个元素调用 function 函数，返回包含每次 function 函数返回值的新列表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="function"><span class="keyword">def</span> <span class="title">square</span><span class="params">(x)</span> :</span>            <span class="comment"># 计算平方数</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> x ** <span class="number">2</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>map(square, [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])   <span class="comment"># 计算列表各个元素的平方</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>map(<span class="keyword">lambda</span> x: x ** <span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])  <span class="comment"># 使用 lambda 匿名函数</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 提供了两个列表，对相同位置的列表数据进行相加</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>map(<span class="keyword">lambda</span> x, y: x + y, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>], [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>])</span><br><span class="line">[<span class="number">3</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">19</span>]</span><br></pre></td></tr></table></figure>
<h1 id="记录shell执行的结果"><a href="#记录shell执行的结果" class="headerlink" title="记录shell执行的结果"></a>记录shell执行的结果</h1><p>如果用<code>os.system</code>执行shell命令，不会保存执行的结果，要保存结果，可以用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">city_list = []</span><br><span class="line">      cmd_out = subprocess.Popen(</span><br><span class="line">          <span class="string">" hadoop fs -ls /shortdata/mobile_poi_raw/day_id=%s|awk -F'city=' 'NF==2&#123;print $2&#125;'"</span> % (self.today),</span><br><span class="line">          stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</span><br><span class="line">      <span class="keyword">for</span> line <span class="keyword">in</span> cmd_out.stdout:</span><br><span class="line">          line = line.strip()</span><br><span class="line">          <span class="keyword">if</span> len(line) &gt; <span class="number">0</span>:</span><br><span class="line">              city_list.append(line)</span><br></pre></td></tr></table></figure>
<p>其中，</p>
<p><code>shell=True</code>如果 args 是字符串，它将作为命令行字符串通过shell 执行．如果是一个序列，</p>
<p>　　　它的第一个条目将作为命令行字符串，后面的条目作为附加的shell参数。</p>
<p><code>stdout=subprocess.PIPE</code>如果stdout=PIPE,这个属性是个文件对象，提供子进程的输出，否则它是None</p>
<p>这样cmd_out就可以保存shell的结果</p>
<h1 id="统计程序的执行时间（python3）"><a href="#统计程序的执行时间（python3）" class="headerlink" title="统计程序的执行时间（python3）"></a>统计程序的执行时间（python3）</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x1 = [<span class="number">9</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">x2 = [<span class="number">9</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"><span class="comment">### VECTORIZED DOT PRODUCT OF VECTORS ###</span></span><br><span class="line">tic = time.process_time()</span><br><span class="line">dot = np.dot(x1,x2)</span><br><span class="line">toc = time.process_time()</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"dot = "</span> + str(dot) + <span class="string">"\n ----- Computation time = "</span> + str(<span class="number">1000</span>*(toc - tic)) + <span class="string">"ms"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="pass"><a href="#pass" class="headerlink" title="pass"></a>pass</h1><p>如果初始化的时候不需要什么，可以写pass当占位符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class NaiveBayes(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<h1 id="基于数组A对数组B排序"><a href="#基于数组A对数组B排序" class="headerlink" title="基于数组A对数组B排序"></a>基于数组A对数组B排序</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">a = np.array([<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br><span class="line">b = np.array([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>])</span><br><span class="line"><span class="comment"># 数据格式为[(0, 0), (1, 1), (2, 3), (3, 2), (4, 5), (5, 6), (6, 4)]</span></span><br><span class="line">zipped=sorted(zip(a, b), key=<span class="keyword">lambda</span> x:x[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># 拆分</span></span><br><span class="line">aa,bb = zip(*zipped)</span><br></pre></td></tr></table></figure>
<h1 id="Python爬虫模拟登录"><a href="#Python爬虫模拟登录" class="headerlink" title="Python爬虫模拟登录"></a>Python爬虫模拟登录</h1><p>还没有试成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">()</span>:</span></span><br><span class="line">    browser = webdriver.Safari()</span><br><span class="line">    <span class="keyword">return</span> browser</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(username, password, browser=None)</span>:</span></span><br><span class="line">    browser.get(<span class="string">"http://www.car900.com/login/"</span>)</span><br><span class="line"></span><br><span class="line">    pwd_btn = browser.find_element_by_id(<span class="string">"userPwd"</span>)</span><br><span class="line">    act_btn = browser.find_element_by_id(<span class="string">"userName"</span>)</span><br><span class="line">    submit_btn = browser.find_element_by_id(<span class="string">"login"</span>)  </span><br><span class="line"></span><br><span class="line">    act_btn.send_keys(username)</span><br><span class="line">    pwd_btn.send_keys(password)</span><br><span class="line">    submit_btn.send_keys(Keys.ENTER)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> browser</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_sessions</span><span class="params">(browser)</span>:</span></span><br><span class="line">    request = requests.Session()</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"User-Agent"</span>:</span><br><span class="line">            <span class="string">"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 "</span></span><br><span class="line">            <span class="string">"(KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36"</span></span><br><span class="line">    &#125;</span><br><span class="line">    request.headers.update(headers)</span><br><span class="line">    cookies = browser.get_cookies()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> cookie <span class="keyword">in</span> cookies:</span><br><span class="line">        request.cookies.set(cookie[<span class="string">'name'</span>], cookie[<span class="string">'value'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> request</span><br><span class="line">    </span><br><span class="line"><span class="comment">#request = requests.Session()</span></span><br><span class="line"><span class="comment">#headers = &#123;</span></span><br><span class="line"><span class="comment">#    "User-Agent":</span></span><br><span class="line"><span class="comment">#        "Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 "</span></span><br><span class="line"><span class="comment">#        "(KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36"</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment">#request.headers.update(headers)</span></span><br><span class="line"><span class="comment">#request.cookies.set("http://www.car900.com/", "sessionId=7957926f-8aa7-40a9-be91-d264500c4659")</span></span><br><span class="line"><span class="comment">#browser = login(u"创辉测试","123456", setup())</span></span><br><span class="line"><span class="comment">#rq = set_sessions(browser)</span></span><br></pre></td></tr></table></figure>
<p><a href="https://www.jianshu.com/p/cc70e35b47fc" target="_blank" rel="noopener">https://www.jianshu.com/p/cc70e35b47fc</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;chromedriver&apos; executable needs to be in PATH</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/tymatlab/article/details/78649727" target="_blank" rel="noopener">https://blog.csdn.net/tymatlab/article/details/78649727</a></p>
<h4 id="使用brew安装chromedriver"><a href="#使用brew安装chromedriver" class="headerlink" title="使用brew安装chromedriver"></a>使用brew安装<code>chromedriver</code></h4><p>1.<code>brew</code>安装<code>chromedriver</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install chromedriver</span><br></pre></td></tr></table></figure>
<p>2.安装完成后，再次运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from selenium import webdriver</span><br><span class="line">driver = webdriver.Chrome()</span><br></pre></td></tr></table></figure>
<h1 id="python带cookie爬"><a href="#python带cookie爬" class="headerlink" title="python带cookie爬"></a>python带cookie爬</h1><p>先从chrome获取cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cookies=&#123;&#125;</span><br><span class="line">cookies[&apos;sessionId&apos;]=&apos;7957926f-8aa7-40a9-be91-d264500c4659&apos;</span><br><span class="line">response = requests.get(&quot;http://www.car900.com/http/TwoChargeVehicle/QueryMortgagePoint.json?city=%E6%B7%AE%E5%8D%97%E5%B8%82&amp;_=1527554506552&quot;, cookies=cookies)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>
<h1 id="随机挑选N个列表中的数"><a href="#随机挑选N个列表中的数" class="headerlink" title="随机挑选N个列表中的数"></a>随机挑选N个列表中的数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import random as rd</span><br><span class="line"></span><br><span class="line">rand_num_list = [1,2,3,4,5]</span><br><span class="line">rand_num = rd.choice(rand_num_list)</span><br><span class="line"></span><br><span class="line">col_names = [&apos;all_avg_speed_nighttime_sd_3days&apos;, &apos;all_distance_in_10km_around_now_unit_address_avg_3days&apos;, &apos;all_distance_in_5km_around_address_avg_3days&apos;]</span><br><span class="line"></span><br><span class="line">rd.sample(col_names,rand_num)</span><br></pre></td></tr></table></figure>
<h1 id="PyHive"><a href="#PyHive" class="headerlink" title="PyHive"></a>PyHive</h1><p>pandas读取hive并转成dataframe</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from pyhive import hive</span><br><span class="line">import pandas as pd</span><br><span class="line"></span><br><span class="line">def getData():</span><br><span class="line">    conn = hive.Connection(host=&quot;1.0.1.38&quot;, auth=&quot;CUSTOM&quot;, username=&apos;hive&apos;, password=&quot;pvXxHTsdqrt8&quot;, port=10000, database=&apos;tapro_atg&apos;)</span><br><span class="line">    df = pd.read_sql(&quot;select * from sales_data_leisure_view&quot;, conn)</span><br><span class="line">    records = df.head(n=100000)</span><br><span class="line">    print(records.to_json(orient=&apos;records&apos;))</span><br><span class="line"></span><br><span class="line">getData();</span><br><span class="line"></span><br><span class="line">作者：Helen_Cat</span><br><span class="line">链接：https://www.jianshu.com/p/cb2b864b4aca</span><br><span class="line">來源：简书</span><br><span class="line">简书著作权归作者所有，任何形式的转载都请联系作者获得授权并注明出处。</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/qq_41664845/article/details/80775319" target="_blank" rel="noopener">https://blog.csdn.net/qq_41664845/article/details/80775319</a></p>
<p>插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cursor.execute(&quot;&quot;&quot;LOAD DATA LOCAL INPATH &apos;%s&apos; INTO TABLE %s&quot;&quot;&quot; % (&apos;aaa.csv&apos;, &apos;carthage_dev.tmp_local_to_hive&apos;))</span><br><span class="line"></span><br><span class="line">sql = &apos;&apos;&apos; LOAD DATA LOCAL INPATH &apos;/home/infra_pub/david.xu/aaa.csv&apos; OVERWRITE INTO TABLE carthage_dev.tmp_local_to_hive &apos;&apos;&apos;</span><br><span class="line">cursor.execute(sql, async=True)</span><br></pre></td></tr></table></figure>
<h1 id="数据问题"><a href="#数据问题" class="headerlink" title="数据问题"></a>数据问题</h1><h2 id="setup没有权限"><a href="#setup没有权限" class="headerlink" title="setup没有权限"></a>setup没有权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br><span class="line"></span><br><span class="line">error: [Errno 13] Permission denied: &apos;/Users/david/anaconda3/lib/python3.6/site-packages/easy-install.pth&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown ysbecca easy-install.pth </span><br><span class="line">chmod +x easy-install.pth</span><br></pre></td></tr></table></figure>
<h1 id="python多线程、多进程详细"><a href="#python多线程、多进程详细" class="headerlink" title="python多线程、多进程详细"></a>python多线程、多进程详细</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/u011734144/article/details/55519272</span><br></pre></td></tr></table></figure>
<h1 id="批量执行shell命令"><a href="#批量执行shell命令" class="headerlink" title="批量执行shell命令"></a>批量执行shell命令</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">cmdtxt = &apos;&apos;&apos;hadoop fs -text /user/dmp/yyfq_car_gps/saigerealtime/180910/10/part-r-00000.gz | grep &apos;&quot;gpsTime\&quot;:\&quot;2018-09-08 %s&apos; &gt; 2018-09-08-%srecov;gzip 2018-09-08-%srecov;hadoop fs -put 2018-09-08-%srecov.gz /user/dmp/yyfq_car_gps/saigerealtime/180908/%s&apos;&apos;&apos;</span><br><span class="line"></span><br><span class="line">for i in range(3, 24, 1):</span><br><span class="line">    hour_str = str(i)</span><br><span class="line">    if i &lt; 10:</span><br><span class="line">        hour_str = &apos;0&apos; + str(i)</span><br><span class="line">    cmd_new = cmdtxt % (hour_str, hour_str, hour_str, hour_str, hour_str)</span><br><span class="line">    print cmd_new</span><br><span class="line">    os.system(cmd_new)</span><br></pre></td></tr></table></figure>
<h1 id="python2-get、post请求"><a href="#python2-get、post请求" class="headerlink" title="python2 get、post请求"></a>python2 get、post请求</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">saige_last_gpstime</span><span class="params">(is_wx, gps_no)</span>:</span></span><br><span class="line">    post_json = &#123;</span><br><span class="line">        <span class="string">'callLetter'</span>: gps_no,</span><br><span class="line">        <span class="string">'flag'</span>: <span class="string">'false'</span>,</span><br><span class="line">        <span class="string">'sign'</span>: <span class="string">'335BB919C5476417E424FF6F0BC5AD6F'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unittype = <span class="string">"YX"</span></span><br><span class="line">    requrl = <span class="string">"http://218.17.3.228:8008/mljrserver/vehicle/queryYXGpsInfo"</span></span><br><span class="line">    <span class="keyword">if</span> is_wx:</span><br><span class="line">        unittype = <span class="string">"WX"</span></span><br><span class="line">        requrl = <span class="string">"http://218.17.3.228:8008/mljrserver/vehicle/queryWXGpsInfo"</span></span><br><span class="line">    headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>&#125;</span><br><span class="line"></span><br><span class="line">    req = urllib2.Request(url=requrl, headers=headers, data=json.dumps(post_json))</span><br><span class="line">    res_data = urllib2.urlopen(req)</span><br><span class="line">    res = json.loads(res_data.read())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> res[<span class="string">'datas'</span>]:</span><br><span class="line">        gpstime_str = res[<span class="string">'datas'</span>][<span class="string">'list'</span>][<span class="number">0</span>][<span class="string">'gpsTime'</span>]</span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; <span class="number">0.001</span>:</span><br><span class="line">            print(<span class="string">'random print'</span> + gps_no + <span class="string">','</span> + gpstime_str)</span><br><span class="line"></span><br><span class="line">        gpstime_date = get_time(gpstime_str)</span><br><span class="line">        <span class="keyword">if</span> (datetime.datetime.now() - gpstime_date).seconds &gt; <span class="number">10800</span> <span class="keyword">and</span> (gpstime_date.date() - yester_date).days == <span class="number">1</span>:</span><br><span class="line">            print(unittype + <span class="string">','</span> + gps_no + <span class="string">','</span> + gpstime_str)</span><br></pre></td></tr></table></figure>
<h1 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line"># 0-1之间</span><br><span class="line">if random.random() &lt; 0.001:</span><br><span class="line">	print(&apos;random print&apos; + gps_no + &apos;,&apos; + gpstime_str)</span><br></pre></td></tr></table></figure>
<h1 id="星号和双星号用法"><a href="#星号和双星号用法" class="headerlink" title="星号和双星号用法"></a>星号和双星号用法</h1><p>在Python中，星号除了用于乘法数值运算和幂运算外，还有一种特殊的用法”在变量前添加单个星号或两个星号”，实现<strong>多参数的传入或变量的拆解</strong>，本文将详细介绍”星号参数”的用法。</p>
<p>最初，星号变量是用在函数的参数传递上的，在下面的实例中，单个星号代表<strong>这个位置接收任意多个非关键字参数</strong>，在函数的<em>b位置上将其转化成<strong>元组</strong>，而双星号代表<strong>这个位置接收任意多个关键字参数</strong>，在<strong>b位置上将其转化成</strong>字典*</em>：</p>
<p><strong>*</strong> 　　该位置接受任意多个非关键字（non-keyword）参数，在函数中将其转化为<strong>元组（1,2,3,4）</strong></p>
<p><strong><em>\</em></strong>　  该位置接受任意多个关键字（keyword）参数，在函数<strong>位置上转化为</strong>词典 [<strong>key:value, key:value </strong>]**</p>
<h1 id="除法转成百分比"><a href="#除法转成百分比" class="headerlink" title="除法转成百分比"></a>除法转成百分比</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def get_per(cnt, sum_cnt):</span><br><span class="line">    if 0 == sum_cnt:</span><br><span class="line">        return &apos;&apos;</span><br><span class="line">    percentage = cnt / (sum_cnt + 0.0)</span><br><span class="line">    return &apos;%.2f%%&apos; % (percentage)</span><br></pre></td></tr></table></figure>
<h1 id="mpl-toolkits没有basemap包"><a href="#mpl-toolkits没有basemap包" class="headerlink" title="mpl_toolkits没有basemap包"></a>mpl_toolkits没有basemap包</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install basemap</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/03/31/算法与数据结构/前缀树/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/31/算法与数据结构/前缀树/" class="post-title-link" itemprop="url">前缀树</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-31 10:28:31" itemprop="dateCreated datePublished" datetime="2018-03-31T10:28:31+08:00">2018-03-31</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/算法与数据结构/" itemprop="url" rel="index"><span itemprop="name">算法与数据结构</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/03/31/算法与数据结构/前缀树/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/31/算法与数据结构/前缀树/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这段代码应用于GeoHash</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.iclick.geo.search;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 前缀树的实现</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> li</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrieTree</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> total;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> totalNode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> prefixNum;<span class="comment">// 以该字符串为前缀的字符数</span></span><br><span class="line">        <span class="keyword">private</span> Node[] childNodes;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isLeaf;<span class="comment">// 是否为单词</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> dumplicateNum;<span class="comment">// 该字符串重复出现的次数(单词重复出现次数)</span></span><br><span class="line">        <span class="keyword">private</span> LinkedList&lt;POINode&gt; pois ;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            prefixNum = <span class="number">0</span>;</span><br><span class="line">            isLeaf = <span class="keyword">false</span>;</span><br><span class="line">            dumplicateNum = <span class="number">0</span>;</span><br><span class="line">            childNodes = <span class="keyword">new</span> Node[<span class="number">36</span>];</span><br><span class="line">            pois = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Node root;<span class="comment">// 根节点</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrieTree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="keyword">new</span> Node();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        insert(<span class="keyword">this</span>.root, word, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(String word, POINode poi)</span> </span>&#123;</span><br><span class="line">        insert(<span class="keyword">this</span>.root, word, poi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入单词</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> word</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Node root, String word,POINode poi)</span> </span>&#123;</span><br><span class="line">        word = word.toLowerCase();</span><br><span class="line">        <span class="keyword">char</span>[] chars = word.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = getNodeIndex(chars[i]);</span><br><span class="line">            <span class="keyword">if</span> (root.childNodes[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                root.childNodes[index] = <span class="keyword">new</span> Node();</span><br><span class="line">                totalNode += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            root.childNodes[index].prefixNum++;</span><br><span class="line">            <span class="keyword">if</span> (i == chars.length - <span class="number">1</span>) &#123;</span><br><span class="line">                root.childNodes[index].isLeaf = <span class="keyword">true</span>;<span class="comment">// 单词</span></span><br><span class="line">                <span class="keyword">if</span>(poi != <span class="keyword">null</span>) &#123;</span><br><span class="line">                	<span class="keyword">if</span>(root.childNodes[index].pois == <span class="keyword">null</span>) &#123;</span><br><span class="line">                		root.childNodes[index].pois = <span class="keyword">new</span> LinkedList&lt;POINode&gt;();</span><br><span class="line">                	&#125;</span><br><span class="line">                	root.childNodes[index].pois.add(poi);</span><br><span class="line">                	total += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                root.childNodes[index].dumplicateNum++;<span class="comment">// 该单词出现的个数</span></span><br><span class="line">            &#125;</span><br><span class="line">            root = root.childNodes[index];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取以prefixStr为前缀的字符串</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefixStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; getPrefixString(Node root, String prefixStr) &#123;</span><br><span class="line">        prefixStr = prefixStr.toLowerCase();</span><br><span class="line">        HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;String, LinkedList&lt;POINode&gt;&gt;();</span><br><span class="line">        <span class="keyword">char</span>[] prefixs = prefixStr.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; prefixs.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = getNodeIndex(prefixs[i]);</span><br><span class="line">            <span class="keyword">if</span> (root.childNodes[index] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                root = root.childNodes[index];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> map;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dfs(root, prefixStr, map);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; getPrefixString(String prefixStr) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getPrefixString(root, prefixStr);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 深度优先遍历</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     *            :根节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; dfs(Node root, String prefixs,</span><br><span class="line">            HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; map) &#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root.isLeaf) &#123;</span><br><span class="line">            map.put(prefixs, root.pois);</span><br><span class="line">        &#125;</span><br><span class="line">        Node[] nodes = root.childNodes;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nodes[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            	<span class="keyword">char</span> c = <span class="string">'0'</span>;</span><br><span class="line">            	<span class="keyword">if</span>(i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            		c = (<span class="keyword">char</span>) (i + <span class="string">'0'</span>);</span><br><span class="line">            	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            		c = (<span class="keyword">char</span>) (i + <span class="string">'a'</span> - <span class="number">10</span>);</span><br><span class="line">            	&#125;</span><br><span class="line">                String tempStr = prefixs + c;</span><br><span class="line">                dfs(root.childNodes[i], tempStr, map);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 遍历所有的字符串</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; dfs() &#123;</span><br><span class="line">        HashMap&lt;String, LinkedList&lt;POINode&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;String, LinkedList&lt;POINode&gt;&gt;();</span><br><span class="line">        <span class="keyword">return</span> dfs(<span class="keyword">this</span>.root, <span class="string">""</span>, map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除节点</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> word</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不存在该单词则删除</span></span><br><span class="line">        Node p = root;</span><br><span class="line">        <span class="keyword">if</span> (!searchWord(word)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        word = word.toLowerCase();</span><br><span class="line">        <span class="keyword">char</span>[] chars = word.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = getNodeIndex(chars[i]);</span><br><span class="line">            Node[] nodes = p.childNodes;</span><br><span class="line">            <span class="keyword">if</span> (nodes[index].prefixNum == <span class="number">1</span>) &#123;</span><br><span class="line">                nodes[index] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nodes[index].prefixNum--;</span><br><span class="line">                p = nodes[index];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (p.dumplicateNum == <span class="number">1</span>) &#123;</span><br><span class="line">            p.isLeaf = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p.dumplicateNum--;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> word</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">searchWord</span><span class="params">(Node root, String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        word = word.toLowerCase();</span><br><span class="line">        <span class="keyword">char</span>[] chars = word.toCharArray();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = getNodeIndex(chars[i]);</span><br><span class="line">            Node[] nodes = root.childNodes;</span><br><span class="line">            <span class="keyword">if</span> (nodes[index] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                root = nodes[index];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!root.isLeaf) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">searchWord</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> searchWord(root, word);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNodeIndex</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (c &gt;= <span class="string">'0'</span> &amp;&amp; c &lt;= <span class="string">'9'</span>) &#123;</span><br><span class="line">			index = c - <span class="string">'0'</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			index = (c - <span class="string">'a'</span>) + <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//    	 char[] chars = &#123;'0','1','2','3','4','5','9','a','b','z'&#125;;</span></span><br><span class="line"><span class="comment">//    	 </span></span><br><span class="line"><span class="comment">//    	 for (int i = 0; i &lt; chars.length; i++) &#123;</span></span><br><span class="line"><span class="comment">//             int index = getNodeIndex(chars[i]);</span></span><br><span class="line"><span class="comment">//             System.out.println(chars[i] + "\t" + index);</span></span><br><span class="line"><span class="comment">//    	 &#125;</span></span><br><span class="line">        TrieTree trieTree = <span class="keyword">new</span> TrieTree();</span><br><span class="line">        trieTree.insert(<span class="string">"gab"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"gb"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"gb"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"gbc"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"gbc"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"go"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"go"</span>);</span><br><span class="line">        trieTree.insert(<span class="string">"goa"</span>);</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, LinkedList&lt;POINode&gt;&gt; entry : trieTree.getPrefixString(<span class="string">"g"</span>)</span><br><span class="line">                .entrySet()) &#123;</span><br><span class="line">            System.out.println(entry.getKey() + <span class="string">" : "</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(trieTree.total + <span class="string">"\t"</span> + trieTree.totalNode);</span><br><span class="line">        System.out.println(trieTree.delete(<span class="string">"gb"</span>));</span><br><span class="line">        System.out.println(trieTree.delete(<span class="string">"gb"</span>));</span><br><span class="line">        System.out.println(<span class="string">"***************"</span>);</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, LinkedList&lt;POINode&gt;&gt; entry : trieTree.getPrefixString(<span class="string">"g"</span>)</span><br><span class="line">                .entrySet()) &#123;</span><br><span class="line">            System.out.println(entry.getKey() + <span class="string">" : "</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://schwimmer.github.io/2018/03/31/hadoop-spark/hive笔记/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Schwimmer">
      <meta itemprop="description" content="Record and Think!">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Schwimmer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/31/hadoop-spark/hive笔记/" class="post-title-link" itemprop="url">hive技巧总结</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-31 10:28:31" itemprop="dateCreated datePublished" datetime="2018-03-31T10:28:31+08:00">2018-03-31</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-04 16:55:19" itemprop="dateModified" datetime="2019-07-04T16:55:19+08:00">2019-07-04</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/大数据平台工具/" itemprop="url" rel="index"><span itemprop="name">大数据平台工具</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2018/03/31/hadoop-spark/hive笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/31/hadoop-spark/hive笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="插入hive表控制part文件数量"><a href="#插入hive表控制part文件数量" class="headerlink" title="插入hive表控制part文件数量"></a>插入hive表控制part文件数量</h1><p><a href="http://blog.sina.com.cn/s/blog_604c7cdd0102wbsw.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_604c7cdd0102wbsw.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 每个文件上限500M</span><br><span class="line">set hive.exec.reducers.bytes.per.reducer=512000000;</span><br><span class="line">insert overwrite table carthage.gps_address_info_weekly_bak PARTITION(DATA_DATE=&apos;2019-01-15&apos;)</span><br><span class="line">select * from carthage.gps_address_info DISTRIBUTE by RAND();</span><br><span class="line">-- DISTRIBUTE by RAND()主要靠这个控制reduce的文件数</span><br></pre></td></tr></table></figure>
<h1 id="strict模式"><a href="#strict模式" class="headerlink" title="strict模式"></a>strict模式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set hive.mapred.mode=strict</span><br></pre></td></tr></table></figure>
<p>有助于前置解决一些语法和可能的逻辑错误。</p>
<h1 id="限制小文件数量"><a href="#限制小文件数量" class="headerlink" title="限制小文件数量"></a>限制小文件数量</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set mapred.max.split.size=256000000;        -- 决定每个map处理的最大的文件大小，单位为B</span><br><span class="line">set mapred.min.split.size.per.node=10000000;         -- 节点中可以处理的最小的文件大小</span><br><span class="line">set mapred.min.split.size.per.rack=10000000;          -- 机架中可以处理的最小的文件大小</span><br></pre></td></tr></table></figure>
<h1 id="查询时如何去掉重复数据"><a href="#查询时如何去掉重复数据" class="headerlink" title="查询时如何去掉重复数据"></a>查询时如何去掉重复数据</h1><p>假设数据为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name  adx        tran_id                  cost        ts</span><br><span class="line">ck        5         125.168.10.0           33.00   1407234660</span><br><span class="line">ck        5         187.18.99.00           33.32   1407234661</span><br><span class="line">ck        5         125.168.10.0           33.24   1407234661</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from (select *,row_number() over (partition by tran_id order by timestamp asc) num from table) t where t.num=1;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>附上：<br><strong>ROW_NUMBER() OVER函数的基本用法 </strong></p>
<p>语法：ROW_NUMBER() OVER(PARTITION BY COLUMN ORDER BY COLUMN) </p>
<p>简单的说row_number()从1开始，为每一条分组记录返回一个数字，这里的ROW_NUMBER() OVER (ORDER BY xlh DESC) 是先把xlh列降序，再为降序以后的没条xlh记录返回一个序号。<br>示例： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; xlh           row_num </span><br><span class="line">&gt; 1700              1 </span><br><span class="line">&gt; 1500              2 </span><br><span class="line">&gt; 1085              3 </span><br><span class="line">&gt; 710                4 </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>row_number() OVER (PARTITION BY COL1 ORDER BY COL2) 表示根据COL1分组，在分组内部根据 COL2排序，而此函数计算的值就表示每组内部排序后的顺序编号（组内连续的唯一的) </p>
</blockquote>
<h1 id="split后的数组长度"><a href="#split后的数组长度" class="headerlink" title="split后的数组长度"></a>split后的数组长度</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size(split(driving_districts,&apos;;&apos;))</span><br></pre></td></tr></table></figure>
<h1 id="切换队列"><a href="#切换队列" class="headerlink" title="切换队列"></a>切换队列</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set mapred.job.queue.name=data;</span><br></pre></td></tr></table></figure>
<p>sqoop切换队列是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D mapred.job.queue.name=data</span><br></pre></td></tr></table></figure>
<h1 id="加载hdfs的udf"><a href="#加载hdfs的udf" class="headerlink" title="加载hdfs的udf"></a>加载hdfs的udf</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ADD JAR hdfs://iclick/zyz/udf/zyz_udf2.jar;</span><br><span class="line">CREATE TEMPORARY FUNCTION get_region as &apos;org.apache.hadoop.hive.ql.udf.Ip2GeoCodeUDF&apos;;</span><br></pre></td></tr></table></figure>
<h1 id="Hive-Trash"><a href="#Hive-Trash" class="headerlink" title="Hive Trash"></a>Hive Trash</h1><p>hive删除表时，会移除表的元数据和数据，而HDFS上的数据，如果配置了Trash，会移到.Trash/Current目录下。删除外部表时，表中的数据不会被删除。</p>
<h1 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h1><p>用groupby代替distinct，少用orderby</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">同事写了个hive的sql语句，执行效率特别慢，跑了一个多小时程序只是map完了，reduce进行到20%。</span><br><span class="line">该Hive语句如下：</span><br><span class="line">select count(distinct ip) </span><br><span class="line">from (select ip as ip from comprehensive.f_client_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot;  </span><br><span class="line">union all </span><br><span class="line">select pub_ip as ip from f_app_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot; </span><br><span class="line">union all select ip as ip from format_log.format_pv1 where year=&quot;2013&quot; and month=&quot;10&quot; and url_first_id=1 </span><br><span class="line">) d </span><br><span class="line"></span><br><span class="line">       分析：select ip as ip from comprehensive.f_client_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot;这个语句筛选出来的数据约有10亿条，select pub_ip as ip from f_app_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot;约有10亿条条，select ip as ip from format_log.format_pv1 where year=&quot;2013&quot; and month=&quot;10&quot; and url_first_id=1 筛选出来的数据约有10亿条，总的数据量大约30亿条。这么大的数据量，使用disticnt函数，所有的数据只会shuffle到一个reducer上，导致reducer数据倾斜严重。</span><br><span class="line">       解决办法：</span><br><span class="line">       首先，通过使用groupby，按照ip进行分组。改写后的sql语句如下：</span><br><span class="line">select count(*) </span><br><span class="line">from </span><br><span class="line">(select ip </span><br><span class="line">from</span><br><span class="line">(select ip as ip from comprehensive.f_client_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot; </span><br><span class="line">union all </span><br><span class="line">select pub_ip as ip from f_app_boot_daily where year=&quot;2013&quot; and month=&quot;10&quot; </span><br><span class="line">union all select ip as ip from format_log.format_pv1 where year=&quot;2013&quot; and month=&quot;10&quot; and url_first_id=1</span><br><span class="line">) d </span><br><span class="line">group by ip ) b </span><br><span class="line">       然后，合理的设置reducer数量，将数据分散到多台机器上。set mapred.reduce.tasks=50; </span><br><span class="line">       经过优化后，速度提高非常明显。整个作业跑完大约只需要20多分钟的时间。</span><br></pre></td></tr></table></figure>
<p>提高order by的性能<a href="https://blog.csdn.net/djd1234567/article/details/51917603" target="_blank" rel="noopener">https://blog.csdn.net/djd1234567/article/details/51917603</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Hive中的order by跟传统的sql语言中的order by作用是一样的，会对查询的结果做一次全局排序，所以说，只有hive的sql中制定了order by所有的数据都会到同一个reducer进行处理（不管有多少map，也不管文件有多少的block只会启动一个reducer）。但是对于大量数据这 将会消耗很长的时间去执行。</span><br><span class="line"></span><br><span class="line">    这里跟传统的sql还有一点区别：如果指定了hive.mapred.mode=strict（默认值是nonstrict）,这时就必须指定limit 来限制输出条数，原因是：所有的数据都会在同一个reducer端进行，数据量大的情况下可能不能出结果，那么在这样的严格模式下，必须指定输出的条数。</span><br><span class="line"></span><br><span class="line">    所以数据量大的时候能不用order by就不用，可以使用sort by结合distribute by来进行实现。sort by是局部排序，而distribute by是控制map怎么划分reducer。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Hive中指定了sort by，那么在每个reducer端都会做排序，也就是说保证了局部有序（每个reducer出来的数据是有序的，但是不能保证所有的数据是有序的，除非只有一个reducer），好处是：执行了局部排序之后可以为接下去的全局排序提高不少的效率（其实就是做一次归并排序就可以做到全局排序了）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ditribute by是控制map的输出在reducer是如何划分的，举个例子，我们有一张表，mid是指这个store所属的商户，money是这个商户的盈利，name是这个store的名字</span><br><span class="line"></span><br><span class="line">store:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mid	money	name</span><br><span class="line">AA	15.0	商店1</span><br><span class="line">AA	20.0	商店2</span><br><span class="line">BB	22.0	商店3</span><br><span class="line">CC	44.0	商店4</span><br><span class="line">    执行hive语句：</span><br><span class="line"></span><br><span class="line">[sql] view plain copy</span><br><span class="line">select mid, money, name from store distribute by mid sort by mid asc, money asc  </span><br><span class="line">我 们所有的mid相同的数据会被送到同一个reducer去处理，这就是因为指定了distribute by mid，这样的话就可以统计出每个商户中各个商店盈利的排序了（这个肯定是全局有序的，因为相同的商户会放到同一个reducer去处理）。这里需要注意 的是distribute by必须要写在sort by之前。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cluster by</span><br><span class="line">    cluster by的功能就是distribute by和sort by相结合，如下2个语句是等价的：</span><br><span class="line"></span><br><span class="line">[sql] view plain copy</span><br><span class="line">select mid, money, name from store cluster by mid  </span><br><span class="line">select mid, money, name from store distribute by mid sort by mid  </span><br><span class="line">    如果需要获得与上面的中语句一样的效果：</span><br><span class="line"></span><br><span class="line">[sql] view plain copy</span><br><span class="line">select mid, money, name from store cluster by mid sort by money  </span><br><span class="line">    注意被cluster by指定的列只能是降序，不能指定asc和desc。</span><br></pre></td></tr></table></figure>
<h1 id="问题集"><a href="#问题集" class="headerlink" title="问题集"></a>问题集</h1><h2 id="查询ES表报错"><a href="#查询ES表报错" class="headerlink" title="查询ES表报错"></a>查询ES表报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed with exception java.io.IOException:org.elasticsearch.hadoop.rest.EsHadoopInvalidRequest: The number of slices [1126] is too large. It must be less than [1024]. This limit can be set by changing the [index.max_slices_per_scroll] index level settin</span><br></pre></td></tr></table></figure>
<p>修改es的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /megacorp/_settings</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;index&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &quot;max_slices_per_scroll&quot; : 1126</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="上传hive-UDF包后重启hive-server报错"><a href="#上传hive-UDF包后重启hive-server报错" class="headerlink" title="上传hive UDF包后重启hive server报错"></a>上传hive UDF包后重启hive server报错</h2><h2 id="hive-udf没有权限执行"><a href="#hive-udf没有权限执行" class="headerlink" title="hive udf没有权限执行"></a>hive udf没有权限执行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error while compiling statement: FAILED: SemanticException No valid privileges User dmp does not have privileges for CREATEFUNCTION The required privileges: Server=server1-&gt;URI=file:///home/hive/aux_libs/carthage-common-udf-hive-test.jar-&gt;action=*;</span><br></pre></td></tr></table></figure>
<h2 id="没有找到jar包的报错"><a href="#没有找到jar包的报错" class="headerlink" title="没有找到jar包的报错"></a>没有找到jar包的报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error while compiling statement: FAILED: SemanticException [Error 10014]: Line 1:7 Wrong arguments &apos;70.0&apos;: org.apache.hadoop.hive.ql.metadata.HiveException: Unable to execute method public java.lang.String com.mljr.carthage.common.geo.udf.hive.UDFGeoLocation.evaluate(java.lang.Double,java.lang.Double) on object com.mljr.carthage.common.geo.udf.hive.UDFGeoLocation@54ee9573 of class com.mljr.carthage.common.geo.udf.hive.UDFGeoLocation with arguments &#123;50.0:java.lang.Double, 70.0:java.lang.Double&#125; of size 2</span><br></pre></td></tr></table></figure>
<p>其他都是可以的，就这个udf的第二个参数一直报错。经测试，还是UDF本身的问题，跟参数的设置没有关系。</p>
<p>最后发现问题是udf的jar包上传后，关联的一些jar包没有打进去，手动加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;1.6&lt;/version&gt;</span><br><span class="line">				&lt;executions&gt;</span><br><span class="line">					&lt;execution&gt;</span><br><span class="line">						&lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">						&lt;goals&gt;</span><br><span class="line">							&lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">						&lt;/goals&gt;</span><br><span class="line">						&lt;configuration&gt;</span><br><span class="line">							&lt;artifactSet&gt;</span><br><span class="line">								&lt;includes&gt;</span><br><span class="line">									&lt;include&gt;com.mljr.carthage:carthage-common-geo&lt;/include&gt;</span><br><span class="line">									&lt;include&gt;com.alibaba:fastjson&lt;/include&gt;</span><br><span class="line">									&lt;include&gt;com.github.davidmoten:geo&lt;/include&gt;</span><br><span class="line">									&lt;include&gt;com.github.davidmoten:grumpy-core&lt;/include&gt;</span><br><span class="line">								&lt;/includes&gt;</span><br><span class="line">							&lt;/artifactSet&gt;</span><br><span class="line">						&lt;/configuration&gt;</span><br><span class="line">					&lt;/execution&gt;</span><br><span class="line">				&lt;/executions&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<h1 id="hive用高版本的UDF"><a href="#hive用高版本的UDF" class="headerlink" title="hive用高版本的UDF"></a>hive用高版本的UDF</h1><p>在hive2.0中有类似于months_between的函数，可以实现2个时间之间的月份差。但是低版本没有这个函数</p>
<p>解决：</p>
<p>下载hive-2.1源码包</p>
<p><a href="http://mirrors.hust.edu.cn/apache/hive/hive-2.2.0/" target="_blank" rel="noopener">http://mirrors.hust.edu.cn/apache/hive/hive-2.2.0/</a></p>
<p>导入eclipse，查找months_between</p>
<p>在org.apache.hadoop.hive.ql.udf.generic包下找到GenericUDFMonthsBetween类，移植即可</p>
<p>/ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDFMonthsBetween.java</p>
<h1 id="String转date"><a href="#String转date" class="headerlink" title="String转date"></a>String转date</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select cast(to_date(from_unixtime(unix_timestamp(&apos;12-05-2010&apos;, &apos;dd-MM-yyyy&apos;))) as date)</span><br></pre></td></tr></table></figure>
<h1 id="MapJoin异常问题处理总结"><a href="#MapJoin异常问题处理总结" class="headerlink" title="MapJoin异常问题处理总结"></a>MapJoin异常问题处理总结</h1><p><a href="https://yq.aliyun.com/articles/64306" target="_blank" rel="noopener">https://yq.aliyun.com/articles/64306</a></p>
<h1 id="替换hive分隔符"><a href="#替换hive分隔符" class="headerlink" title="替换hive分隔符"></a>替换hive分隔符</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;.bak&apos; &apos;s/^A/,/g&apos; baseinfo05.csv</span><br></pre></td></tr></table></figure>
<p><code>^A</code>要用ctrl+V+A打出来</p>
<h1 id="Beeline导出csv后特殊符号"><a href="#Beeline导出csv后特殊符号" class="headerlink" title="Beeline导出csv后特殊符号"></a>Beeline导出csv后特殊符号</h1><p>导出csv后，由于某个字段（比如经纬度），本身就包括逗号，于是在导出时加上了特殊字符。</p>
<p>sublime打开是</p>
<p><img src="//schwimmer.github.io/2018/03/31/hadoop-spark/hive笔记/pic/image-20190704165407658.png" alt="image-20190704165407658"></p>
<p>于是搜索替换的方法，用vim打开后，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%s/\%x00/&quot;/g</span><br></pre></td></tr></table></figure>
<p>就替换为了双引号，这样在读取csv的时候会将双引号自动转义</p>
<h1 id="LOAD-DATA"><a href="#LOAD-DATA" class="headerlink" title="LOAD DATA"></a>LOAD DATA</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA [LOCAL] INPATH &apos;filepath&apos; [OVERWRITE] INTO TABLE tablename[PARTITION (partcol1=val1,partcol2=val2,…)]</span><br></pre></td></tr></table></figure>
<p>最好不要用LOCAL，要从hadoop加载数据。local读的是hive服务器的本地路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># coding:utf-8</span><br><span class="line">from pyhive import hive</span><br><span class="line">from TCLIService.ttypes import TOperationState</span><br><span class="line"></span><br><span class="line"># 打开hive连接</span><br><span class="line">hiveConn = hive.connect(host=&apos;192.168.83.135&apos;,port=11111,username=&apos;hadoop&apos;)</span><br><span class="line">cursor = hiveConn.cursor()</span><br><span class="line"></span><br><span class="line"># 执行sql语句</span><br><span class="line">sql = &apos;&apos;&apos; LOAD DATA LOCAL INPATH &apos;/home/hadoop/HivePy/employee.txt&apos; OVERWRITE INTO TABLE userdbbypy.employee &apos;&apos;&apos;</span><br><span class="line">cursor.execute(sql, async=True)</span><br><span class="line"></span><br><span class="line"># 得到执行语句的状态</span><br><span class="line">status = cursor.poll().operationState</span><br><span class="line">print &quot;status:&quot;,status</span><br><span class="line"></span><br><span class="line"># 关闭hive连接</span><br><span class="line">cursor.close()</span><br><span class="line">hiveConn.close()</span><br></pre></td></tr></table></figure>
<h1 id="return-code-3"><a href="#return-code-3" class="headerlink" title="return code 3"></a>return code 3</h1><p>试试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set hive.vectorized.execution.enabled=false;</span><br></pre></td></tr></table></figure>
<h1 id="hive锁表"><a href="#hive锁表" class="headerlink" title="hive锁表"></a>hive锁表</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Completed compiling command</span><br></pre></td></tr></table></figure>
<p>若卡在上面的语句，说明锁表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show locks carthage_dev.baseinfo_personal_info;</span><br><span class="line">-- 如果是</span><br><span class="line"></span><br><span class="line">unlock table dwh_dml_risk_dev.rec_car_operation;</span><br><span class="line">show locks carthage_dev.baseinfo_personal_info partition(data_date=&apos;20180517&apos;);</span><br><span class="line">unlock table dwh_dml_risk_dev.rec_car_operation partition(data_date=&apos;2018-09-30&apos;);</span><br></pre></td></tr></table></figure>
<p>hive解锁的脚本是<code>all_hive_unlock.sh</code></p>
<h1 id="hive新增列报错"><a href="#hive新增列报错" class="headerlink" title="hive新增列报错"></a>hive新增列报错</h1><p>在添加字段是可以通过CASCADE关键字来，避免出现这种问题。如alter table table_name add columns(age int) CASCADE</p>
<p><a href="https://qubole.zendesk.com/hc/en-us/articles/115002396646-Hive-Null-Pointer-Exception-in-select-query-after-modifying-table-definition" target="_blank" rel="noopener">https://qubole.zendesk.com/hc/en-us/articles/115002396646-Hive-Null-Pointer-Exception-in-select-query-after-modifying-table-definition</a></p>
<blockquote>
<p>This can happen in the scenario where table definition and specific partition definition is different, and the underlying data matches table definition but not partition definition.</p>
<p>When a table with partitions is altered to add a column using statement:</p>
<p><em>ALTER TABLE <tablename> ADD COLUMNS (c1 int);</tablename></em></p>
<p>The table definition for existing partitions don’t get modified as per the above statement. As a result of this there is a mismatch between partition and table definition. </p>
<p>This is ok if the partition data matches the definition of partition, but if the data matches definition of table itself, NPE is thrown as there is a mismatch in data vs definition.</p>
<p>To avoid this issue, this statement should be used in hadoop2</p>
<p><em>ALTER TABLE <tablename> ADD COLUMNS (c1 int) CASCADE;</tablename></em> </p>
<p>In case of hadoop1, CASCADE option is not available. Hence, as long as the table is external table, following can be done:</p>
<ol>
<li>Drop and recreate partitions for this table</li>
<li>Alter partition definition for specific partition having issues</li>
</ol>
</blockquote>
<p>用了cascade 无效。</p>
<p>找到原因：</p>
<p>hive表是ORC格式的，因此cascade无效，若改成text格式则成功。</p>
<p>解决方案：</p>
<p>若必须是ORC格式，建表是先预留若干字段，后期改名字</p>
<h1 id="hive分区解锁"><a href="#hive分区解锁" class="headerlink" title="hive分区解锁"></a>hive分区解锁</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show locks carthage_dev.baseinfo_personal_info;</span><br><span class="line">unlock table carthage_dev.baseinfo_personal_info;</span><br><span class="line">show locks carthage_dev.baseinfo_personal_info partition(data_date=&apos;20180517&apos;);</span><br><span class="line">unlock table carthage_dev.baseinfo_personal_info partition(data_date=&apos;20180517&apos;);</span><br></pre></td></tr></table></figure>
<p>解锁的技巧：</p>
<p>1、定位哪张表锁住，可以分批执行sql，定位关键表</p>
<p>2、show locks并下载，观察锁表的状态，通过</p>
<p><code>show locks table extends</code>可以看依赖的表</p>
<p>3、用脚本all_hive_unlock.sh解锁</p>
<h2 id="hive-column-rename"><a href="#hive-column-rename" class="headerlink" title="hive column rename"></a>hive column rename</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table carthage_dev.gps_wx_stop_status CHANGE stop_region_center_lon stop_status_center_lon string</span><br></pre></td></tr></table></figure>
<h1 id="hive配置"><a href="#hive配置" class="headerlink" title="hive配置"></a>hive配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 输出为gzip</span><br><span class="line">set hive.exec.compress.output=true;    </span><br><span class="line">set mapred.output.compression.codec=org.apache.hadoop.io.compress.GzipCodec;</span><br><span class="line">-- 输出为一个文件</span><br><span class="line">set mapred.reduce.tasks=1;</span><br></pre></td></tr></table></figure>
<h1 id="hive-timestamp转时间"><a href="#hive-timestamp转时间" class="headerlink" title="hive timestamp转时间"></a>hive timestamp转时间</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from_unixtime(unix_timestamp(),‘yyyy/MM/dd HH:mm:ss’);</span><br><span class="line"></span><br><span class="line">from_unixtime(cast(cast(time as bigint)/1000 as bigint),&apos;yyyy/MM/dd HH:mm:ss&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="常用日期函数"><a href="#常用日期函数" class="headerlink" title="常用日期函数"></a>常用日期函数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">to_date：日期时间转日期函数    </span><br><span class="line">	select to_date(&apos;2018-04-02 13:34:12&apos;);   输出：2018-04-02   </span><br><span class="line">from_unixtime：转化unix时间戳到当前时区的时间格式    </span><br><span class="line">	select from_unixtime(1524573762,&apos;yyyy-MM-dd HH:mm:ss&apos;);    输出：2018-04-24 20:42:42</span><br><span class="line">unix_timestamp：获取当前unix时间戳    </span><br><span class="line">	select unix_timestamp();    输出：1524573762  </span><br><span class="line">	select unix_timestamp(&apos;2018-04-01 13:01:20&apos;);  输出：1522558880</span><br><span class="line">datediff：返回开始日期减去结束日期的天数    </span><br><span class="line">	select datediff(&apos;2018-04-09&apos;,&apos;2018-04-01&apos;);    输出：8    </span><br><span class="line">date_sub：返回日期前n天的日期    </span><br><span class="line">	select date_sub(&apos;2018-04-09&apos;,4);    输出：2018-04-05    </span><br><span class="line">date_add：返回日期后n天的日期    </span><br><span class="line">	select date_add(&apos;2018-04-09&apos;,4);    输出：2018-04-13  </span><br><span class="line">add_months：月份增加函数</span><br><span class="line">	select add_months(&apos;2018-02-10&apos;, 2 );    输出：2018-04-10 </span><br><span class="line">last_day：返回当月底日期</span><br><span class="line">	select last_day(&apos;2018-02-21&apos;);    输出：2018-02-28</span><br></pre></td></tr></table></figure>
<h1 id="hive-字符串函数"><a href="#hive-字符串函数" class="headerlink" title="hive 字符串函数"></a>hive 字符串函数</h1><p><strong>1. 字符串长度函数：length</strong></p>
<p>语法: length(string A)</p>
<p>返回值: int</p>
<p>说明：返回字符串A的长度</p>
<p>举例：</p>
<p>hive&gt; select length(‘abcedfg’) from lxw_dual;</p>
<p>7</p>
<p><strong>2. 字符串反转函数：reverse</strong></p>
<p>语法: reverse(string A)</p>
<p>返回值: string</p>
<p>说明：返回字符串A的反转结果</p>
<p>举例：</p>
<p>hive&gt; select reverse(abcedfg’) from lxw_dual;</p>
<p>gfdecba</p>
<p><strong>3. 字符串连接函数：concat</strong></p>
<p>语法: concat(string A, string B…)</p>
<p>返回值: string</p>
<p>说明：返回输入字符串连接后的结果，支持任意个输入字符串</p>
<p>举例：</p>
<p>hive&gt; select concat(‘abc’,’def’,’gh’) from lxw_dual;</p>
<p>abcdefgh</p>
<p><strong>4. 带分隔符字符串连接函数：concat_ws</strong></p>
<p>语法: concat_ws(string SEP, string A, string B…)</p>
<p>返回值: string</p>
<p>说明：返回输入字符串连接后的结果，SEP表示各个字符串间的分隔符</p>
<p>举例：</p>
<p>hive&gt; select concat_ws(‘,’,’abc’,’def’,’gh’) from lxw_dual;</p>
<p>abc,def,gh</p>
<p><strong>5. 字符串截取函数：substr,substring</strong></p>
<p>语法: substr(string A, int start),substring(string A, int start)</p>
<p>返回值: string</p>
<p>说明：返回字符串A从start位置到结尾的字符串</p>
<p>举例：</p>
<p>hive&gt; select substr(‘abcde’,3) from lxw_dual;</p>
<p>cde</p>
<p>hive&gt; select substring(‘abcde’,3) from lxw_dual;</p>
<p>cde</p>
<p>hive&gt;  selectsubstr(‘abcde’,-1) from lxw_dual;  （和ORACLE相同）</p>
<p>e</p>
<p><strong>6. 字符串截取函数：substr,substring</strong></p>
<p>语法: substr(string A, int start, int len),substring(string A, intstart, int len)</p>
<p>返回值: string</p>
<p>说明：返回字符串A从start位置开始，长度为len的字符串</p>
<p>举例：</p>
<p>hive&gt; select substr(‘abcde’,3,2) from lxw_dual;</p>
<p>cd</p>
<p>hive&gt; select substring(‘abcde’,3,2) from lxw_dual;</p>
<p>cd</p>
<p>hive&gt;select substring(‘abcde’,-2,2) from lxw_dual;</p>
<p>de</p>
<p><strong>7. 字符串转大写函数：upper,ucase</strong></p>
<p>语法: upper(string A) ucase(string A)</p>
<p>返回值: string</p>
<p>说明：返回字符串A的大写格式</p>
<p>举例：</p>
<p>hive&gt; select upper(‘abSEd’) from lxw_dual;</p>
<p>ABSED</p>
<p>hive&gt; select ucase(‘abSEd’) from lxw_dual;</p>
<p>ABSED</p>
<p><strong>8. 字符串转小写函数：lower,lcase</strong></p>
<p>语法: lower(string A) lcase(string A)</p>
<p>返回值: string</p>
<p>说明：返回字符串A的小写格式</p>
<p>举例：</p>
<p>hive&gt; select lower(‘abSEd’) from lxw_dual;</p>
<p>absed</p>
<p>hive&gt; select lcase(‘abSEd’) from lxw_dual;</p>
<p>absed</p>
<p><strong>9. 去空格函数：trim</strong></p>
<p>语法: trim(string A)</p>
<p>返回值: string</p>
<p>说明：去除字符串两边的空格</p>
<p>举例：</p>
<p>hive&gt; select trim(‘ abc ‘) from lxw_dual;</p>
<p>abc</p>
<p><strong>10. 左边去空格函数：ltrim</strong></p>
<p>语法: ltrim(string A)</p>
<p>返回值: string</p>
<p>说明：去除字符串左边的空格</p>
<p>举例：</p>
<p>hive&gt; select ltrim(‘ abc ‘) from lxw_dual;</p>
<p>abc</p>
<p><strong>11. 右边去空格函数：rtrim</strong></p>
<p>语法: rtrim(string A)</p>
<p>返回值: string</p>
<p>说明：去除字符串右边的空格</p>
<p>举例：</p>
<p>hive&gt; select rtrim(‘ abc ‘) from lxw_dual;</p>
<p>abc</p>
<p><strong>12. 正则表达式替换函数：regexp_replace</strong></p>
<p>语法: regexp_replace(string A, string B, string C)</p>
<p>返回值: string</p>
<p>说明：将字符串A中的符合java正则表达式B的部分替换为C。注意，在有些情况下要使用转义字符,类似oracle中的regexp_replace函数。</p>
<p>举例：</p>
<p>hive&gt; select regexp_replace(‘foobar’, ‘oo|ar’, ‘’) from lxw_dual;</p>
<p>fb</p>
<p><strong>13. 正则表达式解析函数：regexp_extract</strong></p>
<p>语法: regexp_extract(string subject, string pattern, int index)</p>
<p>返回值: string</p>
<p>说明：将字符串subject按照pattern正则表达式的规则拆分，返回index指定的字符。</p>
<p>举例：</p>
<p>hive&gt; select regexp_extract(‘foothebar’, ‘foo(.*?)(bar)’, 1) fromlxw_dual;</p>
<p>the</p>
<p>hive&gt; select regexp_extract(‘foothebar’, ‘foo(.*?)(bar)’, 2) fromlxw_dual;</p>
<p>bar</p>
<p>hive&gt; select regexp_extract(‘foothebar’, ‘foo(.*?)(bar)’, 0) fromlxw_dual;</p>
<p>foothebar</p>
<p><strong>注意，在有些情况下要使用转义字符，下面的等号要用双竖线转义，这是java**</strong>正则表达式的规则。**</p>
<p>select data_field,</p>
<p>​     regexp_extract(data_field,’.*?bgStart\=(<sup><a href="#fn_&" id="reffn_&">&</a></sup>+)’,1) as aaa,</p>
<p>​     regexp_extract(data_field,’.*?contentLoaded_headStart\=(<sup><a href="#fn_&" id="reffn_&">&</a></sup>+)’,1) as bbb,</p>
<p>​     regexp_extract(data_field,’.*?AppLoad2Req\=(<sup><a href="#fn_&" id="reffn_&">&</a></sup>+)’,1) as ccc</p>
<p>​     from pt_nginx_loginlog_st</p>
<p>​     where pt = ‘2012-03-26’limit 2;</p>
<p><strong>14. URL解析函数：parse_url</strong></p>
<p>语法: parse_url(string urlString, string partToExtract [, stringkeyToExtract])</p>
<p>返回值: string</p>
<p>说明：返回URL中指定的部分。partToExtract的有效值为：HOST, PATH, QUERY, REF, PROTOCOL, AUTHORITY, FILE, and USERINFO.</p>
<p>举例：</p>
<p>hive&gt; selectparse_url(‘<a href="http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1" target="_blank" rel="noopener">http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1</a>‘, ‘HOST’) fromlxw_dual;</p>
<p>facebook.com</p>
<p>hive&gt; selectparse_url(‘<a href="http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1" target="_blank" rel="noopener">http://facebook.com/path1/p.php?k1=v1&amp;k2=v2#Ref1</a>‘, ‘QUERY’,’k1’) from lxw_dual;</p>
<p>v1</p>
<p><strong>15. json解析函数：get_json_object</strong></p>
<p>语法: get_json_object(string json_string, string path)</p>
<p>返回值: string</p>
<p>说明：解析json的字符串json_string,返回path指定的内容。如果输入的json字符串无效，那么返回NULL。</p>
<p>举例：</p>
<p>hive&gt; select get_json_object(‘{“store”:</p>
<p>>  {“fruit”:[{“weight”:8,”type”:”apple”},{“weight”:9,”type”:”pear”}],</p>
<p>>   “bicycle”:{“price”:19.95,”color”:”red”}</p>
<p>>   },</p>
<p>> “email”:”amy@only_for_json_udf_test.net”,</p>
<p>>  “owner”:”amy”</p>
<p>> }</p>
<p>> ‘,’$.owner’) from lxw_dual;</p>
<p>amy</p>
<p><strong>16. 空格字符串函数：space</strong></p>
<p>语法: space(int n)</p>
<p>返回值: string</p>
<p>说明：返回长度为n的字符串</p>
<p>举例：</p>
<p>hive&gt; select space(10) from lxw_dual;</p>
<p>hive&gt; select length(space(10)) from lxw_dual;</p>
<p>10</p>
<p><strong>17. 重复字符串函数：repeat</strong></p>
<p>语法: repeat(string str, int n)</p>
<p>返回值: string</p>
<p>说明：返回重复n次后的str字符串</p>
<p>举例：</p>
<p>hive&gt; select repeat(‘abc’,5) from lxw_dual;</p>
<p>abcabcabcabcabc</p>
<p><strong>18. 首字符ascii函数：ascii</strong></p>
<p>语法: ascii(string str)</p>
<p>返回值: int</p>
<p>说明：返回字符串str第一个字符的ascii码</p>
<p>举例：</p>
<p>hive&gt; select ascii(‘abcde’) from lxw_dual;</p>
<p>97</p>
<p><strong>19. 左补足函数：lpad</strong></p>
<p>语法: lpad(string str, int len, string pad)</p>
<p>返回值: string</p>
<p>说明：将str进行用pad进行左补足到len位</p>
<p>举例：</p>
<p>hive&gt; select lpad(‘abc’,10,’td’) from lxw_dual;</p>
<p>tdtdtdtabc</p>
<p><strong>注意：与GP**</strong>，ORACLE<strong>**不同，pad</strong> <strong>不能默认</strong></p>
<p><strong>20. 右补足函数：rpad</strong></p>
<p>语法: rpad(string str, int len, string pad)</p>
<p>返回值: string</p>
<p>说明：将str进行用pad进行右补足到len位</p>
<p>举例：</p>
<p>hive&gt; select rpad(‘abc’,10,’td’) from lxw_dual;</p>
<p>abctdtdtdt</p>
<p><strong>21. 分割字符串函数: split</strong></p>
<p>语法:  split(string str, stringpat)</p>
<p>返回值:  array</p>
<p>说明: 按照pat字符串分割str，会返回分割后的字符串数组</p>
<p>举例：</p>
<p>hive&gt; select split(‘abtcdtef’,’t’) from lxw_dual;</p>
<p>[“ab”,”cd”,”ef”]</p>
<p><strong>22. 集合查找函数:find_in_set</strong></p>
<p>语法: find_in_set(string str, string strList)</p>
<p>返回值: int</p>
<p>说明: 返回str在strlist第一次出现的位置，strlist是用逗号分割的字符串。如果没有找该str字符，则返回0</p>
<p>举例：</p>
<p>hive&gt; select find_in_set(‘ab’,’ef,ab,de’) from lxw_dual;</p>
<p>2</p>
<p>hive&gt; select find_in_set(‘at’,’ef,ab,de’) from lxw_dual;</p>
<p>0</p>
<p>instr</p>
<h1 id="group后拼接"><a href="#group后拼接" class="headerlink" title="group后拼接"></a>group后拼接</h1><p>group_concat( [distinct] 要连接的字段 [order by 排序字段 asc/desc ] [separator ‘分隔符’] )</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select userid,bankid,group_concat(cast(creditlimit as string))</span><br><span class="line">from vdm_fin.cc_user_bill_0724</span><br><span class="line">group by userid,bankid</span><br></pre></td></tr></table></figure>
<p><img src="//schwimmer.github.io/2018/03/31/hadoop-spark/hive笔记/pic/70.png" alt="è¿éåå¾çæè¿°"></p>
<p><strong>hive实现相同的功能：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,</span><br><span class="line">concat_ws(&apos;|&apos;, collect_set(str)) </span><br><span class="line">FROM t  </span><br><span class="line">GROUP BY id;1234</span><br></pre></td></tr></table></figure>
<p>主意:collect_set 只能返回不重复的集合<br>若要返回带重复的要用collect_list</p>
<p>2、collect_list 展示子表排序后结果，collect_set 不受子表排序影响<br>select phone,collect_list(user_id) ,collect_set(user_id) from<br>(select * from a order by order_time asc)b<br>group by phone<br>结果：123456789    [1,1,3,2,2]    [1,3,2]</p>
<p>a表数据如下<br>phone    user_id order_time<br>123456789    1    2018/8/23<br>123456789    3    2018/8/24<br>123456789    2    2018/8/25<br>123456789    1    2018/8/22<br>123456789    2    2018/8/26</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Schwimmer</p>
              <div class="site-description motion-element" itemprop="description">Record and Think!</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">308</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Schwimmer</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.2.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    
      <div>
        
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "1",
        "bdMiniList": false,
        "bdPic": ""
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      },
      "slide": {
        "bdImg": "5",
        "bdPos": "left",
        "bdTop": "100"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      </div>
    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.2.0"></script>


  

  

  

  
  
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-schwimmer-github-io.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>







  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

    
  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
